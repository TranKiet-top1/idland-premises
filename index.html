div id="admin-pending-controls"<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>ID-Land Premises</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
    rel="stylesheet"
  />

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    /* CSS CHO GHIM GI√Å TI·ªÄN TR√äN B·∫¢N ƒê·ªí */
    .price-marker-label {
      background-color: white;
      border-radius: 12px;
      padding: 4px 8px;
      font-weight: bold;
      font-size: 12px;
      color: #333;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      border: 1px solid #ccc;
      white-space: nowrap;
      text-align: center;
      transition: transform 0.2s;
    }
    .price-marker-label:hover {
      background-color: #3b82f6; /* M√†u xanh primary khi hover */
      color: white;
      border-color: #2563eb;
      transform: scale(1.1);
      z-index: 999 !important;
    }
    /* M≈©i t√™n nh·ªè d∆∞·ªõi ghim (t√πy ch·ªçn) */
    .price-marker-label::after {
      content: "";
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 4px 4px 0;
      border-style: solid;
      border-color: white transparent transparent transparent;
    }
    .price-marker-label:hover::after {
      border-color: #2563eb transparent transparent transparent;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    .premise-card:hover {
      transform: translateY(-2px);
    }
  </style>
</head>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>


<body class="bg-base-200">

  <section id="auth-section" class="min-h-screen flex flex-col bg-base-200">
    <!-- THANH NAVBAR TRANG CH·ª¶ -->
    <header class="navbar bg-base-100 shadow-sm px-4">
      <div class="flex-1 flex items-center gap-2">
        <div class="h-9 w-9 rounded-xl bg-primary flex items-center justify-center text-white font-bold text-xs">
          ID
        </div>
        <div>
          <div class="font-bold text-lg leading-tight">ID-Land Premises</div>
          <div class="text-xs opacity-60">Kho m·∫∑t b·∫±ng cho thu√™ ‚Ä¢ TP.HCM</div>
        </div>
      </div>
      <div class="flex-none">
        <button id="btn-open-login" class="btn btn-outline btn-sm">
          ƒêƒÉng nh·∫≠p nh√¢n s·ª±
        </button>
      </div>
    </header>

    <!-- N·ªòI DUNG TRANG CH·ª¶ D√ÄNH CHO KH√ÅCH -->
    <div class="flex-1 max-w-6xl mx-auto w-full px-4 py-10 grid md:grid-cols-2 gap-10 items-center">
      <!-- C·ªòT B√äN TR√ÅI: HERO CHO KH√ÅCH -->
      <div>
        <p class="text-sm uppercase tracking-wide text-primary font-semibold mb-2">
          Trang tra c·ª©u m·∫∑t b·∫±ng ID-Land
        </p>
        <h1 class="text-3xl sm:text-4xl font-extrabold leading-tight mb-4">
          T√¨m m·∫∑t b·∫±ng kinh doanh<br class="hidden sm:block" />
          <span class="text-primary">nhanh ‚Äì r√µ r√†ng ‚Äì minh b·∫°ch</span>
        </h1>
        <p class="text-sm sm:text-base opacity-80 mb-4">
          ID-Land t·∫≠p trung m·∫∑t b·∫±ng cho thu√™ t·∫°i c√°c qu·∫≠n trung t√¢m TP.HCM.
          Kh√°ch h√†ng c√≥ th·ªÉ li√™n h·ªá nh√¢n s·ª± ƒë·ªÉ ƒë∆∞·ª£c g·ª≠i danh s√°ch ph√π h·ª£p theo
          <b>gi√° ‚Äì di·ªán t√≠ch ‚Äì khu v·ª±c ‚Äì m√¥ h√¨nh kinh doanh</b>.
        </p>
        <ul class="text-sm opacity-80 space-y-1 mb-6">
          <li>‚Ä¢ Th√¥ng tin m·∫∑t b·∫±ng c·∫≠p nh·∫≠t th∆∞·ªùng xuy√™n</li>
          <li>‚Ä¢ H·ªó tr·ª£ xin s·ªë ch·ªß &amp; th∆∞∆°ng l∆∞·ª£ng gi√° thu√™</li>
          <li>‚Ä¢ Ph√π h·ª£p nhi·ªÅu m√¥ h√¨nh: F&amp;B, showroom, spa, vƒÉn ph√≤ng‚Ä¶</li>
        </ul>
        <div class="flex flex-wrap gap-3">
          <a
            href="tel:0798905082"
            class="btn btn-primary btn-md"
          >
            G·ªçi t∆∞ v·∫•n ngay
          </a>
          <button
            type="button"
            class="btn btn-ghost btn-md"
            onclick="alert('Vui l√≤ng li√™n h·ªá nh√¢n s·ª± ID-Land ƒë·ªÉ ƒë∆∞·ª£c g·ª≠i danh s√°ch m·∫∑t b·∫±ng m·ªõi nh·∫•t.')"
          >
            Nh·∫≠n danh s√°ch m·∫∑t b·∫±ng
          </button>
        </div>
      </div>

      <!-- C·ªòT B√äN PH·∫¢I: FORM ƒêƒÇNG NH·∫¨P NH√ÇN S·ª∞ (·∫®N ƒê·∫æN KHI B·∫§M N√öT) -->
      <div id="login-card" class="card w-full max-w-md bg-base-100 shadow-xl ml-auto hidden">
        <div class="card-body">
          <div class="flex items-center gap-2 mb-4">
            <div class="h-10 w-10 rounded-xl bg-primary flex items-center justify-center text-white font-bold">
              ID
            </div>
            <div>
              <h2 class="card-title">ƒêƒÉng nh·∫≠p nh√¢n s·ª±</h2>
              <p class="text-xs opacity-70">
                D√†nh cho n·ªôi b·ªô ID-Land ƒë·ªÉ xem &amp; qu·∫£n l√Ω kho m·∫∑t b·∫±ng.
              </p>
            </div>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Email</span>
            </label>
            <input
              id="login-email"
              type="email"
              placeholder="you@idland.vn"
              class="input input-bordered"
            />
          </div>

          <div class="form-control mt-2">
            <label class="label">
              <span class="label-text">M·∫≠t kh·∫©u</span>
            </label>
            <input
              id="login-password"
              type="password"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              class="input input-bordered"
            />
          </div>

          <div class="form-control mt-4">
            <button id="btn-login" class="btn btn-primary w-full">
              ƒêƒÉng nh·∫≠p
            </button>
          </div>

          <p class="mt-3 text-xs opacity-70">
            Quy·ªÅn <b>admin</b>: xem &amp; ch·ªânh s·ª≠a full th√¥ng tin, s·ªë nh√† &amp; s·ªë ch·ªß.<br />
            Quy·ªÅn <b>nh√¢n s·ª±</b>: xem th√¥ng tin ph·ª•c v·ª• kh√°ch, kh√¥ng ch·ªânh s·ª≠a c·∫•u h√¨nh h·ªá th·ªëng.
          </p>
        </div>
      </div>
    </div>
  </section>


  <div id="app-root" class="hidden min-h-screen flex flex-col">
    <div class="navbar bg-base-100 shadow-sm px-4 sticky top-0 z-50">
      <div class="flex-1 flex items-center gap-2">
        <div class="h-9 w-9 rounded-xl bg-primary flex items-center justify-center text-white font-bold text-xs">ID</div>
        <div>
          <div class="font-bold text-lg leading-tight">ID-Land Premises</div>
          <div class="text-xs opacity-60">Kho m·∫∑t b·∫±ng cho thu√™ ‚Ä¢ TP.HCM</div>
        </div>
      </div>
      <div class="flex-none flex items-center gap-2 text-sm">
        <div class="text-right hidden sm:block mr-2">
             <div id="user-email-display" class="text-xs font-bold"></div>
             <span id="role-badge" class="badge badge-outline"></span>
        </div>
        <button id="btn-logout" class="btn btn-ghost btn-sm">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <main class="flex-1 max-w-6xl mx-auto w-full px-2 sm:px-4 py-4">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <div>
          <h1 class="text-xl sm:text-2xl font-bold">
            B·ªô l·ªçc m·∫∑t b·∫±ng <span class="text-primary">ID-Land</span>
          </h1>
          <p class="text-xs sm:text-sm opacity-70">
            Nh√¢n s·ª± ch·ªâ c·∫ßn nh·∫≠p y√™u c·∫ßu c·ªßa kh√°ch: <b>gi√° ‚Äì di·ªán t√≠ch ‚Äì khu v·ª±c...</b>
          </p>
        </div>

        <div class="flex flex-wrap gap-2 justify-end">
          <div class="join">
            <button id="btn-view-list" class="btn btn-sm join-item btn-active">Danh s√°ch</button>
            <button id="btn-view-map" class="btn btn-sm join-item">B·∫£n ƒë·ªì</button>
          </div>
          <div id="admin-pending-controls" class="hidden flex gap-2">
            <!-- C·∫¶N DUY·ªÜT -->
            <button id="btn-toggle-pending" class="btn btn-warning btn-sm text-white">
              C·∫ßn duy·ªát
              <span class="badge badge-sm bg-white text-warning ml-1 border-none" id="count-pending">0</span>
            </button>

            <!-- B√ÅO H·∫æT -->
            <button id="btn-toggle-rented-reports" class="btn btn-error btn-sm text-white">
              B√°o h·∫øt
              <span class="badge badge-sm bg-white text-error ml-1 border-none" id="count-rented-reports">0</span>
            </button>

            <!-- DUY·ªÜT CH·∫†Y L·∫†I (M·ªöI) -->
            <button id="btn-toggle-reactivate" class="btn btn-info btn-sm text-white">
              Duy·ªát ch·∫°y l·∫°i
              <span class="badge badge-sm bg-white text-info ml-1 border-none" id="count-reactivate">0</span>
            </button>

            <!-- DUY·ªÜT T·∫§T C·∫¢ -->
            <button id="btn-approve-all" class="btn btn-success btn-sm text-white hidden">
              ‚úî Duy·ªát t·∫•t c·∫£
            </button>
            <button onclick="document.getElementById('toolDlg').showModal()" class="btn btn-neutral btn-sm text-white">
              üõ† C√¥ng c·ª•
            </button>
          </div>
          <button id="btn-open-add" class="btn btn-primary btn-sm">
            + Th√™m m·∫∑t b·∫±ng
          </button>
        </div>

      </div>

      <div class="flex flex-wrap items-center gap-2 mb-3">
        <span class="text-xs opacity-70">L·ªçc nhanh:</span>
        <button class="btn btn-xs" data-quick="available">C√≤n tr·ªëng</button>
        <button class="btn btn-xs" data-quick="deposited">Gi·ªØ c·ªçc</button>
        <button class="btn btn-xs" data-quick-district="Qu·∫≠n 1">Qu·∫≠n 1</button>
        <button class="btn btn-xs" data-quick-district="Qu·∫≠n 10">Qu·∫≠n 10</button>
        <button class="btn btn-xs btn-ghost btn-outline" id="btn-clear-quick">
          Xo√° l·ªçc nhanh
        </button>

        <!-- N√öT XEM GHIM -->
        <button class="btn btn-xs btn-outline" id="btn-toggle-favorites">
          Xem m·∫∑t b·∫±ng ƒë√£ ghim
        </button>
      </div>


      <div class="grid md:grid-cols-[260px,1fr] gap-4">
        <aside class="bg-base-100 rounded-2xl shadow-sm p-4">
          <div class="flex items-center gap-2 mb-3">
            <span class="w-2 h-2 rounded-full bg-success"></span>
            <h2 class="font-semibold text-sm">B·ªô l·ªçc</h2>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">T·ª´ kho√°</span>
            </label>
            <input
              id="filter-keyword"
              type="text"
              placeholder="VD: Tr·∫ßn H∆∞ng ƒê·∫°o, Q5..."
              class="input input-sm input-bordered"
            />
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">Qu·∫≠n</span>
            </label>
            <select id="filter-district" class="select select-sm select-bordered">
              <option value="">T·∫•t c·∫£</option>
            </select>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">Ph∆∞·ªùng</span>
            </label>
            <select id="filter-ward" class="select select-sm select-bordered">
              <option value="">T·∫•t c·∫£</option>
            </select>
          </div>

          <div class="grid grid-cols-1 gap-2 mb-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">S·ªë PN</span>
              </label>
              <select id="filter-pn" class="select select-sm select-bordered">
                <option value="">T·∫•t c·∫£</option>
                <option value="1">1 PN</option>
                <option value="2">2 PN</option>
                <option value="3">3 PN</option>
                <option value="4">4 PN</option>
                <option value="5">5 PN</option>
                <option value="6">6 PN</option>
                <option value=">6">> 6 PN</option>
              </select>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">S·ªë WC</span>
              </label>
              <select id="filter-wc" class="select select-sm select-bordered">
                <option value="">T·∫•t c·∫£</option>
                <option value="1">1 WC</option>
                <option value="2">2 WC</option>
                <option value="3">3 WC</option>
                <option value="4">4 WC</option>
                <option value="5">5 WC</option>
                <option value=">5">> 5 WC</option>
              </select>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">S·ªë t·∫ßng</span>
              </label>
              <select id="filter-floors" class="select select-sm select-bordered">
                <option value="">T·∫•t c·∫£</option>
                <option value="1">1 t·∫ßng</option>
                <option value="2">2 t·∫ßng</option>
                <option value="3">3 t·∫ßng</option>
                <option value="4">4 t·∫ßng</option>
                <option value="5">5 t·∫ßng</option>
                <option value=">5">> 5 t·∫ßng</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Gi√° t·ªëi thi·ªÉu</span>
              </label>
              <input
                id="filter-price-min"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Gi√° t·ªëi ƒëa</span>
              </label>
              <input
                id="filter-price-max"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">DT t·ªëi thi·ªÉu (m¬≤)</span>
              </label>
              <input
                id="filter-area-min"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">DT t·ªëi ƒëa (m¬≤)</span>
              </label>
              <input
                id="filter-area-max"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">V·ªã tr√≠</span>
            </label>
            <select id="filter-frontage-type" class="select select-sm select-bordered">
              <option value="">T·∫•t c·∫£</option>
              <option value="hem">Nh√† h·∫ªm</option>
              <option value="hxh">H·∫ªm xe h∆°i</option>
              <option value="mt">M·∫∑t ti·ªÅn</option>
            </select>
          </div>

          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text text-xs">T√¨nh tr·∫°ng</span>
            </label>
            <select id="filter-status" class="select select-sm select-bordered">
              <option value="">T·∫•t c·∫£</option>
              <option value="available">C√≤n tr·ªëng</option>
              <option value="deposited">Gi·ªØ c·ªçc</option>
              <option value="rented">ƒê√£ thu√™</option>
            </select>
          </div>

          <div class="flex gap-2">
            <div class="btn-group">
              <button id="btn-view-list" class="btn btn-sm btn-active">Danh s√°ch</button>
              <button id="btn-view-map" class="btn btn-sm btn-ghost">B·∫£n ƒë·ªì</button>
            </div>

            <button id="btn-apply" class="btn btn-sm btn-primary flex-1">
              L·ªçc
            </button>
            <button id="btn-reset" class="btn btn-sm btn-ghost">
              Xo√° l·ªçc
            </button>
          </div>
        </aside>

        <section class="flex flex-col gap-3">
          <div class="flex items-center justify-between mb-1 text-xs opacity-70">
            <span>Hi·ªÉn th·ªã <span id="count-show">0</span> / <span id="count-total">0</span></span>
            <button id="btn-download-csv" class="btn btn-xs btn-ghost">T·∫£i CSV tr√™n Supabase</button>
          </div>

          <div id="list-view">
            <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
              </div>
            <div class="mt-4 flex justify-center">
              <button id="btn-load-more" class="btn btn-sm btn-ghost">H·∫øt d·ªØ li·ªáu</button>
            </div>
          </div>

          <div id="map-view" class="hidden w-full h-[600px] rounded-xl border border-base-300 relative z-0">
            <div id="premises-map" class="w-full h-full rounded-xl"></div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <dialog id="detailDlg" class="modal">
    <div class="modal-box max-w-5xl p-4">
      <form method="dialog" class="modal-backdrop absolute inset-0" onclick="document.getElementById('detailDlg').close()"></form>
      <div id="detail-content"></div>
    </div>
  </dialog>

  <dialog id="editDlg" class="modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog" class="modal-backdrop absolute inset-0" onclick="document.getElementById('editDlg').close()"></form>
      <h3 class="font-bold text-lg mb-3">Ch·ªânh s·ª≠a m·∫∑t b·∫±ng</h3>

      <div class="grid md:grid-cols-2 gap-3">
        <div class="form-control md:col-span-2">
          <label class="label">
            <span class="label-text">M√£ m·∫∑t b·∫±ng (code)</span>
          </label>
          <input id="edit-code" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label">
            <span class="label-text">Ti√™u ƒë·ªÅ / ƒê·ªãa ch·ªâ hi·ªÉn th·ªã</span>
          </label>
          <input id="edit-address" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Th√†nh ph·ªë</span></label>
          <input id="edit-city" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Qu·∫≠n</span></label>
          <input id="edit-district" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Ph∆∞·ªùng</span></label>
          <input id="edit-ward" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">T√™n ƒë∆∞·ªùng</span></label>
          <input id="edit-street" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control md:col-span-2">
          <label class="label">
            <span class="label-text font-bold text-primary">C·∫≠p nh·∫≠t T·ªça ƒë·ªô (Lat / Lng)</span>
          </label>
          <div class="join w-full">
            <input id="edit-lat" type="text" class="input input-bordered join-item w-1/3" placeholder="Lat (Vƒ© ƒë·ªô)" />
            <input id="edit-lng" type="text" class="input input-bordered join-item w-1/3" placeholder="Lng (Kinh ƒë·ªô)" />
            <button type="button" class="btn btn-accent join-item w-1/3 text-white" onclick="autoFetchCoordsForEdit()">
              üìç D√≤ l·∫°i theo ƒë·ªãa ch·ªâ
            </button>
          </div>
          <label class="label">
            <span class="label-text-alt text-gray-500">
              Admin c√≥ th·ªÉ nh·∫≠p th·ªß c√¥ng ho·∫∑c b·∫•m n√∫t "D√≤ l·∫°i" ƒë·ªÉ l·∫•y t·ªça ƒë·ªô t·ª´ ƒë·ªãa ch·ªâ b√™n tr√™n.
            </span>
          </label>
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Gi√° thu√™ (ƒë)</span></label>
          <input id="edit-price" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Di·ªán t√≠ch (m¬≤)</span></label>
          <input id="edit-area" type="number" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Chi·ªÅu ngang (m)</span></label>
          <input id="edit-width" type="number" step="0.1" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Chi·ªÅu d√†i (m)</span></label>
          <input id="edit-length" type="number" step="0.1" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">S·ªë t·∫ßng</span></label>
          <input id="edit-floors" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">S·ªë PN</span></label>
          <input id="edit-bedrooms" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">S·ªë WC</span></label>
          <input id="edit-wc" type="number" class="input input-bordered w-full" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">K·∫øt c·∫•u</span></label>
          <input id="edit-ket-cau" type="text" class="input input-bordered w-full" placeholder="VD: Tr·ªát 3 l·∫ßu, tr·ªëng su·ªët‚Ä¶" />
        </div>
        
        <div class="form-control md:col-span-2">
            <label class="label"><span class="label-text">SƒêT Ch·ªß nh√† (Ch·ªâ Admin th·∫•y)</span></label>
            <input id="edit-contact-phone" type="text" class="input input-bordered w-full" placeholder="090..." />
        </div>

        <div class="form-control flex items-center gap-2 mt-2">
          <input id="edit-frontage" type="checkbox" class="checkbox" />
          <span class="label-text">Nh√† m·∫∑t ti·ªÅn</span>
        </div>

        <div class="form-control md:col-span-2 grid grid-cols-2 gap-2">
            <div class="form-control">
              <label class="label"><span class="label-text">Lo·∫°i h√¨nh</span></label>
              <select id="edit-road-type" class="select select-bordered w-full">
                <option value="H·∫ªm">H·∫ªm</option>
                <option value="H·∫ªm xe h∆°i">H·∫ªm xe h∆°i</option>
                <option value="M·∫∑t ti·ªÅn">M·∫∑t ti·ªÅn</option>
              </select>
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">Hoa h·ªìng (ng·∫Øn)</span></label>
              <input id="edit-commission-text" type="text" class="input input-bordered w-full" placeholder="VD: 1 th√°ng" />
            </div>
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Tr·∫°ng th√°i</span></label>
          <select id="edit-status" class="select select-bordered w-full">
            <option value="available">C√≤n tr·ªëng</option>
            <option value="deposited">Gi·ªØ c·ªçc</option>
            <option value="rented">ƒê√£ thu√™</option>
          </select>
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Hoa h·ªìng / ghi ch√∫ HH</span></label>
          <input id="edit-commission" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Danh s√°ch ·∫£nh (m·ªói d√≤ng 1 path)</span></label>
          <textarea id="edit-images" class="textarea textarea-bordered w-full min-h-[80px]" placeholder="VD: MB0001/1.jpg
MB0001/2.jpg"></textarea>
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Th√¥ng tin chi ti·∫øt m·∫∑t b·∫±ng</span></label>
          <textarea id="edit-detail" class="textarea textarea-bordered w-full min-h-[140px]"></textarea>
        </div>
      </div>

      <div class="modal-action">
        <button class="btn btn-ghost" onclick="document.getElementById('editDlg').close()">Hu·ª∑</button>
        <button class="btn btn-primary" onclick="saveEditPremise()">L∆∞u thay ƒë·ªïi</button>
      </div>
    </div>
  </dialog>

  <dialog id="addDlg" class="modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button></form>
      <h3 class="font-bold text-lg text-primary mb-4">ƒêƒÉng m·∫∑t b·∫±ng m·ªõi</h3>
      
      <div class="grid md:grid-cols-2 gap-4">
          <div>
             <div class="form-control mb-2">
                 <span class="label-text text-xs font-bold">ƒê·ªãa ch·ªâ (S·ªë nh√† + ƒê∆∞·ªùng) *</span>
                 <input id="add-address" type="text" class="input input-sm input-bordered" placeholder="VD: 123 Nguy·ªÖn Tr√£i"/>
             </div>
             <div class="grid grid-cols-2 gap-2 mb-2">
                 <div class="form-control">
                     <span class="label-text text-xs">Qu·∫≠n *</span>
                     <select id="add-district" class="select select-sm select-bordered">
                        <option value="">-- Ch·ªçn --</option>
                     </select>
                 </div>
                 <div class="form-control">
                     <span class="label-text text-xs">Ph∆∞·ªùng *</span>
                     <select id="add-ward" class="select select-sm select-bordered" disabled>
                        <option value="">-- Ch·ªçn Qu·∫≠n tr∆∞·ªõc --</option>
                     </select>
                 </div>
             </div>
             <div class="form-control mb-2">
                 <span class="label-text text-xs">T√™n ƒë∆∞·ªùng (ƒë·ªÉ l·ªçc)</span>
                 <input id="add-street" type="text" class="input input-sm input-bordered"/>
             </div>
            <div class="form-control mb-2">
                <span class="label-text text-xs font-bold">T·ªça ƒë·ªô (Lat / Lng)</span>
                <div class="join w-full">
                    <input id="add-lat" type="text" class="input input-sm input-bordered join-item w-1/3" placeholder="Vƒ© ƒë·ªô (Lat)" />
                    <input id="add-lng" type="text" class="input input-sm input-bordered join-item w-1/3" placeholder="Kinh ƒë·ªô (Lng)" />
                    <button type="button" class="btn btn-sm btn-accent join-item w-1/3 text-white" onclick="autoFetchCoords()">
                        üìç L·∫•y t·ªça ƒë·ªô
                    </button>
                </div>
                <label class="label cursor-pointer justify-start gap-2 mt-1">
                    <span class="label-text-alt text-gray-500">
                        *M·∫πo: Click chu·ªôt ph·∫£i tr√™n Google Maps ch·ªçn d√≤ng ƒë·∫ßu ti√™n ƒë·ªÉ copy s·ªë.
                    </span>
                </label>
            </div>
             <div class="form-control mt-3">
                 <span class="label-text text-xs font-bold text-primary">Gi√° thu√™ (VNƒê) *</span>
                 <input id="add-price" type="text" class="input input-sm input-bordered font-bold" onkeyup="formatCurrencyInput(this)" placeholder="0"/>
             </div>
             
             <div class="grid grid-cols-2 gap-2 mt-3">
                 <div class="form-control">
                     <span class="label-text text-xs font-bold">Lo·∫°i h√¨nh *</span>
                     <select id="add-road-type" class="select select-sm select-bordered">
                        <option value="H·∫ªm">H·∫ªm</option>
                        <option value="H·∫ªm xe h∆°i">H·∫ªm xe h∆°i</option>
                        <option value="M·∫∑t ti·ªÅn">M·∫∑t ti·ªÅn</option>
                     </select>
                 </div>
                 <div class="form-control">
                     <span class="label-text text-xs font-bold text-success">Hoa h·ªìng</span>
                     <input id="add-commission" type="text" class="input input-sm input-bordered" placeholder="VD: 1 th√°ng"/>
                 </div>
             </div>
          </div>

          <div>
             <div class="grid grid-cols-3 gap-2 mb-2">
                 <div><span class="text-xs">DT (m¬≤)</span><input id="add-area" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">Ngang</span><input id="add-width" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">D√†i</span><input id="add-length" type="number" class="input input-sm input-bordered w-full"/></div>
             </div>
             <div class="grid grid-cols-3 gap-2 mb-2">
                 <div><span class="text-xs">T·∫ßng</span><input id="add-floors" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">PN</span><input id="add-bedrooms" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">WC</span><input id="add-wc" type="number" class="input input-sm input-bordered w-full"/></div>
             </div>
             <div class="form-control mb-2">
                 <span class="text-xs">K·∫øt c·∫•u</span>
                 <input id="add-ket-cau" type="text" class="input input-sm input-bordered" placeholder="VD: Tr·ªát 3 l·∫ßu..."/>
             </div>
             <div class="form-control mb-2">
                 <span class="text-xs font-bold text-error">SƒêT Ch·ªß (Admin xem)</span>
                 <input id="add-contact-phone" type="text" class="input input-sm input-bordered input-error" placeholder="090..."/>
             </div>
          </div>

          <div class="md:col-span-2 border-t pt-3 mt-2">
              <div class="flex justify-between items-center mb-2">
                  <span class="label-text font-bold">H√¨nh ·∫£nh th·ª±c t·∫ø</span>
                  <label for="inp-upload-files" class="btn btn-sm btn-primary text-white">
                      üì∑ T·∫£i ·∫£nh l√™n
                  </label>
                  <input type="file" multiple accept="image/*" onchange="handleSelectFiles(this)" />

              </div>
              
              <div id="preview-container" class="flex flex-wrap gap-3 min-h-[100px] bg-base-200 p-2 rounded-lg border border-dashed border-gray-400">
                  <p class="text-xs text-gray-500 w-full text-center py-8 pointer-events-none">
                      Ch∆∞a c√≥ ·∫£nh n√†o. <br/> ·∫¢nh ƒë·∫ßu ti√™n s·∫Ω l√† <b>·∫¢nh B√¨a</b>. Click v√†o ·∫£nh ƒë·ªÉ ƒë·∫∑t l√†m b√¨a.
                  </p>
              </div>

              <div class="form-control mt-2">
                  <span class="text-xs">M√¥ t·∫£ chi ti·∫øt</span>
                  <textarea id="add-detail" class="textarea textarea-bordered w-full h-20 text-sm"></textarea>
              </div>
          </div>
      </div>

      <div class="modal-action">
        <button class="btn" onclick="document.getElementById('addDlg').close()">Hu·ª∑</button>
        <button id="btn-save-new" class="btn btn-primary" onclick="saveNewPremiseWithUpload()">
            L∆∞u tin
        </button>
      </div>
    </div>
  </dialog>

  <dialog id="demoNoticeDlg" class="modal">
    <div class="modal-box max-w-md">
      <h3 class="font-bold text-lg mb-2 text-error">L∆∞u √Ω: B·∫£n DEMO</h3>
      <p class="text-sm leading-relaxed">
        ƒê√¢y l√† b·∫£n <b>DEMO</b> n√™n c√≤n nhi·ªÅu l·ªói, ch·ª©c nƒÉng ch∆∞a ho√†n thi·ªán.<br/><br/>

        Nh√¢n s·ª± xin s·ªë ch·ªß qua admin. H√†ng n√†o h·∫øt vui l√≤ng b√°o v·ªõi admin 
        ho·∫∑c b·∫•m n√∫t <b>‚ÄúB√°o h·∫øt‚Äù</b> tr√™n web ƒë·ªÉ admin ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i.<br/><br/>

        N·∫øu anh/ch·ªã c√≥ th·∫Øc m·∫Øc, ph√°t hi·ªán l·ªói ho·∫∑c c√≥ ƒë·ªÅ xu·∫•t c·∫£i ti·∫øn trang web,
        xin vui l√≤ng li√™n h·ªá Team <b>"VƒÉn H√≥a"</b> ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.<br/><br/>

        <b>Xin c·∫£m ∆°n!</b>
      </p>

      <div class="flex justify-center gap-4 mt-4">
        <button id="btn-demo-disagree" class="btn btn-outline w-40">toi khong dong tinh</button>
        <button id="btn-demo-agree" class="btn btn-outline w-40">toi dong tinh</button>
      </div>

    </div>
  </dialog>

  <div id="toast" class="toast toast-end z-50 hidden">
    <div class="alert alert-info text-sm" id="toast-text"></div>
  </div>

  <script>
    // ===== 1. CONFIG =====
    const SUPABASE_URL = "https://xclncowkoedwqzcemhei.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbG5jb3drb2Vkd3F6Y2VtaGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNzcwOTUsImV4cCI6MjA3Nzg1MzA5NX0.jfNM46UgXIq9LrwSXcERJJULeKB7bl_c9R9LaVhRy1A";
    const STORAGE_BUCKET = "premise-images";
    const PAGE_SIZE = 24;

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- D·ªÆ LI·ªÜU QU·∫¨N/PH∆Ø·ªúNG CHO FORM TH√äM M·ªöI (C·∫ßn d·ªØ li·ªáu ƒë·ªÉ ch·ªçn) ---
    const HCM_DATA = {
        "Qu·∫≠n 1": ["B·∫øn Ngh√©", "B·∫øn Th√†nh", "C√¥ Giang", "C·∫ßu Kho", "C·∫ßu √îng L√£nh", "ƒêa Kao", "Nguy·ªÖn C∆∞ Trinh", "Nguy·ªÖn Th√°i B√¨nh", "Ph·∫°m Ng≈© L√£o", "T√¢n ƒê·ªãnh"],
        "Qu·∫≠n 2": [
          "Th·∫£o ƒêi·ªÅn",
          "An Ph√∫",
          "B√¨nh An",
          "B√¨nh Tr∆∞ng ƒê√¥ng",
          "B√¨nh Tr∆∞ng T√¢y",
          "An Kh√°nh",
          "C√°t L√°i",
          "Th·∫°nh M·ªπ L·ª£i",
          "Th·ªß Thi√™m"
        ],

        "Qu·∫≠n 3": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "V√µ Th·ªã S√°u"],
        "Qu·∫≠n 4": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16", "Ph∆∞·ªùng 18"],
        "Qu·∫≠n 5": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14"],
        "Qu·∫≠n 6": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14"],
        "Qu·∫≠n 7": ["B√¨nh Thu·∫≠n", "Ph√∫ M·ªπ", "Ph√∫ Thu·∫≠n", "T√¢n H∆∞ng", "T√¢n Ki·ªÉng", "T√¢n Phong", "T√¢n Ph√∫", "T√¢n Quy", "T√¢n Thu·∫≠n ƒê√¥ng", "T√¢n Thu·∫≠n T√¢y"],
        "Qu·∫≠n 8": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16"],
        "Qu·∫≠n 9": [
            "Hi·ªáp Ph√∫",
            "Linh Trung",
            "Linh Chi·ªÉu",
            "Linh T√¢y",
            "Linh ƒê√¥ng",
            "Linh Xu√¢n",
            "TƒÉng Nh∆°n Ph√∫ A",
            "TƒÉng Nh∆°n Ph√∫ B",
            "Ph∆∞·ªõc Long A",
            "Ph∆∞·ªõc Long B",
            "T√¢n Ph√∫",
            "Ph∆∞·ªõc B√¨nh",
            "Long Th·∫°nh M·ªπ",
            "Tr∆∞·ªùng Th·∫°nh",
            "Long Ph∆∞·ªõc",
            "Long B√¨nh",
            "Ph√∫ H·ªØu"
        ],
        "Qu·∫≠n 10": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15"],
        "Qu·∫≠n 11": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16"],
        "Qu·∫≠n 12": ["An Ph√∫ ƒê√¥ng", "ƒê√¥ng H∆∞ng Thu·∫≠n", "Hi·ªáp Th√†nh", "T√¢n Ch√°nh Hi·ªáp", "T√¢n H∆∞ng Thu·∫≠n", "T√¢n Th·ªõi Hi·ªáp", "T√¢n Th·ªõi Nh·∫•t", "Th·∫°nh L·ªôc", "Th·∫°nh Xu√¢n", "Th·ªõi An", "Trung M·ªπ T√¢y"],
        "B√¨nh T√¢n": ["An L·∫°c", "An L·∫°c A", "B√¨nh H∆∞ng H√≤a", "B√¨nh H∆∞ng H√≤a A", "B√¨nh H∆∞ng H√≤a B", "B√¨nh Tr·ªã ƒê√¥ng", "B√¨nh Tr·ªã ƒê√¥ng A", "B√¨nh Tr·ªã ƒê√¥ng B", "T√¢n T·∫°o", "T√¢n T·∫°o A"],
        "B√¨nh Th·∫°nh": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 17", "Ph∆∞·ªùng 19", "Ph∆∞·ªùng 21", "Ph∆∞·ªùng 22", "Ph∆∞·ªùng 24", "Ph∆∞·ªùng 25", "Ph∆∞·ªùng 26", "Ph∆∞·ªùng 27", "Ph∆∞·ªùng 28"],
        "G√≤ V·∫•p": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16", "Ph∆∞·ªùng 17"],
        "Ph√∫ Nhu·∫≠n": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 17"],
        "T√¢n B√¨nh": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15"],
        "T√¢n Ph√∫": ["Hi·ªáp T√¢n", "H√≤a Th·∫°nh", "Ph√∫ Th·∫°nh", "Ph√∫ Th·ªç H√≤a", "Ph√∫ Trung", "S∆°n K·ª≥", "T√¢n Qu√Ω", "T√¢n S∆°n Nh√¨", "T√¢n Th√†nh", "T√¢n Th·ªõi H√≤a", "T√¢y Th·∫°nh"],
        "Th·ªß ƒê·ª©c": ["An Kh√°nh", "An L·ª£i ƒê√¥ng", "An Ph√∫", "B√¨nh Chi·ªÉu", "B√¨nh Th·ªç", "B√¨nh Tr∆∞ng ƒê√¥ng", "B√¨nh Tr∆∞ng T√¢y", "C√°t L√°i", "Hi·ªáp B√¨nh Ch√°nh", "Hi·ªáp B√¨nh Ph∆∞·ªõc", "Linh Chi·ªÉu", "Linh ƒê√¥ng", "Linh T√¢y", "Linh Trung", "Linh Xu√¢n", "Long B√¨nh", "Long Ph∆∞·ªõc", "Long Th·∫°nh M·ªπ", "Long Tr∆∞·ªùng", "Ph√∫ H·ªØu", "Ph∆∞·ªõc B√¨nh", "Ph∆∞·ªõc Long A", "Ph∆∞·ªõc Long B", "Tam B√¨nh", "Tam Ph√∫", "T√¢n Ph√∫", "TƒÉng Nh∆°n Ph√∫ A", "TƒÉng Nh∆°n Ph√∫ B", "Th·∫£o ƒêi·ªÅn", "Th·∫°nh M·ªπ L·ª£i", "Th·ªß Thi√™m", "Tr∆∞·ªùng Th·∫°nh", "Tr∆∞·ªùng Th·ªç"]
    };

    let CURRENT_USER = null;
    let CURRENT_ROLE = "staff";
    let PAGE = 0;
    let TOTAL_COUNT = 0;
    let LAST_ROWS = [];
    let EDITING_ID = null;


// ============================================================
    // C·∫§U H√åNH B·∫¢N ƒê·ªí LEAFLET (OPENSTREETMAP - MI·ªÑN PH√ç)
    // ============================================================
    let MAP_INSTANCE = null;
    let MAP_MARKERS = [];
    let MARKER_CLUSTER_GROUP = null;
    // 1. H√†m kh·ªüi t·∫°o b·∫£n ƒë·ªì
    function initStaffMap() {
      // N·∫øu map ƒë√£ t·∫°o r·ªìi th√¨ kh√¥ng t·∫°o l·∫°i
      if (MAP_INSTANCE) return;

      const el = document.getElementById("premises-map");
      if (!el) return;

      // T·∫°o map, set trung t√¢m l√† TP.HCM (10.7769, 106.7009), zoom 13
      MAP_INSTANCE = L.map('premises-map').setView([10.7769, 106.7009], 13);

      // QUAN TR·ªåNG: Th√™m l·ªõp n·ªÅn OpenStreetMap (c√°i n√†y Google Maps kh√¥ng c·∫ßn nh∆∞ng Leaflet b·∫Øt bu·ªôc)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(MAP_INSTANCE);
    }

    // 2. H√†m x√≥a c√°c marker c≈© khi l·ªçc l·∫°i
    function clearMapMarkers() {
      if (MAP_MARKERS.length > 0) {
        MAP_MARKERS.forEach(marker => marker.remove()); // L·ªánh x√≥a c·ªßa Leaflet
        MAP_MARKERS = [];
      }
    }

    // 3. H√†m v·∫Ω marker l√™n b·∫£n ƒë·ªì
// 3. H√†m v·∫Ω marker (S·ª¨ D·ª§NG CLUSTER ƒê·ªÇ CH·ªêNG CH·ªíNG CH√âO)
    function renderMapMarkers(rows) {
      const mapView = document.getElementById("map-view");
      if (mapView && mapView.classList.contains("hidden")) return;

      initStaffMap();

      // Fix l·ªói map x√°m khi resize
      setTimeout(() => {
         if(MAP_INSTANCE) MAP_INSTANCE.invalidateSize();
      }, 100);

      // --- X√ìA LAYER C≈® ---
      // N·∫øu ƒë√£ c√≥ nh√≥m cluster c≈© th√¨ x√≥a kh·ªèi b·∫£n ƒë·ªì v√† clear d·ªØ li·ªáu
      if (MARKER_CLUSTER_GROUP) {
          MARKER_CLUSTER_GROUP.clearLayers();
          MAP_INSTANCE.removeLayer(MARKER_CLUSTER_GROUP);
      }
      
      // Reset m·∫£ng markers qu·∫£n l√Ω th·ªß c√¥ng (n·∫øu c·∫ßn)
      MAP_MARKERS = [];

      if (!rows || !rows.length || !MAP_INSTANCE) return;

      // --- KH·ªûI T·∫†O CLUSTER GROUP M·ªöI ---
      MARKER_CLUSTER_GROUP = L.markerClusterGroup({
          maxClusterRadius: 40, // B√°n k√≠nh gom nh√≥m (px). S·ªë nh·ªè th√¨ gom √≠t, s·ªë l·ªõn gom nhi·ªÅu.
          spiderfyOnMaxZoom: true, // Quan tr·ªçng: N·∫øu tr√πng v·ªã tr√≠, click v√†o s·∫Ω xo√® ra
          showCoverageOnHover: false, // T·∫Øt hi·ªÉn th·ªã v√πng bao ph·ªß khi hover (cho ƒë·∫πp)
          zoomToBoundsOnClick: true, // Click v√†o nh√≥m s·∫Ω zoom v√†o
          
          // T√πy ch·ªânh icon c·ªßa nh√≥m (Optional - n·∫øu mu·ªën ƒë·∫πp h∆°n m·∫∑c ƒë·ªãnh)
          /*
          iconCreateFunction: function(cluster) {
              return L.divIcon({ 
                  html: '<div style="background:#3b82f6; color:white; border-radius:50%; width:30px; height:30px; display:flex; justify-content:center; align-items:center; font-weight:bold; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3)">' + cluster.getChildCount() + '</div>', 
                  className: 'my-cluster-icon', 
                  iconSize: L.point(30, 30) 
              });
          }
          */
      });

      rows.forEach((row) => {
        if (!row.lat || !row.lng) return;
        const lat = Number(row.lat);
        const lng = Number(row.lng);

        // X·ª≠ l√Ω hi·ªÉn th·ªã gi√°
        let displayPrice = "TL";
        if (row.price) {
           if (row.price >= 1000000000) {
             displayPrice = (row.price / 1000000000).toFixed(1) + " T·ª∑";
           } else if (row.price >= 1000000) {
             displayPrice = (row.price / 1000000).toFixed(1) + " Tr";
           } else {
             displayPrice = new Intl.NumberFormat('vi-VN').format(row.price);
           }
           displayPrice = displayPrice.replace(".0 ", " ");
        }

        const title = (typeof buildTitle === 'function' ? buildTitle(row) : row.address) || "M·∫∑t b·∫±ng";
        
        // T·∫°o icon gi√° ti·ªÅn
        const priceIcon = L.divIcon({
          className: '', 
          html: `<div class="price-marker-label">${displayPrice}</div>`,
          iconSize: [null, null],
          iconAnchor: [20, 10]
        });

        // T·∫°o marker nh∆∞ng KH√îNG addTo(MAP_INSTANCE) ngay l·∫≠p t·ª©c
        const marker = L.marker([lat, lng], { icon: priceIcon });

        // T·∫°o Popup
        const infoContent = `
          <div style="min-width: 200px; font-family: system-ui, sans-serif;">
            <div style="font-weight: bold; color: #000; margin-bottom: 4px; font-size: 13px;">
                ${title}
            </div>
            <div style="color: #d32f2f; font-weight: bold; margin-bottom: 6px;">
                ${money(row.price)}
            </div>
            <div style="font-size: 12px; color: #555; margin-bottom: 8px;">
               ${row.address || row.street || "ƒêang c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ..."}
            </div>
            <button 
              onclick="openDetail('${row.id}')"
              class="btn btn-xs btn-primary w-full text-white" 
              style="width: 100%; padding: 6px; background-color: #4f46e5; color: white; border-radius: 4px; border: none; cursor: pointer;">
              Xem chi ti·∫øt
            </button>
          </div>
        `;

        marker.bindPopup(infoContent);
        
        // Hi·ªáu ·ª©ng hover marker
        marker.on('mouseover', function (e) { this.setZIndexOffset(1000); });
        marker.on('mouseout', function (e) { this.setZIndexOffset(0); });

        // QUAN TR·ªåNG: Th√™m marker v√†o Cluster Group
        MARKER_CLUSTER_GROUP.addLayer(marker);
        
        // (T√πy ch·ªçn) V·∫´n ƒë·∫©y v√†o m·∫£ng qu·∫£n l√Ω n·∫øu c·∫ßn x·ª≠ l√Ω logic kh√°c
        MAP_MARKERS.push(marker);
      });

      // Cu·ªëi c√πng: Th√™m Cluster Group v√†o b·∫£n ƒë·ªì
      MAP_INSTANCE.addLayer(MARKER_CLUSTER_GROUP);

      // Fit bounds ƒë·ªÉ nh√¨n th·∫•y t·∫•t c·∫£ c√°c ƒëi·ªÉm
      if (MAP_MARKERS.length > 0) {
        MAP_INSTANCE.fitBounds(MARKER_CLUSTER_GROUP.getBounds(), { padding: [50, 50] });
      }
    }
    // BI·∫æN M·ªöI CHO ADMIN DUY·ªÜT B√ÄI
    let SHOW_PENDING = false;
    // üëâ ch·∫ø ƒë·ªô xem danh s√°ch tin nh√¢n s·ª± ƒë√£ b√°o h·∫øt (admin)
    let SHOW_REPORTED = false;
    // ƒê·∫øm s·ªë m·∫∑t b·∫±ng nh√¢n s·ª± ƒë√£ b√°o h·∫øt nh∆∞ng admin ch∆∞a x√°c nh·∫≠n
    async function checkRentedReportCount() {
      const { count } = await supabase
        .from("premises")
        .select("*", { count: "exact", head: true })
        .not("rented_reported_at", "is", null)
        .is("rented_confirmed_at", null);

      const cnt = count || 0;
      const span = document.getElementById("count-rented-reports");
      if (span) span.textContent = cnt;
    }

    function toggleReportedMode() {
      SHOW_REPORTED = !SHOW_REPORTED;
      const btn = document.getElementById("btn-toggle-rented-reports");
      if (!btn) return;

      if (SHOW_REPORTED) {
        btn.classList.add("btn-active");
        btn.textContent = "ƒêang xem B√°o h·∫øt (Tho√°t)";
      } else {
        btn.classList.remove("btn-active");
        btn.innerHTML =
          `B√°o h·∫øt <span class="badge badge-sm bg-white text-error ml-1 border-none" id="count-rented-reports">...</span>`;
        checkRentedReportCount();
      }
      applyFilters(true);
    }
    // üëâ ch·∫ø ƒë·ªô xem danh s√°ch tin y√™u c·∫ßu ch·∫°y l·∫°i (admin)
    let SHOW_REACTIVATE = false;

    // ƒê·∫øm s·ªë m·∫∑t b·∫±ng y√™u c·∫ßu ch·∫°y l·∫°i, admin ch∆∞a duy·ªát
    async function checkReactivateCount() {
      try {
        const { count, error } = await supabase
          .from("premises")
          .select("*", { count: "exact", head: true })
          .not("reactivate_reported_at", "is", null)
          .is("reactivate_confirmed_at", null);

        if (error) throw error;
        const cnt = count || 0;
        const span = document.getElementById("count-reactivate");
        if (span) span.textContent = cnt;
      } catch (err) {
        console.error("checkReactivateCount error", err);
      }
    }

    function toggleReactivateMode() {
      SHOW_REACTIVATE = !SHOW_REACTIVATE;
      const btn = document.getElementById("btn-toggle-reactivate");
      if (!btn) return;

      if (SHOW_REACTIVATE) {
        btn.classList.add("btn-active");
        btn.textContent = "ƒêang xem Duy·ªát ch·∫°y l·∫°i (Tho√°t)";
      } else {
        btn.classList.remove("btn-active");
        btn.innerHTML =
          `Duy·ªát ch·∫°y l·∫°i <span class="badge badge-sm bg-white text-info ml-1 border-none" id="count-reactivate">...</span>`;
        checkReactivateCount();
      }

      applyFilters(true);
    }
    // ===== HELPERS =====
    function toast(msg) {
      const toastEl = document.getElementById("toast");
      const textEl = document.getElementById("toast-text");
      textEl.textContent = msg;
      toastEl.classList.remove("hidden");
      setTimeout(() => toastEl.classList.add("hidden"), 2500);
    }

    function money(v) {
      if (v == null || isNaN(v)) return "";
      return new Intl.NumberFormat("vi-VN").format(v) + " ƒë";
    }

    function formatDateVN(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleDateString("vi-VN");
    }

    function pickField(obj, names) {
      for (const n of names) {
        if (obj && obj[n] !== undefined && obj[n] !== null && obj[n] !== "") {
          return obj[n];
        }
      }
      return null;
    }

    function isAdmin() { return CURRENT_ROLE === "admin"; }
    function isStaff() { return CURRENT_ROLE === "staff"; }
    // --- GHIM M·∫∂T B·∫∞NG THEO NH√ÇN S·ª∞ (L∆ØU LOCAL) ---
    let FAVORITES_MODE = false;

    function getFavoriteStorageKey() {
      if (CURRENT_USER && CURRENT_USER.id) {
        return "idland_favorites_" + CURRENT_USER.id;
      }
      // fallback n·∫øu ch∆∞a login (√≠t d√πng)
      return "idland_favorites_guest";
    }

    function getFavoriteIds() {
      try {
        const raw = localStorage.getItem(getFavoriteStorageKey());
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch (e) {
        console.warn("getFavoriteIds error", e);
        return [];
      }
    }

    function saveFavoriteIds(ids) {
      try {
        localStorage.setItem(getFavoriteStorageKey(), JSON.stringify(ids));
      } catch (e) {
        console.warn("saveFavoriteIds error", e);
      }
    }

    function toggleFavorite(e, id) {
      if (e) e.stopPropagation(); // ‚¨Ö ƒë·ªÉ khi b·∫•m sao kh√¥ng b·ªã m·ªü popup

      if (!CURRENT_USER) {
        toast("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ghim s·∫£n ph·∫©m.");
        return;
      }

      let ids = getFavoriteIds();
      const idx = ids.indexOf(id);
      let isFav = false;

      if (idx === -1) {
        ids.push(id);
        isFav = true;
      } else {
        ids.splice(idx, 1);
        isFav = false;
      }

      saveFavoriteIds(ids);

      // C·∫≠p nh·∫≠t icon / m√†u cho t·∫•t c·∫£ n√∫t sao c·ªßa id n√†y
      document.querySelectorAll(`.fav-btn[data-id="${id}"]`).forEach(btn => {
        btn.classList.toggle("btn-error", isFav);
        btn.classList.toggle("text-white", isFav);
        btn.classList.toggle("btn-ghost", !isFav);
        btn.textContent = isFav ? "‚òÖ" : "‚òÜ";
      });

      // N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô ch·ªâ xem ghim th√¨ render l·∫°i
      if (FAVORITES_MODE) {
        const favSet = new Set(ids);
        const filtered = (LAST_ROWS || []).filter(r => favSet.has(r.id));
        renderCards(filtered, true);
        const showEl = document.getElementById("count-show");
        if (showEl) showEl.textContent = filtered.length;
      }
    }


    function toggleFavoriteMode() {
      FAVORITES_MODE = !FAVORITES_MODE;
      const btn = document.getElementById("btn-toggle-favorites");
      if (!btn) return;

      if (FAVORITES_MODE) {
        btn.classList.add("btn-active");
        btn.textContent = "ƒêang xem: M·∫∑t b·∫±ng ƒë√£ ghim (tho√°t)";

        const favSet = new Set(getFavoriteIds());
        const filtered = (LAST_ROWS || []).filter(r => favSet.has(r.id));
        renderCards(filtered, true);

        const showEl = document.getElementById("count-show");
        if (showEl) showEl.textContent = filtered.length;
      } else {
        btn.classList.remove("btn-active");
        btn.textContent = "Xem m·∫∑t b·∫±ng ƒë√£ ghim";

        renderCards(LAST_ROWS || [], true);
        const showEl = document.getElementById("count-show");
        if (showEl) {
          showEl.textContent = Math.min((PAGE + 1) * PAGE_SIZE, TOTAL_COUNT);
        }
      }
    }


    function maskAddress(row) {
      const full = row.address || "";
      // N·∫æU L√Ä ADMIN TH√å HI·ªÜN H·∫æT
      if (isAdmin()) return full || row.street; 

      if (!isStaff()) return full || [row.street, row.ward, row.district].filter(Boolean).join(", ");

      if (full) {
        const parts = full.split(" ");
        if (parts.length > 1) {
          parts.shift();
          return parts.join(" ");
        }
        return full;
      }
      return [row.street, row.ward, row.district].filter(Boolean).join(", ");
    }

    function buildImageUrl(path) {
      if (!path) return null;
      if (path.startsWith('http')) return path; // H·ªó tr·ª£ link ƒë·∫ßy ƒë·ªß
      const { data } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(path);
      return data?.publicUrl || null;
    }

    function formatCurrencyInput(el) {
        let val = el.value.replace(/\D/g, '');
        if(val) el.value = new Intl.NumberFormat('vi-VN').format(val);
    }

    // ===== AUTH =====
    async function initAuth() {
      const { data } = await supabase.auth.getUser();
      if (!data.user) {
        document.getElementById("auth-section").classList.remove("hidden");
        document.getElementById("app-root").classList.add("hidden");
        return;
      }

      // N·∫øu l√† Admin -> hi·ªán n√∫t duy·ªát b√†i + n√∫t B√°o h·∫øt
      if (isAdmin()) {
        document.getElementById("admin-pending-controls").classList.remove("hidden");
        checkPendingCount();
        checkRentedReportCount();
        checkReactivateCount();
      }

      CURRENT_USER = data.user;

      // --- L·∫§Y ROLE T·ª™ B·∫¢NG PROFILES ---
      let role = "staff";
      let userEmail = CURRENT_USER.email;
      const { data: profile } = await supabase
        .from("profiles")
        .select("role, email")
        .eq("id", CURRENT_USER.id)
        .maybeSingle();
      
      if (profile) {
          if (profile.role) role = profile.role;
          if (profile.email) userEmail = profile.email;
      }
      CURRENT_ROLE = role;

      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("app-root").classList.remove("hidden");
      
      // Hi·ªÉn th·ªã t√™n/role
      document.getElementById("user-email-display").textContent = userEmail;
      document.getElementById("role-badge").textContent = (role === "admin" ? "Admin" : "Nh√¢n s·ª±");
      if (isAdmin()) document.getElementById("role-badge").className = "badge badge-error text-white";

      // N√∫t ch·ª©c nƒÉng
      // N·∫øu l√† Admin -> hi·ªán n√∫t duy·ªát b√†i
      if (isAdmin()) {
        document.getElementById("admin-pending-controls").classList.remove("hidden");
        checkPendingCount();
      }

      await applyFilters(true);
      await buildDistrictWardOptions();
      initAddFormDropdowns(); // Kh·ªüi t·∫°o dropdown cho form th√™m m·ªõi
    }

    
    function showDemoNotice() {
      const dlg = document.getElementById("demoNoticeDlg");
      if (dlg && typeof dlg.showModal === "function") {
        dlg.showModal();
      }
    }

    async function handleLogin() {
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value.trim();
      if (!email || !password) {
        toast("Vui l√≤ng nh·∫≠p email & m·∫≠t kh·∫©u");
        return;
      }
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        console.error(error);
        toast("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + error.message);
        return;
      }
      toast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng");
      showDemoNotice();
      await initAuth();
    }

    
    async function handleLogout() {
      await supabase.auth.signOut();
      location.reload();
    }

    // ===== FILTERS =====
    function getFilterValues() {
      return {
        keyword: document.getElementById("filter-keyword").value.trim(),
        district: document.getElementById("filter-district").value,
        ward: document.getElementById("filter-ward").value,
        priceMin: Number(document.getElementById("filter-price-min").value) || null,
        priceMax: Number(document.getElementById("filter-price-max").value) || null,
        areaMin: Number(document.getElementById("filter-area-min").value) || null,
        areaMax: Number(document.getElementById("filter-area-max").value) || null,
        pn: document.getElementById("filter-pn").value,
        wc: document.getElementById("filter-wc").value,
        floors: document.getElementById("filter-floors").value,
        frontageType: document.getElementById("filter-frontage-type").value,
        status: document.getElementById("filter-status").value,
      };
    }

    // --- C·∫¨P NH·∫¨T: applyFilters (V·∫º FULL B·∫¢N ƒê·ªí) ---

    async function applyFilters(resetPage = false) {
      if (resetPage) PAGE = 0;
      const f = getFilterValues();

      // 1. T·∫°o Query c∆° s·ªü (D√πng chung cho c·∫£ List v√† Map)
      // H√†m n√†y gi√∫p √°p d·ª•ng c√°c b·ªô l·ªçc gi·ªëng h·ªát nhau cho c·∫£ 2 lu·ªìng d·ªØ li·ªáu
      const buildBaseQuery = () => {
          let q = supabase.from("premises").select("*", { count: "exact" });
          
          // -- Logic Admin/User --
          if (SHOW_PENDING && isAdmin()) q = q.eq("is_approved", false);
          else q = q.eq("is_approved", true);

          // -- B·ªô l·ªçc --
          if (f.keyword) {
            const kw = "%" + f.keyword + "%";
            q = q.or(`address.ilike.${kw},street.ilike.${kw},ward.ilike.${kw},district.ilike.${kw},code.ilike.${kw}`);
          }
          if (f.district) q = q.eq("district", f.district);
          if (f.ward) q = q.eq("ward", f.ward);
          if (f.status) q = q.eq("status", f.status);
          if (f.priceMin != null) q = q.gte("price", f.priceMin * 1000000);
          if (f.priceMax != null) q = q.lte("price", f.priceMax * 1000000);
          if (f.areaMin != null) q = q.gte("area", f.areaMin);
          if (f.areaMax != null) q = q.lte("area", f.areaMax);
          if (f.pn) {
             if (f.pn.includes(">")) q = q.gt("pn", parseInt(f.pn.replace(">","")));
             else q = q.eq("pn", parseInt(f.pn));
          }
          if (f.wc) {
             if (f.wc.includes(">")) q = q.gt("wc", parseInt(f.wc.replace(">","")));
             else q = q.eq("wc", parseInt(f.wc));
          }
          if (f.floors) {
             if (f.floors.includes(">")) q = q.gt("floors", parseInt(f.floors.replace(">","")));
             else q = q.eq("floors", parseInt(f.floors));
          }
          if (f.frontageType === "mt") q = q.eq("frontage", true);

          return q;
      };

      // --- NHI·ªÜM V·ª§ 1: L·∫§Y D·ªÆ LI·ªÜU CHO DANH S√ÅCH (C√ì PH√ÇN TRANG) ---
      const from = PAGE * PAGE_SIZE;
      const to = from + PAGE_SIZE - 1;
      
      let listQuery = buildBaseQuery()
        .order("updated_at", { ascending: false })
        .order("created_at", { ascending: false })
        .range(from, to);

      const { data, error, count } = await listQuery;

      if (error) {
        console.error(error);
        toast("L·ªói t·∫£i d·ªØ li·ªáu: " + error.message);
        return;
      }

      // X·ª≠ l√Ω d·ªØ li·ªáu danh s√°ch (Client filter H·∫ªm/HXH...)
      let rows = data || [];
      if (f.frontageType === "hem" || f.frontageType === "hxh") {
         rows = rows.filter((row) => {
            const isFront = row.frontage === true;
            const txt = ((row.address || "") + " " + (row.detail || "")).toLowerCase();
            if (f.frontageType === "hxh") return !isFront && (txt.includes("hxh") || txt.includes("xe h∆°i"));
            if (f.frontageType === "hem") return !isFront && !txt.includes("hxh") && !txt.includes("xe h∆°i");
            return true;
         });
      }

      // S·∫Øp x·∫øp tr·∫°ng th√°i
      const STATUS_ORDER = { available: 0, deposited: 1, rented: 2 };
      rows.sort((a, b) => (STATUS_ORDER[a.status] ?? 99) - (STATUS_ORDER[b.status] ?? 99));

      LAST_ROWS = rows;
      TOTAL_COUNT = count || 0;

      // Render Danh s√°ch
      if (PAGE === 0) renderCards(LAST_ROWS, true);
      else renderCards(LAST_ROWS, false);

      // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
      document.getElementById("count-total").textContent = TOTAL_COUNT;
      document.getElementById("count-show").textContent = Math.min((PAGE + 1) * PAGE_SIZE, TOTAL_COUNT);
      
      const btnMore = document.getElementById("btn-load-more");
      if ((PAGE + 1) * PAGE_SIZE >= TOTAL_COUNT) {
          btnMore.textContent = "H·∫øt d·ªØ li·ªáu";
          btnMore.classList.add("btn-disabled");
      } else {
          btnMore.textContent = "T·∫£i th√™m";
          btnMore.classList.remove("btn-disabled");
      }

      // --- NHI·ªÜM V·ª§ 2: L·∫§Y D·ªÆ LI·ªÜU CHO B·∫¢N ƒê·ªí (KH√îNG PH√ÇN TRANG) ---
      // Ch·ªâ ch·∫°y khi ·ªü trang 0 ho·∫∑c khi l·ªçc l·∫°i, ƒë·ªÉ tr√°nh g·ªçi API qu√° nhi·ªÅu
      if (PAGE === 0) {
          // Ch·ªâ l·∫•y c√°c tr∆∞·ªùng c·∫ßn thi·∫øt cho b·∫£n ƒë·ªì ƒë·ªÉ nh·∫π (id, lat, lng, price, address)
          // L∆∞u √Ω: .select() ƒë√® l√™n select("*") c·ªßa buildBaseQuery, nh∆∞ng logic filter gi·ªØ nguy√™n
          let mapQuery = buildBaseQuery() 
            .select("id, lat, lng, price, address, street, district, ward") 
            .not("lat", "is", null); // Ch·ªâ l·∫•y c√°i n√†o c√≥ t·ªça ƒë·ªô

          const { data: mapData } = await mapQuery;
          
          // V·∫Ω b·∫£n ƒë·ªì v·ªõi d·ªØ li·ªáu mapData (ch·ª©a to√†n b·ªô k·∫øt qu·∫£) thay v√¨ rows (ch·ªâ 24 c√°i)
          if (mapData && mapData.length > 0) {
              renderMapMarkers(mapData);
          } else {
              clearMapMarkers();
          }
      }
    }

    function renderCards(rows, replace) {
      const grid = document.getElementById("grid");
      if (replace) grid.innerHTML = "";

      if (!rows || rows.length === 0) {
        if (PAGE === 0) {
          grid.innerHTML = `
            <div class="col-span-full text-center text-sm opacity-70 py-10">
              Ch∆∞a c√≥ m·∫∑t b·∫±ng n√†o kh·ªõp b·ªô l·ªçc hi·ªán t·∫°i.
            </div>`;
        }
        return;
      }

      // L·∫•y danh s√°ch ghim
      const favSet = new Set(getFavoriteIds());

      // üëâ ∆ØU TI√äN H√ÄNG ƒê∆Ø·ª¢C GHIM L√äN TR√äN
      const sortedRows = [...rows].sort((a, b) => {
        const af = favSet.has(a.id);
        const bf = favSet.has(b.id);
        if (af === bf) return 0;
        return af ? -1 : 1; // ghim l√™n tr∆∞·ªõc
      });

      const html = sortedRows.map((row) => {
        // X·ª≠ l√Ω ·∫£nh
        let firstPath = null;
        if (Array.isArray(row.images) && row.images.length > 0) firstPath = row.images[0];
        else if (typeof row.images === "string" && row.images.trim()) {
          try {
            if (row.images.startsWith("[")) firstPath = JSON.parse(row.images)[0];
            else firstPath = row.images.split(/[\n;,]+/)[0];
          } catch (e) {}
        }
        const imgUrl = firstPath ? buildImageUrl(firstPath) : null;

        const pnVal = pickField(row, ["pn", "so_pn", "bedrooms", "rooms"]);
        const wcVal = pickField(row, ["wc", "bathrooms"]);
        const floorsVal = pickField(row, ["floors"]);
        const updatedLabel = formatDateVN(row.updated_at || row.created_at);
        const creatorEmail = row.profiles?.email || "";
        const shortName = creatorEmail.split("@")[0];

        // Badge v·ªã tr√≠
        let locationBadge = "";
        const roadType = row.road_type || (row.frontage ? "M·∫∑t ti·ªÅn" : "H·∫ªm");
        if (roadType === "M·∫∑t ti·ªÅn") {
          locationBadge = `<span class="badge badge-xs badge-error text-white border-none">M·∫∑t ti·ªÅn</span>`;
        } else if (roadType === "H·∫ªm xe h∆°i") {
          locationBadge = `<span class="badge badge-xs badge-info text-white border-none">H·∫ªm xe h∆°i</span>`;
        } else {
          locationBadge = `<span class="badge badge-xs badge-ghost border-none opacity-70">Nh√† h·∫ªm</span>`;
        }

        const hhBadge = row.commission
          ? `<span class="badge badge-xs badge-success text-white border-none ml-1">${row.commission}</span>`
          : "";

        const staffReportBadge =
          row.rented_reported_at && row.status !== "rented"
            ? `<span class="badge badge-xs badge-warning border-none ml-1">NS b√°o h·∫øt</span>`
            : "";

        let approveBtn = "";
        if (SHOW_PENDING && isAdmin()) {
          approveBtn = `
            <button onclick="approveOne('${row.id}', event)" 
              class="btn btn-xs btn-success w-full mt-2 text-white">
              ‚úî Duy·ªát ngay
            </button>`;
        }

        // Tr·∫°ng th√°i ghim
        const isFav = favSet.has(row.id);
        const favBtnClass = isFav ? "btn-error text-white" : "btn-ghost";
        const favIcon = isFav ? "‚òÖ" : "‚òÜ";

        return `
          <article 
            class="card bg-base-100 border border-base-200 shadow-sm hover:shadow-md transition-all cursor-pointer premise-card overflow-hidden"
            data-id="${row.id}">
            
            <figure class="h-52 bg-base-200 flex items-center justify-center relative">
              <div id="thumb-box-${row.code}" 
                class="w-full h-full flex items-center justify-center ${imgUrl ? "" : "opacity-60"}">
                ${
                  imgUrl
                    ? `<img src="${imgUrl}" alt="${row.address || ""}" class="w-full h-full object-cover" />`
                    : `<div class="text-xs">(ƒêang qu√©t ·∫£nh...)</div>`
                }
              </div>

              <div class="absolute top-2 right-2 shadow-sm flex items-center gap-1">
                <button 
                  type="button"
                  class="fav-btn btn btn-sm ${favBtnClass} btn-circle border-none text-lg"
                  data-id="${row.id}"
                  title="Ghim / b·ªè ghim"
                  onclick="toggleFavorite(event, '${row.id}')">
                  ${favIcon}
                </button>
                ${locationBadge}
                ${isAdmin() ? hhBadge : ""}
                ${isAdmin() ? staffReportBadge : ""}
              </div>

              <div class="absolute bottom-0 left-0 w-full bg-black/50 text-white text-[10px] p-1 px-2 truncate">
                ƒêƒÉng b·ªüi: <b>${shortName || "·∫®n danh"}</b>
              </div>
            </figure>

            <div class="card-body p-4 gap-2">
              <h3 class="font-semibold text-sm line-clamp-2">${buildTitle(row)}</h3>
              <div class="flex items-center flex-wrap gap-2 text-[11px] opacity-70">
                <span>${[row.ward, row.district].filter(Boolean).join(" ‚Ä¢ ")}</span>
              </div>
              <div class="flex flex-wrap items-center gap-2 text-[11px] mt-1">
                ${row.area ? `<span>${row.area} m¬≤</span>` : ""}
                ${row.width && row.length ? `<span>${row.width}√ó${row.length} m</span>` : ""}
                ${pnVal ? `<span>${pnVal} PN</span>` : ""}
                ${floorsVal ? `<span>${floorsVal} t·∫ßng</span>` : ""}
              </div>
              <div class="flex items-center justify-between mt-1">
                <div class="text-primary font-extrabold text-lg">${money(row.price)}</div>
                <div class="text-[10px] opacity-60">${updatedLabel}</div>
              </div>
              ${approveBtn}
            </div>
          </article>
        `;
      });

      grid.insertAdjacentHTML("beforeend", html.join(""));

      // üëâ G·∫ÆN CLICK ƒê·ªÇ M·ªû POPUP
      grid.querySelectorAll(".premise-card").forEach((el) => {
        el.onclick = () => {
          const id = el.getAttribute("data-id");
          if (id) openDetail(id);
        };
      });

      // Qu√©t ·∫£nh n·∫øu c√≥ h√†m scanGridImages
      if (typeof scanGridImages === "function") {
        scanGridImages(sortedRows).catch(err =>
          console.error("scanGridImages error", err)
        );
      }
    }



    // === H√ÄM M·ªöI: L·∫§Y QU·∫¨N T·ª™ HCM_DATA ===
    function buildDistrictWardOptions() {
      const selectDistrict = document.getElementById("filter-district");
      // B·ªè ch·ªØ "window." ƒëi ƒë·ªÉ truy c·∫≠p tr·ª±c ti·∫øp v√†o bi·∫øn HCM_DATA
      if (!selectDistrict || !HCM_DATA) return;

      // L∆∞u l·∫°i gi√° tr·ªã ƒëang ch·ªçn (n·∫øu c√≥)
      const current = selectDistrict.value;

      // L·∫•y danh s√°ch qu·∫≠n t·ª´ HCM_DATA v√† sort theo ti·∫øng Vi·ªát
      const districts = Object.keys(HCM_DATA).sort((a, b) =>
        a.localeCompare(b, "vi")
      );

      // Reset l·∫°i dropdown
      selectDistrict.innerHTML = '<option value="">T·∫•t c·∫£</option>';

      // ƒê·ªï option qu·∫≠n
      districts.forEach((d) => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        selectDistrict.appendChild(opt);
      });

      // N·∫øu tr∆∞·ªõc ƒë√≥ ƒë√£ ch·ªçn qu·∫≠n v√† qu·∫≠n ƒë√≥ v·∫´n t·ªìn t·∫°i ‚Üí set l·∫°i
      if (current && districts.includes(current)) {
        selectDistrict.value = current;
      }

      // C·∫≠p nh·∫≠t l·∫°i danh s√°ch ph∆∞·ªùng theo qu·∫≠n ƒëang ch·ªçn
      if (typeof updateWardOptions === "function") {
        updateWardOptions();
      }
    }

    // === H√ÄM M·ªöI: L·ªåC PH∆Ø·ªúNG THEO QU·∫¨N T·ª™ HCM_DATA ===
    function updateWardOptions() {
      const district = document.getElementById("filter-district").value;
      const selectWard = document.getElementById("filter-ward");
      selectWard.innerHTML = '<option value="">T·∫•t c·∫£</option>';

      if (!district || !HCM_DATA[district]) return;

      const wards = HCM_DATA[district];
      wards.forEach((w) => {
        const opt = document.createElement("option");
        opt.value = w;
        opt.textContent = w;
        selectWard.appendChild(opt);
      });
    }
    // ===== C√ÅC H√ÄM H·ªñ TR·ª¢ (UTILS) =====

    function buildTitle(item) {
      if (!item) return "";

      const street = item.street ? item.street.toUpperCase() : "";
      const detail = (item.detail || "").toLowerCase();
      const ket = (item.ket_cau || "").toLowerCase();

      // ==== 1. X√ÅC ƒê·ªäNH LO·∫†I H√åNH (MB / NNC) ====
      let type = "NNC"; // m·∫∑c ƒë·ªãnh NNC

      // M·∫∂T B·∫∞NG n·∫øu b√†i c√≥ MB / LDC / LDR trong m√¥ t·∫£
      if (
        detail.includes(" mb") || detail.startsWith("mb ") || detail.includes("mb ") ||
        detail.includes("ldc") ||
        detail.includes("ldr")
      ) {
        type = "MB";
      }

      // N·∫øu kh√¥ng c√≥ MB nh∆∞ng c√≥ k·∫øt c·∫•u nh√† ‚Üí NNC
      if (
        ket.includes("tr·ªát") || ket.includes("tret") ||
        ket.includes("l·∫ßu")  || ket.includes("lau") ||
        ket.includes("l·ª≠ng") || ket.includes("lung") ||
        ket.includes("tum")  ||
        ket.includes("pn")   ||
        ket.includes("wc")
      ) {
        type = "NNC";
      }

      // ==== 2. H∆Ø·ªöNG (MT / HXH / HEM) ====
      let huong = "HEM";
      const addr = (item.address || "").toLowerCase();

      if (item.frontage) huong = "MT";
      else if (addr.includes("/")) huong = "HXH";
      else if (detail.includes("hxh")) huong = "HXH";

      // ==== 3. PN / WC ====
      const pn = item.pn ? `${item.pn}PN` : "";
      const wc = item.wc ? `${item.wc}WC` : "";

      // ==== 4. DI·ªÜN T√çCH ====
      let dientich = "";
      if (item.width && item.length) {
        dientich = `${item.width}X${item.length}`;
      } else if (item.area) {
        dientich = `${item.area}M2`;
      }

      // ==== 5. K·∫æT C·∫§U ====
      const ketcau = item.ket_cau ? item.ket_cau.toUpperCase() : "";

      // ==== 6. QU·∫¨N ====
      let quan = "";
      if (item.district) {
        const q = item.district.replace("Q.", "").replace("Qu·∫≠n", "").trim();
        quan = `QU·∫¨N ${q}`;
      }

      // ==== GH√âP TI√äU ƒê·ªÄ ====
      const parts = [
        type,
        huong,
        street,
        pn,
        wc,
        dientich,
        ketcau,
        quan
      ].filter(p => p);

      return parts.join(" - ").toUpperCase();
    }
    // --- C·∫¨P NH·∫¨T: H√ÄM T√åM T·ªåA ƒê·ªò TH√îNG MINH (FALLBACK) ---
    async function autoFetchCoords() {
        const addressInput = document.getElementById("add-address").value; // VD: 490/8 L√™ VƒÉn S·ªπ
        const district = document.getElementById("add-district").value;    // VD: Qu·∫≠n 3
        const streetInput = document.getElementById("add-street").value;   // VD: L√™ VƒÉn S·ªπ (n·∫øu c√≥ nh·∫≠p)
        const city = "H·ªì Ch√≠ Minh";

        if (!district) {
            alert("Vui l√≤ng ch·ªçn Qu·∫≠n tr∆∞·ªõc!");
            return;
        }

        const btn = document.querySelector("button[onclick='autoFetchCoords()']");
        const originalText = btn.innerText;
        btn.innerText = "ƒêang d√≤...";
        btn.disabled = true;

        // H√†m con ƒë·ªÉ g·ªçi API
        const callApi = async (query) => {
            try {
                console.log("ƒêang t√¨m: " + query);
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                const res = await fetch(url);
                const data = await res.json();
                return (data && data.length > 0) ? data[0] : null;
            } catch (e) {
                return null;
            }
        };

        try {
            let result = null;

            // --- CHI·∫æN THU·∫¨T 1: T√¨m ch√≠nh x√°c c·∫£ s·ªë nh√† ---
            // ∆Øu ti√™n l·∫•y t√™n ƒë∆∞·ªùng t·ª´ √¥ "T√™n ƒë∆∞·ªùng" n·∫øu nh√¢n vi√™n c√≥ nh·∫≠p, v√¨ n√≥ chu·∫©n h∆°n
            let streetName = streetInput; 
            if (!streetName && addressInput) {
                // C·ªë g·∫Øng ƒëo√°n t√™n ƒë∆∞·ªùng t·ª´ ƒë·ªãa ch·ªâ (B·ªè s·ªë nh√† ·ªü ƒë·∫ßu)
                // VD: "490/8 L√™ VƒÉn S·ªπ" -> l·∫•y "L√™ VƒÉn S·ªπ" (c√°ch ƒë∆°n gi·∫£n)
                const parts = addressInput.split(" ");
                if (parts.length > 1 && /^\d/.test(parts[0])) { 
                    parts.shift(); // B·ªè ph·∫ßn s·ªë (VD: 490/8)
                    streetName = parts.join(" ");
                } else {
                    streetName = addressInput;
                }
            }

            // Th·ª≠ t√¨m full ƒë·ªãa ch·ªâ tr∆∞·ªõc: "490/8 L√™ VƒÉn S·ªπ, Qu·∫≠n 3, H·ªì Ch√≠ Minh"
            const fullQuery = `${addressInput}, ${district}, ${city}`;
            result = await callApi(fullQuery);

            // --- CHI·∫æN THU·∫¨T 2: N·∫øu th·∫•t b·∫°i, t√¨m theo T√äN ƒê∆Ø·ªúNG + QU·∫¨N ---
            if (!result && streetName) {
                toast("Kh√¥ng t√¨m th·∫•y s·ªë nh√†, ƒëang t√¨m theo t√™n ƒë∆∞·ªùng...");
                // Query: "ƒê∆∞·ªùng L√™ VƒÉn S·ªπ, Qu·∫≠n 3, H·ªì Ch√≠ Minh"
                const streetQuery = `${streetName}, ${district}, ${city}`;
                result = await callApi(streetQuery);
            }

            // --- K·∫æT QU·∫¢ ---
            if (result) {
                const lat = result.lat;
                const lng = result.lon; // API tr·∫£ v·ªÅ 'lon'

                // 1. ƒêi·ªÅn v√†o √¥ input
                document.getElementById("add-lat").value = lat;
                document.getElementById("add-lng").value = lng;

                // 2. C·∫≠p nh·∫≠t b·∫£n ƒë·ªì ch·ªçn (Picker Map) n·∫øu ƒë√£ c√†i ƒë·∫∑t ·ªü b∆∞·ªõc tr∆∞·ªõc
                if (typeof PICKER_MAP !== 'undefined' && PICKER_MAP && PICKER_MARKER) {
                    const newLatLng = new L.LatLng(lat, lng);
                    PICKER_MARKER.setLatLng(newLatLng);
                    PICKER_MAP.setView(newLatLng, 16);
                }

                toast(`ƒê√£ ghim t·∫°i: ${result.display_name.split(',')[0]}`);
            } else {
                alert("Kh√¥ng t√¨m th·∫•y c·∫£ ƒë∆∞·ªùng l·∫´n s·ªë nh√†. Vui l√≤ng nh·∫≠p th·ªß c√¥ng ho·∫∑c ki·ªÉm tra l·∫°i t√™n ƒë∆∞·ªùng.");
            }

        } catch (e) {
            console.error(e);
            toast("L·ªói k·∫øt n·ªëi b·∫£n ƒë·ªì.");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
    // ===== CHI TI·∫æT & S·ª¨A =====
    // ===== CHI TI·∫æT & S·ª¨A (ƒê√É N√ÇNG C·∫§P T·ª∞ QU√âT ·∫¢NH STORAGE) =====
    async function openDetail(id) {
      const dlg = document.getElementById("detailDlg");
      const wrap = document.getElementById("detail-content");
      wrap.innerHTML = `<div class="py-10 text-center text-sm opacity-70"><span class="loading loading-spinner"></span> ƒêang t·∫£i d·ªØ li·ªáu v√† qu√©t h√¨nh ·∫£nh...</div>`;
      dlg.showModal();

      // 1. L·∫•y th√¥ng tin cƒÉn nh√† t·ª´ Database
      const { data, error } = await supabase
        .from("premises")
        .select("*")
        .eq("id", id)
        .single();

      if (error || !data) {
        console.error(error);
        wrap.innerHTML = `<div class="py-10 text-center text-sm text-error">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu.</div>`;
        return;
      }

      const item = data;

      // 2. X·ª¨ L√ù H√åNH ·∫¢NH:
      // ∆Øu ti√™n 1: L·∫•y t·ª´ c·ªôt 'images' trong Database (n·∫øu c√≥)
      // ∆Øu ti√™n 2: N·∫øu Database tr·ªëng, t·ª± ƒë·ªông qu√©t Storage theo M√É CƒÇN (item.code)
      
      let imgUrls = [];
      let rawImgs = item.images;

      // B∆∞·ªõc 2a: Th·ª≠ l·∫•y t·ª´ Database tr∆∞·ªõc
      if (Array.isArray(rawImgs) && rawImgs.length > 0) {
        imgUrls = rawImgs.map(p => buildImageUrl(p)).filter(Boolean);
      } 
      else if (typeof rawImgs === "string" && rawImgs.trim()) {
         // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p l∆∞u d·∫°ng chu·ªói JSON ho·∫∑c xu·ªëng d√≤ng
         let paths = [];
         try {
            if (rawImgs.startsWith("[")) paths = JSON.parse(rawImgs);
            else paths = rawImgs.split(/[\n;,]+/).map(s => s.trim());
         } catch(e) { paths = []; }
         imgUrls = paths.map(p => buildImageUrl(p)).filter(Boolean);
      }

      // B∆∞·ªõc 2b: N·∫øu v·∫´n ch∆∞a c√≥ ·∫£nh n√†o -> QU√âT STORAGE
      if (imgUrls.length === 0 && item.code) {
          console.log("Database kh√¥ng c√≥ ·∫£nh, ƒëang qu√©t Storage folder:", item.code);
          
          // T√¨m folder c√≥ t√™n tr√πng v·ªõi M√£ cƒÉn
          const { data: files, error: listError } = await supabase.storage
            .from(STORAGE_BUCKET)
            .list(item.code, { // T√™n folder = item.code
                limit: 50,
                offset: 0,
                sortBy: { column: 'name', order: 'asc' },
            });

          if (!listError && files && files.length > 0) {
              // L·ªçc b·ªè file r√°c h·ªá th·ªëng (n·∫øu c√≥)
              const validFiles = files.filter(f => f.name !== '.emptyFolderPlaceholder');
              
              // T·∫°o ƒë∆∞·ªùng d·∫´n public
              imgUrls = validFiles.map(f => {
                  const fullPath = `${item.code}/${f.name}`;
                  const { data } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(fullPath);
                  return data.publicUrl;
              });
              console.log("ƒê√£ t√¨m th·∫•y ·∫£nh trong Storage:", imgUrls);
          }
      }

      // --- C√ÅC PH·∫¶N D∆Ø·ªöI GI·ªÆ NGUY√äN ---
      const pnVal = pickField(item, ["pn", "so_pn", "bedrooms", "rooms"]);
      const wcVal = pickField(item, ["wc", "bathrooms"]);
      const floorsVal = pickField(item, ["floors"]);
      const detailText = item.detail || item.description || "";
      const updatedLabel = formatDateVN(item.updated_at || item.created_at);
      
      const price = typeof item.price === "number" ? new Intl.NumberFormat("vi-VN").format(item.price) + " ƒë/th√°ng" : "";
      const area = typeof item.area === "number" ? item.area + " m¬≤" : "";
            // GH√âP ƒê·ªäA CH·ªà ƒê·∫¶Y ƒê·ª¶: S·ªê NH√Ä / ƒê∆Ø·ªúNG + PH∆Ø·ªúNG + QU·∫¨N + TP
      const addressParts = [];

      if (item.address) {
        // address th∆∞·ªùng l√† "591/8 L√™ Quang ƒê·ªãnh"
        addressParts.push(item.address);
      } else if (item.street) {
        addressParts.push(item.street);
      }

      if (item.ward) addressParts.push(item.ward);
      if (item.district) addressParts.push(item.district);
      if (item.city) addressParts.push(item.city);

      const address = addressParts.join(", ");


      // Embed Map
      const mapsQuery = encodeURIComponent([item.address, item.ward, item.district, item.city].filter(Boolean).join(", "));
      const mapEmbed = `<iframe class="w-full h-64 border-0 rounded-xl" loading="lazy" referrerpolicy="no-referrer-when-downgrade" src="https://maps.google.com/maps?q=${mapsQuery}&t=&z=15&ie=UTF8&iwloc=&output=embed"></iframe>`;

      // N√∫t h√†nh ƒë·ªông
      const isRented = item.status === "rented";
      const isAvailableLike =
        item.status === "available" || item.status === "deposited";

      const actions = `
        <div class="join join-horizontal flex flex-wrap gap-2">
          ${
            item.contact_phone && !isStaff()
              ? `<a class="btn btn-sm join-item" href="tel:${item.contact_phone}">
                   G·ªçi
                 </a>`
              : ""
          }
          ${
            item.contact_phone && !isStaff()
              ? `<a class="btn btn-sm join-item" target="_blank"
                   href="https://zalo.me/${(item.contact_phone || "")
                     .replace(/[^0-9]/g, "")}">
                   Zalo
                 </a>`
              : ""
          }

          <a class="btn btn-sm join-item" target="_blank"
             href="https://www.google.com/maps/search/?api=1&query=${mapsQuery}">
            M·ªü Map
          </a>

          <button class="btn btn-sm join-item"
            onclick="navigator.clipboard.writeText(window.location.href);toast('ƒê√£ copy link')">
            Copy link
          </button>

          ${
            // üî¥ B√ÅO H·∫æT ‚Äì NH√ÇN S·ª∞: ch·ªâ b√°o, ch·ªù admin duy·ªát
            isStaff() &&
            isAvailableLike &&
            !item.rented_reported_at &&
            !item.rented_confirmed_at
              ? `<button class="btn btn-sm btn-error btn-outline join-item"
                         onclick="reportRentedStaff('${id}')">
                   B√°o h·∫øt
                 </button>`
              : ""
          }

          ${
            // üî¥ B√ÅO H·∫æT ‚Äì ADMIN: chuy·ªÉn th·∫≥ng sang "rented", kh√¥ng c·∫ßn duy·ªát
            isAdmin() && isAvailableLike
              ? `<button class="btn btn-sm btn-error join-item"
                         onclick="reportRentedDirect('${id}')">
                   B√°o h·∫øt
                 </button>`
              : ""
          }


          ${
            // üü° B√ÅO CH·∫†Y L·∫†I ‚Äì ch·ªâ hi·ªán khi ƒëang ·ªü tr·∫°ng th√°i ƒë√£ h·∫øt
            isRented && !item.reactivate_reported_at
              ? `<button class="btn btn-sm btn-outline join-item"
                         onclick="requestReactivate('${id}')">
                   B√°o ch·∫°y l·∫°i
                 </button>`
              : ""
          }

          ${
            // ‚úÖ DUY·ªÜT CH·∫†Y L·∫†I ‚Äì ch·ªâ admin th·∫•y khi c√≥ y√™u c·∫ßu ch·∫°y l·∫°i
            isAdmin() && item.reactivate_reported_at && !item.reactivate_confirmed_at
              ? `<button class="btn btn-sm btn-success join-item"
                         onclick="confirmReactivate('${id}')">
                   Duy·ªát ch·∫°y l·∫°i
                 </button>`
              : ""
          }

          ${
            isAdmin()
              ? `<button class="btn btn-outline btn-sm join-item"
                         onclick="openEditPremise('${id}')">
                   S·ª≠a
                 </button>`
              : ""
          }
        </div>
      `;



      // Render HTML
      const html = `
        <div class="relative">
          <button type="button" onclick="document.getElementById('detailDlg').close()" class="absolute top-3 right-3 z-50 w-9 h-9 flex items-center justify-center bg-white rounded-full shadow hover:bg-gray-200 transition">‚úï</button>

          <div class="grid md:grid-cols-2 gap-6">
            <div class="space-y-3">
              <div class="w-full h-[340px] bg-base-200 flex items-center justify-center rounded-xl overflow-hidden bg-black/5">
                ${imgUrls.length 
                  ? `<img id="detail-main-img" src="${imgUrls[0]}" class="w-full h-full object-contain" />` 
                  : `<div class="flex flex-col items-center opacity-40"><span class="text-4xl">üì∑</span><span class="text-xs mt-2">Ch∆∞a c√≥ h√¨nh ·∫£nh trong folder "${item.code || '...'}"</span></div>`
                }
              </div>

              ${imgUrls.length > 1 ? `
                  <div class="grid grid-cols-5 gap-2">
                    ${imgUrls.slice(0, 10).map(url => `
                      <div class="cursor-pointer border border-base-200 rounded-lg overflow-hidden hover:border-primary h-14 bg-base-100" 
                           onclick="document.getElementById('detail-main-img').src='${url}'">
                        <img src="${url}" class="w-full h-full object-cover" />
                      </div>
                    `).join("")}
                  </div>
                ` : ""}
              ${mapEmbed}
            </div>

            <div class="space-y-3 text-sm">
              <div>
                <h3 class="font-semibold text-lg mb-1 leading-snug">${buildTitle(item) || "(Kh√¥ng c√≥ ti√™u ƒë·ªÅ)"}</h3>
                <p class="text-gray-600">${address || ""}</p>
              </div>

              <div class="flex flex-wrap gap-2 text-xs">
                ${price ? `<span class="badge badge-primary badge-outline font-bold">Gi√°: ${price}</span>` : ""}
                ${area ? `<span class="badge badge-outline">DT: ${area}</span>` : ""}
                ${item.status ? `<span class="badge badge-ghost">${item.status}</span>` : ""}
              </div>

              <div class="text-xs text-gray-500 flex justify-between items-end border-b pb-2">
                 <span>M√£: <span class="font-mono font-bold text-black">${item.code || '---'}</span></span>
                 <span>C·∫≠p nh·∫≠t: ${updatedLabel}</span>
              </div>

              <div class="grid grid-cols-2 gap-y-1 gap-x-4 text-sm mt-2">
                <div>Di·ªán t√≠ch: <b>${item.area ?? '-'} m¬≤</b></div>
                <div>T·∫ßng: <b>${floorsVal ?? '-'}</b></div>
                <div>Ngang: <b>${item.width ?? '-'} m</b></div>
                <div>D√†i: <b>${item.length ?? '-'} m</b></div>
                <div>PN: <b>${pnVal ?? '-'}</b></div>
                <div>WC: <b>${wcVal ?? '-'}</b></div>
                <div>K·∫øt c·∫•u: <b>${item.ket_cau || '-'}</b></div>
                <div>Hoa h·ªìng: <b class="text-success">${item.commission_note || '-'}</b></div>
                <div>H∆∞·ªõng: <b>${item.frontage ? 'M·∫∑t ti·ªÅn' : (item.direction || '-')}</b></div>
              </div>

              ${
                item.status === "rented" && item.rented_confirmed_at
                  ? `<div class="mt-2 text-xs text-error">
                       Ng√†y b√°o h·∫øt: <b>${formatDateVN(item.rented_confirmed_at)}</b>
                     </div>`
                  : ""
              }

              ${
                item.reactivate_reported_at && !item.reactivate_confirmed_at
                  ? `<div class="mt-1 text-xs text-warning">
                       ƒê√£ b√°o ch·∫°y l·∫°i ng√†y <b>${formatDateVN(
                         item.reactivate_reported_at
                       )}</b> ‚Äì ch·ªù admin duy·ªát.
                     </div>`
                  : ""
              }


              ${item.contact_phone && !isStaff() ? `

                <div class="mt-3 p-3 bg-base-200 rounded-lg text-sm border border-base-300">
                  Li√™n h·ªá ch·ªß nh√†: <br/>
                  <b class="text-lg">${item.contact_phone}</b> ${item.contact_name ? `(${item.contact_name})` : ""}
                </div>
              ` : ""}

              <div class="mt-4">
                <div class="font-semibold mb-1 opacity-70 uppercase text-xs">Chi ti·∫øt:</div>
                <p class="whitespace-pre-line text-gray-700 leading-relaxed">${detailText || "(Ch∆∞a c√≥ m√¥ t·∫£ chi ti·∫øt)"}</p>
              </div>

              <div class="mt-4 pt-4 border-t">
                ${actions}
              </div>
            </div>
          </div>
        </div>
      `;
      wrap.innerHTML = html;
    }

    async function openEditPremise(id) {
      if (!isAdmin()) {
        toast("Ch·ªâ admin m·ªõi ƒë∆∞·ª£c s·ª≠a m·∫∑t b·∫±ng");
        return;
      }

      EDITING_ID = id;
      const dlg = document.getElementById("editDlg");

      const { data, error } = await supabase
        .from("premises")
        .select("*")
        .eq("id", id)
        .single();

      if (error || !data) {
        console.error(error);
        toast("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu ƒë·ªÉ s·ª≠a");
        return;
      }

      const item = data;
      const setVal = (elId, val) => {
        const el = document.getElementById(elId);
        if (el) el.value = val == null ? "" : String(val);
      };
      setVal("edit-road-type", item.road_type || (item.frontage ? "M·∫∑t ti·ªÅn" : "H·∫ªm"));
      setVal("edit-commission-text", item.commission || "");

      // ƒëi·ªÅn d·ªØ li·ªáu v√†o form edit
      setVal("edit-code", item.code || "");
      setVal("edit-address", item.address || "");
      setVal("edit-city", item.city || "TP.HCM");
      setVal("edit-district", item.district || "");
      setVal("edit-ward", item.ward || "");
      setVal("edit-street", item.street || "");

      setVal("edit-price", item.price ?? "");
      setVal("edit-area", item.area ?? "");
      setVal("edit-width", item.width ?? "");
      setVal("edit-length", item.length ?? "");
      setVal("edit-floors", item.floors ?? "");
      setVal("edit-bedrooms", item.pn ?? item.bedrooms ?? "");
      setVal("edit-wc", item.wc ?? "");
      setVal("edit-ket-cau", item.ket_cau || "");
      setVal("edit-contact-phone", item.contact_phone || "");
      setVal("edit-commission", item.commission_note || "");
      setVal("edit-detail", item.detail || "");
      setVal("edit-lat", item.lat || "");
      setVal("edit-lng", item.lng || "");
      const statusSelect = document.getElementById("edit-status");
      if (statusSelect) {
        statusSelect.value = item.status || "available";
      }

      const frontageCheckbox = document.getElementById("edit-frontage");
      if (frontageCheckbox) {
        frontageCheckbox.checked = !!item.frontage;
      }

      // x·ª≠ l√Ω field images: array / json / string
      let rawImgs = item.images;
      let imgPaths = [];

      if (Array.isArray(rawImgs)) {
        imgPaths = rawImgs;
      } else if (typeof rawImgs === "string" && rawImgs.trim()) {
        const s = rawImgs.trim();
        try {
          if (s.startsWith("[") && s.endsWith("]")) {
            const parsed = JSON.parse(s);
            if (Array.isArray(parsed)) imgPaths = parsed;
          } else {
            imgPaths = s.split(/[\n;,]+/);
          }
        } catch (e) {
          console.warn("parse images error in edit", e);
          imgPaths = s.split(/[\n;,]+/);
        }
      }

      const imagesTextarea = document.getElementById("edit-images");
      if (imagesTextarea) {
        imagesTextarea.value = (imgPaths || [])
          .map((p) => (p || "").trim())
          .filter(Boolean)
          .join("\n");
      }

      dlg.showModal();
    }
    
    async function saveEditPremise() {
      if (!isAdmin() || !EDITING_ID) return;
      const getVal = (id) => document.getElementById(id).value.trim();
      const getNum = (id) => { const v = getVal(id).replace(/[^\d.]/g, ""); return v ? Number(v) : 0; };

      const payload = {
        code: getVal("edit-code"),
        address: getVal("edit-address"),
        city: getVal("edit-city"),
        district: getVal("edit-district"),
        ward: getVal("edit-ward"),
        street: getVal("edit-street"),
        price: getNum("edit-price"),
        area: getNum("edit-area"),
        width: getNum("edit-width"),
        length: getNum("edit-length"),
        floors: getNum("edit-floors"),
        pn: getNum("edit-bedrooms"),
        wc: getNum("edit-wc"),
        ket_cau: getVal("edit-ket-cau"),
        contact_phone: getVal("edit-contact-phone"),
        frontage: document.getElementById("edit-frontage").checked,
        status: getVal("edit-status"),
        commission_note: getVal("edit-commission"),
        images: getVal("edit-images").split("\n").map(s => s.trim()).filter(Boolean),
        detail: getVal("edit-detail"),
        updated_at: new Date().toISOString(),
        road_type: document.getElementById("edit-road-type").value, // M·ªöI
        commission: getVal("edit-commission-text"), // M·ªöI
        lat: getVal("edit-lat") ? Number(getVal("edit-lat")) : null,
        lng: getVal("edit-lng") ? Number(getVal("edit-lng")) : null,
      };
      // N·∫øu admin ch·ªânh tr·∫°ng th√°i kh√°c "rented" -> xo√° ng√†y b√°o h·∫øt & y√™u c·∫ßu ch·∫°y l·∫°i
      if (payload.status && payload.status !== "rented") {
        payload.rented_reported_at = null;
        payload.rented_confirmed_at = null;
        payload.reactivate_reported_at = null;
        payload.reactivate_confirmed_at = null;
      }

      const { error } = await supabase
        .from("premises")
        .update(payload)
        .eq("id", editingId);

      if (error) { toast("L·ªói: " + error.message); return; }
      toast("ƒê√£ l∆∞u thay ƒë·ªïi!");
      document.getElementById("editDlg").close();
      await applyFilters(false);
    }
    // ===== B√ÅO H·∫æT (KH√îNG C·∫¶N DUY·ªÜT) =====
    async function reportRentedDirect(id) {
      if (!isAdmin()) return;  // ch·ªâ admin ƒë∆∞·ª£c d√πng
      if (!confirm("X√°c nh·∫≠n m·∫∑t b·∫±ng n√†y ƒë√£ h·∫øt / ƒë√£ cho thu√™?")) return;
      const nowIso = new Date().toISOString();
      const { error } = await supabase
        .from("premises")
        .update({
          status: "rented",
          rented_reported_at: nowIso,
          rented_confirmed_at: nowIso, // coi nh∆∞ duy·ªát lu√¥n
          reactivate_reported_at: null,
          reactivate_confirmed_at: null,
        })
        .eq("id", id);

      if (error) {
        console.error(error);
        toast("L·ªói b√°o h·∫øt: " + error.message);
        return;
      }

      toast("ƒê√£ b√°o h·∫øt m·∫∑t b·∫±ng n√†y.");
      document.getElementById("detailDlg").close();
      applyFilters(true);
    }

    // ===== B√ÅO CH·∫†Y L·∫†I (NS & ADMIN) =====
    async function requestReactivate(id) {
      if (!confirm("B√°o ch·∫°y l·∫°i m·∫∑t b·∫±ng n√†y?")) return;

      const { error } = await supabase
        .from("premises")
        .update({
          reactivate_reported_at: new Date().toISOString(),
        })
        .eq("id", id);

      if (error) {
        console.error(error);
        toast("L·ªói b√°o ch·∫°y l·∫°i: " + error.message);
        return;
      }

      toast("ƒê√£ b√°o ch·∫°y l·∫°i ‚Äì ch·ªù admin duy·ªát.");
      document.getElementById("detailDlg").close();
      applyFilters(true);
    }

    // ===== ADMIN DUY·ªÜT CH·∫†Y L·∫†I =====
    async function confirmReactivate(id) {
      if (!isAdmin()) return;
      if (!confirm("Duy·ªát cho m·∫∑t b·∫±ng n√†y ch·∫°y l·∫°i?")) return;

      const { error } = await supabase
        .from("premises")
        .update({
          status: "available",
          reactivate_confirmed_at: new Date().toISOString(),
          reactivate_reported_at: null,
          // xo√° d·∫•u v·∫øt 'Ng√†y b√°o h·∫øt' ƒë·ªÉ ·∫©n d√≤ng ƒë√≥
          rented_reported_at: null,
          rented_confirmed_at: null,
        })
        .eq("id", id);

      if (error) {
        console.error(error);
        toast("L·ªói duy·ªát ch·∫°y l·∫°i: " + error.message);
        return;
      }

      toast("ƒê√£ duy·ªát cho m·∫∑t b·∫±ng ch·∫°y l·∫°i.");
      document.getElementById("detailDlg").close();
      applyFilters(true);
    }


    async function confirmRented(id) {
      if (!isAdmin()) return;
      if (!confirm("X√°c nh·∫≠n m·∫∑t b·∫±ng n√†y ƒë√£ h·∫øt / ƒë√£ thu√™?")) return;

      const { error } = await supabase
        .from("premises")
        .update({
          status: "rented",
          rented_confirmed_at: new Date().toISOString()
        })
        .eq("id", id);

      if (error) {
        console.error(error);
        toast("L·ªói x√°c nh·∫≠n: " + error.message);
        return;
      }
      toast("ƒê√£ x√°c nh·∫≠n m·∫∑t b·∫±ng h·∫øt");
      document.getElementById("detailDlg").close();
      applyFilters(true);
    }

    async function cancelRented(id) {
      if (!isAdmin()) return;
      if (!confirm("Hu·ª∑ y√™u c·∫ßu b√°o h·∫øt m·∫∑t b·∫±ng n√†y?")) return;

      const { error } = await supabase
        .from("premises")
        .update({
          rented_reported_at: null,
          rented_confirmed_at: null
        })
        .eq("id", id);

      if (error) {
        console.error(error);
        toast("L·ªói hu·ª∑ b√°o h·∫øt: " + error.message);
        return;
      }
      toast("ƒê√£ hu·ª∑ b√°o h·∫øt");
      document.getElementById("detailDlg").close();
      applyFilters(true);
    }

    // ===== LOGIC TH√äM M·ªöI (M·ªöI) =====
    function initAddFormDropdowns() {
        const distSelect = document.getElementById("add-district");
        const wardSelect = document.getElementById("add-ward");
        
        // Load Districts
        const dists = Object.keys(HCM_DATA).sort();
        distSelect.innerHTML = `<option value="">-- Ch·ªçn --</option>` + dists.map(d => `<option value="${d}">${d}</option>`).join("");
        
        // Event Change
        distSelect.addEventListener("change", () => {
            const val = distSelect.value;
            wardSelect.innerHTML = `<option value="">-- Ch·ªçn --</option>`;
            if(HCM_DATA[val]) {
                wardSelect.disabled = false;
                wardSelect.innerHTML += HCM_DATA[val].map(w => `<option value="${w}">${w}</option>`).join("");
            } else {
                wardSelect.disabled = true;
            }
        });
    }
    // ====================== GLOBAL VARIABLES ======================
    let FILES_BUFFER = [];  // L∆∞u file khi ch·ªçn ·∫£nh b·∫±ng input


    // ====================== H√ÄM T·∫†O M√É M·∫∂T B·∫∞NG ======================
    async function generateNextCode() {
      const { data, error } = await supabase
        .from("premises")
        .select("code")
        .order("code", { ascending: false })
        .limit(1);

      if (error) throw error;

      let nextNumber = 1;
      if (data && data.length > 0) {
        const lastCode = data[0].code; // VD: MBKD 56780001345
        const num = parseInt(lastCode.replace(/\D/g, ""), 10);
        nextNumber = num + 1;
      }

      return "MBKD " + nextNumber.toString().padStart(11, "0");
    }


    // ====================== H√ÄM CH·ªåN FILE ·∫¢NH ======================
    function handleSelectFiles(input) {
      const files = Array.from(input.files || []);
      if (!files.length) return;

      for (const file of files) {
        FILES_BUFFER.push(file);
      }

      renderImagePreview();
    }
    function renderImagePreview() {
      const previewBox = document.getElementById("new-images-preview");
      if (!previewBox) return;

      if (FILES_BUFFER.length === 0) {
        previewBox.innerHTML = `
          <div class="text-center text-gray-400 py-6">
            Ch∆∞a c√≥ ·∫£nh n√†o. ·∫¢nh ƒë·∫ßu ti√™n s·∫Ω l√† <b>·∫¢nh B√¨a</b>.
          </div>`;
        return;
      }

      previewBox.innerHTML = FILES_BUFFER.map((file, i) => {
        const url = URL.createObjectURL(file);
        return `
          <div class="relative inline-block m-1">
            <img src="${url}" class="h-24 w-24 object-cover rounded-lg border" />
            <button class="btn btn-xs btn-circle absolute -top-2 -right-2 bg-white"
                    onclick="deleteImageFromBuffer(${i})">‚úï</button>
          </div>
        `;
      }).join("");
    }

    function deleteImageFromBuffer(index) {
      FILES_BUFFER.splice(index, 1);
      renderImagePreview();
    }

    async function saveNewPremise() {
        const getVal = (id) => document.getElementById(id).value.trim();
        // L·∫•y gi√° ti·ªÅn t·ª´ input ƒë√£ format (x√≥a d·∫•u ch·∫•m/ph·∫©y ƒëi)
        const priceRaw = getVal("add-price").replace(/\D/g,'');
        const priceNum = priceRaw ? parseInt(priceRaw) : 0;

        if (!getVal("add-address") || !getVal("add-district") || !priceNum) {
            toast("Vui l√≤ng nh·∫≠p: ƒê·ªãa ch·ªâ, Qu·∫≠n v√† Gi√° thu√™!");
            return;
        }

        const payload = {
            address: getVal("add-address"),
            district: document.getElementById("add-district").value,
            ward: document.getElementById("add-ward").value,
            street: getVal("add-street"),
            price: priceNum,
            area: Number(getVal("add-area")) || null,
            width: Number(getVal("add-width")) || null,
            length: Number(getVal("add-length")) || null,
            floors: Number(getVal("add-floors")) || null,
            pn: Number(getVal("add-bedrooms")) || null,
            wc: Number(getVal("add-wc")) || null,
            ket_cau: getVal("add-ket-cau"),
            contact_phone: getVal("add-contact-phone"),
            frontage: document.getElementById("add-frontage").checked,
            images: getVal("add-images").split('\n').map(s=>s.trim()).filter(Boolean),
            detail: getVal("add-detail"),
            status: 'available',
            road_type: document.getElementById("add-road-type").value, // M·ªöI
              commission: getVal("add-commission"),
            // code, created_by, is_approved S·∫º ƒê∆Ø·ª¢C DB T·ª∞ ƒê·ªòNG X·ª¨ L√ù (N·∫æU ƒê√É CH·∫†Y SQL)
        };

        const { error } = await supabase.from("premises").insert([payload]);
        if (error) {
            toast("L·ªói: " + error.message);
        } else {
            toast(isAdmin() ? "ƒê√£ th√™m th√†nh c√¥ng!" : "ƒê√£ g·ª≠i duy·ªát!");
            document.getElementById("addDlg").close();
            applyFilters(true);
            if(isAdmin()) checkPendingCount();
        }
    }
      // ===== NH√ÇN S·ª∞: B√ÅO H·∫æT (CH·ªú ADMIN DUY·ªÜT) =====
    async function reportRentedStaff(id) {
      if (!isStaff()) return;
      if (!confirm("X√°c nh·∫≠n b√°o h·∫øt m·∫∑t b·∫±ng n√†y ƒë·ªÉ admin duy·ªát?")) return;

      const { error } = await supabase
        .from("premises")
        .update({
          rented_reported_at: new Date().toISOString(),
          rented_confirmed_at: null   // ch·∫Øc ch·∫Øn l√† ch∆∞a duy·ªát
        })
        .eq("id", id);

      if (error) {
        console.error(error);
        toast("L·ªói b√°o h·∫øt: " + error.message);
        return;
      }

      toast("ƒê√£ b√°o h·∫øt ‚Äì ch·ªù admin x√°c nh·∫≠n.");
      document.getElementById("detailDlg").close();
      applyFilters(true);
    }

    // ===== LOGIC ADMIN PENDING (M·ªöI) =====
    async function checkPendingCount() {
        const { count } = await supabase.from("premises").select("*", { count: 'exact', head: true }).eq("is_approved", false);
        const cnt = count || 0;
        document.getElementById("count-pending").textContent = cnt;
        if (cnt > 0 && SHOW_PENDING) document.getElementById("btn-approve-all").classList.remove("hidden");
        else document.getElementById("btn-approve-all").classList.add("hidden");
    }

    function togglePendingMode() {
        SHOW_PENDING = !SHOW_PENDING;
        const btn = document.getElementById("btn-toggle-pending");
        if (SHOW_PENDING) {
            btn.classList.replace("btn-warning", "btn-active");
            btn.textContent = "ƒêang xem Ch·ªù duy·ªát (Tho√°t)";
        } else {
            btn.classList.replace("btn-active", "btn-warning");
            btn.innerHTML = `C·∫ßn duy·ªát <span class="badge badge-sm bg-white text-warning ml-1 border-none" id="count-pending">...</span>`;
            checkPendingCount();
        }
        applyFilters(true);
    }

    async function approveOne(id, e) {
        e.stopPropagation();
        if(!confirm("Duy·ªát b√†i n√†y?")) return;
        await supabase.from("premises").update({ is_approved: true }).eq("id", id);
        toast("ƒê√£ duy·ªát!");
        applyFilters(true);
        checkPendingCount();
    }

    async function approveAll() {
        if(!confirm("Duy·ªát t·∫•t c·∫£ b√†i ƒëang ch·ªù?")) return;
        await supabase.from("premises").update({ is_approved: true }).eq("is_approved", false);
        toast("ƒê√£ duy·ªát t·∫•t c·∫£!");
        applyFilters(true);
        checkPendingCount();
    }

    // ===== INIT EVENTS =====
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btn-login").addEventListener("click", handleLogin);
      document.getElementById("btn-logout").addEventListener("click", handleLogout);
      
      document.getElementById("btn-apply").addEventListener("click", () => applyFilters(true));
      document.getElementById("btn-reset").addEventListener("click", () => {
        document.querySelectorAll("aside input, aside select").forEach(el => el.value = "");
        applyFilters(true);
      });
      // N√∫t m·ªü form ƒêƒÉng nh·∫≠p nh√¢n s·ª± tr√™n trang ch·ªß
      const btnOpenLogin = document.getElementById("btn-open-login");
      const loginCard = document.getElementById("login-card");
      if (btnOpenLogin && loginCard) {
        btnOpenLogin.addEventListener("click", () => {
          loginCard.classList.remove("hidden");
          loginCard.scrollIntoView({ behavior: "smooth", block: "center" });
        });
      }

      document.getElementById("btn-load-more").addEventListener("click", () => {
        PAGE++;
        applyFilters(false);
      });

      // Khi ch·ªçn QU·∫¨N trong b·ªô l·ªçc -> c·∫≠p nh·∫≠t PH∆Ø·ªúNG + l·ªçc l·∫°i
      const filterDistrict = document.getElementById("filter-district");
      if (filterDistrict) {
        filterDistrict.addEventListener("change", () => {
          if (typeof updateWardOptions === "function") {
            updateWardOptions();
          }
          applyFilters(true);
        });
      }

      // Admin / Add Events
      document.getElementById("btn-open-add").onclick = () => document.getElementById("addDlg").showModal();
      document.getElementById("btn-toggle-pending").onclick = togglePendingMode;
      const btnToggleReported = document.getElementById("btn-toggle-rented-reports");
      if (btnToggleReported) btnToggleReported.onclick = toggleReportedMode;

      const btnToggleReactivate = document.getElementById("btn-toggle-reactivate");
      if (btnToggleReactivate) btnToggleReactivate.onclick = toggleReactivateMode;

      document.getElementById("btn-approve-all").onclick = approveAll;
      
      const btnToggleRented = document.getElementById("btn-toggle-rented-reports");
      if (btnToggleRented) {
        btnToggleRented.onclick = toggleReportedMode;
      }

      // Quick filters
      document.querySelectorAll("[data-quick]").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.getElementById("filter-status").value = btn.getAttribute("data-quick");
          applyFilters(true);
        });
      });
      document.querySelectorAll("[data-quick-district]").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.getElementById("filter-district").value = btn.getAttribute("data-quick-district");
          updateWardOptions();
          applyFilters(true);
        });
      });
      document.getElementById("btn-clear-quick").addEventListener("click", () => {
        document.getElementById("filter-status").value = "";
        document.getElementById("filter-district").value = "";
        document.getElementById("filter-ward").value = "";
        applyFilters(true);
      });
      // N√∫t xem danh s√°ch m·∫∑t b·∫±ng ƒë√£ ghim
      const btnToggleFavorites = document.getElementById("btn-toggle-favorites");
      if (btnToggleFavorites) {
        btnToggleFavorites.addEventListener("click", toggleFavoriteMode);
      }

      // ===== DEMO NOTICE BUTTONS =====
      const demoAgreeBtn = document.getElementById("btn-demo-agree");
      const demoDisagreeBtn = document.getElementById("btn-demo-disagree");
      const demoDlg = document.getElementById("demoNoticeDlg");
      if (demoAgreeBtn && demoDlg) {
        demoAgreeBtn.addEventListener("click", () => demoDlg.close());
      }
      if (demoDisagreeBtn && demoDlg) {
        demoDisagreeBtn.addEventListener("click", async () => {
          demoDlg.close();
          await supabase.auth.signOut();
          location.reload();
        });
      }

      // Lu√¥n build dropdown QU·∫¨N/PH∆Ø·ªúNG khi load trang
      buildDistrictWardOptions();

      // R·ªìi m·ªõi x·ª≠ l√Ω login / role / d·ªØ li·ªáu
      initAuth();
    });
// --- X·ª¨ L√ù CHUY·ªÇN TAB LIST / MAP (LEAFLET VERSION) ---
      const btnList = document.getElementById("btn-view-list");
      const btnMap = document.getElementById("btn-view-map");
      const divList = document.getElementById("list-view");
      const divMap = document.getElementById("map-view");

      // --- S·ª¨A L·ªñI: H√ÄM CHUY·ªÇN TAB M·ªöI ---
      function switchView(mode) {
        const btnList = document.getElementById("btn-view-list");
        const btnMap = document.getElementById("btn-view-map");
        const divList = document.getElementById("list-view");
        const divMap = document.getElementById("map-view");

        if (mode === 'list') {
          // Hi·ªán List, ·∫®n Map
          if(divList) divList.classList.remove("hidden");
          if(divMap) divMap.classList.add("hidden");
          if(btnList) btnList.classList.add("btn-active");
          if(btnMap) btnMap.classList.remove("btn-active");
        } else {
          // Hi·ªán Map, ·∫®n List
          if(divList) divList.classList.add("hidden");
          if(divMap) divMap.classList.remove("hidden");
          if(btnList) btnList.classList.remove("btn-active");
          if(btnMap) btnMap.classList.add("btn-active");

          // B∆Ø·ªöC 1: Kh·ªüi t·∫°o map ngay l·∫≠p t·ª©c (kh√¥ng ch·ªù d·ªØ li·ªáu)
          initStaffMap();

          // B∆Ø·ªöC 2: Bu·ªôc b·∫£n ƒë·ªì t√≠nh l·∫°i k√≠ch th∆∞·ªõc ƒë·ªÉ tr√°nh b·ªã m√†u x√°m
          setTimeout(() => {
             if(MAP_INSTANCE) {
               MAP_INSTANCE.invalidateSize();
             }
          }, 200);

          // B∆Ø·ªöC 3: V·∫Ω marker n·∫øu ƒë√£ c√≥ d·ªØ li·ªáu t·ª´ tr∆∞·ªõc
          if (typeof LAST_ROWS !== 'undefined' && LAST_ROWS.length > 0) {
              renderMapMarkers(LAST_ROWS);
          }
        }
      }

      // G·∫Øn s·ª± ki·ªán click
      if(btnList) btnList.onclick = () => switchView('list');
      if(btnMap) btnMap.onclick = () => switchView('map');

    // --- 2. C√ÅC H√ÄM X·ª¨ L√ù GIAO DI·ªÜN ·∫¢NH (GI·ªÆ NGUY√äN) ---
    function handleSelectFiles(input) {
        if (!input.files || input.files.length === 0) return;
        const newFiles = Array.from(input.files);
        FILES_BUFFER = [...FILES_BUFFER, ...newFiles];
        input.value = '';
        renderPreview();
    }

    function renderPreview() {
        const container = document.getElementById("preview-container");
        container.innerHTML = ""; 
        if (FILES_BUFFER.length === 0) {
            container.innerHTML = `<p class="text-xs text-gray-500 w-full text-center py-8 pointer-events-none">Ch∆∞a c√≥ ·∫£nh n√†o.<br/>·∫¢nh ƒë·∫ßu ti√™n s·∫Ω l√† <b>·∫¢nh B√¨a</b>.</p>`;
            return;
        }
        FILES_BUFFER.forEach((file, index) => {
            const url = URL.createObjectURL(file);
            const div = document.createElement("div");
            div.className = `relative w-24 h-24 rounded-lg overflow-hidden border-2 cursor-pointer transition-all group ${index === 0 ? 'border-primary ring-2 ring-primary ring-offset-1' : 'border-gray-300 hover:border-primary'}`;
            div.title = index === 0 ? "·∫¢nh b√¨a hi·ªán t·∫°i" : "Click ƒë·ªÉ ƒë·∫∑t l√†m ·∫£nh b√¨a";
            div.onclick = () => makeCover(index);

            const img = document.createElement("img");
            img.src = url;
            img.className = "w-full h-full object-cover";
            
            const btnRemove = document.createElement("button");
            btnRemove.innerHTML = "‚úï";
            btnRemove.className = "absolute top-0 right-0 bg-red-500 text-white w-5 h-5 text-[10px] flex items-center justify-center rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity";
            btnRemove.onclick = (e) => { e.stopPropagation(); removeFile(index); };

            if (index === 0) {
                const badge = document.createElement("div");
                badge.innerText = "B√¨a";
                badge.className = "absolute bottom-0 left-0 right-0 bg-primary text-white text-[10px] text-center font-bold py-0.5";
                div.appendChild(badge);
            }
            div.appendChild(img); div.appendChild(btnRemove); container.appendChild(div);
        });
    }

    function makeCover(index) {
        if (index === 0) return;
        const item = FILES_BUFFER.splice(index, 1)[0];
        FILES_BUFFER.unshift(item);
        renderPreview();
    }

    function removeFile(index) {
        FILES_BUFFER.splice(index, 1);
        renderPreview();
    }

    // --- 3. H√ÄM UPLOAD (C·∫¨P NH·∫¨T: NH·∫¨N THAM S·ªê FOLDER NAME) ---
    async function uploadFilesToSupabase(folderName) {
        if (FILES_BUFFER.length === 0) return [];
        
        const uploadedPaths = [];
        // Kh√¥ng c·∫ßn timestamp ·ªü t√™n file n·ªØa v√¨ ƒë√£ c√≥ folder ri√™ng, nh∆∞ng v·∫´n th√™m random cho ch·∫Øc
        
        toast(`ƒêang t·∫£i ${FILES_BUFFER.length} ·∫£nh l√™n folder ${folderName}...`);

        for (let i = 0; i < FILES_BUFFER.length; i++) {
            const file = FILES_BUFFER[i];
            
            // L√†m s·∫°ch t√™n file (b·ªè d·∫•u ti·∫øng vi·ªát, k√Ω t·ª± l·∫°)
            const cleanName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
            
            // C·∫•u tr√∫c path: T√äN_FOLDER/T√äN_FILE
            // V√≠ d·ª•: MB-123456/hinh_nha_1.jpg
            const filePath = `${folderName}/${cleanName}`;
            
            const { data, error } = await supabase.storage
                .from(STORAGE_BUCKET)
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: false
                });

            if (error) {
                console.error("L·ªói upload:", file.name, error);
                continue; 
            }
            if (data) uploadedPaths.push(data.path);
        }
        return uploadedPaths;
    }

    // --- 4. H√ÄM L∆ØU TIN (ƒê√É C·∫¨P NH·∫¨T LOGIC TƒÇNG M√É) ---
    async function saveNewPremiseWithUpload() {
        const btn = document.getElementById("btn-save-new");
        
        // Validate c∆° b·∫£n
        const getVal = (id) => document.getElementById(id).value.trim();
        const priceRaw = getVal("add-price").replace(/\D/g,'');
        const priceNum = priceRaw ? parseInt(priceRaw) : 0;

        if (!getVal("add-address") || !getVal("add-district") || !priceNum) {
            toast("Vui l√≤ng nh·∫≠p: ƒê·ªãa ch·ªâ, Qu·∫≠n v√† Gi√° thu√™!");
            return;
        }

        // Disable n√∫t ƒë·ªÉ tr√°nh click ƒë√∫p
        btn.disabled = true;
        btn.innerHTML = `<span class="loading loading-spinner"></span> ƒêang l·∫•y m√£ MB...`;

        try {
            // B∆Ø·ªöC 1: L·∫§Y M√É MB TI·∫æP THEO T·ª™ DATABASE (Async)
            const newCode = await generateNextCode();
            console.log("M√£ m·ªõi s·∫Ω l√†:", newCode);

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t b·∫•m
            btn.innerHTML = `<span class="loading loading-spinner"></span> ƒêang up ·∫£nh l√™n ${newCode}...`;

            // B∆Ø·ªöC 2: UPLOAD ·∫¢NH V√ÄO FOLDER C√ì T√äN L√Ä M√É MB V·ª™A T·∫†O
            const imagePaths = await uploadFilesToSupabase(newCode);

            // B∆Ø·ªöC 3: CHU·∫®N B·ªä DATA
            const rType = document.getElementById("add-road-type").value;
            const isFrontage = rType === "M·∫∑t ti·ªÅn";

            const payload = {
                code: newCode, // <-- M√É T·ª∞ TƒÇNG
                
                address: getVal("add-address"),
                district: document.getElementById("add-district").value,
                ward: document.getElementById("add-ward").value,
                street: getVal("add-street"),
                lat: document.getElementById("add-lat").value || null,
                lng: document.getElementById("add-lng").value || null,
                price: priceNum,
                area: Number(getVal("add-area")) || null,
                width: Number(getVal("add-width")) || null,
                length: Number(getVal("add-length")) || null,
                floors: Number(getVal("add-floors")) || null,
                pn: Number(getVal("add-bedrooms")) || null,
                wc: Number(getVal("add-wc")) || null,
                ket_cau: getVal("add-ket-cau"),
                contact_phone: getVal("add-contact-phone"),
                
                road_type: rType,
                commission: getVal("add-commission"),
                frontage: isFrontage,

                images: imagePaths, 
                detail: getVal("add-detail"),
                status: 'available',
                created_at: new Date().toISOString()
            };

            // B∆Ø·ªöC 4: INSERT V√ÄO DB
            const { error } = await supabase.from("premises").insert([payload]);

            if (error) throw error;

            toast(isAdmin() ? `Th√™m th√†nh c√¥ng! M√£: ${newCode}` : "ƒê√£ g·ª≠i duy·ªát!");
            
            // Reset form
            document.getElementById("addDlg").close();
            FILES_BUFFER = []; 
            renderPreview();
            applyFilters(true);
            if(isAdmin()) checkPendingCount();

        } catch (err) {
            console.error(err);
            toast("L·ªói: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = "L∆∞u tin";
        }
    }
    async function cancelRentedStaff(id) {
      if (!isStaff()) return;
      if (!confirm("B·∫°n mu·ªën hu·ª∑ b√°o h·∫øt m·∫∑t b·∫±ng n√†y?")) return;

      const { error } = await supabase
        .from("premises")
        .update({
          rented_reported_at: null
        })
        .eq("id", id);

      if (error) {
        console.error(error);
        toast("L·ªói: " + error.message);
        return;
      }

      toast("ƒê√£ hu·ª∑ b√°o h·∫øt");
      document.getElementById("detailDlg").close();
      applyFilters(true);
    }
// === QU√âT ·∫¢NH RUNTIME T·ª™ STORAGE, KH√îNG PH·ª§ THU·ªòC C·ªòT images ===
async function scanGridImages(rows) {
  if (!rows || !rows.length) return;

  for (const row of rows) {
    if (!row || !row.code) continue;

    // T√¨m khung ·∫£nh theo id ƒë√£ render ·ªü renderCards
    const imgContainer = document.getElementById(`thumb-box-${row.id}`);
    if (!imgContainer) continue;

    // N·∫øu trong DOM ƒë√£ c√≥ <img> (do c·ªôt images render s·∫µn) th√¨ b·ªè qua
    if (imgContainer.querySelector("img")) continue;

    try {
      // Qu√©t folder theo m√£ m·∫∑t b·∫±ng trong Storage
      const { data: files, error } = await supabase.storage
        .from(STORAGE_BUCKET) // vd: "premise-images"
        .list(row.code, {
          limit: 10,
          sortBy: { column: "name", order: "asc" },
        });

      if (error) {
        console.error("L·ªói list storage cho", row.code, error);
        continue;
      }

      if (!files || !files.length) {
        // Kh√¥ng c√≥ file n√†o trong storage => gi·ªØ nguy√™n "(ƒêang qu√©t ·∫£nh...)"
        continue;
      }

      // B·ªè file placeholder n·∫øu c√≥, l·∫•y file ƒë·∫ßu ti√™n
      const first = files.find(f => f.name !== ".emptyFolderPlaceholder") || files[0];
      if (!first) continue;

      const fullPath = `${row.code}/${first.name}`;
      const { data } = supabase.storage
        .from(STORAGE_BUCKET)
        .getPublicUrl(fullPath);

      if (data && data.publicUrl) {
        imgContainer.innerHTML = `
          <img src="${data.publicUrl}"
               class="w-full h-full object-cover animate-fade-in"
               alt="${row.code}" />
        `;
        imgContainer.classList.remove("opacity-60");
      }
    } catch (err) {
      console.error("scanGridImages error", row.code, err);
    }
  }
}

    // ==== TOOL 1 L·∫¶N: ƒê·ªíNG B·ªò ·∫¢NH T·ª™ STORAGE -> C·ªòT images ====
    async function syncImagesFromStorage() {
      if (!isAdmin || !isAdmin()) {
        alert("Ch·ªâ admin m·ªõi ƒë∆∞·ª£c ch·∫°y sync images.");
        return;
      }

      const PAGE_SIZE = 100;
      let from = 0;
      let totalUpdated = 0;

      alert("B·∫Øt ƒë·∫ßu sync ·∫£nh, m·ªü Console ƒë·ªÉ xem log. ƒê·ª´ng t·∫Øt tab cho t·ªõi khi xong.");

      while (true) {
        const { data: rows, error } = await supabase
          .from("premises")
          .select("id, code, images", { count: "exact" })
          .range(from, from + PAGE_SIZE - 1);

        if (error) {
          console.error("L·ªói load premises:", error);
          break;
        }
        if (!rows || rows.length === 0) break;

        console.log(`ƒêang x·ª≠ l√Ω t·ª´ row ${from} t·ªõi ${from + rows.length - 1}`);

        for (const row of rows) {
          // N·∫øu ƒë√£ c√≥ images r·ªìi th√¨ b·ªè qua
          let hasImg = false;
          if (Array.isArray(row.images) && row.images.length > 0) hasImg = true;
          else if (typeof row.images === "string" && row.images.trim().length > 0) hasImg = true;
          if (hasImg) continue;
          if (!row.code) continue;

          console.log("‚Üí Qu√©t folder:", row.code);

          const { data: files, error: err2 } = await supabase.storage
            .from(STORAGE_BUCKET) // v√≠ d·ª• "premise-images"
            .list(row.code, {
              limit: 50,
              sortBy: { column: "name", order: "asc" },
            });

          if (err2) {
            console.error("   L·ªói list storage", row.code, err2);
            continue;
          }
          if (!files || !files.length) {
            console.log("   Kh√¥ng c√≥ file n√†o trong storage cho", row.code);
            continue;
          }

          // B·ªè file placeholder n·∫øu c√≥
          const validFiles = files.filter(f => f.name !== ".emptyFolderPlaceholder");
          if (!validFiles.length) continue;

          // L∆∞u ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi v√†o c·ªôt images (Postgres text[] ho·∫∑c jsonb ƒë·ªÅu ok)
          const paths = validFiles.map(f => `${row.code}/${f.name}`);

          const { error: err3 } = await supabase
            .from("premises")
            .update({ images: paths })
            .eq("id", row.id);

          if (err3) {
            console.error("   L·ªói update images cho", row.code, err3);
          } else {
            totalUpdated++;
            console.log("   ƒê√£ update images cho", row.code, paths);
          }
        }

        from += PAGE_SIZE;
      }

      alert("Sync ·∫£nh xong. T·ªïng s·ªë m·∫∑t b·∫±ng ƒë∆∞·ª£c c·∫≠p nh·∫≠t: " + totalUpdated);
    }
    // --- BI·∫æN TO√ÄN C·ª§C ƒê·ªÇ ƒêI·ªÄU KHI·ªÇN ---
    let STOP_SYNC = false;

    // --- TOOL QU√âT T·ªåA ƒê·ªò SI√äU C·∫§P (KH√îNG BAO GI·ªú B·ªé S√ìT) ---
    async function startSyncCoordinates() {
      if (!isAdmin()) { alert("Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c d√πng!"); return; }

      const btn = document.getElementById("btn-start-sync");
      const logBox = document.getElementById("sync-log");
      
      // 1. Ki·ªÉm tra th·ªëng k√™ tr∆∞·ªõc khi ch·∫°y
      const { count: total } = await supabase.from("premises").select("*", { count: 'exact', head: true });
      const { count: missing } = await supabase.from("premises").select("*", { count: 'exact', head: true }).is("lat", null);
      
      if (missing === 0) {
          alert(`Tuy·ªát v·ªùi! To√†n b·ªô ${total} m·∫∑t b·∫±ng ƒë√£ c√≥ t·ªça ƒë·ªô. Kh√¥ng c·∫ßn qu√©t.`);
          return;
      }

      if(!confirm(`T·ªïng: ${total} cƒÉn.\nHi·ªán c√≥ ${missing} cƒÉn ƒêANG M·∫§T T·ªåA ƒê·ªò (kh√¥ng hi·ªán tr√™n map).\nB·∫°n c√≥ mu·ªën qu√©t l·∫°i to√†n b·ªô ${missing} cƒÉn n√†y kh√¥ng?`)) return;

      // 2. B·∫Øt ƒë·∫ßu x·ª≠ l√Ω
      document.getElementById("sync-status").classList.remove("hidden");
      btn.disabled = true;
      STOP_SYNC = false;
      logBox.innerHTML = "<div>ƒêang t·∫£i danh s√°ch c·∫ßn x·ª≠ l√Ω...</div>";

      // L·∫•y danh s√°ch ch∆∞a c√≥ t·ªça ƒë·ªô
      const { data: list } = await supabase
        .from("premises")
        .select("id, address, district, ward, street")
        .is("lat", null);

      document.getElementById("sync-total").innerText = list.length;
      let processed = 0;

      for (const item of list) {
        if (STOP_SYNC) break;
        processed++;
        document.getElementById("sync-count").innerText = processed;
        document.getElementById("sync-bar").style.width = (processed / list.length * 100) + "%";

        // --- C√ÅC CHI·∫æN THU·∫¨T T√åM KI·∫æM ---
        const city = "Ho Chi Minh City";
        const district = item.district || "";
        const ward = item.ward || "";
        
        // X·ª≠ l√Ω t√™n ƒë∆∞·ªùng: B·ªè "G√≥c", "H·∫ªm", s·ªë nh√† r·∫Øc r·ªëi
        let cleanStreet = "";
        if (item.street) cleanStreet = item.street;
        else if (item.address) {
             cleanStreet = item.address.replace(/^[0-9\/A-Za-z]+\s+(.*)$/, "$1"); // B·ªè s·ªë nh√† ƒë·∫ßu
             cleanStreet = cleanStreet.replace(/^(G√≥c|H·∫ªm|Nh√†|L√¥)\s+/i, "");
        }

        const queries = [
            // 1. T√¨m ch√≠nh x√°c (S·ªë nh√† + ƒê∆∞·ªùng + Qu·∫≠n)
            `${item.address}, ${district}, ${city}`,
            
            // 2. T√¨m ƒê∆∞·ªùng + Ph∆∞·ªùng + Qu·∫≠n (B·ªè s·ªë nh√†)
            `ƒê∆∞·ªùng ${cleanStreet}, ${ward}, ${district}, ${city}`,
            
            // 3. T√¨m ƒê∆∞·ªùng + Qu·∫≠n (B·ªè ph∆∞·ªùng lu√¥n)
            `ƒê∆∞·ªùng ${cleanStreet}, ${district}, ${city}`,
            
            // 4. T√¨m Ph∆∞·ªùng + Qu·∫≠n (N·∫øu t√™n ƒë∆∞·ªùng sai, l·∫•y t√¢m Ph∆∞·ªùng) - FALLBACK 1
            `UBND ${ward}, ${district}, ${city}`,
            
            // 5. T√¨m Qu·∫≠n (N·∫øu ph∆∞·ªùng c≈©ng sai, l·∫•y t√¢m Qu·∫≠n) - FALLBACK 2
            `${district}, ${city}`
        ];

        logBox.innerHTML += `<div class="border-t mt-1 pt-1 font-bold text-gray-500">${item.address || cleanStreet}</div>`;
        logBox.scrollTop = logBox.scrollHeight;

        let found = null;
        let method = 0;

        for (const q of queries) {
            method++;
            try {
                // logBox.innerHTML += `<div class="text-[9px] text-gray-400">... th·ª≠ c√°ch ${method}</div>`;
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data && data.length > 0) {
                    found = data[0];
                    break; // T√¨m th·∫•y th√¨ d·ª´ng ngay
                }
            } catch(e) {}
            await new Promise(r => setTimeout(r, 1200)); // Ngh·ªâ 1.2s ƒë·ªÉ kh√¥ng b·ªã kh√≥a IP
        }

        if (found) {
            await supabase.from("premises").update({ lat: found.lat, lng: found.lon }).eq("id", item.id);
            
            let color = "text-success"; // Xanh: T√¨m ch√≠nh x√°c
            if(method >= 4) color = "text-warning"; // V√†ng: Ch·ªâ t√¨m th·∫•y Ph∆∞·ªùng/Qu·∫≠n
            
            logBox.innerHTML += `<div class="${color} text-[10px] pl-2">-> OK (C√°ch ${method}): ${found.display_name.substring(0,40)}...</div>`;
        } else {
            logBox.innerHTML += `<div class="text-error text-[10px] pl-2">-> V·∫™N TH·∫§T B·∫†I (Check l·∫°i t√™n Qu·∫≠n)</div>`;
        }
      }

      btn.disabled = false;
      alert("Ho√†n t·∫•t! H√£y t·∫£i l·∫°i trang ƒë·ªÉ xem b·∫£n ƒë·ªì.");
      applyFilters(true);
    }

    // H√†m g·ªçi API ri√™ng l·∫ª
    async function fetchOpenStreetMap(query) {
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
        const res = await fetch(url);
        const data = await res.json();
        if (data && data.length > 0) return data[0];
        return null;
      } catch (e) {
        return null;
      }
    }
    // H√ÄM D√í T·ªåA ƒê·ªò CHO FORM S·ª¨A (ADMIN)
    async function autoFetchCoordsForEdit() {
        const address = document.getElementById("edit-address").value;
        const district = document.getElementById("edit-district").value;
        const street = document.getElementById("edit-street").value;
        const city = document.getElementById("edit-city").value || "H·ªì Ch√≠ Minh";

        if (!district) {
            alert("Vui l√≤ng nh·∫≠p Qu·∫≠n trong form s·ª≠a tr∆∞·ªõc!");
            return;
        }

        const btn = document.querySelector("button[onclick='autoFetchCoordsForEdit()']");
        const oldText = btn.innerText;
        btn.innerText = "ƒêang d√≤...";
        btn.disabled = true;

        try {
            // Logic t√¨m ki·∫øm gi·ªëng h·ªát l√∫c th√™m m·ªõi
            let query = `${address}, ${district}, ${city}`;
            // N·∫øu ƒë·ªãa ch·ªâ qu√° ng·∫Øn ho·∫∑c kh√¥ng c√≥ s·ªë nh√†, ∆∞u ti√™n t√¨m theo ƒë∆∞·ªùng
            if (!address || (address.split(' ').length < 2 && street)) {
                 query = `${street}, ${district}, ${city}`;
            }

            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
            const res = await fetch(url);
            const data = await res.json();

            if (data && data.length > 0) {
                document.getElementById("edit-lat").value = data[0].lat;
                document.getElementById("edit-lng").value = data[0].lon;
                toast(`ƒê√£ t√¨m th·∫•y: ${data[0].display_name.split(',')[0]}`);
            } else {
                // Th·ª≠ l·∫°i l·∫ßn 2 ch·ªâ v·ªõi T√™n ƒë∆∞·ªùng + Qu·∫≠n (fallback)
                if (street) {
                    const url2 = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(street + ", " + district + ", " + city)}&limit=1`;
                    const res2 = await fetch(url2);
                    const data2 = await res2.json();
                    if (data2 && data2.length > 0) {
                         document.getElementById("edit-lat").value = data2[0].lat;
                         document.getElementById("edit-lng").value = data2[0].lon;
                         toast(`ƒê√£ t√¨m th·∫•y (theo ƒë∆∞·ªùng): ${data2[0].display_name.split(',')[0]}`);
                         return;
                    }
                }
                alert("Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô. Vui l√≤ng nh·∫≠p tay ho·∫∑c ki·ªÉm tra l·∫°i ƒë·ªãa ch·ªâ.");
            }
        } catch (e) {
            console.error(e);
            toast("L·ªói k·∫øt n·ªëi b·∫£n ƒë·ªì.");
        } finally {
            btn.innerText = oldText;
            btn.disabled = false;
        }
    }
  </script>
  <dialog id="toolDlg" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">C√¥ng c·ª• Admin</h3>
      
      <div class="border p-4 rounded-xl bg-base-200">
        <h4 class="font-bold text-sm mb-2">T·ª± ƒë·ªông c·∫≠p nh·∫≠t T·ªça ƒë·ªô (Lat/Lng)</h4>
        <p class="text-xs opacity-70 mb-3">
          H·ªá th·ªëng s·∫Ω t√¨m nh·ªØng m·∫∑t b·∫±ng <b>ch∆∞a c√≥ t·ªça ƒë·ªô</b> v√† t·ª± ƒë·ªông qu√©t t·ª´ ƒë·ªãa ch·ªâ.
          <br/><span class="text-error">L∆∞u √Ω: T·ªëc ƒë·ªô ch·∫≠m (1.5s/cƒÉn) ƒë·ªÉ tr√°nh b·ªã kh√≥a IP. Vui l√≤ng kh√¥ng t·∫Øt tab.</span>
        </p>
        
        <div class="flex items-center gap-2">
          <button id="btn-start-sync" class="btn btn-primary btn-sm" onclick="startSyncCoordinates()">
            ‚ñ∂ B·∫Øt ƒë·∫ßu qu√©t
          </button>
          <button class="btn btn-sm btn-ghost" onclick="STOP_SYNC = true">‚èπ D·ª´ng l·∫°i</button>
        </div>

        <div id="sync-status" class="mt-3 text-xs font-mono hidden">
          ƒêang x·ª≠ l√Ω: <span id="sync-count" class="font-bold text-primary">0</span> / <span id="sync-total">0</span>
          <div class="w-full bg-gray-300 h-2 rounded mt-1 overflow-hidden">
             <div id="sync-bar" class="bg-primary h-full w-0 transition-all duration-300"></div>
          </div>
          <div id="sync-log" class="mt-2 max-h-32 overflow-y-auto border p-2 bg-white rounded text-[10px]"></div>
        </div>
      </div>

      <div class="modal-action">
        <form method="dialog"><button class="btn">ƒê√≥ng</button></form>
      </div>
    </div>
  </dialog>
</body>
</html>