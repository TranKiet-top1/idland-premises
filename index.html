<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>ID-Land Premises</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
    rel="stylesheet"
  />

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    .premise-card:hover {
      transform: translateY(-2px);
    }
  </style>
</head>
<body class="bg-base-200">

  <section id="auth-section" class="min-h-screen flex items-center justify-center">
    <div class="card w-full max-w-md bg-base-100 shadow-xl">
      <div class="card-body">
        <div class="flex items-center gap-2 mb-4">
          <div class="h-10 w-10 rounded-xl bg-primary flex items-center justify-center text-white font-bold">ID</div>
          <div>
            <h2 class="card-title">ID-Land Premises</h2>
            <p class="text-xs opacity-70">Đăng nhập để xem kho mặt bằng</p>
          </div>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Email</span>
          </label>
          <input id="login-email" type="email" placeholder="you@idland.vn" class="input input-bordered" />
        </div>

        <div class="form-control mt-2">
          <label class="label">
            <span class="label-text">Mật khẩu</span>
          </label>
          <input id="login-password" type="password" placeholder="••••••••" class="input input-bordered" />
        </div>

        <div class="form-control mt-4">
          <button id="btn-login" class="btn btn-primary w-full">Đăng nhập</button>
        </div>

        <p class="mt-3 text-xs opacity-70">
          Quyền <b>admin</b>: xem & chỉnh sửa full thông tin, số nhà & số chủ.<br/>
          Quyền <b>nhân sự</b>: bị ẩn số nhà & số điện thoại chủ nhà.
        </p>
      </div>
    </div>
  </section>

  <div id="app-root" class="hidden min-h-screen flex flex-col">
    <div class="navbar bg-base-100 shadow-sm px-4 sticky top-0 z-50">
      <div class="flex-1 flex items-center gap-2">
        <div class="h-9 w-9 rounded-xl bg-primary flex items-center justify-center text-white font-bold text-xs">ID</div>
        <div>
          <div class="font-bold text-lg leading-tight">ID-Land Premises</div>
          <div class="text-xs opacity-60">Kho mặt bằng cho thuê • TP.HCM</div>
        </div>
      </div>
      <div class="flex-none flex items-center gap-2 text-sm">
        <div class="text-right hidden sm:block mr-2">
             <div id="user-email-display" class="text-xs font-bold"></div>
             <span id="role-badge" class="badge badge-outline"></span>
        </div>
        <button id="btn-logout" class="btn btn-ghost btn-sm">Đăng xuất</button>
      </div>
    </div>

    <main class="flex-1 max-w-6xl mx-auto w-full px-2 sm:px-4 py-4">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <div>
          <h1 class="text-xl sm:text-2xl font-bold">
            Bộ lọc mặt bằng <span class="text-primary">ID-Land</span>
          </h1>
          <p class="text-xs sm:text-sm opacity-70">
            Nhân sự chỉ cần nhập yêu cầu của khách: <b>giá – diện tích – khu vực...</b>
          </p>
        </div>

        <div class="flex flex-wrap gap-2 justify-end">
          <div id="admin-pending-controls" class="hidden flex gap-2">
               <button id="btn-toggle-pending" class="btn btn-warning btn-sm text-white">
                   Cần duyệt <span class="badge badge-sm bg-white text-warning ml-1 border-none" id="count-pending">0</span>
               </button>
               <button id="btn-approve-all" class="btn btn-success btn-sm text-white hidden">✔ Duyệt tất cả</button>
          </div>

          <button id="btn-open-add" class="btn btn-primary btn-sm">
            + Thêm mặt bằng
          </button>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2 mb-3">
        <span class="text-xs opacity-70">Lọc nhanh:</span>
        <button class="btn btn-xs" data-quick="available">Còn trống</button>
        <button class="btn btn-xs" data-quick="deposited">Giữ cọc</button>
        <button class="btn btn-xs" data-quick-district="Quận 1">Quận 1</button>
        <button class="btn btn-xs" data-quick-district="Quận 10">Quận 10</button>
        <button class="btn btn-xs btn-ghost btn-outline" id="btn-clear-quick">
          Xoá lọc nhanh
        </button>
      </div>

      <div class="grid md:grid-cols-[260px,1fr] gap-4">
        <aside class="bg-base-100 rounded-2xl shadow-sm p-4">
          <div class="flex items-center gap-2 mb-3">
            <span class="w-2 h-2 rounded-full bg-success"></span>
            <h2 class="font-semibold text-sm">Bộ lọc</h2>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">Từ khoá</span>
            </label>
            <input
              id="filter-keyword"
              type="text"
              placeholder="VD: Trần Hưng Đạo, Q5..."
              class="input input-sm input-bordered"
            />
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">Quận</span>
            </label>
            <select id="filter-district" class="select select-sm select-bordered">
              <option value="">Tất cả</option>
            </select>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">Phường</span>
            </label>
            <select id="filter-ward" class="select select-sm select-bordered">
              <option value="">Tất cả</option>
            </select>
          </div>

          <div class="grid grid-cols-1 gap-2 mb-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Số PN</span>
              </label>
              <select id="filter-pn" class="select select-sm select-bordered">
                <option value="">Tất cả</option>
                <option value="1">1 PN</option>
                <option value="2">2 PN</option>
                <option value="3">3 PN</option>
                <option value="4">4 PN</option>
                <option value="5">5 PN</option>
                <option value="6">6 PN</option>
                <option value=">6">> 6 PN</option>
              </select>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Số WC</span>
              </label>
              <select id="filter-wc" class="select select-sm select-bordered">
                <option value="">Tất cả</option>
                <option value="1">1 WC</option>
                <option value="2">2 WC</option>
                <option value="3">3 WC</option>
                <option value="4">4 WC</option>
                <option value="5">5 WC</option>
                <option value=">5">> 5 WC</option>
              </select>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Số tầng</span>
              </label>
              <select id="filter-floors" class="select select-sm select-bordered">
                <option value="">Tất cả</option>
                <option value="1">1 tầng</option>
                <option value="2">2 tầng</option>
                <option value="3">3 tầng</option>
                <option value="4">4 tầng</option>
                <option value="5">5 tầng</option>
                <option value=">5">> 5 tầng</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Giá tối thiểu</span>
              </label>
              <input
                id="filter-price-min"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Giá tối đa</span>
              </label>
              <input
                id="filter-price-max"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">DT tối thiểu (m²)</span>
              </label>
              <input
                id="filter-area-min"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">DT tối đa (m²)</span>
              </label>
              <input
                id="filter-area-max"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">Vị trí</span>
            </label>
            <select id="filter-frontage-type" class="select select-sm select-bordered">
              <option value="">Tất cả</option>
              <option value="hem">Nhà hẻm</option>
              <option value="hxh">Hẻm xe hơi</option>
              <option value="mt">Mặt tiền</option>
            </select>
          </div>

          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text text-xs">Tình trạng</span>
            </label>
            <select id="filter-status" class="select select-sm select-bordered">
              <option value="">Tất cả</option>
              <option value="available">Còn trống</option>
              <option value="deposited">Giữ cọc</option>
              <option value="rented">Đã thuê</option>
            </select>
          </div>

          <div class="flex gap-2">
            <button id="btn-apply" class="btn btn-sm btn-primary flex-1">
              Lọc
            </button>
            <button id="btn-reset" class="btn btn-sm btn-ghost">
              Xoá lọc
            </button>
          </div>
        </aside>

        <section class="flex flex-col gap-3">
          <div class="flex items-center justify-between mb-1 text-xs opacity-70">
            <span>
              Hiển thị <span id="count-show">0</span> / <span id="count-total">0</span>
            </span>
            <button id="btn-download-csv" class="btn btn-xs btn-ghost">
              Tải CSV trên Supabase
            </button>
          </div>

          <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            </div>

          <div class="mt-4 flex justify-center">
            <button id="btn-load-more" class="btn btn-sm btn-ghost">
              Hết dữ liệu
            </button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <dialog id="detailDlg" class="modal">
    <div class="modal-box max-w-5xl p-4">
      <form method="dialog" class="modal-backdrop absolute inset-0" onclick="document.getElementById('detailDlg').close()"></form>
      <div id="detail-content"></div>
    </div>
  </dialog>

  <dialog id="editDlg" class="modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog" class="modal-backdrop absolute inset-0" onclick="document.getElementById('editDlg').close()"></form>
      <h3 class="font-bold text-lg mb-3">Chỉnh sửa mặt bằng</h3>

      <div class="grid md:grid-cols-2 gap-3">
        <div class="form-control md:col-span-2">
          <label class="label">
            <span class="label-text">Mã mặt bằng (code)</span>
          </label>
          <input id="edit-code" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label">
            <span class="label-text">Tiêu đề / Địa chỉ hiển thị</span>
          </label>
          <input id="edit-address" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Thành phố</span></label>
          <input id="edit-city" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Quận</span></label>
          <input id="edit-district" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Phường</span></label>
          <input id="edit-ward" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Tên đường</span></label>
          <input id="edit-street" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Giá thuê (đ)</span></label>
          <input id="edit-price" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Diện tích (m²)</span></label>
          <input id="edit-area" type="number" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Chiều ngang (m)</span></label>
          <input id="edit-width" type="number" step="0.1" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Chiều dài (m)</span></label>
          <input id="edit-length" type="number" step="0.1" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Số tầng</span></label>
          <input id="edit-floors" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Số PN</span></label>
          <input id="edit-bedrooms" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Số WC</span></label>
          <input id="edit-wc" type="number" class="input input-bordered w-full" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Kết cấu</span></label>
          <input id="edit-ket-cau" type="text" class="input input-bordered w-full" placeholder="VD: Trệt 3 lầu, trống suốt…" />
        </div>
        
        <div class="form-control md:col-span-2">
            <label class="label"><span class="label-text">SĐT Chủ nhà (Chỉ Admin thấy)</span></label>
            <input id="edit-contact-phone" type="text" class="input input-bordered w-full" placeholder="090..." />
        </div>

        <div class="form-control flex items-center gap-2 mt-2">
          <input id="edit-frontage" type="checkbox" class="checkbox" />
          <span class="label-text">Nhà mặt tiền</span>
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Trạng thái</span></label>
          <select id="edit-status" class="select select-bordered w-full">
            <option value="available">Còn trống</option>
            <option value="deposited">Giữ cọc</option>
            <option value="rented">Đã thuê</option>
          </select>
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Hoa hồng / ghi chú HH</span></label>
          <input id="edit-commission" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Danh sách ảnh (mỗi dòng 1 path)</span></label>
          <textarea id="edit-images" class="textarea textarea-bordered w-full min-h-[80px]" placeholder="VD: MB0001/1.jpg
MB0001/2.jpg"></textarea>
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Thông tin chi tiết mặt bằng</span></label>
          <textarea id="edit-detail" class="textarea textarea-bordered w-full min-h-[140px]"></textarea>
        </div>
      </div>

      <div class="modal-action">
        <button class="btn btn-ghost" onclick="document.getElementById('editDlg').close()">Huỷ</button>
        <button class="btn btn-primary" onclick="saveEditPremise()">Lưu thay đổi</button>
      </div>
    </div>
  </dialog>

  <dialog id="addDlg" class="modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
      <h3 class="font-bold text-lg text-primary mb-4">Đăng mặt bằng mới</h3>
      <div class="grid md:grid-cols-2 gap-4">
          <div>
             <div class="form-control mb-2">
                 <span class="label-text text-xs font-bold">Địa chỉ (Số nhà + Đường) *</span>
                 <input id="add-address" type="text" class="input input-sm input-bordered" placeholder="VD: 123 Nguyễn Trãi"/>
             </div>
             <div class="grid grid-cols-2 gap-2 mb-2">
                 <div class="form-control">
                     <span class="label-text text-xs">Quận *</span>
                     <select id="add-district" class="select select-sm select-bordered">
                        <option value="">-- Chọn --</option>
                     </select>
                 </div>
                 <div class="form-control">
                     <span class="label-text text-xs">Phường *</span>
                     <select id="add-ward" class="select select-sm select-bordered" disabled>
                        <option value="">-- Chọn Quận trước --</option>
                     </select>
                 </div>
             </div>
             <div class="form-control mb-2">
                 <span class="label-text text-xs">Tên đường (để lọc)</span>
                 <input id="add-street" type="text" class="input input-sm input-bordered"/>
             </div>
             <div class="form-control mt-3">
                 <span class="label-text text-xs font-bold text-primary">Giá thuê (VNĐ) *</span>
                 <input id="add-price" type="text" class="input input-sm input-bordered font-bold" onkeyup="formatCurrencyInput(this)" placeholder="0"/>
             </div>
             <div class="mt-3">
                 <label class="flex items-center gap-2 cursor-pointer border p-2 rounded">
                     <input id="add-frontage" type="checkbox" class="checkbox checkbox-sm checkbox-primary" />
                     <span class="text-sm font-medium">Nhà mặt tiền</span>
                 </label>
             </div>
          </div>
          <div>
             <div class="grid grid-cols-3 gap-2 mb-2">
                 <div><span class="text-xs">DT (m²)</span><input id="add-area" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">Ngang</span><input id="add-width" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">Dài</span><input id="add-length" type="number" class="input input-sm input-bordered w-full"/></div>
             </div>
             <div class="grid grid-cols-3 gap-2 mb-2">
                 <div><span class="text-xs">Tầng</span><input id="add-floors" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">PN</span><input id="add-bedrooms" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">WC</span><input id="add-wc" type="number" class="input input-sm input-bordered w-full"/></div>
             </div>
             <div class="form-control mb-2">
                 <span class="text-xs">Kết cấu</span>
                 <input id="add-ket-cau" type="text" class="input input-sm input-bordered" placeholder="VD: Trệt 3 lầu..."/>
             </div>
             <div class="form-control mb-2">
                 <span class="text-xs font-bold text-error">SĐT Chủ (Admin xem)</span>
                 <input id="add-contact-phone" type="text" class="input input-sm input-bordered input-error" placeholder="090..."/>
             </div>
          </div>
          <div class="md:col-span-2">
              <span class="text-xs">Link ảnh (Mỗi dòng 1 link)</span>
              <textarea id="add-images" class="textarea textarea-bordered w-full h-16 text-xs mb-2" placeholder="http://..."></textarea>
              <span class="text-xs">Mô tả chi tiết</span>
              <textarea id="add-detail" class="textarea textarea-bordered w-full h-20 text-sm"></textarea>
          </div>
      </div>
      <div class="modal-action">
        <button class="btn" onclick="document.getElementById('addDlg').close()">Huỷ</button>
        <button class="btn btn-primary" onclick="saveNewPremise()">Lưu tin</button>
      </div>
    </div>
  </dialog>

  <dialog id="demoNoticeDlg" class="modal">
    <div class="modal-box max-w-md">
      <h3 class="font-bold text-lg mb-2 text-error">Lưu ý: Bản DEMO</h3>
      <p class="text-sm leading-relaxed">
        Đây là bản <b>DEMO</b> nên còn nhiều lỗi, chức năng chưa hoàn thiện.<br/><br/>
        Nếu anh/chị có thắc mắc, phát hiện lỗi hoặc có đề xuất cải tiến trang web,
        xin vui lòng liên hệ Team <b>"Văn Hóa"</b> để được hỗ trợ.
      </p>
      <div class="mt-4 flex justify-end gap-2">
        <button id="btn-demo-disagree" class="btn btn-outline btn-sm">
          toi khong dong tinh
        </button>
        <button id="btn-demo-agree" class="btn btn-primary btn-sm">
          toi dong tinh
        </button>
      </div>
    </div>
  </dialog>

  <div id="toast" class="toast toast-end z-50 hidden">
    <div class="alert alert-info text-sm" id="toast-text"></div>
  </div>

  <script>
    // ===== 1. CONFIG =====
    const SUPABASE_URL = "https://xclncowkoedwqzcemhei.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbG5jb3drb2Vkd3F6Y2VtaGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNzcwOTUsImV4cCI6MjA3Nzg1MzA5NX0.jfNM46UgXIq9LrwSXcERJJULeKB7bl_c9R9LaVhRy1A";
    const STORAGE_BUCKET = "premise-images";
    const PAGE_SIZE = 24;

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- DỮ LIỆU QUẬN/PHƯỜNG CHO FORM THÊM MỚI (Cần dữ liệu để chọn) ---
    const HCM_DATA = {
        "Quận 1": ["Bến Nghé", "Bến Thành", "Cô Giang", "Cầu Kho", "Cầu Ông Lãnh", "Đa Kao", "Nguyễn Cư Trinh", "Nguyễn Thái Bình", "Phạm Ngũ Lão", "Tân Định"],
        "Quận 2": [
          "Thảo Điền",
          "An Phú",
          "Bình An",
          "Bình Trưng Đông",
          "Bình Trưng Tây",
          "An Khánh",
          "Cát Lái",
          "Thạnh Mỹ Lợi",
          "Thủ Thiêm"
        ],

        "Quận 3": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Võ Thị Sáu"],
        "Quận 4": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 6", "Phường 8", "Phường 9", "Phường 10", "Phường 13", "Phường 14", "Phường 15", "Phường 16", "Phường 18"],
        "Quận 5": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14"],
        "Quận 6": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14"],
        "Quận 7": ["Bình Thuận", "Phú Mỹ", "Phú Thuận", "Tân Hưng", "Tân Kiểng", "Tân Phong", "Tân Phú", "Tân Quy", "Tân Thuận Đông", "Tân Thuận Tây"],
        "Quận 8": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Phường 15", "Phường 16"],
        "Quận 9": [
            "Hiệp Phú",
            "Linh Trung",
            "Linh Chiểu",
            "Linh Tây",
            "Linh Đông",
            "Linh Xuân",
            "Tăng Nhơn Phú A",
            "Tăng Nhơn Phú B",
            "Phước Long A",
            "Phước Long B",
            "Tân Phú",
            "Phước Bình",
            "Long Thạnh Mỹ",
            "Trường Thạnh",
            "Long Phước",
            "Long Bình",
            "Phú Hữu"
        ],
        "Quận 10": ["Phường 1", "Phường 2", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Phường 15"],
        "Quận 11": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Phường 15", "Phường 16"],
        "Quận 12": ["An Phú Đông", "Đông Hưng Thuận", "Hiệp Thành", "Tân Chánh Hiệp", "Tân Hưng Thuận", "Tân Thới Hiệp", "Tân Thới Nhất", "Thạnh Lộc", "Thạnh Xuân", "Thới An", "Trung Mỹ Tây"],
        "Bình Tân": ["An Lạc", "An Lạc A", "Bình Hưng Hòa", "Bình Hưng Hòa A", "Bình Hưng Hòa B", "Bình Trị Đông", "Bình Trị Đông A", "Bình Trị Đông B", "Tân Tạo", "Tân Tạo A"],
        "Bình Thạnh": ["Phường 1", "Phường 2", "Phường 3", "Phường 5", "Phường 6", "Phường 7", "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Phường 15", "Phường 17", "Phường 19", "Phường 21", "Phường 22", "Phường 24", "Phường 25", "Phường 26", "Phường 27", "Phường 28"],
        "Gò Vấp": ["Phường 1", "Phường 3", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Phường 15", "Phường 16", "Phường 17"],
        "Phú Nhuận": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 13", "Phường 15", "Phường 17"],
        "Tân Bình": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Phường 15"],
        "Tân Phú": ["Hiệp Tân", "Hòa Thạnh", "Phú Thạnh", "Phú Thọ Hòa", "Phú Trung", "Sơn Kỳ", "Tân Quý", "Tân Sơn Nhì", "Tân Thành", "Tân Thới Hòa", "Tây Thạnh"],
        "Thủ Đức": ["An Khánh", "An Lợi Đông", "An Phú", "Bình Chiểu", "Bình Thọ", "Bình Trưng Đông", "Bình Trưng Tây", "Cát Lái", "Hiệp Bình Chánh", "Hiệp Bình Phước", "Linh Chiểu", "Linh Đông", "Linh Tây", "Linh Trung", "Linh Xuân", "Long Bình", "Long Phước", "Long Thạnh Mỹ", "Long Trường", "Phú Hữu", "Phước Bình", "Phước Long A", "Phước Long B", "Tam Bình", "Tam Phú", "Tân Phú", "Tăng Nhơn Phú A", "Tăng Nhơn Phú B", "Thảo Điền", "Thạnh Mỹ Lợi", "Thủ Thiêm", "Trường Thạnh", "Trường Thọ"]
    };

    let CURRENT_USER = null;
    let CURRENT_ROLE = "staff";
    let PAGE = 0;
    let TOTAL_COUNT = 0;
    let LAST_ROWS = [];
    let EDITING_ID = null;
    
    // BIẾN MỚI CHO ADMIN DUYỆT BÀI
    let SHOW_PENDING = false;

    // ===== HELPERS =====
    function toast(msg) {
      const toastEl = document.getElementById("toast");
      const textEl = document.getElementById("toast-text");
      textEl.textContent = msg;
      toastEl.classList.remove("hidden");
      setTimeout(() => toastEl.classList.add("hidden"), 2500);
    }

    function money(v) {
      if (v == null || isNaN(v)) return "";
      return new Intl.NumberFormat("vi-VN").format(v) + " đ";
    }

    function formatDateVN(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleDateString("vi-VN");
    }

    function pickField(obj, names) {
      for (const n of names) {
        if (obj && obj[n] !== undefined && obj[n] !== null && obj[n] !== "") {
          return obj[n];
        }
      }
      return null;
    }

    function isAdmin() { return CURRENT_ROLE === "admin"; }
    function isStaff() { return CURRENT_ROLE === "staff"; }

    function maskAddress(row) {
      const full = row.address || "";
      // NẾU LÀ ADMIN THÌ HIỆN HẾT
      if (isAdmin()) return full || row.street; 

      if (!isStaff()) return full || [row.street, row.ward, row.district].filter(Boolean).join(", ");

      if (full) {
        const parts = full.split(" ");
        if (parts.length > 1) {
          parts.shift();
          return parts.join(" ");
        }
        return full;
      }
      return [row.street, row.ward, row.district].filter(Boolean).join(", ");
    }

    function buildImageUrl(path) {
      if (!path) return null;
      if (path.startsWith('http')) return path; // Hỗ trợ link đầy đủ
      const { data } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(path);
      return data?.publicUrl || null;
    }

    function formatCurrencyInput(el) {
        let val = el.value.replace(/\D/g, '');
        if(val) el.value = new Intl.NumberFormat('vi-VN').format(val);
    }

    // ===== AUTH =====
    async function initAuth() {
      const { data } = await supabase.auth.getUser();
      if (!data.user) {
        document.getElementById("auth-section").classList.remove("hidden");
        document.getElementById("app-root").classList.add("hidden");
        return;
      }
      CURRENT_USER = data.user;

      // --- LẤY ROLE TỪ BẢNG PROFILES ---
      let role = "staff";
      let userEmail = CURRENT_USER.email;
      const { data: profile } = await supabase
        .from("profiles")
        .select("role, email")
        .eq("id", CURRENT_USER.id)
        .maybeSingle();
      
      if (profile) {
          if (profile.role) role = profile.role;
          if (profile.email) userEmail = profile.email;
      }
      CURRENT_ROLE = role;

      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("app-root").classList.remove("hidden");
      
      // Hiển thị tên/role
      document.getElementById("user-email-display").textContent = userEmail;
      document.getElementById("role-badge").textContent = (role === "admin" ? "Admin" : "Nhân sự");
      if (isAdmin()) document.getElementById("role-badge").className = "badge badge-error text-white";

      // Nút chức năng
      // Nếu là Admin -> hiện nút duyệt bài
      if (isAdmin()) {
        document.getElementById("admin-pending-controls").classList.remove("hidden");
        checkPendingCount();
      }

      await applyFilters(true);
      await buildDistrictWardOptions();
      initAddFormDropdowns(); // Khởi tạo dropdown cho form thêm mới
    }

    
    function showDemoNotice() {
      const dlg = document.getElementById("demoNoticeDlg");
      if (dlg && typeof dlg.showModal === "function") {
        dlg.showModal();
      }
    }

    async function handleLogin() {
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value.trim();
      if (!email || !password) {
        toast("Vui lòng nhập email & mật khẩu");
        return;
      }
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        console.error(error);
        toast("Đăng nhập thất bại: " + error.message);
        return;
      }
      toast("Đăng nhập thành công");
      showDemoNotice();
      await initAuth();
    }

    
    async function handleLogout() {
      await supabase.auth.signOut();
      location.reload();
    }

    // ===== FILTERS =====
    function getFilterValues() {
      return {
        keyword: document.getElementById("filter-keyword").value.trim(),
        district: document.getElementById("filter-district").value,
        ward: document.getElementById("filter-ward").value,
        priceMin: Number(document.getElementById("filter-price-min").value) || null,
        priceMax: Number(document.getElementById("filter-price-max").value) || null,
        areaMin: Number(document.getElementById("filter-area-min").value) || null,
        areaMax: Number(document.getElementById("filter-area-max").value) || null,
        pn: document.getElementById("filter-pn").value,
        wc: document.getElementById("filter-wc").value,
        floors: document.getElementById("filter-floors").value,
        frontageType: document.getElementById("filter-frontage-type").value,
        status: document.getElementById("filter-status").value,
      };
    }

    // --- HÀM TẢI DỮ LIỆU CHÍNH (Đã sửa lỗi JOIN) ---
    async function applyFilters(resetPage = false) {
      if (resetPage) PAGE = 0;

      const f = getFilterValues();

      // THỬ LẤY DỮ LIỆU + JOIN PROFILES (Lấy email người tạo)
      let query = supabase
        .from("premises")
        .select("*, profiles(email)", { count: "exact" });

      // --- LOGIC DUYỆT BÀI ---
      if (SHOW_PENDING && isAdmin()) {
          query = query.eq("is_approved", false);
      } else {
          query = query.eq("is_approved", true);
      }

      // --- ÁP DỤNG FILTER ---
      if (f.keyword) {
        const kw = "%" + f.keyword + "%";
        query = query.or(`address.ilike.${kw},street.ilike.${kw},ward.ilike.${kw},district.ilike.${kw},code.ilike.${kw}`);
      }
      if (f.district) query = query.eq("district", f.district);
      if (f.ward) query = query.eq("ward", f.ward);
      if (f.status) query = query.eq("status", f.status);

      if (f.priceMin != null) query = query.gte("price", f.priceMin * 1000000); // Nhân 1tr vì input là đơn vị triệu
      if (f.priceMax != null) query = query.lte("price", f.priceMax * 1000000);
      if (f.areaMin != null) query = query.gte("area", f.areaMin);
      if (f.areaMax != null) query = query.lte("area", f.areaMax);

      if (f.pn) {
        if (f.pn.includes(">")) query = query.gt("pn", parseInt(f.pn.replace(">","")));
        else query = query.eq("pn", parseInt(f.pn));
      }
      if (f.wc) {
        if (f.wc.includes(">")) query = query.gt("wc", parseInt(f.wc.replace(">","")));
        else query = query.eq("wc", parseInt(f.wc));
      }
      if (f.floors) {
        if (f.floors.includes(">")) query = query.gt("floors", parseInt(f.floors.replace(">","")));
        else query = query.eq("floors", parseInt(f.floors));
      }
      if (f.frontageType === "mt") {
        query = query.eq("frontage", true);
      }

      const from = PAGE * PAGE_SIZE;
      const to = from + PAGE_SIZE - 1;

      query = query
        .order("updated_at", { ascending: false })
        .order("created_at", { ascending: false })
        .range(from, to);

      let { data, error, count } = await query;

      // --- CƠ CHẾ TỰ SỬA LỖI (NẾU DB CHƯA FIX JOIN) ---
      if (error && error.message.includes("profiles")) {
         console.warn("Lỗi lấy tên người đăng (Join Profiles). Đang tải lại chế độ an toàn...");
         // Thử tải lại KHÔNG join profiles
         let safeQuery = supabase.from("premises").select("*", { count: "exact" });
         // (Lặp lại filter logic ngắn gọn để code chạy được)
         if (SHOW_PENDING && isAdmin()) safeQuery = safeQuery.eq("is_approved", false);
         else safeQuery = safeQuery.eq("is_approved", true);
         
         safeQuery = safeQuery.order("created_at", { ascending: false }).range(from, to);
         const res = await safeQuery;
         data = res.data;
         error = res.error;
         count = res.count;
      }

      if (error) {
        console.error(error);
        toast("Không tải được dữ liệu: " + error.message);
        return;
      }

      let rows = data || [];

      // Client filter: Hẻm / HXH
      if (f.frontageType === "hem" || f.frontageType === "hxh") {
        rows = rows.filter((row) => {
          const isFront = row.frontage === true;
          const txt = ((row.address || "") + " " + (row.detail || "")).toLowerCase();
          if (f.frontageType === "hxh") {
            if (isFront) return false;
            return txt.includes("hxh") || txt.includes("xe hơi");
          }
          if (f.frontageType === "hem") {
            if (isFront) return false;
            if (txt.includes("hxh") || txt.includes("hẻm xe hơi")) return false;
            return true;
          }
          return true;
        });
      }

      LAST_ROWS = rows;
      TOTAL_COUNT = count || rows.length;

      if (PAGE === 0) {
        renderCards(LAST_ROWS, true);
      } else {
        renderCards(LAST_ROWS, false);
      }

      document.getElementById("count-total").textContent = TOTAL_COUNT;
      document.getElementById("count-show").textContent = Math.min(
        (PAGE + 1) * PAGE_SIZE,
        TOTAL_COUNT
      );

      const btnMore = document.getElementById("btn-load-more");
      if ((PAGE + 1) * PAGE_SIZE >= TOTAL_COUNT) {
        btnMore.textContent = "Hết dữ liệu";
        btnMore.classList.add("btn-disabled");
      } else {
        btnMore.textContent = "Tải thêm";
        btnMore.classList.remove("btn-disabled");
      }
    }

    function renderCards(rows, replace) {
      const grid = document.getElementById("grid");
      if (replace) grid.innerHTML = "";

      if (!rows || rows.length === 0) {
        if (PAGE === 0) {
          grid.innerHTML =
            `<div class="col-span-full text-center text-sm opacity-70 py-10">
              Chưa có mặt bằng nào khớp bộ lọc hiện tại.
            </div>`;
        }
        return;
      }

      const html = rows.map((row) => {
        const hasImages = Array.isArray(row.images) && row.images.length > 0;
        const firstPath = hasImages ? row.images[0] : null;
        const imgUrl = firstPath ? buildImageUrl(firstPath) : null;

        const pnVal = pickField(row, ["pn", "so_pn", "bedrooms", "rooms"]);
        const wcVal = pickField(row, ["wc", "bathrooms"]);
        const floorsVal = pickField(row, ["floors"]);
        const updatedLabel = formatDateVN(row.updated_at || row.created_at);
        
        // Lấy tên người đăng (nếu có)
        const creatorEmail = row.profiles?.email || "";
        const shortName = creatorEmail.split("@")[0];

        // --- BADGE VỊ TRÍ ---
        let locationBadge = "";
        if (row.frontage === true) {
            locationBadge = `<span class="badge badge-xs badge-error text-white border-none">Mặt tiền</span>`;
        } else {
            const fullText = ((row.address || "") + " " + (row.detail || "") + " " + (row.ket_cau || "")).toLowerCase();
            if (fullText.includes("hxh") || fullText.includes("hẻm xe hơi") || fullText.includes("xe tải")) {
                locationBadge = `<span class="badge badge-xs badge-info text-white border-none">Hẻm xe hơi</span>`;
            } else {
                locationBadge = `<span class="badge badge-xs badge-ghost border-none opacity-70">Nhà hẻm</span>`;
            }
        }
        
        // --- NÚT DUYỆT (NẾU ADMIN ĐANG Ở CHẾ ĐỘ PENDING) ---
        let approveBtn = "";
        if (SHOW_PENDING && isAdmin()) {
            approveBtn = `<button onclick="approveOne('${row.id}', event)" class="btn btn-xs btn-success w-full mt-2 text-white">✔ Duyệt ngay</button>`;
        }

        return `
          <article class="card bg-base-100 border border-base-200 shadow-sm hover:shadow-md transition-all cursor-pointer premise-card overflow-hidden" data-id="${row.id}">
            <figure class="h-52 bg-base-200 flex items-center justify-center relative">
              ${
                imgUrl
                  ? `<img src="${imgUrl}" alt="${row.address || ""}" class="w-full h-full object-cover" />`
                  : `<div class="text-xs opacity-60">(Không có ảnh)</div>`
              }
               <div class="absolute top-2 right-2 shadow-sm">${locationBadge}</div>
               
               <div class="absolute bottom-0 left-0 w-full bg-black/50 text-white text-[10px] p-1 px-2 truncate">
                  Đăng bởi: <b>${shortName || 'Ẩn danh'}</b>
               </div>
            </figure>
            <div class="card-body p-4 gap-2">
              <h3 class="font-semibold text-sm line-clamp-2">${maskAddress(row)}</h3>
              
              <div class="flex items-center flex-wrap gap-2 text-[11px] opacity-70">
                <span>${[row.ward, row.district].filter(Boolean).join(" • ")}</span>
              </div>

              <div class="flex flex-wrap items-center gap-2 text-[11px] mt-1">
                ${row.area ? `<span>${row.area} m²</span>` : ""}
                ${row.width && row.length ? `<span>${row.width}×${row.length} m</span>` : ""}
                ${pnVal ? `<span>${pnVal} PN</span>` : ""}
                ${wcVal ? `<span>${wcVal} WC</span>` : ""}
                ${floorsVal ? `<span>${floorsVal} tầng</span>` : ""}
              </div>
              
              <div class="flex items-center justify-between mt-1">
                <div class="text-primary font-extrabold text-lg">${money(row.price)}</div>
                <div class="text-[10px] opacity-60">${updatedLabel}</div>
              </div>
              
              ${approveBtn}
            </div>
          </article>
        `;
      });

      grid.insertAdjacentHTML("beforeend", html.join(""));

      grid.querySelectorAll("[data-id]").forEach((el) => {
        el.onclick = () => openDetail(el.getAttribute("data-id"));
      });
    }

    // === HÀM MỚI: LẤY QUẬN TỪ HCM_DATA ===
    async function buildDistrictWardOptions() {
      // Lấy danh sách quận chuẩn từ HCM_DATA (không trùng, không quận ảo)
      const selectDistrict = document.getElementById("filter-district");
      const current = selectDistrict.value;

      const districts = Object.keys(HCM_DATA).sort((a, b) =>
        a.localeCompare(b, "vi")
      );

      selectDistrict.innerHTML = '<option value="">Tất cả</option>';
      districts.forEach((d) => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        selectDistrict.appendChild(opt);
      });

      // Giữ lại quận đang chọn nếu còn tồn tại
      if (current && districts.includes(current)) {
        selectDistrict.value = current;
      }

      updateWardOptions();
    }

    // === HÀM MỚI: LỌC PHƯỜNG THEO QUẬN TỪ HCM_DATA ===
    function updateWardOptions() {
      const district = document.getElementById("filter-district").value;
      const selectWard = document.getElementById("filter-ward");
      selectWard.innerHTML = '<option value="">Tất cả</option>';

      if (!district || !HCM_DATA[district]) return;

      const wards = HCM_DATA[district];
      wards.forEach((w) => {
        const opt = document.createElement("option");
        opt.value = w;
        opt.textContent = w;
        selectWard.appendChild(opt);
      });
    }

    // ===== CHI TIẾT & SỬA =====
    async function openDetail(id) {
      const dlg = document.getElementById("detailDlg");
      const wrap = document.getElementById("detail-content");
      wrap.innerHTML = `<div class="py-10 text-center text-sm opacity-70">Đang tải...</div>`;
      dlg.showModal();

      const { data, error } = await supabase
        .from("premises")
        .select("*")
        .eq("id", id)
        .single();

      if (error || !data) {
        console.error(error);
        wrap.innerHTML = `<div class="py-10 text-center text-sm text-error">Không tải được dữ liệu.</div>`;
        return;
      }

      const item = data;

      // ===== LẤY THÔNG TIN CƠ BẢN =====
      const pnVal = pickField(item, ["pn", "so_pn", "bedrooms", "rooms"]);
      const wcVal = pickField(item, ["wc", "bathrooms"]);
      const floorsVal = pickField(item, ["floors"]);
      const detailText =
        pickField(item, [
          "detail",
          "thong_tin_chi_tiet",
          "chi_tiet",
          "description",
          "info_detail",
        ]) || "";

      const updatedLabel = formatDateVN(item.updated_at || item.created_at);
      const price =
        typeof item.price === "number"
          ? new Intl.NumberFormat("vi-VN").format(item.price) + " đ/tháng"
          : "";
      const area =
        typeof item.area === "number" ? item.area + " m²" : "";
      const address =
        item.address ||
        [item.street, item.ward, item.district, item.city]
          .filter(Boolean)
          .join(", ");

      // ===== XỬ LÝ HÌNH ẢNH: ARRAY / JSON / CHUỖI NGĂN CÁCH ; , \n =====
      let rawImgs = item.images;
      let imgPaths = [];

      if (Array.isArray(rawImgs)) {
        imgPaths = rawImgs;
      } else if (typeof rawImgs === "string" && rawImgs.trim()) {
        const s = rawImgs.trim();
        try {
          if (s.startsWith("[") && s.endsWith("]")) {
            const parsed = JSON.parse(s);
            if (Array.isArray(parsed)) imgPaths = parsed;
          } else {
            imgPaths = s.split(/[\n;,]+/);
          }
        } catch (e) {
          console.warn("parse images error", e);
          imgPaths = s.split(/[\n;,]+/);
        }
      }

      // làm sạch path + log ra để debug
      imgPaths = (imgPaths || [])
        .map((p) => (p || "").trim())
        .filter(Boolean);

      const imgUrls = imgPaths
        .map((p) => buildImageUrl(p))
        .filter(Boolean);

      console.log("IMAGES for", item.code || item.id, { imgPaths, imgUrls });


      // ===== MAP EMBED =====
      const mapsQuery = encodeURIComponent(
        [item.address, item.ward, item.district, item.city]
          .filter(Boolean)
          .join(", ")
      );
      const mapEmbed = `
        <iframe
          class="w-full h-64 border-0 rounded-xl"
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"
          src="https://www.google.com/maps?q=${mapsQuery}&output=embed">
        </iframe>
      `;

      // ===== ACTION BUTTONS =====
      const actions = `
        <div class="join join-horizontal flex flex-wrap gap-2">
          ${
            item.contact_phone && !isStaff()
              ? `<a class="btn btn-sm join-item" href="tel:${item.contact_phone}">Gọi</a>`
              : ""
          }
          ${
            item.contact_phone && !isStaff()
              ? `<a class="btn btn-sm join-item" target="_blank"
                     href="https://zalo.me/${(item.contact_phone || "")
                       .replace(/[^0-9]/g, "")}">
                    Zalo
                 </a>`
              : ""
          }
          <a class="btn btn-sm join-item" target="_blank"
             href="https://www.google.com/maps/search/?api=1&query=${mapsQuery}">
            Mở Map
          </a>
          <button
            class="btn btn-sm join-item"
            onclick="navigator.clipboard.writeText(window.location.origin + window.location.pathname + '?id=${encodeURIComponent(
              id
            )}');toast('Đã copy link')">
            Copy link
          </button>
          ${
            isAdmin()
              ? `<button class="btn btn-outline btn-sm join-item"
                         onclick="openEditPremise('${id}')">
                   Sửa
                 </button>`
              : ""
          }
        </div>
      `;

      // ===== HTML HIỂN THỊ CHI TIẾT + GALLERY =====
      const html = `
        <div class="relative">
          <button
            onclick="document.getElementById('detail-modal').classList.add('hidden')"
            class="absolute top-3 right-3 z-50 w-9 h-9 flex items-center justify-center
                   bg-white rounded-full shadow hover:bg-gray-200 transition"
          >
            ✕
          </button>

          <div class="grid md:grid-cols-2 gap-6">

          <!-- CỘT HÌNH ẢNH -->
          <div class="space-y-3">
            <div class="w-full h-[340px] bg-base-200 flex items-center justify-center rounded-xl overflow-hidden">
              ${
                imgUrls.length
                  ? `<img id="detail-main-img" src="${imgUrls[0]}" class="w-full h-full object-cover" />`
                  : `<div class="text-xs text-gray-500 italic">Chưa có hình ảnh</div>`
              }
            </div>

            ${
              imgUrls.length > 1
                ? `
                  <div class="grid grid-cols-4 gap-2">
                    ${imgUrls
                      .slice(0, 8)
                      .map(
                        (url) => `
                      <div
                        class="cursor-pointer border border-base-200 rounded-lg overflow-hidden hover:border-primary"
                        onclick="(function(){
                          const m = document.getElementById('detail-main-img');
                          if (m) m.src='${url.replace(/'/g, "\\'")}';
                        })()">
                        <img src="${url}" class="w-full h-16 object-cover" />
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                `
                : ""
            }

            ${mapEmbed}
          </div>

          <!-- CỘT THÔNG TIN -->
          <div class="space-y-3 text-sm">
            <div>
              <h3 class="font-semibold text-lg mb-1">
                ${item.street || "(Không có tiêu đề)"}
              </h3>
              <p class="text-gray-600">${address || ""}</p>
            </div>

            <div class="flex flex-wrap gap-2 text-xs">
              ${
                price
                  ? `<span class="badge badge-primary badge-outline">Giá: ${price}</span>`
                  : ""
              }
              ${
                area
                  ? `<span class="badge badge-outline">Diện tích: ${area}</span>`
                  : ""
              }
              ${
                floorsVal
                  ? `<span class="badge badge-outline">Tầng: ${floorsVal}</span>`
                  : ""
              }
              ${
                pnVal
                  ? `<span class="badge badge-outline">PN: ${pnVal}</span>`
                  : ""
              }
              ${
                wcVal
                  ? `<span class="badge badge-outline">WC: ${wcVal}</span>`
                  : ""
              }
              ${
                item.status
                  ? `<span class="badge badge-outline">Trạng thái: ${item.status}</span>`
                  : ""
              }
            </div>

            <div class="text-xs text-gray-500">
              ${
                item.code
                  ? `Mã: <span class="font-mono">${item.code}</span><br/>`
                  : ""
              }
              ${updatedLabel ? `Cập nhật: ${updatedLabel}` : ""}
            </div>

            <div class="grid grid-cols-2 gap-2 text-sm mt-2">
              <div>Diện tích: <b>${item.area ?? '-'} m²</b></div>
              <div>Tầng: <b>${floorsVal ?? '-'}</b></div>

              <div>Ngang: <b>${item.width ?? '-'} m</b></div>
              <div>Dài: <b>${item.length ?? '-'} m</b></div>

              <div>PN: <b>${pnVal ?? '-'}</b></div>
              <div>WC: <b>${wcVal ?? '-'}</b></div>

              <div>Kết cấu: <b>${item.ket_cau || '-'}</b></div>
              <div>Hoa hồng: <b>${item.commission_note || '-'}</b></div>

              <div>Hướng: <b>${item.frontage ? 'Mặt tiền' : 'Hẻm'}</b></div>
            </div>

            ${
              item.contact_phone && !isStaff()
                ? `
                <div class="mt-2 text-sm">
                  Liên hệ: ${
                    item.contact_name
                      ? `<b>${item.contact_name}</b> - `
                      : ""
                  }${item.contact_phone}
                </div>
              `
                : ""
            }

            <div class="mt-4">
              <div class="font-semibold mb-1">Chi tiết:</div>
              <p class="whitespace-pre-line text-gray-700">
                ${detailText || "(Chưa có mô tả chi tiết)"}
              </p>
            </div>

            <div class="mt-4">
              ${actions}
            </div>
          </div>
        </div>
        </div>
      `;

      wrap.innerHTML = html;
    }

    async function openEditPremise(id) {
      if (!isAdmin()) {
        toast("Chỉ admin mới được sửa mặt bằng");
        return;
      }

      EDITING_ID = id;
      const dlg = document.getElementById("editDlg");

      const { data, error } = await supabase
        .from("premises")
        .select("*")
        .eq("id", id)
        .single();

      if (error || !data) {
        console.error(error);
        toast("Không tải được dữ liệu để sửa");
        return;
      }

      const item = data;
      const setVal = (elId, val) => {
        const el = document.getElementById(elId);
        if (el) el.value = val == null ? "" : String(val);
      };

      // điền dữ liệu vào form edit
      setVal("edit-code", item.code || "");
      setVal("edit-address", item.address || "");
      setVal("edit-city", item.city || "TP.HCM");
      setVal("edit-district", item.district || "");
      setVal("edit-ward", item.ward || "");
      setVal("edit-street", item.street || "");

      setVal("edit-price", item.price ?? "");
      setVal("edit-area", item.area ?? "");
      setVal("edit-width", item.width ?? "");
      setVal("edit-length", item.length ?? "");
      setVal("edit-floors", item.floors ?? "");
      setVal("edit-bedrooms", item.pn ?? item.bedrooms ?? "");
      setVal("edit-wc", item.wc ?? "");
      setVal("edit-ket-cau", item.ket_cau || "");
      setVal("edit-contact-phone", item.contact_phone || "");
      setVal("edit-commission", item.commission_note || "");
      setVal("edit-detail", item.detail || "");

      const statusSelect = document.getElementById("edit-status");
      if (statusSelect) {
        statusSelect.value = item.status || "available";
      }

      const frontageCheckbox = document.getElementById("edit-frontage");
      if (frontageCheckbox) {
        frontageCheckbox.checked = !!item.frontage;
      }

      // xử lý field images: array / json / string
      let rawImgs = item.images;
      let imgPaths = [];

      if (Array.isArray(rawImgs)) {
        imgPaths = rawImgs;
      } else if (typeof rawImgs === "string" && rawImgs.trim()) {
        const s = rawImgs.trim();
        try {
          if (s.startsWith("[") && s.endsWith("]")) {
            const parsed = JSON.parse(s);
            if (Array.isArray(parsed)) imgPaths = parsed;
          } else {
            imgPaths = s.split(/[\n;,]+/);
          }
        } catch (e) {
          console.warn("parse images error in edit", e);
          imgPaths = s.split(/[\n;,]+/);
        }
      }

      const imagesTextarea = document.getElementById("edit-images");
      if (imagesTextarea) {
        imagesTextarea.value = (imgPaths || [])
          .map((p) => (p || "").trim())
          .filter(Boolean)
          .join("\n");
      }

      dlg.showModal();
    }
    
    async function saveEditPremise() {
      if (!isAdmin() || !EDITING_ID) return;
      const getVal = (id) => document.getElementById(id).value.trim();
      const getNum = (id) => { const v = getVal(id).replace(/[^\d.]/g, ""); return v ? Number(v) : 0; };

      const payload = {
        code: getVal("edit-code"),
        address: getVal("edit-address"),
        city: getVal("edit-city"),
        district: getVal("edit-district"),
        ward: getVal("edit-ward"),
        street: getVal("edit-street"),
        price: getNum("edit-price"),
        area: getNum("edit-area"),
        width: getNum("edit-width"),
        length: getNum("edit-length"),
        floors: getNum("edit-floors"),
        pn: getNum("edit-bedrooms"),
        wc: getNum("edit-wc"),
        ket_cau: getVal("edit-ket-cau"),
        contact_phone: getVal("edit-contact-phone"),
        frontage: document.getElementById("edit-frontage").checked,
        status: getVal("edit-status"),
        commission_note: getVal("edit-commission"),
        images: getVal("edit-images").split("\n").map(s => s.trim()).filter(Boolean),
        detail: getVal("edit-detail"),
        updated_at: new Date().toISOString(),
      };

      const { error } = await supabase.from("premises").update(payload).eq("id", EDITING_ID);
      if (error) { toast("Lỗi: " + error.message); return; }
      toast("Đã lưu thay đổi!");
      document.getElementById("editDlg").close();
      await applyFilters(false);
    }

    // ===== LOGIC THÊM MỚI (MỚI) =====
    function initAddFormDropdowns() {
        const distSelect = document.getElementById("add-district");
        const wardSelect = document.getElementById("add-ward");
        
        // Load Districts
        const dists = Object.keys(HCM_DATA).sort();
        distSelect.innerHTML = `<option value="">-- Chọn --</option>` + dists.map(d => `<option value="${d}">${d}</option>`).join("");
        
        // Event Change
        distSelect.addEventListener("change", () => {
            const val = distSelect.value;
            wardSelect.innerHTML = `<option value="">-- Chọn --</option>`;
            if(HCM_DATA[val]) {
                wardSelect.disabled = false;
                wardSelect.innerHTML += HCM_DATA[val].map(w => `<option value="${w}">${w}</option>`).join("");
            } else {
                wardSelect.disabled = true;
            }
        });
    }

    async function saveNewPremise() {
        const getVal = (id) => document.getElementById(id).value.trim();
        // Lấy giá tiền từ input đã format (xóa dấu chấm/phẩy đi)
        const priceRaw = getVal("add-price").replace(/\D/g,'');
        const priceNum = priceRaw ? parseInt(priceRaw) : 0;

        if (!getVal("add-address") || !getVal("add-district") || !priceNum) {
            toast("Vui lòng nhập: Địa chỉ, Quận và Giá thuê!");
            return;
        }

        const payload = {
            address: getVal("add-address"),
            district: document.getElementById("add-district").value,
            ward: document.getElementById("add-ward").value,
            street: getVal("add-street"),
            price: priceNum,
            area: Number(getVal("add-area")) || null,
            width: Number(getVal("add-width")) || null,
            length: Number(getVal("add-length")) || null,
            floors: Number(getVal("add-floors")) || null,
            pn: Number(getVal("add-bedrooms")) || null,
            wc: Number(getVal("add-wc")) || null,
            ket_cau: getVal("add-ket-cau"),
            contact_phone: getVal("add-contact-phone"),
            frontage: document.getElementById("add-frontage").checked,
            images: getVal("add-images").split('\n').map(s=>s.trim()).filter(Boolean),
            detail: getVal("add-detail"),
            status: 'available'
            // code, created_by, is_approved SẼ ĐƯỢC DB TỰ ĐỘNG XỬ LÝ (NẾU ĐÃ CHẠY SQL)
        };

        const { error } = await supabase.from("premises").insert([payload]);
        if (error) {
            toast("Lỗi: " + error.message);
        } else {
            toast(isAdmin() ? "Đã thêm thành công!" : "Đã gửi duyệt!");
            document.getElementById("addDlg").close();
            applyFilters(true);
            if(isAdmin()) checkPendingCount();
        }
    }

    // ===== LOGIC ADMIN PENDING (MỚI) =====
    async function checkPendingCount() {
        const { count } = await supabase.from("premises").select("*", { count: 'exact', head: true }).eq("is_approved", false);
        const cnt = count || 0;
        document.getElementById("count-pending").textContent = cnt;
        if (cnt > 0 && SHOW_PENDING) document.getElementById("btn-approve-all").classList.remove("hidden");
        else document.getElementById("btn-approve-all").classList.add("hidden");
    }

    function togglePendingMode() {
        SHOW_PENDING = !SHOW_PENDING;
        const btn = document.getElementById("btn-toggle-pending");
        if (SHOW_PENDING) {
            btn.classList.replace("btn-warning", "btn-active");
            btn.textContent = "Đang xem Chờ duyệt (Thoát)";
        } else {
            btn.classList.replace("btn-active", "btn-warning");
            btn.innerHTML = `Cần duyệt <span class="badge badge-sm bg-white text-warning ml-1 border-none" id="count-pending">...</span>`;
            checkPendingCount();
        }
        applyFilters(true);
    }

    async function approveOne(id, e) {
        e.stopPropagation();
        if(!confirm("Duyệt bài này?")) return;
        await supabase.from("premises").update({ is_approved: true }).eq("id", id);
        toast("Đã duyệt!");
        applyFilters(true);
        checkPendingCount();
    }

    async function approveAll() {
        if(!confirm("Duyệt tất cả bài đang chờ?")) return;
        await supabase.from("premises").update({ is_approved: true }).eq("is_approved", false);
        toast("Đã duyệt tất cả!");
        applyFilters(true);
        checkPendingCount();
    }

    // ===== INIT EVENTS =====
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btn-login").addEventListener("click", handleLogin);
      document.getElementById("btn-logout").addEventListener("click", handleLogout);
      
      document.getElementById("btn-apply").addEventListener("click", () => applyFilters(true));
      document.getElementById("btn-reset").addEventListener("click", () => {
         document.querySelectorAll("aside input, aside select").forEach(el => el.value = "");
         applyFilters(true);
      });

      document.getElementById("btn-load-more").addEventListener("click", () => {
          PAGE++; applyFilters(false);
      });

      // Admin / Add Events
      document.getElementById("btn-open-add").onclick = () => document.getElementById("addDlg").showModal();
      document.getElementById("btn-toggle-pending").onclick = togglePendingMode;
      document.getElementById("btn-approve-all").onclick = approveAll;

      // Quick filters
      document.querySelectorAll("[data-quick]").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.getElementById("filter-status").value = btn.getAttribute("data-quick");
          applyFilters(true);
        });
      });
      document.querySelectorAll("[data-quick-district]").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.getElementById("filter-district").value = btn.getAttribute("data-quick-district");
          updateWardOptions(); applyFilters(true);
        });
      });
      document.getElementById("btn-clear-quick").addEventListener("click", () => {
          document.getElementById("filter-status").value = "";
          document.getElementById("filter-district").value = "";
          document.getElementById("filter-ward").value = "";
          applyFilters(true);
      });

      // ===== DEMO NOTICE BUTTONS =====
      const demoAgreeBtn = document.getElementById("btn-demo-agree");
      const demoDisagreeBtn = document.getElementById("btn-demo-disagree");
      const demoDlg = document.getElementById("demoNoticeDlg");

      if (demoAgreeBtn && demoDlg) {
        demoAgreeBtn.addEventListener("click", () => {
          demoDlg.close();
        });
      }

      if (demoDisagreeBtn && demoDlg) {
        demoDisagreeBtn.addEventListener("click", async () => {
          demoDlg.close();
          await supabase.auth.signOut();
          location.reload();
        });
      }

      initAuth();
    });
  </script>
</body>
</html>
