<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>ID-Land Premises</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind + DaisyUI CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: ["class", '[data-theme="dark"]'],
      theme: {
        extend: {
          fontFamily: {
            sans: ['system-ui', 'sans-serif'],
          },
        },
      },
    };
  </script>
  <link
    href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
    rel="stylesheet"
    type="text/css"
  />

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .scrollbar-thin::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 999px;
    }
  </style>
</head>
<body class="bg-base-200 min-h-screen">
  <div id="toast" class="toast toast-top toast-end z-50 hidden">
    <div class="alert alert-info">
      <span id="toast-msg"></span>
    </div>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="flex flex-col min-h-screen">
    <!-- TOP BAR -->
    <header
      class="navbar bg-base-100 border-b border-base-300 sticky top-0 z-40"
    >
      <div class="flex-1">
        <span class="text-xl font-bold text-primary">ID-Land Premises</span>
        <span
          id="pending-badge"
          class="ml-3 badge badge-warning hidden"
        ></span>
      </div>

      <div class="flex-none gap-2 items-center">
        <span id="current-user" class="text-sm text-gray-600 hidden"></span>
        <button
          id="btn-login-open"
          class="btn btn-sm btn-primary"
        >
          Đăng nhập
        </button>
        <button
          id="btn-logout"
          class="btn btn-sm btn-ghost hidden"
        >
          Đăng xuất
        </button>
      </div>
    </header>

    <!-- CONTENT -->
    <div class="flex-1 flex flex-col lg:flex-row">
      <!-- SIDEBAR FILTERS -->
      <aside
        class="w-full lg:w-72 bg-base-100 border-r border-base-300 p-4 space-y-4"
      >
        <h2 class="font-semibold text-lg mb-2">Bộ lọc</h2>

        <!-- QUICK FILTERS -->
        <div class="space-y-2">
          <span class="text-xs font-semibold text-gray-500"
            >Trạng thái nhanh</span
          >
          <div class="flex flex-wrap gap-2">
            <button
              class="btn btn-xs"
              data-quick=""
            >
              Tất cả
            </button>
            <button
              class="btn btn-xs btn-success"
              data-quick="available"
            >
              Còn trống
            </button>
            <button
              class="btn btn-xs btn-warning"
              data-quick="deposited"
            >
              Đã cọc
            </button>
            <button
              class="btn btn-xs btn-error"
              data-quick="rented"
            >
              Đã thuê
            </button>
          </div>
        </div>

        <div class="space-y-2">
          <span class="text-xs font-semibold text-gray-500"
            >Khu vực nhanh</span
          >
          <div class="flex flex-wrap gap-2">
            <button class="btn btn-xs" data-quick-district="">Tất cả</button>
            <button class="btn btn-xs" data-quick-district="Quận 1">Q1</button>
            <button class="btn btn-xs" data-quick-district="Quận 3">Q3</button>
            <button class="btn btn-xs" data-quick-district="Quận 5">Q5</button>
            <button class="btn btn-xs" data-quick-district="Quận 10">Q10</button>
            <button class="btn btn-xs" data-quick-district="Gò Vấp">GV</button>
          </div>
          <button
            id="btn-clear-quick"
            class="btn btn-xs btn-ghost"
          >
            Xóa lọc nhanh
          </button>
        </div>

        <div class="divider my-2"></div>

        <!-- FORM FILTER -->
        <div class="space-y-3">
          <div class="form-control">
            <label class="label">
              <span class="label-text text-sm">Từ khóa (địa chỉ, ghi chú)</span>
            </label>
            <input
              id="filter-q"
              type="text"
              placeholder="VD: Trần Hưng Đạo, spa..."
              class="input input-sm input-bordered"
            />
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Quận</span>
              </label>
              <select
                id="filter-district"
                class="select select-bordered select-sm"
              >
                <option value="">Tất cả</option>
                <option>Quận 1</option>
                <option>Quận 3</option>
                <option>Quận 5</option>
                <option>Quận 10</option>
                <option>Gò Vấp</option>
                <option>Bình Thạnh</option>
                <option>Phú Nhuận</option>
              </select>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Phường</span>
              </label>
              <select
                id="filter-ward"
                class="select select-bordered select-sm"
              >
                <option value="">Tất cả</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Giá từ (triệu)</span>
              </label>
              <input
                id="filter-price-min"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Đến (triệu)</span>
              </label>
              <input
                id="filter-price-max"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Diện tích từ (m²)</span>
              </label>
              <input
                id="filter-area-min"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Đến (m²)</span>
              </label>
              <input
                id="filter-area-max"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <!-- PN / WC / TẦNG -->
          <div class="grid grid-cols-3 gap-2">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Số PN</span>
              </label>
              <select
                id="filter-pn"
                class="select select-bordered select-xs"
              >
                <option value="">Tất cả</option>
                <option value="1">1 PN</option>
                <option value="2">2 PN</option>
                <option value="3">3 PN</option>
                <option value="4">4 PN</option>
                <option value="5">5 PN</option>
                <option value="6">6 PN</option>
                <option value=">6">>6 PN</option>
              </select>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">WC</span>
              </label>
              <select
                id="filter-wc"
                class="select select-bordered select-xs"
              >
                <option value="">Tất cả</option>
                <option value="1">1 WC</option>
                <option value="2">2 WC</option>
                <option value="3">3 WC</option>
                <option value="4">4 WC</option>
                <option value="5">5 WC</option>
                <option value=">5">>5 WC</option>
              </select>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Số tầng</span>
              </label>
              <select
                id="filter-floors"
                class="select select-bordered select-xs"
              >
                <option value="">Tất cả</option>
                <option value="1">1 tầng</option>
                <option value="2">2 tầng</option>
                <option value="3">3 tầng</option>
                <option value="4">4 tầng</option>
                <option value="5">5 tầng</option>
                <option value=">5">>5 tầng</option>
              </select>
            </div>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Trạng thái</span>
            </label>
            <select
              id="filter-status"
              class="select select-bordered select-sm"
            >
              <option value="">Tất cả</option>
              <option value="available">Còn trống</option>
              <option value="deposited">Đã cọc</option>
              <option value="rented">Đã thuê</option>
            </select>
          </div>

          <div class="flex gap-2 pt-2">
            <button
              id="btn-apply"
              class="btn btn-primary btn-sm flex-1"
            >
              Áp dụng
            </button>
            <button
              id="btn-reset"
              class="btn btn-ghost btn-sm"
            >
              Xóa lọc
            </button>
          </div>
        </div>

        <div class="divider my-2"></div>

        <!-- ADMIN PANEL (CHỈ ADMIN MỚI THẤY) -->
        <div id="admin-panel" class="space-y-2 hidden">
          <h3 class="font-semibold text-sm text-primary">Khu vực Admin</h3>
          <p class="text-xs text-gray-500">
            - Thêm mặt bằng mới.<br />
            - Duyệt tin chờ duyệt.<br />
            - Chỉnh sửa full thông tin, số nhà & số chủ.<br />
            Quyền chỉnh sửa dữ liệu.
          </p>
          <div class="space-y-2">
            <button
              id="btn-open-add"
              class="btn btn-sm btn-outline btn-primary w-full"
            >
              + Thêm mặt bằng mới
            </button>
            <button
              id="btn-toggle-pending"
              class="btn btn-sm btn-outline w-full"
            >
              Xem tin CHỜ DUYỆT
            </button>
            <button
              id="btn-approve-all"
              class="btn btn-sm btn-success w-full"
            >
              Duyệt tất cả tin đang xem
            </button>
          </div>
        </div>
      </aside>

      <!-- MAIN LIST -->
      <main class="flex-1 p-4">
        <div
          id="stats-bar"
          class="flex flex-wrap gap-2 mb-3 text-xs text-gray-600"
        ></div>

        <div
          id="premises-list"
          class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3"
        ></div>

        <div class="flex justify-center mt-4">
          <button
            id="btn-load-more"
            class="btn btn-sm btn-outline"
          >
            Tải thêm
          </button>
        </div>
      </main>
    </div>
  </div>

  <!-- DETAIL DIALOG -->
  <dialog id="detailDlg" class="modal">
    <div class="modal-box max-w-2xl">
      <h3 id="detail-title" class="font-bold text-lg mb-2"></h3>
      <p
        id="detail-basic"
        class="text-sm text-gray-700 mb-2"
      ></p>
      <p
        id="detail-extra"
        class="text-sm whitespace-pre-wrap"
      ></p>

      <div
        id="detail-images"
        class="mt-3 grid grid-cols-3 gap-2"
      ></div>

      <div class="modal-action">
        <button
          class="btn btn-sm"
          onclick="document.getElementById('detailDlg').close()"
        >
          Đóng
        </button>
      </div>
    </div>
  </dialog>

  <!-- EDIT DIALOG -->
  <dialog id="editDlg" class="modal">
    <div class="modal-box max-w-3xl">
      <h3 class="font-bold text-lg mb-4">Chỉnh sửa mặt bằng</h3>
      <div
        id="edit-form"
        class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto pr-2 scrollbar-thin"
      >
        <!-- Cột 1 -->
        <div class="space-y-2">
          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Mã (code)</span>
            </label>
            <input
              id="edit-code"
              class="input input-sm input-bordered"
            />
            <span class="text-[10px] text-gray-500 mt-1"
              >Nếu bỏ trống sẽ dùng ID hệ thống.</span
            >
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Địa chỉ đầy đủ</span>
            </label>
            <input
              id="edit-address"
              class="input input-sm input-bordered"
            />
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Quận</span>
              </label>
              <input
                id="edit-district"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Phường</span>
              </label>
              <input
                id="edit-ward"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Tên đường</span>
            </label>
            <input
              id="edit-street"
              class="input input-sm input-bordered"
            />
          </div>

          <div class="grid grid-cols-3 gap-2">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Chiều ngang (m)</span>
              </label>
              <input
                id="edit-width"
                type="number"
                step="0.1"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Chiều dài (m)</span>
              </label>
              <input
                id="edit-length"
                type="number"
                step="0.1"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Diện tích (m²)</span>
              </label>
              <input
                id="edit-area"
                type="number"
                step="0.1"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <div class="grid grid-cols-3 gap-2">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Số tầng</span>
              </label>
              <input
                id="edit-floors"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Số PN</span>
              </label>
              <input
                id="edit-pn"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">WC</span>
              </label>
              <input
                id="edit-wc"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
          </div>
        </div>

        <!-- Cột 2 -->
        <div class="space-y-2">
          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Giá thuê / tháng (VNĐ)</span>
            </label>
            <input
              id="edit-price"
              class="input input-sm input-bordered"
            />
            <span class="text-[10px] text-gray-500 mt-1"
              >Nhập số hoặc chuỗi có số, hệ thống sẽ tự bóc số.</span
            >
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Trạng thái</span>
            </label>
            <select
              id="edit-status"
              class="select select-bordered select-sm"
            >
              <option value="">(để trống)</option>
              <option value="available">Còn trống</option>
              <option value="deposited">Đã cọc</option>
              <option value="rented">Đã thuê</option>
            </select>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Số chủ nhà</span>
            </label>
            <input
              id="edit-contact-phone"
              class="input input-sm input-bordered"
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Mặt tiền / hẻm</span>
            </label>
            <input
              id="edit-frontage"
              class="input input-sm input-bordered"
              placeholder='VD: "MTKD", "hẻm xe hơi"...'
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Ghi chú hoa hồng</span>
            </label>
            <input
              id="edit-commission"
              class="input input-sm input-bordered"
              placeholder="hoa hồng, thương lượng..."
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Kết cấu</span>
            </label>
            <input
              id="edit-ket-cau"
              class="input input-sm input-bordered"
              placeholder="trệt 3 lầu, 4PN 3WC..."
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Link images (JSON hoặc ;)</span>
            </label>
            <textarea
              id="edit-images"
              class="textarea textarea-xs textarea-bordered h-16"
              placeholder='["url1","url2"] hoặc url1;url2;url3'
            ></textarea>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Ghi chú chi tiết</span>
            </label>
            <textarea
              id="edit-detail"
              class="textarea textarea-xs textarea-bordered h-24"
            ></textarea>
          </div>
        </div>
      </div>

      <div class="modal-action">
        <button
          class="btn btn-sm btn-ghost"
          onclick="document.getElementById('editDlg').close()"
        >
          Hủy
        </button>
        <button
          id="btn-save-edit"
          class="btn btn-sm btn-primary"
        >
          Lưu
        </button>
      </div>
    </div>
  </dialog>

  <!-- ADD DIALOG -->
  <dialog id="addDlg" class="modal">
    <div class="modal-box max-w-3xl">
      <h3 class="font-bold text-lg mb-4">Thêm mặt bằng mới</h3>
      <div
        class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto pr-2 scrollbar-thin"
      >
        <!-- Cột 1 -->
        <div class="space-y-2">
          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Mã (code) (có thể bỏ trống)</span>
            </label>
            <input
              id="add-code"
              class="input input-sm input-bordered"
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Địa chỉ đầy đủ</span>
            </label>
            <input
              id="add-address"
              class="input input-sm input-bordered"
            />
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Quận</span>
              </label>
              <input
                id="add-district"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Phường</span>
              </label>
              <input
                id="add-ward"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Tên đường (để lọc)</span>
            </label>
            <input
              id="add-street"
              class="input input-sm input-bordered"
            />
          </div>

          <div class="grid grid-cols-3 gap-2">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Chiều ngang (m)</span>
              </label>
              <input
                id="add-width"
                type="number"
                step="0.1"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Chiều dài (m)</span>
              </label>
              <input
                id="add-length"
                type="number"
                step="0.1"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Diện tích (m²)</span>
              </label>
              <input
                id="add-area"
                type="number"
                step="0.1"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <div class="grid grid-cols-3 gap-2">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Số tầng</span>
              </label>
              <input
                id="add-floors"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Số PN</span>
              </label>
              <input
                id="add-pn"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">WC</span>
              </label>
              <input
                id="add-wc"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
          </div>
        </div>

        <!-- Cột 2 -->
        <div class="space-y-2">
          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Giá thuê / tháng (VNĐ)</span>
            </label>
            <input
              id="add-price"
              class="input input-sm input-bordered"
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Trạng thái</span>
            </label>
            <select
              id="add-status"
              class="select select-bordered select-sm"
            >
              <option value="">(để trống)</option>
              <option value="available">Còn trống</option>
              <option value="deposited">Đã cọc</option>
              <option value="rented">Đã thuê</option>
            </select>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Số chủ nhà</span>
            </label>
            <input
              id="add-contact-phone"
              class="input input-sm input-bordered"
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Mặt tiền / hẻm</span>
            </label>
            <input
              id="add-frontage"
              class="input input-sm input-bordered"
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Ghi chú hoa hồng</span>
            </label>
            <input
              id="add-commission"
              class="input input-sm input-bordered"
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Kết cấu</span>
            </label>
            <input
              id="add-ket-cau"
              class="input input-sm input-bordered"
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Link images (JSON hoặc ;)</span>
            </label>
            <textarea
              id="add-images"
              class="textarea textarea-xs textarea-bordered h-16"
              placeholder="http://..."
            ></textarea>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text text-xs">Ghi chú chi tiết</span>
            </label>
            <textarea
              id="add-detail"
              class="textarea textarea-xs textarea-bordered h-24"
            ></textarea>
          </div>
        </div>
      </div>

      <div class="modal-action">
        <button
          class="btn btn-sm btn-ghost"
          onclick="document.getElementById('addDlg').close()"
        >
          Hủy
        </button>
        <button
          class="btn btn-sm btn-primary"
          onclick="saveNewPremise()"
        >
          Lưu tin
        </button>
      </div>
    </div>
  </dialog>

  <!-- DEMO NOTICE DIALOG -->
  <dialog id="demoNoticeDlg" class="modal">
    <div class="modal-box max-w-md">
      <h3 class="font-bold text-lg mb-2 text-error">Lưu ý: Bản DEMO</h3>
      <p class="text-sm leading-relaxed">
        Đây là bản <b>DEMO</b> nên còn nhiều lỗi, chức năng chưa hoàn thiện.<br /><br />
        Nếu anh/chị có thắc mắc, phát hiện lỗi hoặc có đề xuất cải tiến trang web,
        xin vui lòng liên hệ Team <b>"Văn Hóa"</b> để được hỗ trợ.
      </p>
      <div class="mt-4 flex justify-end gap-2">
        <button id="btn-demo-disagree" class="btn btn-outline btn-sm">
          toi khong dong tinh
        </button>
        <button id="btn-demo-agree" class="btn btn-primary btn-sm">
          toi dong tinh
        </button>
      </div>
    </div>
  </dialog>

  <!-- LOGIN DIALOG -->
  <dialog id="loginDlg" class="modal">
    <div class="modal-box max-w-sm">
      <h3 class="font-bold text-lg mb-3">Đăng nhập Admin</h3>
      <div class="space-y-3">
        <div class="form-control">
          <label class="label">
            <span class="label-text text-xs">Email</span>
          </label>
          <input
            id="login-email"
            type="email"
            class="input input-sm input-bordered"
          />
        </div>
        <div class="form-control">
          <label class="label">
            <span class="label-text text-xs">Mật khẩu</span>
          </label>
          <input
            id="login-password"
            type="password"
            class="input input-sm input-bordered"
          />
        </div>
      </div>
      <div class="modal-action">
        <button
          class="btn btn-sm btn-ghost"
          onclick="document.getElementById('loginDlg').close()"
        >
          Đóng
        </button>
        <button
          id="btn-login"
          class="btn btn-sm btn-primary"
        >
          Đăng nhập
        </button>
      </div>
    </div>
  </dialog>

  <script>
    const SUPABASE_URL = "https://xclncowkoedwqzcemhei.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbG5jb3drb2Vkd3F6Y2VtaGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNzcwOTUsImV4cCI6MjA3Nzg1MzA5NX0.jfNM46UgXIq9LrwSXcERJJULeKB7bl_c9R9LaVhRy1A";

    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    let PAGE = 0;
    const PAGE_SIZE = 18;
    let LAST_FILTER = null;
    let CURRENT_USER = null;

    let SHOW_PENDING = false;

    function toast(msg) {
      const toastEl = document.getElementById("toast");
      const msgEl = document.getElementById("toast-msg");
      msgEl.textContent = msg;
      toastEl.classList.remove("hidden");
      setTimeout(() => {
        toastEl.classList.add("hidden");
      }, 3000);
    }

    function formatPrice(vnd) {
      if (!vnd || isNaN(vnd)) return "";
      const trieu = vnd / 1_000_000;
      if (trieu >= 100) {
        return (
          trieu.toLocaleString("vi-VN", {
            maximumFractionDigits: 0,
          }) + "tr/tháng"
        );
      }
      return (
        trieu.toLocaleString("vi-VN", {
          maximumFractionDigits: 1,
        }) + "tr/tháng"
      );
    }

    function formatArea(area) {
      if (!area || isNaN(area)) return "";
      return area + " m²";
    }

    function formatStatus(status) {
      if (!status) return "";
      switch (status) {
        case "available":
          return '<span class="badge badge-success badge-sm">Còn trống</span>';
        case "deposited":
          return '<span class="badge badge-warning badge-sm">Đã cọc</span>';
        case "rented":
          return '<span class="badge badge-error badge-sm">Đã thuê</span>';
        default:
          return '<span class="badge badge-ghost badge-sm">' + status + "</span>";
      }
    }

    function pickField(obj, names) {
      for (const n of names) {
        if (obj && obj[n] !== undefined && obj[n] !== null && obj[n] !== "") {
          return obj[n];
        }
      }
      return null;
    }

    function formatDateVN(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleDateString("vi-VN");
    }

    function parseImages(imagesField) {
      if (!imagesField) return [];
      if (Array.isArray(imagesField)) return imagesField;
      const s = imagesField.toString().trim();
      if (!s) return [];
      if (s.startsWith("[") && s.endsWith("]")) {
        try {
          const arr = JSON.parse(s);
          return Array.isArray(arr) ? arr : [];
        } catch (e) {
          console.warn("JSON images parse error", e);
        }
      }
      return s
        .split(";")
        .map((x) => x.trim())
        .filter(Boolean);
    }

    function buildTitle(p) {
      const district = p.district ? p.district.replace(/^Quận\s*/i, "Q.") : "";
      const street = p.street || "";
      const area = p.area ? p.area + "m²" : "";
      const priceText = formatPrice(p.price);
      const parts = [];
      if (street) parts.push(street);
      if (district) parts.push(district);
      if (area) parts.push(area);
      if (priceText) parts.push(priceText);
      return parts.join(" • ");
    }

    function buildShortAddress(p) {
      const address = p.address || "";
      if (!address) return "";
      return address.replace(/,?\s*TP\.?\s*HCM$/i, "");
    }

    function buildCardHtml(p) {
      const title = buildTitle(p);
      const addr = buildShortAddress(p);
      const priceText = formatPrice(p.price);
      const areaText = formatArea(p.area);
      const statusHtml = formatStatus(p.status);

      const createdAt = formatDateVN(p.created_at);
      const code = p.code || p.id || "";
      const pn = p.pn ? p.pn + " PN" : "";
      const wc = p.wc ? p.wc + " WC" : "";
      const floors = p.floors ? p.floors + " tầng" : "";
      const ketCau = p.ket_cau || "";
      const sdt = p.contact_phone || "";

      const infoLine = [floors, pn, wc].filter(Boolean).join(" • ");

      let detailText =
        p.detail ||
        [
          addr,
          p.ward ? "P." + p.ward : "",
          p.district,
          areaText,
          floors,
          priceText,
        ]
          .filter(Boolean)
          .join(" | ");

      let cardHeaderExtra = "";
      if (p.is_approved === false || p.is_approved === "false") {
        cardHeaderExtra =
          '<span class="badge badge-outline badge-warning badge-sm ml-1">Chờ duyệt</span>';
      }

      return `
        <article class="card bg-base-100 shadow-sm hover:shadow-md transition cursor-pointer border border-base-200" data-id="${
          p.id
        }">
          <div class="card-body p-3 flex flex-col h-full">
            <header class="flex items-start justify-between gap-2">
              <div class="flex-1">
                <h3 class="card-title text-sm leading-snug mb-1">
                  ${title || "(Chưa có tiêu đề)"} ${cardHeaderExtra}
                </h3>
                <p class="text-[11px] text-gray-600">${addr || ""}</p>
              </div>
              <div class="text-right text-xs">
                ${
                  priceText
                    ? `<div class="font-semibold text-primary">${priceText}</div>`
                    : ""
                }
                ${
                  areaText
                    ? `<div class="text-[11px] text-gray-500">${areaText}</div>`
                    : ""
                }
                <div class="mt-1">${statusHtml}</div>
              </div>
            </header>

            ${
              infoLine
                ? `<p class="mt-2 text-[11px] text-gray-700">${infoLine}</p>`
                : ""
            }

            <p class="mt-1 text-xs text-gray-700 line-clamp-3">${detailText}</p>

            <div class="mt-2 flex justify-between items-center text-[10px] text-gray-500">
              <span>${code ? "Mã: " + code : ""}</span>
              <span>${createdAt ? "Tạo: " + createdAt : ""}</span>
            </div>

            <div class="mt-2 flex justify-between items-center">
              ${
                sdt
                  ? `<a href="tel:${sdt}" class="text-xs text-primary">Gọi chủ: ${sdt}</a>`
                  : `<span class="text-[10px] text-gray-400 italic">Chưa có SĐT chủ</span>`
              }
              ${
                CURRENT_USER
                  ? `<button class="btn btn-ghost btn-xs text-[11px] px-2" data-edit-id="${
                      p.id
                    }">Chỉnh sửa</button>`
                  : ""
              }
            </div>
          </div>
        </article>
      `;
    }

    async function applyFilters(resetPage = true) {
      const q = document.getElementById("filter-q").value.trim();
      const district = document.getElementById("filter-district").value.trim();
      const ward = document.getElementById("filter-ward").value.trim();
      const priceMin = document.getElementById("filter-price-min").value;
      const priceMax = document.getElementById("filter-price-max").value;
      const areaMin = document.getElementById("filter-area-min").value;
      const areaMax = document.getElementById("filter-area-max").value;
      const status = document.getElementById("filter-status").value;
      const pn = document.getElementById("filter-pn").value;
      const wc = document.getElementById("filter-wc").value;
      const floors = document.getElementById("filter-floors").value;

      const filterObject = {
        q,
        district,
        ward,
        priceMin,
        priceMax,
        areaMin,
        areaMax,
        status,
        pn,
        wc,
        floors,
        pending: SHOW_PENDING,
      };

      if (resetPage) {
        PAGE = 0;
        LAST_FILTER = filterObject;
        document.getElementById("premises-list").innerHTML = "";
      } else if (LAST_FILTER) {
        Object.assign(filterObject, LAST_FILTER);
      }

      const placeholder = document.getElementById("premises-list");
      const loadMoreBtn = document.getElementById("btn-load-more");
      loadMoreBtn.disabled = true;
      loadMoreBtn.textContent = "Đang tải...";

      let query = supabase.from("premises").select("*", { count: "exact" });

      if (filterObject.pending) {
        query = query.eq("is_approved", false);
      } else {
        query = query.eq("is_approved", true);
      }

      if (filterObject.q) {
        query = query.or(
          `address.ilike.%${filterObject.q}%,detail.ilike.%${filterObject.q}%,ket_cau.ilike.%${filterObject.q}%`
        );
      }
      if (filterObject.district) {
        query = query.ilike("district", `%${filterObject.district}%`);
      }
      if (filterObject.ward) {
        query = query.ilike("ward", `%${filterObject.ward}%`);
      }

      if (filterObject.priceMin) {
        const v = Number(filterObject.priceMin) * 1_000_000;
        query = query.gte("price", v);
      }
      if (filterObject.priceMax) {
        const v = Number(filterObject.priceMax) * 1_000_000;
        query = query.lte("price", v);
      }

      if (filterObject.areaMin) {
        query = query.gte("area", Number(filterObject.areaMin));
      }
      if (filterObject.areaMax) {
        query = query.lte("area", Number(filterObject.areaMax));
      }

      if (filterObject.status) {
        query = query.eq("status", filterObject.status);
      }

      if (filterObject.pn) {
        if (filterObject.pn.includes(">")) {
          query = query.gt(
            "pn",
            parseInt(filterObject.pn.replace(">", "")) || 0
          );
        } else {
          query = query.eq("pn", parseInt(filterObject.pn));
        }
      }

      if (filterObject.wc) {
        if (filterObject.wc.includes(">")) {
          query = query.gt(
            "wc",
            parseInt(filterObject.wc.replace(">", "")) || 0
          );
        } else {
          query = query.eq("wc", parseInt(filterObject.wc));
        }
      }

      if (filterObject.floors) {
        if (filterObject.floors.includes(">")) {
          query = query.gt(
            "floors",
            parseInt(filterObject.floors.replace(">", "")) || 0
          );
        } else {
          query = query.eq("floors", parseInt(filterObject.floors));
        }
      }

      query = query.order("created_at", { ascending: false }).range(
        PAGE * PAGE_SIZE,
        PAGE * PAGE_SIZE + PAGE_SIZE - 1
      );

      const { data, error, count } = await query;

      if (error) {
        console.error(error);
        toast("Lỗi tải dữ liệu: " + error.message);
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = "Tải thêm";
        return;
      }

      const html = (data || []).map((p) => buildCardHtml(p)).join("");
      if (data && data.length) {
        placeholder.insertAdjacentHTML("beforeend", html);
      }

      loadMoreBtn.disabled = !data || data.length < PAGE_SIZE;
      loadMoreBtn.textContent =
        !data || data.length < PAGE_SIZE ? "Hết dữ liệu" : "Tải thêm";

      updateStats(count || 0);
      attachCardEvents();
      checkPendingCount();
    }

    function updateStats(totalCount) {
      const bar = document.getElementById("stats-bar");
      const modeLabel = SHOW_PENDING ? "Đang xem tin CHỜ DUYỆT" : "Đang xem tin ĐÃ DUYỆT";
      bar.innerHTML = `
        <span class="badge badge-sm badge-outline">${modeLabel}</span>
        <span class="badge badge-sm badge-outline">Tổng: ${totalCount}</span>
      `;
    }

    function attachCardEvents() {
      const list = document.getElementById("premises-list");
      list.querySelectorAll("article.card").forEach((card) => {
        const id = card.getAttribute("data-id");
        card.addEventListener("click", (e) => {
          if (e.target.closest("[data-edit-id]")) return;
          openDetail(id);
        });
      });

      list.querySelectorAll("[data-edit-id]").forEach((btn) => {
        const id = btn.getAttribute("data-edit-id");
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          openEdit(id);
        });
      });
    }

    async function checkPendingCount() {
      const { count, error } = await supabase
        .from("premises")
        .select("*", { count: "exact", head: true })
        .eq("is_approved", false);

      const badge = document.getElementById("pending-badge");
      if (error) {
        console.warn("checkPendingCount error", error);
        badge.classList.add("hidden");
        return;
      }
      if (!count) {
        badge.classList.add("hidden");
        badge.textContent = "";
      } else {
        badge.classList.remove("hidden");
        badge.textContent = count + " tin chờ duyệt";
      }
    }

    function togglePendingMode() {
      SHOW_PENDING = !SHOW_PENDING;
      const btn = document.getElementById("btn-toggle-pending");
      if (SHOW_PENDING) {
        btn.textContent = "Xem tin ĐÃ DUYỆT";
      } else {
        btn.textContent = "Xem tin CHỜ DUYỆT";
      }
      applyFilters(true);
    }

    async function approveAll() {
      if (!SHOW_PENDING) {
        toast("Vui lòng chuyển sang chế độ xem tin CHỜ DUYỆT.");
        return;
      }
      if (!confirm("Duyệt tất cả tin đang xem?")) return;

      const filter = LAST_FILTER || {};
      let query = supabase.from("premises").update({ is_approved: true });

      query = query.eq("is_approved", false);

      if (filter.q) {
        query = query.or(
          `address.ilike.%${filter.q}%,detail.ilike.%${filter.q}%,ket_cau.ilike.%${filter.q}%`
        );
      }
      if (filter.district) {
        query = query.ilike("district", `%${filter.district}%`);
      }
      if (filter.ward) {
        query = query.ilike("ward", `%${filter.ward}%`);
      }
      if (filter.status) {
        query = query.eq("status", filter.status);
      }
      if (filter.pn) {
        if (filter.pn.includes(">")) {
          query = query.gt("pn", parseInt(filter.pn.replace(">", "")) || 0);
        } else {
          query = query.eq("pn", parseInt(filter.pn));
        }
      }
      if (filter.wc) {
        if (filter.wc.includes(">")) {
          query = query.gt("wc", parseInt(filter.wc.replace(">", "")) || 0);
        } else {
          query = query.eq("wc", parseInt(filter.wc));
        }
      }
      if (filter.floors) {
        if (filter.floors.includes(">")) {
          query = query.gt(
            "floors",
            parseInt(filter.floors.replace(">", "")) || 0
          );
        } else {
          query = query.eq("floors", parseInt(filter.floors));
        }
      }

      const { error } = await query;
      if (error) {
        console.error(error);
        toast("Lỗi duyệt tin: " + error.message);
        return;
      }
      toast("Đã duyệt các tin đang xem.");
      SHOW_PENDING = false;
      document.getElementById("btn-toggle-pending").textContent =
        "Xem tin CHỜ DUYỆT";
      applyFilters(true);
    }

    async function openDetail(id) {
      const { data, error } = await supabase
        .from("premises")
        .select("*")
        .eq("id", id)
        .maybeSingle();
      if (error || !data) {
        toast("Không tìm thấy bản ghi.");
        return;
      }

      const p = data;
      const dlg = document.getElementById("detailDlg");
      document.getElementById("detail-title").textContent = buildTitle(p);
      const addr = buildShortAddress(p);
      const code = p.code || p.id || "";
      const price = formatPrice(p.price);
      const area = formatArea(p.area);
      const floors = p.floors ? p.floors + " tầng" : "";
      const pn = p.pn ? p.pn + " PN" : "";
      const wc = p.wc ? p.wc + " WC" : "";
      const statusStr = p.status
        ? p.status === "available"
          ? "Còn trống"
          : p.status === "deposited"
          ? "Đang giữ cọc"
          : "Đã cho thuê"
        : "";
      const sdt = p.contact_phone || "";
      const createdAt = formatDateVN(p.created_at);
      const frontage = p.frontage || "";
      const ketCau = p.ket_cau || "";

      const infoLines = [];
      if (addr) infoLines.push("Địa chỉ: " + addr);
      if (p.ward || p.district) {
        infoLines.push(
          "Khu vực: " +
            [p.ward ? "P." + p.ward : "", p.district].filter(Boolean).join(", ")
        );
      }
      if (price) infoLines.push("Giá thuê: " + price);
      if (area) infoLines.push("Diện tích: " + area);
      if (floors || pn || wc) {
        infoLines.push(
          "Kết cấu: " + [floors, pn, wc, ketCau].filter(Boolean).join(" • ")
        );
      } else if (ketCau) {
        infoLines.push("Kết cấu: " + ketCau);
      }
      if (frontage) infoLines.push("Mặt bằng: " + frontage);
      if (statusStr) infoLines.push("Trạng thái: " + statusStr);
      if (sdt) infoLines.push("SĐT chủ nhà: " + sdt);
      if (createdAt) infoLines.push("Ngày tạo: " + createdAt);
      if (code) infoLines.push("Mã tham chiếu: " + code);

      document.getElementById("detail-basic").innerHTML = infoLines.join(
        "<br/>"
      );

      let detailText = p.detail;
      if (!detailText) {
        detailText =
          (p.address ? p.address : "") +
          (p.ward ? " | Phường: " + p.ward : "") +
          (p.district ? " | Quận: " + p.district : "") +
          (p.area ? " | Diện tích: " + p.area + " m²" : "") +
          (p.floors ? " | Số tầng: " + p.floors : "") +
          (p.price ? " | Giá thuê: " + p.price : "") +
          (p.status ? " | Trạng thái: " + p.status : "") +
          (p.contact_phone ? " | SĐT chủ nhà: " + p.contact_phone : "");
      }
      document.getElementById("detail-extra").textContent = detailText;

      const imgs = parseImages(p.images);
      const imgContainer = document.getElementById("detail-images");
      if (imgs.length) {
        imgContainer.innerHTML = imgs
          .slice(0, 9)
          .map(
            (url) =>
              `<img src="${url}" class="w-full h-24 object-cover rounded border border-base-200" />`
          )
          .join("");
      } else {
        imgContainer.innerHTML =
          '<p class="text-xs text-gray-400 italic">Chưa có hình ảnh.</p>';
      }

      dlg.showModal();
    }

    let EDITING_ID = null;

    async function openEdit(id) {
      const { data, error } = await supabase
        .from("premises")
        .select("*")
        .eq("id", id)
        .maybeSingle();
      if (error || !data) {
        toast("Không tìm thấy bản ghi để sửa.");
        return;
      }
      const p = data;
      EDITING_ID = p.id;

      document.getElementById("edit-code").value = p.code || "";
      document.getElementById("edit-address").value = p.address || "";
      document.getElementById("edit-district").value = p.district || "";
      document.getElementById("edit-ward").value = p.ward || "";
      document.getElementById("edit-street").value = p.street || "";
      document.getElementById("edit-width").value = p.width || "";
      document.getElementById("edit-length").value = p.length || "";
      document.getElementById("edit-area").value = p.area || "";
      document.getElementById("edit-floors").value = p.floors || "";
      document.getElementById("edit-pn").value = p.pn || "";
      document.getElementById("edit-wc").value = p.wc || "";
      document.getElementById("edit-price").value = p.price || "";
      document.getElementById("edit-status").value = p.status || "";
      document.getElementById("edit-contact-phone").value =
        p.contact_phone || "";
      document.getElementById("edit-frontage").value = p.frontage || "";
      document.getElementById("edit-commission").value =
        p.commission_note || "";
      document.getElementById("edit-ket-cau").value = p.ket_cau || "";
      document.getElementById("edit-detail").value = p.detail || "";

      const imgsArr = parseImages(p.images);
      if (imgsArr.length) {
        document.getElementById("edit-images").value = JSON.stringify(
          imgsArr,
          null,
          0
        );
      } else {
        document.getElementById("edit-images").value = "";
      }

      document.getElementById("editDlg").showModal();
    }

    async function saveEditPremise() {
      if (!EDITING_ID) return;

      const payload = {};
      const code = document.getElementById("edit-code").value.trim();
      const address = document.getElementById("edit-address").value.trim();
      const district = document.getElementById("edit-district").value.trim();
      const ward = document.getElementById("edit-ward").value.trim();
      const street = document.getElementById("edit-street").value.trim();
      const width = document.getElementById("edit-width").value;
      const length = document.getElementById("edit-length").value;
      const area = document.getElementById("edit-area").value;
      const floors = document.getElementById("edit-floors").value;
      const pn = document.getElementById("edit-pn").value;
      const wc = document.getElementById("edit-wc").value;
      const price = document.getElementById("edit-price").value;
      const status = document.getElementById("edit-status").value;
      const contact_phone = document
        .getElementById("edit-contact-phone")
        .value.trim();
      const frontage = document.getElementById("edit-frontage").value.trim();
      const commission = document
        .getElementById("edit-commission")
        .value.trim();
      const ket_cau = document.getElementById("edit-ket-cau").value.trim();
      const detail = document.getElementById("edit-detail").value.trim();
      const imagesStr = document.getElementById("edit-images").value.trim();

      if (code) payload.code = code;
      if (address) payload.address = address;
      if (district) payload.district = district;
      if (ward) payload.ward = ward;
      if (street) payload.street = street;

      function toNum(val) {
        if (!val) return null;
        const n = Number(val);
        return isNaN(n) ? null : n;
      }

      const wNum = toNum(width);
      if (wNum !== null) payload.width = wNum;
      const lNum = toNum(length);
      if (lNum !== null) payload.length = lNum;
      const aNum = toNum(area);
      if (aNum !== null) payload.area = aNum;
      const fNum = toNum(floors);
      if (fNum !== null) payload.floors = fNum;
      const pnNum = toNum(pn);
      if (pnNum !== null) payload.pn = pnNum;
      const wcNum = toNum(wc);
      if (wcNum !== null) payload.wc = wcNum;

      if (price) {
        const digits = price.toString().replace(/[^\d]/g, "");
        if (digits) {
          const n = Number(digits);
          if (!isNaN(n)) payload.price = n;
        }
      }

      if (status) payload.status = status;
      if (contact_phone) payload.contact_phone = contact_phone;
      if (frontage) payload.frontage = frontage;
      if (commission) payload.commission_note = commission;
      if (ket_cau) payload.ket_cau = ket_cau;
      if (detail) payload.detail = detail;

      if (imagesStr) {
        let arr = [];
        if (
          imagesStr.startsWith("[") &&
          imagesStr.endsWith("]")
        ) {
          try {
            const parsed = JSON.parse(imagesStr);
            if (Array.isArray(parsed)) {
              arr = parsed;
            }
          } catch (e) {
            console.warn("edit images JSON parse error", e);
          }
        } else {
          arr = imagesStr.split(";").map((x) => x.trim()).filter(Boolean);
        }
        payload.images = arr;
      }

      const { error } = await supabase
        .from("premises")
        .update(payload)
        .eq("id", EDITING_ID);
      if (error) {
        console.error(error);
        toast("Lỗi lưu: " + error.message);
        return;
      }
      toast("Đã lưu thay đổi.");
      document.getElementById("editDlg").close();
      await applyFilters(false);
    }

    async function saveNewPremise() {
      const payload = {};
      const code = document.getElementById("add-code").value.trim();
      const address = document.getElementById("add-address").value.trim();
      const district = document.getElementById("add-district").value.trim();
      const ward = document.getElementById("add-ward").value.trim();
      const street = document.getElementById("add-street").value.trim();
      const width = document.getElementById("add-width").value;
      const length = document.getElementById("add-length").value;
      const area = document.getElementById("add-area").value;
      const floors = document.getElementById("add-floors").value;
      const pn = document.getElementById("add-pn").value;
      const wc = document.getElementById("add-wc").value;
      const price = document.getElementById("add-price").value;
      const status = document.getElementById("add-status").value;
      const contact_phone = document
        .getElementById("add-contact-phone")
        .value.trim();
      const frontage = document.getElementById("add-frontage").value.trim();
      const commission = document
        .getElementById("add-commission")
        .value.trim();
      const ket_cau = document.getElementById("add-ket-cau").value.trim();
      const detail = document.getElementById("add-detail").value.trim();
      const imagesStr = document.getElementById("add-images").value.trim();

      if (code) payload.code = code;
      if (address) payload.address = address;
      if (district) payload.district = district;
      if (ward) payload.ward = ward;
      if (street) payload.street = street;

      function toNum(val) {
        if (!val) return null;
        const n = Number(val);
        return isNaN(n) ? null : n;
      }

      const wNum = toNum(width);
      if (wNum !== null) payload.width = wNum;
      const lNum = toNum(length);
      if (lNum !== null) payload.length = lNum;
      const aNum = toNum(area);
      if (aNum !== null) payload.area = aNum;
      const fNum = toNum(floors);
      if (fNum !== null) payload.floors = fNum;
      const pnNum = toNum(pn);
      if (pnNum !== null) payload.pn = pnNum;
      const wcNum = toNum(wc);
      if (wcNum !== null) payload.wc = wcNum;

      if (price) {
        const digits = price.toString().replace(/[^\d]/g, "");
        if (digits) {
          const n = Number(digits);
          if (!isNaN(n)) payload.price = n;
        }
      }

      if (status) payload.status = status;
      if (contact_phone) payload.contact_phone = contact_phone;
      if (frontage) payload.frontage = frontage;
      if (commission) payload.commission_note = commission;
      if (ket_cau) payload.ket_cau = ket_cau;
      if (detail) payload.detail = detail;

      if (imagesStr) {
        let arr = [];
        if (
          imagesStr.startsWith("[") &&
          imagesStr.endsWith("]")
        ) {
          try {
            const parsed = JSON.parse(imagesStr);
            if (Array.isArray(parsed)) {
              arr = parsed;
            }
          } catch (e) {
            console.warn("add images JSON parse error", e);
          }
        } else {
          arr = imagesStr.split(";").map((x) => x.trim()).filter(Boolean);
        }
        payload.images = arr;
      }

      payload.is_approved = false;

      const { error } = await supabase.from("premises").insert(payload);
      if (error) {
        console.error(error);
        toast("Lỗi thêm tin: " + error.message);
        return;
      }
      toast("Đã thêm tin mới (chờ duyệt).");
      document.getElementById("addDlg").close();
      SHOW_PENDING = true;
      document.getElementById("btn-toggle-pending").textContent =
        "Xem tin ĐÃ DUYỆT";
      applyFilters(true);
      checkPendingCount();
    }

    async function initAuth() {
      const {
        data: { session },
        error,
      } = await supabase.auth.getSession();
      if (error) {
        console.error("getSession error", error);
      }
      CURRENT_USER = session?.user || null;

      const userSpan = document.getElementById("current-user");
      const btnLoginOpen = document.getElementById("btn-login-open");
      const btnLogout = document.getElementById("btn-logout");
      const adminPanel = document.getElementById("admin-panel");

      if (CURRENT_USER) {
        userSpan.textContent = CURRENT_USER.email || "(Không rõ email)";
        userSpan.classList.remove("hidden");
        btnLoginOpen.classList.add("hidden");
        btnLogout.classList.remove("hidden");
        adminPanel.classList.remove("hidden");
      } else {
        userSpan.textContent = "";
        userSpan.classList.add("hidden");
        btnLoginOpen.classList.remove("hidden");
        btnLogout.classList.add("hidden");
        adminPanel.classList.add("hidden");
        SHOW_PENDING = false;
      }

      PAGE = 0;
      applyFilters(true);
    }

    function showDemoNotice() {
      const dlg = document.getElementById("demoNoticeDlg");
      if (dlg && typeof dlg.showModal === "function") {
        dlg.showModal();
      }
    }

    async function handleLogin() {
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value.trim();
      if (!email || !password) {
        toast("Vui lòng nhập email & mật khẩu");
        return;
      }
      const { error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });
      if (error) {
        console.error(error);
        toast("Đăng nhập thất bại: " + error.message);
        return;
      }
      toast("Đăng nhập thành công");
      showDemoNotice();
      await initAuth();
    }

    async function handleLogout() {
      await supabase.auth.signOut();
      toast("Đã đăng xuất");
      location.reload();
    }

    function getWardOptionsByDistrict(district) {
      const map = {
        "Quận 1": [
          "Phường Bến Nghé",
          "Phường Bến Thành",
          "Phường Nguyễn Thái Bình",
          "Phường Phạm Ngũ Lão",
          "Phường Cầu Kho",
          "Phường Cầu Ông Lãnh",
        ],
        "Quận 3": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5"],
        "Quận 5": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5"],
        "Quận 10": [
          "Phường 1",
          "Phường 2",
          "Phường 3",
          "Phường 4",
          "Phường 5",
          "Phường 11",
        ],
        "Gò Vấp": [
          "Phường 1",
          "Phường 3",
          "Phường 4",
          "Phường 5",
          "Phường 6",
          "Phường 7",
        ],
        "Bình Thạnh": [
          "Phường 1",
          "Phường 2",
          "Phường 3",
          "Phường 5",
          "Phường 6",
        ],
        "Phú Nhuận": ["Phường 1", "Phường 2", "Phường 3", "Phường 4"],
      };
      return map[district] || [];
    }

    function updateWardOptions() {
      const district = document.getElementById("filter-district").value;
      const wardSelect = document.getElementById("filter-ward");
      const wards = getWardOptionsByDistrict(district);
      wardSelect.innerHTML = '<option value="">Tất cả</option>';
      wards.forEach((w) => {
        const opt = document.createElement("option");
        opt.value = w;
        opt.textContent = w;
        wardSelect.appendChild(opt);
      });
    }

    document
      .getElementById("filter-district")
      .addEventListener("change", () => {
        updateWardOptions();
      });

    document
      .getElementById("btn-save-edit")
      .addEventListener("click", saveEditPremise);

    document.addEventListener("DOMContentLoaded", () => {
      document
        .getElementById("btn-login-open")
        .addEventListener("click", () =>
          document.getElementById("loginDlg").showModal()
        );
      document
        .getElementById("btn-login")
        .addEventListener("click", handleLogin);
      document
        .getElementById("btn-logout")
        .addEventListener("click", handleLogout);

      document
        .getElementById("btn-apply")
        .addEventListener("click", () => applyFilters(true));
      document
        .getElementById("btn-reset")
        .addEventListener("click", () => {
          document
            .querySelectorAll("aside input, aside select")
            .forEach((el) => (el.value = ""));
          applyFilters(true);
        });

      document
        .getElementById("btn-load-more")
        .addEventListener("click", () => {
          PAGE++;
          applyFilters(false);
        });

      document.getElementById("btn-open-add").onclick = () =>
        document.getElementById("addDlg").showModal();
      document.getElementById("btn-toggle-pending").onclick =
        togglePendingMode;
      document.getElementById("btn-approve-all").onclick = approveAll;

      document
        .querySelectorAll("[data-quick]")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            document.getElementById("filter-status").value =
              btn.getAttribute("data-quick");
            applyFilters(true);
          });
        });
      document
        .querySelectorAll("[data-quick-district]")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            document.getElementById("filter-district").value =
              btn.getAttribute("data-quick-district");
            updateWardOptions();
            applyFilters(true);
          });
        });
      document
        .getElementById("btn-clear-quick")
        .addEventListener("click", () => {
          document.getElementById("filter-status").value = "";
          document.getElementById("filter-district").value = "";
          document.getElementById("filter-ward").value = "";
          applyFilters(true);
        });

      // DEMO notice buttons
      const demoAgreeBtn = document.getElementById("btn-demo-agree");
      const demoDisagreeBtn = document.getElementById("btn-demo-disagree");
      const demoDlg = document.getElementById("demoNoticeDlg");

      if (demoAgreeBtn && demoDlg) {
        demoAgreeBtn.addEventListener("click", () => {
          demoDlg.close();
        });
      }

      if (demoDisagreeBtn && demoDlg) {
        demoDisagreeBtn.addEventListener("click", async () => {
          demoDlg.close();
          await supabase.auth.signOut();
          location.reload();
        });
      }

      initAuth();
    });
  </script>
</body>
</html>
