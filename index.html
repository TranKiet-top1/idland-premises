<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>ID-Land Premises</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
  
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    .premise-card:hover { transform: translateY(-3px); }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

  <section id="auth-section" class="flex-1 flex items-center justify-center p-4">
    <div class="card w-full max-w-md bg-base-100 shadow-xl">
      <div class="card-body">
        <div class="flex items-center gap-3 mb-4">
          <div class="h-12 w-12 rounded-xl bg-primary flex items-center justify-center text-white font-bold text-xl">ID</div>
          <div>
            <h2 class="card-title text-2xl">ID-Land</h2>
            <p class="text-sm opacity-70">H·ªá th·ªëng qu·∫£n l√Ω kho m·∫∑t b·∫±ng</p>
          </div>
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Email</span></label>
          <input id="login-email" type="email" placeholder="admin@idland.vn" class="input input-bordered" />
        </div>
        <div class="form-control mt-3">
          <label class="label"><span class="label-text">M·∫≠t kh·∫©u</span></label>
          <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="input input-bordered" />
        </div>
        
        <div class="form-control mt-6">
          <button id="btn-login" class="btn btn-primary w-full text-lg">ƒêƒÉng nh·∫≠p</button>
        </div>
        <div id="login-error" class="text-error text-sm mt-3 text-center hidden"></div>
      </div>
    </div>
  </section>

  <div id="app-root" class="hidden flex-col min-h-screen">
    
    <div class="navbar bg-base-100 shadow-sm px-4 sticky top-0 z-30">
      <div class="flex-1 flex items-center gap-2">
        <div class="h-8 w-8 rounded-lg bg-primary flex items-center justify-center text-white font-bold text-xs">ID</div>
        <div class="leading-tight hidden sm:block">
          <div class="font-bold text-lg">ID-Land Premises</div>
          <div class="text-[10px] opacity-60 uppercase tracking-wide">Kho d·ªØ li·ªáu n·ªôi b·ªô</div>
        </div>
      </div>
      <div class="flex-none flex items-center gap-3">
        <div class="text-right hidden sm:block">
          <div id="user-email" class="text-xs font-bold">user@email.com</div>
          <div id="role-badge" class="badge badge-xs badge-outline uppercase">Staff</div>
        </div>
        <button id="btn-logout" class="btn btn-ghost btn-sm text-error">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <main class="flex-1 w-full max-w-7xl mx-auto p-4">
      
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <div>
          <h1 class="text-2xl font-bold">Danh s√°ch m·∫∑t b·∫±ng</h1>
          <p class="text-sm opacity-70">Qu·∫£n l√Ω v√† t√¨m ki·∫øm m·∫∑t b·∫±ng cho thu√™ TP.HCM</p>
        </div>
        
        <div class="flex flex-wrap gap-2">
          <div id="admin-controls" class="hidden flex gap-2">
            <button id="btn-pending" class="btn btn-warning btn-sm text-white">
              C·∫ßn duy·ªát <span class="badge badge-sm bg-white text-warning border-none ml-1" id="count-pending">0</span>
            </button>
            <button id="btn-approve-all" class="btn btn-success btn-sm text-white hidden">
              ‚úî Duy·ªát t·∫•t c·∫£
            </button>
          </div>
          
          <button id="btn-add-premise" class="btn btn-primary btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            ƒêƒÉng m·ªõi
          </button>
        </div>
      </div>

      <div class="bg-base-100 p-4 rounded-xl shadow-sm mb-6 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
        <div class="col-span-2">
            <input id="filter-keyword" type="text" placeholder="üîç T√¨m theo t√™n ƒë∆∞·ªùng, m√£ MB..." class="input input-sm input-bordered w-full" />
        </div>
        <select id="filter-district" class="select select-sm select-bordered w-full">
            <option value="">T·∫•t c·∫£ Qu·∫≠n</option>
        </select>
        <select id="filter-price" class="select select-sm select-bordered w-full">
           <option value="">M·ª©c gi√°: T·∫•t c·∫£</option>
           <option value="0-20">D∆∞·ªõi 20 tri·ªáu</option>
           <option value="20-50">20 - 50 tri·ªáu</option>
           <option value="50-100">50 - 100 tri·ªáu</option>
           <option value="100+">Tr√™n 100 tri·ªáu</option>
        </select>
        <select id="filter-status" class="select select-sm select-bordered w-full">
           <option value="">Tr·∫°ng th√°i: T·∫•t c·∫£</option>
           <option value="available">C√≤n tr·ªëng</option>
           <option value="deposited">Gi·ªØ c·ªçc</option>
           <option value="rented">ƒê√£ thu√™</option>
        </select>
        <button id="btn-search" class="btn btn-sm btn-primary w-full">L·ªçc d·ªØ li·ªáu</button>
      </div>

      <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
        </div>
      
      <div class="mt-8 text-center">
        <button id="btn-load-more" class="btn btn-ghost">T·∫£i th√™m k·∫øt qu·∫£</button>
      </div>
    </main>
  </div>

  <dialog id="addDlg" class="modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button></form>
      <h3 class="font-bold text-xl text-primary mb-1">ƒêƒÉng m·∫∑t b·∫±ng m·ªõi</h3>
      <p class="text-xs opacity-60 mb-4 italic">M√£ m·∫∑t b·∫±ng (MB-xxxx) s·∫Ω ƒë∆∞·ª£c h·ªá th·ªëng t·ª± ƒë·ªông t·∫°o sau khi l∆∞u.</p>
      
      <div class="grid md:grid-cols-2 gap-4">
        <div class="space-y-3">
            <h4 class="font-semibold text-sm border-b pb-1">V·ªã tr√≠</h4>
            <div class="form-control">
                <label class="label pt-0"><span class="label-text text-xs font-bold">ƒê·ªãa ch·ªâ hi·ªÉn th·ªã *</span></label>
                <input id="add-address" type="text" placeholder="VD: 123 Nguy·ªÖn Tr√£i" class="input input-bordered input-sm" />
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text text-xs">Qu·∫≠n *</span></label>
                    <select id="add-district" class="select select-bordered select-sm w-full"></select>
                </div>
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text text-xs">Ph∆∞·ªùng *</span></label>
                    <select id="add-ward" class="select select-bordered select-sm w-full" disabled>
                        <option value="">--</option>
                    </select>
                </div>
            </div>
            <div class="form-control">
                <label class="label pt-0"><span class="label-text text-xs">T√™n ƒë∆∞·ªùng (ƒë·ªÉ l·ªçc)</span></label>
                <input id="add-street" type="text" class="input input-bordered input-sm" />
            </div>
            
            <h4 class="font-semibold text-sm border-b pb-1 mt-4">ƒê·∫∑c ƒëi·ªÉm</h4>
            <div class="flex gap-4">
                 <label class="cursor-pointer flex items-center gap-2 border p-2 rounded-lg flex-1">
                    <input id="add-frontage" type="checkbox" class="checkbox checkbox-sm checkbox-primary" /> 
                    <span class="text-sm font-medium">M·∫∑t ti·ªÅn</span>
                 </label>
                 </div>
        </div>

        <div class="space-y-3">
            <h4 class="font-semibold text-sm border-b pb-1">Th√¥ng s·ªë & Gi√°</h4>
            <div class="form-control">
                <label class="label pt-0"><span class="label-text text-xs font-bold text-primary">Gi√° thu√™ (VNƒê) *</span></label>
                <input id="add-price" type="text" class="input input-bordered input-sm font-bold text-primary" onkeyup="formatCurrencyInput(this)" placeholder="0" />
            </div>
            
            <div class="grid grid-cols-3 gap-2">
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text text-xs">Di·ªán t√≠ch (m¬≤)</span></label>
                    <input id="add-area" type="number" class="input input-bordered input-sm" />
                </div>
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text text-xs">Ngang (m)</span></label>
                    <input id="add-width" type="number" step="0.1" class="input input-bordered input-sm" />
                </div>
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text text-xs">D√†i (m)</span></label>
                    <input id="add-length" type="number" step="0.1" class="input input-bordered input-sm" />
                </div>
            </div>

            <div class="grid grid-cols-3 gap-2">
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text text-xs">S·ªë t·∫ßng</span></label>
                    <input id="add-floors" type="number" class="input input-bordered input-sm" />
                </div>
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text text-xs">Ph√≤ng ng·ªß</span></label>
                    <input id="add-bedrooms" type="number" class="input input-bordered input-sm" />
                </div>
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text text-xs">Toilet</span></label>
                    <input id="add-wc" type="number" class="input input-bordered input-sm" />
                </div>
            </div>

            <div class="form-control">
                <label class="label pt-0"><span class="label-text text-xs">K·∫øt c·∫•u (VD: Tr·ªát 3 l·∫ßu...)</span></label>
                <input id="add-ket-cau" type="text" class="input input-bordered input-sm" />
            </div>
        </div>

        <div class="md:col-span-2 grid md:grid-cols-2 gap-4 mt-2">
            <div class="form-control">
                <label class="label pt-0"><span class="label-text text-xs font-bold text-error">SƒêT Ch·ªß nh√† (Ch·ªâ Admin th·∫•y)</span></label>
                <input id="add-contact-phone" type="text" class="input input-bordered input-sm input-error" placeholder="090..." />
            </div>
            <div class="form-control">
                <label class="label pt-0"><span class="label-text text-xs">Hoa h·ªìng / Ghi ch√∫</span></label>
                <input id="add-commission" type="text" class="input input-bordered input-sm" />
            </div>
        </div>

        <div class="md:col-span-2 form-control">
            <label class="label pt-0"><span class="label-text text-xs">Link ·∫£nh (M·ªói d√≤ng 1 link)</span></label>
            <textarea id="add-images" class="textarea textarea-bordered h-16 text-xs" placeholder="https://bucket.../img1.jpg&#10;https://bucket.../img2.jpg"></textarea>
        </div>

        <div class="md:col-span-2 form-control">
            <label class="label pt-0"><span class="label-text text-xs">M√¥ t·∫£ chi ti·∫øt</span></label>
            <textarea id="add-detail" class="textarea textarea-bordered h-24 text-sm"></textarea>
        </div>
      </div>

      <div class="modal-action">
        <button class="btn" onclick="document.getElementById('addDlg').close()">Hu·ª∑ b·ªè</button>
        <button class="btn btn-primary px-8" onclick="saveNewPremise()">L∆∞u tin</button>
      </div>
    </div>
  </dialog>

  <dialog id="detailDlg" class="modal">
    <div class="modal-box max-w-5xl p-0 overflow-hidden relative bg-base-100">
        <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 z-10 bg-base-100">‚úï</button></form>
        <div id="detail-content" class="min-h-[300px] flex items-center justify-center">
            <span class="loading loading-spinner loading-lg text-primary"></span>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <div id="toast" class="toast toast-top toast-end z-[100] hidden">
    <div class="alert alert-info shadow-lg" id="toast-text">
      <span>Message here</span>
    </div>
  </div>

  <script>
    // --- C·∫§U H√åNH (Thay ƒë√∫ng URL/Key c·ªßa b·∫°n v√†o ƒë√¢y) ---
    const SUPABASE_URL = "https://xclncowkoedwqzcemhei.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbG5jb3drb2Vkd3F6Y2VtaGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNzcwOTUsImV4cCI6MjA3Nzg1MzA5NX0.jfNM46UgXIq9LrwSXcERJJULeKB7bl_c9R9LaVhRy1A";
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // DATA QU·∫¨N/PH∆Ø·ªúNG HCM
    const HCM_DATA = {
        "Qu·∫≠n 1": ["B·∫øn Ngh√©", "B·∫øn Th√†nh", "C√¥ Giang", "C·∫ßu Kho", "C·∫ßu √îng L√£nh", "ƒêa Kao", "Nguy·ªÖn C∆∞ Trinh", "Nguy·ªÖn Th√°i B√¨nh", "Ph·∫°m Ng≈© L√£o", "T√¢n ƒê·ªãnh"],
        "Qu·∫≠n 3": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "V√µ Th·ªã S√°u"],
        "Qu·∫≠n 4": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16", "Ph∆∞·ªùng 18"],
        "Qu·∫≠n 5": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14"],
        "Qu·∫≠n 6": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14"],
        "Qu·∫≠n 7": ["B√¨nh Thu·∫≠n", "Ph√∫ M·ªπ", "Ph√∫ Thu·∫≠n", "T√¢n H∆∞ng", "T√¢n Ki·ªÉng", "T√¢n Phong", "T√¢n Ph√∫", "T√¢n Quy", "T√¢n Thu·∫≠n ƒê√¥ng", "T√¢n Thu·∫≠n T√¢y"],
        "Qu·∫≠n 8": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16"],
        "Qu·∫≠n 10": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15"],
        "Qu·∫≠n 11": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16"],
        "Qu·∫≠n 12": ["An Ph√∫ ƒê√¥ng", "ƒê√¥ng H∆∞ng Thu·∫≠n", "Hi·ªáp Th√†nh", "T√¢n Ch√°nh Hi·ªáp", "T√¢n H∆∞ng Thu·∫≠n", "T√¢n Th·ªõi Hi·ªáp", "T√¢n Th·ªõi Nh·∫•t", "Th·∫°nh L·ªôc", "Th·∫°nh Xu√¢n", "Th·ªõi An", "Trung M·ªπ T√¢y"],
        "B√¨nh T√¢n": ["An L·∫°c", "An L·∫°c A", "B√¨nh H∆∞ng H√≤a", "B√¨nh H∆∞ng H√≤a A", "B√¨nh H∆∞ng H√≤a B", "B√¨nh Tr·ªã ƒê√¥ng", "B√¨nh Tr·ªã ƒê√¥ng A", "B√¨nh Tr·ªã ƒê√¥ng B", "T√¢n T·∫°o", "T√¢n T·∫°o A"],
        "B√¨nh Th·∫°nh": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 17", "Ph∆∞·ªùng 19", "Ph∆∞·ªùng 21", "Ph∆∞·ªùng 22", "Ph∆∞·ªùng 24", "Ph∆∞·ªùng 25", "Ph∆∞·ªùng 26", "Ph∆∞·ªùng 27", "Ph∆∞·ªùng 28"],
        "G√≤ V·∫•p": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16", "Ph∆∞·ªùng 17"],
        "Ph√∫ Nhu·∫≠n": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 17"],
        "T√¢n B√¨nh": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15"],
        "T√¢n Ph√∫": ["Hi·ªáp T√¢n", "H√≤a Th·∫°nh", "Ph√∫ Th·∫°nh", "Ph√∫ Th·ªç H√≤a", "Ph√∫ Trung", "S∆°n K·ª≥", "T√¢n Qu√Ω", "T√¢n S∆°n Nh√¨", "T√¢n Th√†nh", "T√¢n Th·ªõi H√≤a", "T√¢y Th·∫°nh"],
        "Th·ªß ƒê·ª©c": ["An Kh√°nh", "An L·ª£i ƒê√¥ng", "An Ph√∫", "B√¨nh Chi·ªÉu", "B√¨nh Th·ªç", "B√¨nh Tr∆∞ng ƒê√¥ng", "B√¨nh Tr∆∞ng T√¢y", "C√°t L√°i", "Hi·ªáp B√¨nh Ch√°nh", "Hi·ªáp B√¨nh Ph∆∞·ªõc", "Linh Chi·ªÉu", "Linh ƒê√¥ng", "Linh T√¢y", "Linh Trung", "Linh Xu√¢n", "Long B√¨nh", "Long Ph∆∞·ªõc", "Long Th·∫°nh M·ªπ", "Long Tr∆∞·ªùng", "Ph√∫ H·ªØu", "Ph∆∞·ªõc B√¨nh", "Ph∆∞·ªõc Long A", "Ph∆∞·ªõc Long B", "Tam B√¨nh", "Tam Ph√∫", "T√¢n Ph√∫", "TƒÉng Nh∆°n Ph√∫ A", "TƒÉng Nh∆°n Ph√∫ B", "Th·∫£o ƒêi·ªÅn", "Th·∫°nh M·ªπ L·ª£i", "Th·ªß Thi√™m", "Tr∆∞·ªùng Th·∫°nh", "Tr∆∞·ªùng Th·ªç"]
    };

    // STATE VARIABLES
    let CURRENT_USER = null;
    let CURRENT_ROLE = "staff";
    let SHOW_PENDING = false;

    // ================== KH·ªûI T·∫†O ==================
    document.addEventListener("DOMContentLoaded", () => {
        initDropdowns();
        checkSession();

        // Events Login/Logout
        document.getElementById("btn-login").onclick = handleLogin;
        document.getElementById("btn-logout").onclick = handleLogout;

        // Events Actions
        document.getElementById("btn-search").onclick = () => loadPremises(true);
        document.getElementById("btn-add-premise").onclick = () => document.getElementById("addDlg").showModal();
        document.getElementById("add-district").onchange = (e) => updateWardSelect(e.target.value);

        // Pending mode toggle
        document.getElementById("btn-pending").onclick = togglePendingMode;
        document.getElementById("btn-approve-all").onclick = approveAllPending;
    });

    // ================== AUTHENTICATION ==================
    async function checkSession() {
        const { data } = await supabase.auth.getUser();
        if (data.user) {
            CURRENT_USER = data.user;
            await loadUserProfile();
            showApp();
        } else {
            showLogin();
        }
    }

    async function loadUserProfile() {
        // L·∫•y role
        const { data: profile } = await supabase.from("profiles").select("role, email").eq("id", CURRENT_USER.id).maybeSingle();
        // N·∫øu kh√¥ng c√≥ profile (l·ªói), m·∫∑c ƒë·ªãnh l√† staff
        CURRENT_ROLE = profile?.role || "staff";
        const displayEmail = profile?.email || CURRENT_USER.email;

        // Update UI
        document.getElementById("user-email").textContent = displayEmail;
        document.getElementById("role-badge").textContent = CURRENT_ROLE;
        
        // Show Admin Controls
        if (CURRENT_ROLE === 'admin') {
            document.getElementById("admin-controls").classList.remove("hidden");
            document.getElementById("role-badge").className = "badge badge-xs badge-error text-white uppercase";
            checkPendingCount();
        }
    }

    async function handleLogin() {
        const email = document.getElementById("login-email").value.trim();
        const password = document.getElementById("login-password").value.trim();
        const errEl = document.getElementById("login-error");
        
        errEl.classList.add("hidden");
        if(!email || !password) return;

        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
            errEl.textContent = "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + error.message;
            errEl.classList.remove("hidden");
        } else {
            checkSession();
        }
    }

    async function handleLogout() {
        await supabase.auth.signOut();
        location.reload();
    }

    function showApp() {
        document.getElementById("auth-section").classList.add("hidden");
        document.getElementById("app-root").classList.remove("hidden");
        document.getElementById("app-root").classList.add("flex");
        loadPremises(true);
    }

    function showLogin() {
        document.getElementById("app-root").classList.remove("flex");
        document.getElementById("app-root").classList.add("hidden");
        document.getElementById("auth-section").classList.remove("hidden");
    }

    // ================== DATA & RENDERING ==================
    async function loadPremises(reset = false) {
        const grid = document.getElementById("grid");
        if (reset) grid.innerHTML = "";
        
        let query = supabase.from("premises").select("*"); // JOIN b·∫£ng profiles ƒë·ªÉ l·∫•y email ng∆∞·ªùi ƒëƒÉng

        // FILTER LOGIC
        if (SHOW_PENDING && CURRENT_ROLE === 'admin') {
            query = query.eq("is_approved", false);
        } else {
            query = query.eq("is_approved", true);
        }

        // Search Text
        const kw = document.getElementById("filter-keyword").value.trim();
        if (kw) query = query.or(`address.ilike.%${kw}%, street.ilike.%${kw}%, code.ilike.%${kw}%`);

        // Filter Dropdowns
        const dist = document.getElementById("filter-district").value;
        if (dist) query = query.eq("district", dist);

        const st = document.getElementById("filter-status").value;
        if (st) query = query.eq("status", st);

        const priceRange = document.getElementById("filter-price").value;
        if(priceRange) {
            if(priceRange === "0-20") query = query.lt("price", 20000000);
            else if(priceRange === "20-50") query = query.gte("price", 20000000).lte("price", 50000000);
            else if(priceRange === "50-100") query = query.gte("price", 50000000).lte("price", 100000000);
            else if(priceRange === "100+") query = query.gt("price", 100000000);
        }

        query = query.order("created_at", { ascending: false }).limit(50);

        const { data, error } = await query;
        if (error) {
            console.error(error);
            toast("L·ªói t·∫£i d·ªØ li·ªáu", "error");
            return;
        }

        if (data.length === 0) {
            grid.innerHTML = `<div class="col-span-full text-center py-10 opacity-50">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p.</div>`;
            return;
        }

        data.forEach(item => {
            const html = renderCard(item);
            grid.insertAdjacentHTML("beforeend", html);
        });
    }

    function renderCard(item) {
        // X·ª≠ l√Ω Badge V·ªã tr√≠
        let locationBadge = `<span class="badge badge-xs badge-ghost opacity-70">H·∫ªm</span>`;
        const fullText = (item.address + " " + (item.detail||"")).toLowerCase();
        if (item.frontage) locationBadge = `<span class="badge badge-xs badge-error text-white border-none">M·∫∑t ti·ªÅn</span>`;
        else if (fullText.includes("hxh") || fullText.includes("xe h∆°i")) locationBadge = `<span class="badge badge-xs badge-info text-white border-none">H·∫ªm xe h∆°i</span>`;

        // X·ª≠ l√Ω ·∫£nh
        let imgUrl = "https://placehold.co/400x300?text=No+Image";
        if (item.images && item.images.length > 0) {
            // Ki·ªÉm tra n·∫øu l√† full link hay path
            if(item.images[0].startsWith("http")) imgUrl = item.images[0];
            else imgUrl = supabase.storage.from("premise-images").getPublicUrl(item.images[0]).data.publicUrl;
        }

        // Format ti·ªÅn
        const priceStr = item.price ? new Intl.NumberFormat('vi-VN').format(item.price) : "Th·ªèa thu·∫≠n";

        // T√™n ng∆∞·ªùi ƒëƒÉng (L·∫•y t·ª´ b·∫£ng profiles join sang)
        const authorEmail = item.profiles?.email || "·∫®n danh";
        const shortName = authorEmail.split('@')[0];

        // N√∫t Duy·ªát (N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô ch·ªù duy·ªát)
        let approveBtn = "";
        if (SHOW_PENDING && CURRENT_ROLE === 'admin') {
            approveBtn = `<button onclick="approveOne('${item.id}', event)" class="btn btn-sm btn-success w-full mt-2 text-white">‚úî Duy·ªát</button>`;
        }

        return `
        <div class="card bg-base-100 border shadow-sm hover:shadow-md transition-all cursor-pointer premise-card h-full flex flex-col" onclick="openDetail('${item.id}')">
            <figure class="h-48 bg-gray-100 relative overflow-hidden">
                <img src="${imgUrl}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-105" loading="lazy" />
                <div class="absolute top-2 right-2">${locationBadge}</div>
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 text-white text-xs truncate">
                    <span class="opacity-80">ƒêƒÉng b·ªüi:</span> <b>${shortName}</b>
                </div>
            </figure>
            <div class="card-body p-3 gap-1 flex-1">
                <div class="text-xs opacity-60 font-medium uppercase tracking-wide">
                    ${item.code || "Ch·ªù c·∫•p m√£"} ‚Ä¢ ${item.district}
                </div>
                <h3 class="font-bold text-sm leading-tight line-clamp-2 mb-1 h-10">
                    ${item.address}
                </h3>
                
                <div class="text-lg font-extrabold text-primary">
                    ${priceStr} <span class="text-xs font-normal text-base-content/70">/th√°ng</span>
                </div>
                
                <div class="flex items-center gap-3 text-xs mt-auto pt-2 border-t border-base-200 opacity-80">
                    <div class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1h-4m4 0v4m0-4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg> ${item.area || 0}m¬≤</div>
                    <div class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg> ${item.floors || 0} t·∫ßng</div>
                    <div class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg> ${item.pn || 0} PN</div>
                </div>
                ${approveBtn}
            </div>
        </div>
        `;
    }

    // ================== ADD NEW PREMISE ==================
    async function saveNewPremise() {
        const getVal = (id) => document.getElementById(id).value.trim();
        
        // Validate
        if (!getVal("add-address") || !getVal("add-district") || !getVal("add-ward") || !getVal("add-price")) {
            toast("Vui l√≤ng ƒëi·ªÅn ƒë·ªß: ƒê·ªãa ch·ªâ, Qu·∫≠n, Ph∆∞·ªùng, Gi√°!", "error");
            return;
        }

        const priceNum = parseInt(getVal("add-price").replace(/\D/g,''));
        
        const payload = {
            address: getVal("add-address"),
            district: getVal("add-district"),
            ward: getVal("add-ward"),
            street: getVal("add-street"),
            price: priceNum,
            area: Number(getVal("add-area")) || null,
            width: Number(getVal("add-width")) || null,
            length: Number(getVal("add-length")) || null,
            floors: Number(getVal("add-floors")) || null,
            pn: Number(getVal("add-bedrooms")) || null,
            wc: Number(getVal("add-wc")) || null,
            ket_cau: getVal("add-ket-cau"),
            frontage: document.getElementById("add-frontage").checked,
            contact_phone: getVal("add-contact-phone"),
            commission_note: getVal("add-commission"),
            images: getVal("add-images").split('\n').map(s=>s.trim()).filter(s=>s),
            detail: getVal("add-detail"),
            status: 'available'
            // Code, created_by, is_approved: T·ª∞ ƒê·ªòNG B·ªûI DATABASE TRIGGER
        };

        const { error } = await supabase.from("premises").insert([payload]);
        if (error) {
            toast("L·ªói: " + error.message, "error");
        } else {
            document.getElementById("addDlg").close();
            toast(CURRENT_ROLE === 'admin' ? "ƒêƒÉng th√†nh c√¥ng!" : "ƒê√£ g·ª≠i duy·ªát!", "success");
            loadPremises(true);
            if(CURRENT_ROLE === 'admin') checkPendingCount();
        }
    }

    // ================== ADMIN PENDING LOGIC ==================
    async function checkPendingCount() {
        const { count } = await supabase.from("premises").select("*", { count: 'exact', head: true }).eq("is_approved", false);
        const cnt = count || 0;
        document.getElementById("count-pending").innerText = cnt;
        
        // Hi·ªán/·∫®n n√∫t Duy·ªát t·∫•t c·∫£
        const btnAll = document.getElementById("btn-approve-all");
        if (SHOW_PENDING && cnt > 0) btnAll.classList.remove("hidden");
        else btnAll.classList.add("hidden");
    }

    function togglePendingMode() {
        SHOW_PENDING = !SHOW_PENDING;
        const btn = document.getElementById("btn-pending");
        if (SHOW_PENDING) {
            btn.classList.replace("btn-warning", "btn-active");
            btn.innerHTML = "ƒêang xem b√†i ch·ªù duy·ªát (Tho√°t)";
        } else {
            btn.classList.replace("btn-active", "btn-warning");
            btn.innerHTML = `C·∫ßn duy·ªát <span class="badge badge-sm bg-white text-warning border-none ml-1" id="count-pending">...</span>`;
            checkPendingCount();
        }
        loadPremises(true);
        checkPendingCount();
    }

    async function approveOne(id, e) {
        e.stopPropagation(); // Tr√°nh click v√†o card m·ªü detail
        if (!confirm("Duy·ªát b√†i n√†y?")) return;
        await supabase.from("premises").update({ is_approved: true }).eq("id", id);
        toast("ƒê√£ duy·ªát!", "success");
        loadPremises(true);
        checkPendingCount();
    }

    async function approveAllPending() {
        if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën duy·ªát T·∫§T C·∫¢ b√†i ƒëang ch·ªù?")) return;
        
        // Update t·∫•t c·∫£ d√≤ng c√≥ is_approved = false
        const { error } = await supabase.from("premises").update({ is_approved: true }).eq("is_approved", false);
        
        if (error) toast("L·ªói: " + error.message, "error");
        else {
            toast("ƒê√£ duy·ªát t·∫•t c·∫£!", "success");
            loadPremises(true);
            checkPendingCount();
        }
    }

    // ================== HELPERS ==================
    function initDropdowns() {
        // Qu·∫≠n
        const distSel = document.getElementById("add-district");
        const filterDist = document.getElementById("filter-district");
        const dists = Object.keys(HCM_DATA).sort();
        
        const opts = dists.map(d => `<option value="${d}">${d}</option>`).join("");
        distSel.innerHTML = `<option value="">-- Ch·ªçn Qu·∫≠n --</option>` + opts;
        filterDist.innerHTML = `<option value="">T·∫•t c·∫£ Qu·∫≠n</option>` + opts;
    }

    function updateWardSelect(dist) {
        const wardSel = document.getElementById("add-ward");
        if(!dist || !HCM_DATA[dist]) {
            wardSel.innerHTML = `<option value="">--</option>`;
            wardSel.disabled = true;
            return;
        }
        wardSel.disabled = false;
        wardSel.innerHTML = HCM_DATA[dist].map(w => `<option value="${w}">${w}</option>`).join("");
    }

    function formatCurrencyInput(el) {
        let val = el.value.replace(/\D/g, '');
        if(val) el.value = new Intl.NumberFormat('vi-VN').format(val);
    }

    function toast(msg, type="info") {
        const t = document.getElementById("toast");
        const txt = document.getElementById("toast-text");
        txt.innerHTML = `<span>${msg}</span>`;
        
        txt.className = `alert shadow-lg ${type==='error' ? 'alert-error' : type==='success' ? 'alert-success' : 'alert-info'}`;
        
        t.classList.remove("hidden");
        setTimeout(() => t.classList.add("hidden"), 3000);
    }
    
    async function openDetail(id) {
        const dlg = document.getElementById("detailDlg");
        const content = document.getElementById("detail-content");
        dlg.showModal();
        content.innerHTML = `<div class="flex justify-center p-10"><span class="loading loading-spinner loading-lg"></span></div>`;
        
        const { data: item } = await supabase.from("premises").select("*, profiles(email)").eq("id", id).single();
        if(!item) return;

        // Render Detail (R√∫t g·ªçn cho file n√†y ƒë·ª° d√†i, b·∫°n c√≥ th·ªÉ custom th√™m ƒë·∫πp h∆°n)
        content.innerHTML = `
            <div class="grid md:grid-cols-2 gap-0 bg-base-100 min-h-[500px]">
                <div class="bg-gray-100 flex items-center justify-center p-4">
                     ${item.images && item.images.length ? `<img src="${item.images[0].startsWith('http')?item.images[0]:supabase.storage.from('premise-images').getPublicUrl(item.images[0]).data.publicUrl}" class="max-h-[400px] rounded shadow"/>` : 'Kh√¥ng ·∫£nh'}
                </div>
                <div class="p-6 flex flex-col gap-3">
                    <div class="badge badge-outline">${item.code || 'MB-NEW'}</div>
                    <h2 class="text-2xl font-bold leading-tight">${item.address}</h2>
                    <p class="text-sm opacity-70">${item.ward}, ${item.district}</p>
                    
                    <div class="text-3xl font-extrabold text-primary my-2">${new Intl.NumberFormat('vi-VN').format(item.price)} ƒë</div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm border-y py-4">
                        <div>Di·ªán t√≠ch: <b>${item.area}m¬≤</b></div>
                        <div>K·∫øt c·∫•u: <b>${item.ket_cau || '--'}</b></div>
                        <div>Ngang: <b>${item.width || '--'}m</b></div>
                        <div>D√†i: <b>${item.length || '--'}m</b></div>
                    </div>
                    
                    <div class="bg-base-200 p-3 rounded text-sm mt-2">
                        <div class="font-bold mb-1">M√¥ t·∫£:</div>
                        <p class="whitespace-pre-line opacity-80">${item.detail || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                    </div>
                    
                    ${CURRENT_ROLE === 'admin' ? `<div class="alert alert-warning text-xs mt-auto">Admin Note: ${item.commission_note||'None'} | Tel: ${item.contact_phone||'--'}</div>` : ''}
                </div>
            </div>
        `;
    }
  </script>
</body>
</html>