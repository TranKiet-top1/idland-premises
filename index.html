<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>ID-Land Premises</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    .premise-card:hover { transform: translateY(-2px); }
  </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

  <section id="auth-section" class="flex-1 flex items-center justify-center">
    <div class="card w-full max-w-md bg-base-100 shadow-xl">
      <div class="card-body">
        <div class="flex items-center gap-2 mb-4">
          <div class="h-10 w-10 rounded-xl bg-primary flex items-center justify-center text-white font-bold">ID</div>
          <div><h2 class="card-title">ID-Land Admin</h2><p class="text-xs opacity-70">Đăng nhập hệ thống</p></div>
        </div>
        <div class="form-control"><label class="label">Email</label><input id="login-email" type="email" class="input input-bordered" /></div>
        <div class="form-control mt-2"><label class="label">Mật khẩu</label><input id="login-password" type="password" class="input input-bordered" /></div>
        <div class="form-control mt-4"><button id="btn-login" class="btn btn-primary w-full">Đăng nhập</button></div>
        <div id="login-msg" class="text-error text-sm mt-2 hidden"></div>
      </div>
    </div>
  </section>

  <div id="app-root" class="hidden min-h-screen flex flex-col">
    <div class="navbar bg-base-100 shadow-sm px-4 sticky top-0 z-30">
      <div class="flex-1 flex items-center gap-2">
        <div class="h-8 w-8 rounded-lg bg-primary flex items-center justify-center text-white font-bold text-xs">ID</div>
        <div><div class="font-bold text-lg leading-tight">ID-Land</div><div class="text-[10px] opacity-60">Kho mặt bằng TP.HCM</div></div>
      </div>
      <div class="flex-none flex items-center gap-2 text-sm">
        <div class="text-right hidden sm:block">
             <div id="user-email" class="text-xs font-bold">...</div>
             <div id="role-badge" class="badge badge-xs badge-ghost">...</div>
        </div>
        <button id="btn-logout" class="btn btn-ghost btn-sm text-error">Thoát</button>
      </div>
    </div>

    <main class="flex-1 max-w-[1400px] mx-auto w-full px-2 sm:px-4 py-4">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <div>
          <h1 class="text-xl font-bold">Quản lý mặt bằng</h1>
          <p class="text-xs opacity-70">Bộ lọc chi tiết & Quản lý trạng thái</p>
        </div>
        <div class="flex gap-2">
           <div id="admin-actions" class="hidden flex gap-2">
               <button id="btn-pending" class="btn btn-warning btn-sm text-white">
                   Cần duyệt <span class="badge badge-sm bg-white text-warning ml-1" id="count-pending">0</span>
               </button>
               <button id="btn-approve-all" class="btn btn-success btn-sm text-white hidden">✔ Duyệt hết</button>
           </div>
           <button id="btn-add-premise" class="btn btn-primary btn-sm">+ Đăng mới</button>
        </div>
      </div>

      <div class="grid md:grid-cols-[260px,1fr] gap-4">
        
        <aside class="bg-base-100 rounded-2xl shadow-sm p-4 h-fit">
          <div class="flex items-center gap-2 mb-3"><span class="w-2 h-2 rounded-full bg-success"></span><h2 class="font-semibold text-sm">Bộ lọc tìm kiếm</h2></div>
          
          <div class="form-control mb-2">
            <label class="label py-1"><span class="label-text text-xs">Từ khoá / Mã MB</span></label>
            <input id="filter-keyword" type="text" placeholder="Đường, Phường..." class="input input-sm input-bordered" />
          </div>

          <div class="form-control mb-2">
            <label class="label py-1"><span class="label-text text-xs">Quận</span></label>
            <select id="filter-district" class="select select-sm select-bordered w-full"><option value="">Tất cả</option></select>
          </div>
          <div class="form-control mb-2">
            <label class="label py-1"><span class="label-text text-xs">Phường</span></label>
            <select id="filter-ward" class="select select-sm select-bordered w-full"><option value="">Tất cả</option></select>
          </div>

          <div class="grid grid-cols-2 gap-2 mb-2">
             <div class="form-control">
               <label class="label py-1"><span class="label-text text-xs">Giá từ (triệu)</span></label>
               <input id="filter-price-min" type="number" class="input input-sm input-bordered" />
             </div>
             <div class="form-control">
               <label class="label py-1"><span class="label-text text-xs">Đến (triệu)</span></label>
               <input id="filter-price-max" type="number" class="input input-sm input-bordered" />
             </div>
          </div>

          <div class="grid grid-cols-2 gap-2 mb-2">
             <div class="form-control">
               <label class="label py-1"><span class="label-text text-xs">DT từ (m²)</span></label>
               <input id="filter-area-min" type="number" class="input input-sm input-bordered" />
             </div>
             <div class="form-control">
               <label class="label py-1"><span class="label-text text-xs">Đến (m²)</span></label>
               <input id="filter-area-max" type="number" class="input input-sm input-bordered" />
             </div>
          </div>

          <div class="grid grid-cols-3 gap-1 mb-2">
             <select id="filter-pn" class="select select-sm select-bordered text-[10px] px-1">
                <option value="">PN</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5+">>5</option>
             </select>
             <select id="filter-wc" class="select select-sm select-bordered text-[10px] px-1">
                <option value="">WC</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5+">>5</option>
             </select>
             <select id="filter-floors" class="select select-sm select-bordered text-[10px] px-1">
                <option value="">Tầng</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5+">>5</option>
             </select>
          </div>

          <div class="form-control mb-2">
             <label class="label py-1"><span class="label-text text-xs">Vị trí</span></label>
             <select id="filter-frontage" class="select select-sm select-bordered">
                <option value="">Tất cả</option>
                <option value="mt">Mặt tiền</option>
                <option value="hxh">Hẻm xe hơi</option>
                <option value="hem">Hẻm thường</option>
             </select>
          </div>

          <div class="form-control mb-4">
             <label class="label py-1"><span class="label-text text-xs">Trạng thái</span></label>
             <select id="filter-status" class="select select-sm select-bordered">
                <option value="">Tất cả</option>
                <option value="available">Còn trống</option>
                <option value="deposited">Giữ cọc</option>
                <option value="rented">Đã thuê</option>
             </select>
          </div>

          <div class="flex gap-2">
             <button id="btn-apply" class="btn btn-sm btn-primary flex-1">Lọc</button>
             <button id="btn-reset" class="btn btn-sm btn-ghost">Xoá</button>
          </div>
        </aside>

        <section class="flex flex-col gap-3">
           <div class="flex justify-between items-center text-xs opacity-70 px-1">
              <span>Hiển thị kết quả mới nhất</span>
              <span id="result-count">Loading...</span>
           </div>
           
           <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
              </div>
           <div class="text-center mt-4"><button id="btn-load-more" class="btn btn-sm btn-ghost">Tải thêm</button></div>
        </section>
      </div>
    </main>
  </div>

  <dialog id="addDlg" class="modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
      <h3 class="font-bold text-lg mb-4 text-primary">Đăng mặt bằng mới</h3>
      <div class="grid md:grid-cols-2 gap-4">
          <div>
              <div class="form-control mb-2"><span class="label-text text-xs font-bold">Địa chỉ *</span><input id="add-address" type="text" class="input input-sm input-bordered"/></div>
              <div class="grid grid-cols-2 gap-2 mb-2">
                  <select id="add-district" class="select select-sm select-bordered"><option>Quận</option></select>
                  <select id="add-ward" class="select select-sm select-bordered" disabled><option>Phường</option></select>
              </div>
              <div class="form-control mb-2"><span class="label-text text-xs">Tên đường</span><input id="add-street" type="text" class="input input-sm input-bordered"/></div>
              <div class="form-control mt-4"><span class="label-text text-xs font-bold text-primary">Giá thuê</span><input id="add-price" type="text" class="input input-sm input-bordered font-bold" onkeyup="formatMoney(this)"/></div>
              <div class="flex gap-4 mt-2">
                  <label class="flex items-center gap-2 cursor-pointer"><input id="add-frontage" type="checkbox" class="checkbox checkbox-sm" /><span class="text-sm">Mặt tiền</span></label>
              </div>
          </div>
          <div>
              <div class="grid grid-cols-3 gap-2 mb-2">
                  <div><span class="text-xs">DT (m²)</span><input id="add-area" type="number" class="input input-sm input-bordered w-full"/></div>
                  <div><span class="text-xs">Ngang</span><input id="add-width" type="number" class="input input-sm input-bordered w-full"/></div>
                  <div><span class="text-xs">Dài</span><input id="add-length" type="number" class="input input-sm input-bordered w-full"/></div>
              </div>
              <div class="grid grid-cols-3 gap-2 mb-2">
                  <div><span class="text-xs">Tầng</span><input id="add-floors" type="number" class="input input-sm input-bordered w-full"/></div>
                  <div><span class="text-xs">PN</span><input id="add-bedrooms" type="number" class="input input-sm input-bordered w-full"/></div>
                  <div><span class="text-xs">WC</span><input id="add-wc" type="number" class="input input-sm input-bordered w-full"/></div>
              </div>
              <div class="form-control mb-2"><span class="text-xs">Kết cấu</span><input id="add-ket-cau" type="text" class="input input-sm input-bordered"/></div>
              <div class="form-control mb-2"><span class="text-xs text-error font-bold">SĐT Chủ (Admin xem)</span><input id="add-contact" type="text" class="input input-sm input-bordered input-error"/></div>
          </div>
          <div class="md:col-span-2">
             <textarea id="add-images" class="textarea textarea-bordered w-full h-16 text-xs mb-2" placeholder="Link ảnh (mỗi dòng 1 link)"></textarea>
             <textarea id="add-detail" class="textarea textarea-bordered w-full h-20 text-sm" placeholder="Mô tả chi tiết..."></textarea>
          </div>
      </div>
      <div class="modal-action"><button class="btn" onclick="addDlg.close()">Huỷ</button><button class="btn btn-primary" onclick="saveNew()">Lưu tin</button></div>
    </div>
  </dialog>

  <dialog id="detailDlg" class="modal"><div class="modal-box max-w-5xl p-0" id="detail-content"></div><form method="dialog" class="modal-backdrop"><button>close</button></form></dialog>

  <div id="toast" class="toast toast-top toast-end hidden z-50"><div id="toast-msg" class="alert alert-info shadow-lg"></div></div>

  <script>
    // CONFIG
    const SUPABASE_URL = "https://xclncowkoedwqzcemhei.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbG5jb3drb2Vkd3F6Y2VtaGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNzcwOTUsImV4cCI6MjA3Nzg1MzA5NX0.jfNM46UgXIq9LrwSXcERJJULeKB7bl_c9R9LaVhRy1A";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // DATA HCM
    const HCM_DATA = {"Quận 1":["Bến Nghé","Bến Thành","Đa Kao","Tân Định","Nguyễn Cư Trinh"],"Quận 3":["Phường 1","Phường 2","Võ Thị Sáu"],"Quận 5":["Phường 1","Phường 5"],"Quận 10":["Phường 12","Phường 14"],"Bình Thạnh":["Phường 1","Phường 25"],"Tân Bình":["Phường 1","Phường 13"]}; // Demo ngắn gọn, bạn có thể paste full list cũ vào

    let USER = null, ROLE = "staff", PENDING_MODE = false;

    // INIT
    document.addEventListener("DOMContentLoaded", () => {
        initDistricts();
        checkSession();
        
        // Events
        document.getElementById("btn-login").onclick = doLogin;
        document.getElementById("btn-logout").onclick = async () => { await supabase.auth.signOut(); location.reload(); };
        document.getElementById("btn-add-premise").onclick = () => document.getElementById("addDlg").showModal();
        document.getElementById("btn-apply").onclick = () => loadData(true);
        document.getElementById("btn-reset").onclick = resetFilters;
        document.getElementById("add-district").onchange = (e) => updateWards("add-ward", e.target.value);
        document.getElementById("filter-district").onchange = (e) => updateWards("filter-ward", e.target.value);
        
        // Admin Events
        document.getElementById("btn-pending").onclick = togglePending;
        document.getElementById("btn-approve-all").onclick = approveAll;
    });

    // AUTH
    async function checkSession() {
        const { data } = await supabase.auth.getUser();
        if(data.user) {
            USER = data.user;
            // Lấy Role
            const { data: profile } = await supabase.from("profiles").select("role, email").eq("id", USER.id).maybeSingle();
            ROLE = profile?.role || "staff";
            
            document.getElementById("user-email").innerText = profile?.email || USER.email;
            document.getElementById("role-badge").innerText = ROLE;
            document.getElementById("auth-section").classList.add("hidden");
            document.getElementById("app-root").classList.remove("hidden");

            if(ROLE === 'admin') {
                document.getElementById("admin-actions").classList.remove("hidden");
                document.getElementById("role-badge").className = "badge badge-xs badge-error text-white";
                countPending();
            }
            loadData(true);
        }
    }

    async function doLogin() {
        const email = document.getElementById("login-email").value;
        const pass = document.getElementById("login-password").value;
        const { error } = await supabase.auth.signInWithPassword({email, password: pass});
        if(error) document.getElementById("login-msg").innerText = error.message, document.getElementById("login-msg").classList.remove("hidden");
        else checkSession();
    }

    // LOAD DATA
    async function loadData(reset = false) {
        const grid = document.getElementById("grid");
        if(reset) grid.innerHTML = "";
        
        // QUAN TRỌNG: Join profiles để lấy email người đăng
        let query = supabase.from("premises").select("*, profiles(email)");

        // 1. Filter logic
        if(PENDING_MODE && ROLE === 'admin') query = query.eq("is_approved", false);
        else query = query.eq("is_approved", true);

        // 2. Sidebar Filters
        const kw = document.getElementById("filter-keyword").value.trim();
        if(kw) query = query.or(`address.ilike.%${kw}%, code.ilike.%${kw}%`);

        const d = document.getElementById("filter-district").value; if(d) query = query.eq("district", d);
        const w = document.getElementById("filter-ward").value; if(w) query = query.eq("ward", w);
        
        const pMin = document.getElementById("filter-price-min").value; if(pMin) query = query.gte("price", pMin*1000000);
        const pMax = document.getElementById("filter-price-max").value; if(pMax) query = query.lte("price", pMax*1000000);
        
        const aMin = document.getElementById("filter-area-min").value; if(aMin) query = query.gte("area", aMin);
        const aMax = document.getElementById("filter-area-max").value; if(aMax) query = query.lte("area", aMax);
        
        const pn = document.getElementById("filter-pn").value; if(pn) pn.includes('+') ? query = query.gte("pn", 5) : query = query.eq("pn", pn);
        const wc = document.getElementById("filter-wc").value; if(wc) wc.includes('+') ? query = query.gte("wc", 5) : query = query.eq("wc", wc);
        const fl = document.getElementById("filter-floors").value; if(fl) fl.includes('+') ? query = query.gte("floors", 5) : query = query.eq("floors", fl);

        const ft = document.getElementById("filter-frontage").value;
        if(ft === 'mt') query = query.eq("frontage", true);
        
        const st = document.getElementById("filter-status").value; if(st) query = query.eq("status", st);

        query = query.order("created_at", {ascending: false}).limit(50);

        const { data, error } = await query;
        if(error) { 
            console.error(error); 
            // Fallback nếu chưa chạy SQL fix: Ẩn tên người đăng đi để ko lỗi
            if(error.code === '400') {
                alert("Lỗi quyền: Bạn chưa chạy lệnh SQL fix DB! Tải lại trang sẽ dùng chế độ an toàn (không hiện tên người đăng).");
                query = supabase.from("premises").select("*"); // Retry without join
                // ... (Simplified retry logic logic omitted for brevity)
            }
            return; 
        }

        document.getElementById("result-count").innerText = `${data.length} kết quả`;
        if(!data.length) grid.innerHTML = `<div class="col-span-full text-center py-10 opacity-50">Không tìm thấy.</div>`;

        // Client-side filter for Hẻm/HXH (DB only has frontage boolean)
        let rows = data;
        if(ft === 'hxh' || ft === 'hem') {
            rows = rows.filter(r => {
                const txt = (r.address + (r.detail||"")).toLowerCase();
                const isHXH = txt.includes("hxh") || txt.includes("xe hơi");
                return ft === 'hxh' ? (!r.frontage && isHXH) : (!r.frontage && !isHXH);
            });
        }

        rows.forEach(item => grid.insertAdjacentHTML("beforeend", renderCard(item)));
    }

    function renderCard(item) {
        const price = item.price ? (item.price/1000000).toLocaleString() + " triệu" : "Thỏa thuận";
        const img = (item.images && item.images[0]) 
            ? (item.images[0].startsWith('http') ? item.images[0] : supabase.storage.from("premise-images").getPublicUrl(item.images[0]).data.publicUrl)
            : "https://placehold.co/400x300?text=No+Image";
        
        // Badge Vị trí
        let badge = `<span class="badge badge-xs badge-ghost">Hẻm</span>`;
        if(item.frontage) badge = `<span class="badge badge-xs badge-error text-white">Mặt tiền</span>`;
        else if((item.address+(item.detail||"")).toLowerCase().includes("hxh")) badge = `<span class="badge badge-xs badge-info text-white">HXH</span>`;

        // Tên người đăng
        const creator = item.profiles?.email?.split('@')[0] || "Ẩn danh";

        // Nút Duyệt
        const approveBtn = (PENDING_MODE && ROLE==='admin') ? `<button onclick="approveOne('${item.id}', event)" class="btn btn-xs btn-success w-full mt-2 text-white">✔ Duyệt bài</button>` : '';

        return `
        <div class="card bg-base-100 border shadow-sm hover:shadow-md cursor-pointer premise-card" onclick="openDetail('${item.id}')">
           <figure class="h-48 bg-gray-100 relative">
              <img src="${img}" class="w-full h-full object-cover"/>
              <div class="absolute top-2 right-2">${badge}</div>
              <div class="absolute bottom-0 left-0 w-full bg-black/50 text-white text-[10px] p-1 px-2 truncate">
                  Đăng bởi: ${creator}
              </div>
           </figure>
           <div class="card-body p-3 gap-1">
              <div class="text-xs opacity-60">${item.code || 'MB-NEW'} • ${item.district}</div>
              <h3 class="font-bold text-sm truncate">${item.address}</h3>
              <div class="font-extrabold text-primary text-lg">${price}</div>
              <div class="flex gap-2 text-xs opacity-80 mt-1">
                  <span>${item.width||0}x${item.length||0}m</span> • <span>${item.area||0}m²</span> • <span>${item.pn||0}PN</span>
              </div>
              ${approveBtn}
           </div>
        </div>`;
    }

    // ACTIONS
    async function saveNew() {
        const getVal = (id) => document.getElementById(id).value.trim();
        const price = parseInt(getVal("add-price").replace(/\D/g,'')) || 0;
        
        const payload = {
            address: getVal("add-address"),
            district: document.getElementById("add-district").value,
            ward: document.getElementById("add-ward").value,
            street: getVal("add-street"),
            price,
            area: getVal("add-area"), width: getVal("add-width"), length: getVal("add-length"),
            floors: getVal("add-floors"), pn: getVal("add-bedrooms"), wc: getVal("add-wc"),
            ket_cau: getVal("add-ket-cau"), contact_phone: getVal("add-contact"),
            frontage: document.getElementById("add-frontage").checked,
            images: getVal("add-images").split('\n').filter(x=>x),
            detail: getVal("add-detail"),
            status: 'available'
        };

        const { error } = await supabase.from("premises").insert([payload]);
        if(error) toast(error.message, 'error');
        else {
            toast(ROLE==='admin' ? "Đã thêm thành công!" : "Đã gửi duyệt!");
            document.getElementById("addDlg").close();
            loadData(true);
            if(ROLE==='admin') countPending();
        }
    }

    // ADMIN LOGIC
    async function countPending() {
        const { count } = await supabase.from("premises").select("*", {count: 'exact', head: true}).eq("is_approved", false);
        document.getElementById("count-pending").innerText = count || 0;
        if(count > 0) document.getElementById("btn-approve-all").classList.remove("hidden");
        else document.getElementById("btn-approve-all").classList.add("hidden");
    }

    function togglePending() {
        PENDING_MODE = !PENDING_MODE;
        const btn = document.getElementById("btn-pending");
        if(PENDING_MODE) btn.classList.replace("btn-warning", "btn-active"), btn.innerText = "Đang xem Chờ duyệt (Thoát)";
        else btn.classList.replace("btn-active", "btn-warning"), btn.innerHTML = `Cần duyệt <span class="badge badge-sm bg-white text-warning ml-1" id="count-pending">...</span>`, countPending();
        loadData(true);
    }

    async function approveOne(id, e) {
        e.stopPropagation();
        await supabase.from("premises").update({is_approved: true}).eq("id", id);
        toast("Đã duyệt!"); loadData(true); countPending();
    }
    
    async function approveAll() {
        if(!confirm("Duyệt tất cả bài chờ?")) return;
        await supabase.from("premises").update({is_approved: true}).eq("is_approved", false);
        toast("Đã duyệt toàn bộ!"); loadData(true); countPending();
    }

    // HELPERS
    function initDistricts() {
        const html = Object.keys(HCM_DATA).map(d => `<option value="${d}">${d}</option>`).join("");
        document.getElementById("add-district").innerHTML += html;
        document.getElementById("filter-district").innerHTML += html;
    }
    function updateWards(elId, dist) {
        const el = document.getElementById(elId);
        el.innerHTML = '<option value="">Tất cả</option>';
        if(HCM_DATA[dist]) el.innerHTML += HCM_DATA[dist].map(w => `<option value="${w}">${w}</option>`).join(""), el.disabled = false;
        else el.disabled = true;
    }
    function resetFilters() {
        document.querySelectorAll("aside input, aside select").forEach(i => i.value = "");
        loadData(true);
    }
    function formatMoney(el) { el.value = new Intl.NumberFormat('vi-VN').format(el.value.replace(/\D/g,'')); }
    function toast(msg, type='info') {
        const t = document.getElementById("toast"), m = document.getElementById("toast-msg");
        m.innerText = msg; m.className = `alert shadow-lg alert-${type}`;
        t.classList.remove("hidden"); setTimeout(() => t.classList.add("hidden"), 2500);
    }
    async function openDetail(id) {
        const d = document.getElementById("detailDlg"), c = document.getElementById("detail-content");
        d.showModal(); c.innerHTML = `<div class="p-10 text-center"><span class="loading loading-spinner"></span></div>`;
        const { data } = await supabase.from("premises").select("*").eq("id", id).single();
        c.innerHTML = `<div class="p-8"><h2 class="text-2xl font-bold">${data.address}</h2><p>${data.detail || '...'}</p></div>`;
    }
  </script>
</body>
</html>