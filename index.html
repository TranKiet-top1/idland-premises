<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>ID Land Premises</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <style>
    .modal-open { display:block !important; }
    .modal { display:none; }
  </style>
</head>

<body class="bg-gray-50">

  <!-- ================= NAVBAR ================= -->
  <div class="navbar px-4 py-3 shadow-sm bg-white flex justify-between">
    <div class="flex items-center gap-2">
      <img src="logo.png" class="w-10 h-10 rounded-full border" />
      <span class="text-xl font-bold">ID-Land Premises</span>
    </div>

    <div class="flex items-center gap-3">
      <button id="addPremiseBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hidden">+ Thêm mặt bằng</button>
      <button id="logoutBtn" class="text-red-500 font-semibold hidden">Đăng xuất</button>
    </div>
  </div>

  <!-- ================= LOGIN FORM ================= -->
  <div id="loginSection" class="w-full flex justify-center mt-12">
    <div class="bg-white shadow-md p-8 rounded-lg w-96">
      <h2 class="text-2xl font-semibold mb-4 text-center">Đăng nhập</h2>

      <input id="loginEmail" type="email" placeholder="Email"
        class="input input-bordered w-full mb-3 px-3 py-2 border rounded-lg" />

      <input id="loginPassword" type="password" placeholder="Mật khẩu"
        class="input input-bordered w-full mb-3 px-3 py-2 border rounded-lg" />

      <button id="loginBtn" class="bg-blue-600 text-white w-full py-2 rounded-lg mt-2">
        Đăng nhập
      </button>

      <p id="loginError" class="text-red-500 text-center mt-3 hidden"></p>
    </div>
  </div>

  <!-- ================= MAIN CONTENT ================= -->
  <div id="mainSection" class="hidden px-4">

    <h1 class="text-3xl font-bold mt-5 mb-3">Bộ lọc mặt bằng</h1>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">

      <!-- Bộ lọc bên trái -->
      <div class="bg-white p-4 rounded-lg shadow">

        <h2 class="font-semibold text-lg mb-2">Bộ lọc</h2>

        <input id="searchInput" class="w-full px-3 py-2 border rounded-lg mb-3"
          placeholder="VD: Trần Hưng Đạo, MB 0001" />

        <select id="districtFilter" class="w-full px-3 py-2 border rounded-lg mb-3">
          <option value="">Quận (Tất cả)</option>
        </select>

        <select id="wardFilter" class="w-full px-3 py-2 border rounded-lg mb-3">
          <option value="">Phường (Tất cả)</option>
        </select>

        <!-- PN -->
        <select id="pnFilter" class="w-full px-3 py-2 border rounded-lg mb-3">
          <option value="">Số PN (Tất cả)</option>
          <option value="1">1</option><option value="2">2</option>
          <option value="3">3</option><option value="4">4</option>
          <option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option>
          <option value="9">9</option><option value="10">10</option>
          <option value=">10">>10</option>
        </select>

        <!-- TẦNG -->
        <select id="floorsFilter" class="w-full px-3 py-2 border rounded-lg mb-3">
          <option value="">Số tầng (Tất cả)</option>
          <option value="1">1</option><option value="2">2</option>
          <option value="3">3</option><option value="4">4</option>
          <option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option>
          <option value="9">9</option><option value="10">10</option>
          <option value=">10">>10</option>
        </select>

        <!-- WC -->
        <select id="wcFilter" class="w-full px-3 py-2 border rounded-lg mb-3">
          <option value="">Số WC (Tất cả)</option>
          <option value="1">1</option><option value="2">2</option>
          <option value="3">3</option><option value="4">4</option>
          <option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option>
          <option value="9">9</option><option value="10">10</option>
          <option value=">10">>10</option>
        </select>

        <!-- Mặt tiền -->
        <select id="frontageFilter" class="w-full px-3 py-2 border rounded-lg mb-3">
          <option value="">Mặt tiền (Tất cả)</option>
          <option value="hem">Hẻm</option>
          <option value="hx h">Hẻm xe hơi</option>
          <option value="mt">Mặt tiền</option>
        </select>

      </div>

      <!-- DANH SÁCH -->
      <div id="premiseList" class="col-span-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- JS Render -->
      </div>

    </div>
  </div>

<!-- =============== MODAL CHI TIẾT MẶT BẰNG =============== -->
<div id="detailModal" class="modal fixed inset-0 bg-black bg-opacity-40 flex justify-center items-start py-10 z-[999]">
  <div class="bg-white rounded-lg shadow-xl p-6 w-[95%] lg:w-[70%] relative">

    <!-- Close button -->
    <button onclick="closeDetailModal()" class="absolute right-4 top-4 text-gray-600 hover:text-black text-xl">✕</button>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">

      <!-- Hình ảnh -->
      <div>
        <img id="detailImage" src="" class="w-full rounded-lg shadow" />
        <div id="detailImageList" class="flex gap-2 mt-2"></div>
      </div>

      <!-- Thông tin mặt bằng -->
      <div>
        <h2 id="detailTitle" class="text-2xl font-bold mb-2"></h2>

        <div class="text-gray-600 space-y-1 text-[15px]">
          <p><b>Mã MB:</b> <span id="detailCode"></span></p>
          <p><b>Địa chỉ:</b> <span id="detailAddress"></span></p>
          <p><b>Quận:</b> <span id="detailDistrict"></span></p>
          <p><b>Phường:</b> <span id="detailWard"></span></p>
          <p><b>Kết cấu:</b> <span id="detailStructure"></span></p>
          <p><b>Số PN:</b> <span id="detailPN"></span></p>
          <p><b>Số WC:</b> <span id="detailWC"></span></p>
          <p><b>Số tầng:</b> <span id="detailFloors"></span></p>
          <p><b>Diện tích:</b> <span id="detailArea"></span></p>
          <p><b>Mặt tiền:</b> <span id="detailFrontage"></span></p>

          <p class="text-blue-600 font-bold text-xl mt-3">Giá thuê:
            <span id="detailPrice"></span> đ
          </p>

          <p class="mt-1"><b>Liên hệ:</b>
            <span id="detailContact" class="text-blue-700"></span>
          </p>

          <p><b>Ngày cập nhật:</b> <span id="detailUpdated"></span></p>
        </div>

        <!-- Button nhóm -->
        <div class="flex gap-2 mt-4">
          <a id="btnCall" href="#" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Gọi</a>
          <a id="btnZalo" href="#" class="px-4 py-2 bg-teal-600 text-white rounded-lg">Zalo</a>
          <button id="btnCopyLink" class="px-4 py-2 bg-gray-200 rounded-lg">Copy link</button>

          <button id="btnEdit" onclick="openEditModal()"
            class="px-4 py-2 bg-yellow-400 text-black rounded-lg hidden">
            Chỉnh sửa
          </button>
        </div>

        <!-- Thông tin chi tiết -->
        <div class="mt-5 bg-gray-100 p-4 rounded-lg shadow-inner">
          <h3 class="font-semibold mb-2 text-lg">Thông tin chi tiết</h3>
          <p id="detailMore" class="text-gray-700 whitespace-pre-line"></p>
        </div>

      </div>
    </div>

    <!-- Map -->
    <div class="mt-6">
      <iframe id="detailMap" class="w-full h-72 rounded-xl"
        loading="lazy" allowfullscreen referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>

  </div>
</div>

<!-- =============== MODAL CHỈNH SỬA =============== -->
<div id="editModal" class="modal fixed inset-0 bg-black bg-opacity-40 flex justify-center items-start py-10 z-[999]">
  <div class="bg-white rounded-lg shadow-xl p-6 w-[95%] lg:w-[60%] relative">

    <button onclick="closeEditModal()" class="absolute right-4 top-4 text-gray-600 hover:text-black text-xl">✕</button>

    <h2 class="text-2xl font-bold mb-4">Chỉnh sửa mặt bằng</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

      <div>
        <label class="font-semibold">Mã mặt bằng</label>
        <input id="editCode" class="w-full px-3 py-2 border rounded-lg mb-3" />
      </div>

      <div>
        <label class="font-semibold">Địa chỉ</label>
        <input id="editAddress" class="w-full px-3 py-2 border rounded-lg mb-3" />
      </div>

      <div>
        <label class="font-semibold">Phường</label>
        <input id="editWard" class="w-full px-3 py-2 border rounded-lg mb-3" />
      </div>

      <div>
        <label class="font-semibold">Quận</label>
        <input id="editDistrict" class="w-full px-3 py-2 border rounded-lg mb-3" />
      </div>

      <div>
        <label class="font-semibold">Kết cấu</label>
        <input id="editStructure" class="w-full px-3 py-2 border rounded-lg mb-3" />
      </div>

      <div>
        <label class="font-semibold">Số PN</label>
        <input id="editPN" type="number" class="w-full px-3 py-2 border rounded-lg mb-3" />
      </div>

      <div>
        <label class="font-semibold">Số WC</label>
        <input id="editWC" type="number" class="w-full px-3 py-2 border rounded-lg mb-3" />
      </div>

      <div>
        <label class="font-semibold">Số tầng</label>
        <input id="editFloors" type="number" class="w-full px-3 py-2 border rounded-lg mb-3" />
      </div>

      <div>
        <label class="font-semibold">Diện tích (m²)</label>
        <input id="editArea" class="w-full px-3 py-2 border rounded-lg mb-3" />
      </div>

      <div>
        <label class="font-semibold">Mặt tiền</label>
        <input id="editFrontage" class="w-full px-3 py-2 border rounded-lg mb-3" />
      </div>

      <div>
        <label class="font-semibold">Giá thuê</label>
        <input id="editPrice" class="w-full px-3 py-2 border rounded-lg mb-3" />
      </div>

      <div>
        <label class="font-semibold">SĐT chủ nhà</label>
        <input id="editContact" class="w-full px-3 py-2 border rounded-lg mb-3" />
      </div>

      <div class="col-span-2">
        <label class="font-semibold">Thông tin chi tiết</label>
        <textarea id="editMore" class="w-full px-3 py-2 border rounded-lg h-32"></textarea>
      </div>

    </div>

    <button onclick="saveEdit()"
      class="bg-green-600 text-white px-6 py-2 rounded-lg mt-5">Lưu thay đổi</button>
  </div>
</div>
<script>
/* ============================================================
   KHAI BÁO SUPABASE
============================================================ */
const supabase = window.supabase.createClient(
  "https://xclncowkoedwqzcemhei.supabase.co",
  "YOUR_ANON_KEY"
);

/* ============================================================
   TÀI KHOẢN HIỆN TẠI (ADMIN / STAFF)
============================================================ */
let currentRole = localStorage.getItem("role") || "staff"; 
// staff = không xem số nhà, số điện thoại
// admin = full quyền

if (currentRole === "admin") {
  document.getElementById("btnAdd")?.classList.remove("hidden");
  document.getElementById("btnLogout")?.classList.remove("hidden");
}

/* ============================================================
   TẢI DANH SÁCH MẶT BẰNG
============================================================ */
let allRows = [];

async function loadPremises() {
  const { data, error } = await supabase
    .from("premises")
    .select("*")
    .order("updated_at", { ascending: false });

  if (error) {
    console.error(error);
    return;
  }

  allRows = data;
  renderCards(allRows);
}

loadPremises();

/* ============================================================
   RENDER DANH SÁCH THẺ CARD
============================================================ */
function money(v) {
  if (!v) return "";
  return Number(v).toLocaleString("vi-VN");
}

async function getImageUrl(path) {
  if (!path) return null;

  const { data } = await supabase.storage
    .from("premise-images")
    .getPublicUrl(path);

  return data?.publicUrl || null;
}

async function renderCards(list) {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  for (const item of list) {
    let img = "";
    if (Array.isArray(item.images) && item.images.length > 0) {
      const url = await getImageUrl(item.images[0]);
      img = `<img src="${url}" class="w-full h-56 object-cover rounded-xl" />`;
    } else {
      img = `<div class="w-full h-56 bg-gray-200 rounded-xl flex items-center justify-center text-gray-500">Không có ảnh</div>`;
    }

    // ẨN SỐ NHÀ + SỐ ĐIỆN THOẠI CHO STAFF
    const title = currentRole === "staff"
      ? (item.street || "")
      : (item.address || "");

    const contact = currentRole === "staff"
      ? "Ẩn"
      : (item.contact_phone || "");

    const updated = item.updated_at
      ? new Date(item.updated_at).toLocaleDateString("vi-VN")
      : "";

    grid.innerHTML += `
      <div class="border rounded-xl shadow-md p-3 bg-white cursor-pointer"
           onclick="openDetail('${item.id}')">
        ${img}
        <h3 class="mt-2 font-bold text-lg">${title}</h3>

        <div class="text-gray-600 text-sm mt-1">
          ${item.district || ""} • ${item.area || ""} m² • Cập nhật ${updated}
        </div>

        <div class="mt-2 text-blue-600 font-bold text-xl">
          ${money(item.price)} đ
        </div>
      </div>
    `;
  }
}

/* ============================================================
   MỞ MODAL CHI TIẾT
============================================================ */
let currentDetail = null;

async function openDetail(id) {
  const row = allRows.find(r => r.id === id);
  if (!row) return;

  currentDetail = row;

  // HÌNH ẢNH
  if (Array.isArray(row.images) && row.images.length > 0) {
    const first = await getImageUrl(row.images[0]);
    document.getElementById("detailImage").src = first;

    let thumbs = "";
    for (let p of row.images) {
      const url = await getImageUrl(p);
      thumbs += `<img onclick="changeDetailImage('${url}')"
                 src="${url}" class="w-16 h-16 object-cover rounded-lg cursor-pointer" />`;
    }
    document.getElementById("detailImageList").innerHTML = thumbs;
  }

  // DỮ LIỆU
  document.getElementById("detailTitle").textContent = row.address || "";
  document.getElementById("detailCode").textContent = row.code || "";
  document.getElementById("detailAddress").textContent = row.address || "";
  document.getElementById("detailDistrict").textContent = row.district || "";
  document.getElementById("detailWard").textContent = row.ward || "";
  document.getElementById("detailStructure").textContent = row.structure || "";
  document.getElementById("detailPN").textContent = row.pn || "0";
  document.getElementById("detailWC").textContent = row.wc || "0";
  document.getElementById("detailFloors").textContent = row.floors || "0";
  document.getElementById("detailArea").textContent = row.area || "";
  document.getElementById("detailFrontage").textContent = row.frontage || "";
  document.getElementById("detailPrice").textContent = money(row.price);
  document.getElementById("detailContact").textContent =
    currentRole === "staff" ? "Ẩn" : (row.contact_phone || "");
  document.getElementById("detailMore").textContent = row.detail || "";

  const upd = row.updated_at
    ? new Date(row.updated_at).toLocaleDateString("vi-VN")
    : "";
  document.getElementById("detailUpdated").textContent = upd;

  // MAP
  const query = encodeURIComponent(row.address || "");
  document.getElementById("detailMap").src =
    `https://www.google.com/maps?q=${query}&output=embed`;

  // HIỆN NÚT CHỈNH SỬA CHO ADMIN
  if (currentRole === "admin")
    document.getElementById("btnEdit").classList.remove("hidden");
  else
    document.getElementById("btnEdit").classList.add("hidden");

  document.getElementById("detailModal").style.display = "flex";
}

function changeDetailImage(url) {
  document.getElementById("detailImage").src = url;
}

function closeDetailModal() {
  document.getElementById("detailModal").style.display = "none";
}

/* ============================================================
   MỞ MODAL CHỈNH SỬA
============================================================ */
function openEditModal() {
  const r = currentDetail;

  document.getElementById("editCode").value = r.code || "";
  document.getElementById("editAddress").value = r.address || "";
  document.getElementById("editWard").value = r.ward || "";
  document.getElementById("editDistrict").value = r.district || "";
  document.getElementById("editStructure").value = r.structure || "";
  document.getElementById("editPN").value = r.pn || "";
  document.getElementById("editWC").value = r.wc || "";
  document.getElementById("editFloors").value = r.floors || "";
  document.getElementById("editArea").value = r.area || "";
  document.getElementById("editFrontage").value = r.frontage || "";
  document.getElementById("editPrice").value = r.price || "";
  document.getElementById("editContact").value = r.contact_phone || "";
  document.getElementById("editMore").value = r.detail || "";

  document.getElementById("editModal").style.display = "flex";
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}

/* ============================================================
   LƯU CHỈNH SỬA
============================================================ */
async function saveEdit() {
  const payload = {
    code: document.getElementById("editCode").value,
    address: document.getElementById("editAddress").value,
    ward: document.getElementById("editWard").value,
    district: document.getElementById("editDistrict").value,
    structure: document.getElementById("editStructure").value,
    pn: Number(document.getElementById("editPN").value),
    wc: Number(document.getElementById("editWC").value),
    floors: Number(document.getElementById("editFloors").value),
    area: Number(document.getElementById("editArea").value),
    frontage: document.getElementById("editFrontage").value,
    price: Number(document.getElementById("editPrice").value),
    contact_phone: document.getElementById("editContact").value,
    detail: document.getElementById("editMore").value,
    updated_at: new Date().toISOString(),
  };

  const { error } = await supabase
    .from("premises")
    .update(payload)
    .eq("id", currentDetail.id);

  if (error) {
    alert("Lỗi khi lưu: " + error.message);
    return;
  }

  alert("Đã lưu thay đổi!");
  closeEditModal();
  loadPremises();
  closeDetailModal();
}
</script>
