<!doctype html>
<html lang="vi" data-theme="corporate">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ID-Land – Bộ lọc mặt bằng (Supabase)</title>
  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .line-clamp-1{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-base-200 to-base-100 text-base-content">
  <!-- NAV -->
  <header class="sticky top-0 z-20 bg-base-100/90 backdrop-blur border-b shadow-sm">
    <div class="max-w-7xl mx-auto px-4">
      <div class="navbar p-0 min-h-14">
        <div class="flex-1 gap-3 items-center">
          <div class="flex items-center gap-2">
            <div class="w-9 h-9 rounded-xl bg-primary/10 flex items-center justify-center">
              <span class="font-black text-primary text-lg">ID</span>
            </div>
            <div class="flex flex-col leading-tight">
              <span class="font-bold text-lg">ID-Land Premises</span>
              <span class="text-xs opacity-70 hidden sm:block">Kho mặt bằng cho thuê • TP.HCM</span>
            </div>
          </div>
          <div id="badgeEnv" class="badge badge-outline text-xs">Supabase</div>
        </div>
        <div class="flex-none flex items-center gap-3">
          <div class="hidden sm:flex flex-col items-end text-[11px] leading-tight">
            <span id="countGlobal" class="opacity-70">—</span>
            <span class="opacity-40">Đồng bộ Google Sheet</span>
          </div>
          <button class="btn btn-primary btn-sm rounded-full shadow-md" onclick="openAdd()">
            + Thêm mặt bằng
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="bg-base-100/80 border-b">
    <div class="max-w-7xl mx-auto px-4 py-4 sm:py-5 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="space-y-1">
        <h1 class="text-xl sm:text-2xl font-bold">
          Bộ lọc mặt bằng cho thuê <span class="text-primary">ID-Land</span>
        </h1>
        <p class="text-sm sm:text-[13px] opacity-70 max-w-2xl">
          Nhân sự chỉ cần nhập yêu cầu của khách: <b>giá – diện tích – khu vực – mặt tiền</b>, bộ lọc sẽ trả về danh sách mặt bằng phù hợp kèm hình ảnh & Google Maps.
        </p>
        <div class="flex flex-wrap gap-2 pt-1">
          <div class="badge badge-ghost badge-sm gap-1">
            <span class="w-1.5 h-1.5 rounded-full bg-success"></span> Realtime từ Supabase
          </div>
          <div class="badge badge-ghost badge-sm">Đồng bộ Google Sheet</div>
          <div class="badge badge-ghost badge-sm">Upload ảnh mặt bằng</div>
        </div>
      </div>
      <div class="flex gap-2 items-center text-xs mt-2 md:mt-0">
        <span class="hidden sm:inline opacity-60">Lọc nhanh:</span>
        <button class="btn btn-xs btn-outline rounded-full" onclick="quickFilter('available')">Còn trống</button>
        <button class="btn btn-xs btn-outline rounded-full" onclick="quickFilter('deposited')">Giữ cọc</button>
        <button class="btn btn-xs btn-outline rounded-full" onclick="quickFilterDistrict('Quận 1')">Quận 1</button>
        <button class="btn btn-xs btn-outline rounded-full" onclick="quickFilterDistrict('Quận 10')">Quận 10</button>
      </div>
    </div>
  </section>

  <!-- BODY -->
  <main class="max-w-7xl mx-auto px-4 py-5 grid grid-cols-1 lg:grid-cols-5 gap-5">
    <!-- FILTERS -->
    <aside class="lg:col-span-1 bg-base-100 rounded-2xl p-4 sm:p-5 shadow-sm border space-y-3 sticky top-[108px] h-fit">
      <div class="flex items-center justify-between gap-2">
        <div class="text-base font-semibold flex items-center gap-2">
          <span class="inline-flex w-6 h-6 rounded-full bg-primary/10 items-center justify-center">
            <span class="w-1.5 h-1.5 rounded-full bg-primary"></span>
          </span>
          Bộ lọc
        </div>
      </div>

      <div class="form-control">
        <label class="label py-1">
          <span class="label-text text-xs font-semibold uppercase tracking-wide">Từ khóa</span>
        </label>
        <input id="kw" class="input input-bordered input-sm w-full rounded-xl" placeholder="VD: Trần Hưng Đạo, Q5..." />
      </div>

      <div class="form-control">
        <label class="label py-1">
          <span class="label-text text-xs font-semibold uppercase tracking-wide">Quận</span>
        </label>
        <select id="district" class="select select-bordered select-sm w-full rounded-xl">
          <option value="">Tất cả</option>
        </select>
      </div>

      <!-- PHƯỜNG FILTER -->
      <div class="form-control">
        <label class="label py-1">
          <span class="label-text text-xs font-semibold uppercase tracking-wide">Phường</span>
        </label>
        <select id="ward" class="select select-bordered select-sm w-full rounded-xl">
          <option value="">Tất cả</option>
        </select>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <div class="form-control">
          <label class="label py-1">
            <span class="label-text text-[11px] font-semibold uppercase tracking-wide">Giá tối thiểu</span>
          </label>
          <input id="minPrice" type="number" class="input input-bordered input-sm w-full rounded-xl" />
        </div>
        <div class="form-control">
          <label class="label py-1">
            <span class="label-text text-[11px] font-semibold uppercase tracking-wide">Giá tối đa</span>
          </label>
          <input id="maxPrice" type="number" class="input input-bordered input-sm w-full rounded-xl" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <div class="form-control">
          <label class="label py-1">
            <span class="label-text text-[11px] font-semibold uppercase tracking-wide">DT tối thiểu (m²)</span>
          </label>
          <input id="minArea" type="number" class="input input-bordered input-sm w-full rounded-xl" />
        </div>
        <div class="form-control">
          <label class="label py-1">
            <span class="label-text text-[11px] font-semibold uppercase tracking-wide">DT tối đa (m²)</span>
          </label>
          <input id="maxArea" type="number" class="input input-bordered input-sm w-full rounded-xl" />
        </div>
      </div>

      <div class="form-control">
        <label class="label py-1">
          <span class="label-text text-xs font-semibold uppercase tracking-wide">Mặt tiền</span>
        </label>
        <select id="frontage" class="select select-bordered select-sm w-full rounded-xl">
          <option value="">Tất cả</option>
          <option value="yes">Có</option>
          <option value="no">Không</option>
        </select>
      </div>

      <div class="form-control">
        <label class="label py-1">
          <span class="label-text text-xs font-semibold uppercase tracking-wide">Tình trạng</span>
        </label>
        <select id="status" class="select select-bordered select-sm w-full rounded-xl">
          <option value="">Tất cả</option>
          <option value="available">Còn trống</option>
          <option value="deposited">Giữ cọc</option>
          <option value="rented">Đã thuê</option>
        </select>
      </div>

      <div class="form-control">
        <label class="label py-1">
          <span class="label-text text-xs font-semibold uppercase tracking-wide">Ngành phù hợp</span>
        </label>
        <input id="suitable" class="input input-bordered input-sm w-full rounded-xl" placeholder="VD: cafe, phở..." />
      </div>

      <div class="grid grid-cols-2 gap-2">
        <div class="form-control">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide">Sắp xếp</span>
          </label>
          <select id="sort" class="select select-bordered select-sm w-full rounded-xl">
            <option value="newest">Mới nhất</option>
            <option value="price_asc">Giá tăng dần</option>
            <option value="price_desc">Giá giảm dần</option>
          </select>
        </div>
        <div class="form-control">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide">Mỗi trang</span>
          </label>
          <select id="perPage" class="select select-bordered select-sm w-full rounded-xl">
            <option>24</option><option>48</option><option>96</option>
          </select>
        </div>
      </div>

      <div class="flex gap-2 pt-1">
        <button id="btnApply" class="btn btn-primary btn-sm flex-1 rounded-full">Lọc</button>
        <button class="btn btn-sm flex-1 rounded-full" onclick="resetFilters()">Xóa lọc</button>
      </div>
      <p class="text-[11px] opacity-60 pt-1">
        Gợi ý: nhập đúng <b>đường + quận</b> để lọc nhanh (VD: “Lê Đức Thọ Q. Gò Vấp”).
      </p>
    </aside>

    <!-- LIST -->
    <section class="lg:col-span-4 space-y-3">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
        <div id="countPage" class="text-xs sm:text-sm opacity-70">—</div>
        <div class="flex items-center gap-2 justify-between sm:justify-end">
          <button class="btn btn-ghost btn-xs rounded-full" onclick="downloadCSV()">
            Tải CSV trên Supabase
          </button>
        </div>
      </div>

      <div id="grid" class="grid sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>

      <div class="flex justify-center mt-4">
        <button id="btnMore" class="btn btn-sm rounded-full px-6" disabled>—</button>
      </div>
    </section>
  </main>

  <!-- ADD MODAL -->
  <dialog id="dlg" class="modal">
    <div class="modal-box max-w-2xl">
      <h3 class="font-bold text-lg mb-3">Thêm mặt bằng mới</h3>
      <p class="text-xs opacity-60 mb-3">
        Điền tối đa thông tin có thể. Ảnh mặt bằng sẽ được upload lên Supabase Storage (bucket <b>premise-images</b>).
      </p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <input id="f_address" class="input input-bordered input-sm" placeholder="Địa chỉ (ghi rõ số, đường)">
        <input id="f_street" class="input input-bordered input-sm" placeholder="Đường">

        <!-- QUẬN -->
        <div class="form-control">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide">Quận</span>
          </label>
          <select id="add-district" class="select select-bordered select-sm w-full rounded-xl">
            <option value="">Chọn quận</option>
            <!-- JS sẽ tự đổ list quận -->
          </select>
        </div>

        <!-- PHƯỜNG -->
        <div class="form-control">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide">Phường</span>
          </label>
          <select id="add-ward" class="select select-bordered select-sm w-full rounded-xl">
            <option value="">Chọn phường</option>
            <!-- JS sẽ tự đổ list phường theo quận -->
          </select>
        </div>

        <input id="f_width" type="number" class="input input-bordered input-sm" placeholder="Ngang (m)">
        <input id="f_length" type="number" class="input input-bordered input-sm" placeholder="Dài (m)">
        <input id="f_area" type="number" class="input input-bordered input-sm" placeholder="Diện tích (m²)">
        <input id="f_floors" type="number" class="input input-bordered input-sm" placeholder="Số tầng">
        <input id="f_price" type="number" class="input input-bordered input-sm" placeholder="Giá thuê (VND)">
        <input id="f_commission" class="input input-bordered input-sm" placeholder="Hoa hồng (vd: hh1/2)">
        <input id="f_suitable" class="input input-bordered input-sm" placeholder="Ngành phù hợp (cách nhau dấu phẩy)">
        <select id="f_status" class="select select-bordered select-sm">
          <option value="available">Còn trống</option>
          <option value="deposited">Giữ cọc</option>
          <option value="rented">Đã thuê</option>
        </select>
        <input id="f_contact_name" class="input input-bordered input-sm" placeholder="Tên liên hệ">
        <input id="f_contact_phone" class="input input-bordered input-sm" placeholder="SĐT liên hệ">
        <label class="label cursor-pointer gap-2">
          <span class="label-text text-sm">Mặt tiền</span>
          <input id="f_frontage" type="checkbox" class="toggle toggle-sm">
        </label>
      </div>
      <div class="divider my-3">Ảnh mặt bằng</div>
      <input id="f_images" type="file" class="file-input file-input-bordered file-input-sm w-full" multiple accept="image/*" />
      <progress id="upProgress" class="progress progress-primary w-full hidden mt-2" value="0" max="100"></progress>
      <p id="upHint" class="text-[11px] opacity-60 mt-1">
        Chọn 1–10 ảnh. Ưu tiên ảnh mặt tiền, tổng thể, layout bên trong.
      </p>
      <div class="modal-action">
        <form method="dialog" class="flex gap-2">
          <button class="btn btn-sm">Đóng</button>
          <button class="btn btn-primary btn-sm" onclick="addItem()">Lưu mặt bằng</button>
        </form>
      </div>
    </div>
  </dialog>

  <!-- DETAIL MODAL -->
  <dialog id="detailDlg" class="modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog">
        <button class="btn btn-sm btn-circle absolute right-2 top-2">✕</button>
      </form>
      <div id="detailBody" class="space-y-4"></div>
    </div>
  </dialog>

  <footer class="text-center text-[11px] text-base-content/60 py-6 border-t mt-4">
    © <span id="yr"></span> ID-Land • Bộ lọc mặt bằng (Supabase + Google Sheet)
  </footer>

  <script>
    // ====== 1) CONFIG SUPABASE ======
    const SUPABASE_URL = "https://xclncowkoedwqzcemhei.supabase.co"; // nếu anh đổi project thì sửa ở đây
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbG5jb3drb2Vkd3F6Y2VtaGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNzcwOTUsImV4cCI6MjA3Nzg1MzA5NX0.jfNM46UgXIq9LrwSXcERJJULeKB7bl_c9R9LaVhRy1A";
    const STORAGE_BUCKET = "premise-images";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== 2) STATE ======
    document.getElementById('yr').textContent = new Date().getFullYear();

    const DISTRICTS = [
      "Quận 1","Quận 3","Quận 4","Quận 5","Quận 6","Quận 7","Quận 8",
      "Quận 10","Quận 11","Quận Bình Thạnh","Quận Phú Nhuận",
      "Quận Gò Vấp","Quận Tân Bình","Quận Tân Phú","Quận 12",
      "Thành phố Thủ Đức","Huyện Bình Chánh","Huyện Hóc Môn",
      "Huyện Nhà Bè","Huyện Củ Chi","Huyện Cần Giờ"
    ];

    const WARDS_BY_DISTRICT = {
      "Quận 1": ["Bến Nghé","Bến Thành","Cô Giang","Cầu Ông Lãnh","Đa Kao","Nguyễn Cư Trinh","Nguyễn Thái Bình","Phạm Ngũ Lão","Tân Định"],
      "Quận 3": ["Võ Thị Sáu","Phường 1","Phường 2","Phường 3","Phường 4","Phường 5","Phường 9","Phường 10","Phường 11","Phường 12","Phường 13","Phường 14"],
      "Quận 4": [],
      "Quận 5": [],
      "Quận 6": [],
      "Quận 7": [],
      "Quận 8": [],
      "Quận 10": [],
      "Quận 11": [],
      "Quận Bình Thạnh": [],
      "Quận Phú Nhuận": [],
      "Quận Gò Vấp": [],
      "Quận Tân Bình": [],
      "Quận Tân Phú": [],
      "Quận 12": [],
      "Thành phố Thủ Đức": [],
      "Huyện Bình Chánh": [],
      "Huyện Hóc Môn": [],
      "Huyện Nhà Bè": [],
      "Huyện Củ Chi": [],
      "Huyện Cần Giờ": []
      // Anh có thể bổ sung thêm phường cho các quận khác nếu cần
    };

    function setupDistrictWardPair(districtId, wardId, allLabel = "Tất cả") {
      const districtSelect = document.getElementById(districtId);
      const wardSelect = document.getElementById(wardId);
      if (!districtSelect || !wardSelect) return;

      // Đổ danh sách quận
      districtSelect.innerHTML = "";
      const optAllDistrict = document.createElement("option");
      optAllDistrict.value = "";
      optAllDistrict.textContent = allLabel === "Tất cả" ? "Tất cả" : "Chọn quận";
      districtSelect.appendChild(optAllDistrict);

      DISTRICTS.forEach(d => {
        const o = document.createElement("option");
        o.value = d;
        o.textContent = d;
        districtSelect.appendChild(o);
      });

      function refreshWardOptions() {
        wardSelect.innerHTML = "";
        const optAllWard = document.createElement("option");
        optAllWard.value = "";
        optAllWard.textContent = allLabel === "Tất cả" ? "Tất cả" : "Chọn phường";
        wardSelect.appendChild(optAllWard);

        const wards = WARDS_BY_DISTRICT[districtSelect.value] || [];
        wards.forEach(w => {
          const o = document.createElement("option");
          o.value = w;
          o.textContent = w;
          wardSelect.appendChild(o);
        });
      }

      districtSelect.addEventListener("change", refreshWardOptions);
      refreshWardOptions();
    }

    // 1) Bộ lọc bên trái: giữ label "Tất cả"
    setupDistrictWardPair("district", "ward", "Tất cả");

    // 2) Form thêm mặt bằng: label kiểu "Chọn quận/phường"
    setupDistrictWardPair("add-district", "add-ward", "Chọn");

    let PAGE = 1;
    let TOTAL = 0;

    function getFilters(){
      return {
        kw: document.getElementById("kw").value.trim(),
        district: document.getElementById("district").value,
        ward: document.getElementById("ward").value,
        minPrice: Number(document.getElementById("minPrice").value||0),
        maxPrice: Number(document.getElementById("maxPrice").value||0),
        minArea: Number(document.getElementById("minArea").value||0),
        maxArea: Number(document.getElementById("maxArea").value||0),
        frontage: document.getElementById("frontage").value,
        status: document.getElementById("status").value,
        suitable: document.getElementById("suitable").value.trim(),
        sort: document.getElementById("sort").value,
        perPage: Number(document.getElementById("perPage").value||24),
      };
    }

    function money(v){ return Number(v||0).toLocaleString("vi-VN",{style:"currency",currency:"VND",maximumFractionDigits:0}); }

    // ====== 3) QUERY BUILDER ======
    async function fetchPremises({kw='', district='', ward='', status='', frontage='', minPrice=0, maxPrice=0, minArea=0, maxArea=0, suitable='', sort='newest', page=1, perPage=24}) {
      let q = supabase.from('premises').select('*', { count: 'exact' });

      if (district) q = q.eq('district', district);
      if (ward)     q = q.eq('ward', ward);
      if (status)   q = q.eq('status', status);
      if (frontage) q = q.eq('frontage', frontage === 'yes');
      if (minPrice) q = q.gte('price', minPrice);
      if (maxPrice) q = q.lte('price', maxPrice);
      if (minArea)  q = q.gte('area', minArea);
      if (maxArea)  q = q.lte('area', maxArea);
      if (suitable) q = q.contains('suitable', [suitable]);

      if (kw) {
        const safe = kw.replaceAll(",", " ");
        q = q.or(
          `address.ilike.%${safe}%,street.ilike.%${safe}%,district.ilike.%${safe}%`
        );
      }

      if (sort === 'price_asc')      q = q.order('price', { ascending: true });
      else if (sort === 'price_desc') q = q.order('price', { ascending: false });
      else                            q = q.order('created_at', { ascending: false });

      const from = (page-1)*perPage;
      const to   = from + perPage - 1;
      q = q.range(from, to);

      const { data, count, error } = await q;
      if (error) { console.error("Query error:", error); toast('Lỗi tải dữ liệu'); return { data: [], count: 0 }; }
      return { data, count: count||0 };
    }

    // ====== 4) RENDER ======
    function renderCards(rows){
      const grid = document.getElementById("grid");

      if (!rows.length && PAGE === 1) {
        grid.innerHTML = `
          <div class="col-span-full">
            <div class="rounded-2xl border border-dashed bg-base-100/80 p-6 text-center text-sm opacity-80">
              Chưa có mặt bằng nào khớp bộ lọc hiện tại. Thử nới lỏng điều kiện tìm kiếm.
            </div>
          </div>`;
        return;
      }

      const htmlCards = rows.map(it => {
        const imgUrl = Array.isArray(it.images) && it.images.length > 0
          ? resolveImageUrl(it.images[0])
          : null;

        const statusLabel =
          it.status === 'available' ? 'Còn trống' :
          it.status === 'deposited' ? 'Giữ cọc' :
          it.status === 'rented' ? 'Đã thuê' :
          (it.status || '');

        const statusClass =
          it.status === 'available' ? 'badge-success' :
          it.status === 'deposited' ? 'badge-warning' :
          it.status === 'rented' ? 'badge-neutral' :
          '';

        // TIÊU ĐỀ: Đường + Phường (nếu có)
        const titleAddr =
          (it.address && it.address.trim()) ||
          [it.street, it.ward].filter(Boolean).join(", ");

        // DÒNG CHỮ NHỎ: Quận • DT • Kích thước • PN • Ngày update (+ Mặt tiền nếu có)
        const metaParts = [];
        if (it.district) metaParts.push(it.district);
        if (it.area) metaParts.push(`${it.area} m²`);
        if (it.width && it.length) metaParts.push(`${it.width}×${it.length} m`);

        const bedrooms = it.bedrooms || it.rooms || it.pn;
        if (bedrooms) metaParts.push(`${bedrooms} PN`);

        const updated = it.updated_at || it.created_at;
        if (updated) metaParts.push(`Cập nhật ${formatDate(updated)}`);

        if (it.frontage) metaParts.push('Mặt tiền');

        const metaLine = metaParts.join(" • ");

        return `
          <article class="card bg-base-100/95 border border-base-200 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer premise-card rounded-2xl overflow-hidden" data-id="${encodeURIComponent(it.id)}">
            <figure class="h-44 bg-base-200 flex items-center justify-center text-base-content/50">
              ${
                imgUrl
                  ? `<img src="${imgUrl}" class="w-full h-full object-cover" onerror="this.parentNode.innerHTML='(Không có ảnh)'" />`
                  : `(Không có ảnh)`
              }
            </figure>
            <div class="card-body p-4 space-y-2">
              <div class="flex items-start justify-between gap-3">
                <h3 class="card-title text-[15px] leading-snug line-clamp-1">${titleAddr}</h3>
                ${
                  statusLabel
                    ? `<div class="badge badge-outline badge-sm ${statusClass}">${statusLabel}</div>`
                    : ''
                }
              </div>
              <div class="text-[12px] opacity-70">
                ${metaLine}
              </div>
              <div class="flex items-center justify-between pt-1">
                <div class="text-xl sm:text-2xl font-extrabold text-primary">${money(it.price)}</div>
                ${
                  it.commission_note
                    ? `<div class="badge badge-outline badge-secondary badge-sm">HH: ${it.commission_note}</div>`
                    : ''
                }
              </div>
            </div>
          </article>
        `;
      }).join("");

      if (PAGE === 1) grid.innerHTML = htmlCards;
      else grid.insertAdjacentHTML('beforeend', htmlCards);

      grid.querySelectorAll('.premise-card').forEach(card => {
        card.addEventListener('click', () => {
          const id = decodeURIComponent(card.dataset.id || '');
          openDetail(id);
        });
      });
    }

    async function applyFilters(resetPage=true){
      if (resetPage) PAGE = 1;
      const f = getFilters();
      const btnMore = document.getElementById('btnMore');
      btnMore.disabled = true; btnMore.textContent = 'Đang tải...';

      const { data, count } = await fetchPremises({ ...f, page: PAGE, perPage: f.perPage });
      TOTAL = count;
      document.getElementById('countGlobal').textContent = `${count.toLocaleString('vi-VN')} mặt bằng`;
      document.getElementById('countPage').textContent = `Hiển thị ${(Math.min(PAGE*f.perPage, count)).toLocaleString('vi-VN')} / ${count.toLocaleString('vi-VN')}`;

      renderCards(data||[]);

      const more = PAGE * f.perPage < count;
      btnMore.disabled = !more;
      btnMore.textContent = more ? 'Tải thêm' : 'Hết dữ liệu';
    }

    // ====== 5) DETAIL POPUP ======
    async function openDetail(id){
      const { data, error } = await supabase
        .from('premises')
        .select('*')
        .eq('id', id)
        .single();
      if (error) { console.error(error); return; }
      const item = data;
      const imgs = Array.isArray(item.images) ? item.images : [];

      const gallery = imgs.length
        ? (() => {
            const slides = imgs.map((src, i) => {
              const url = resolveImageUrl(src);
              if (!url) {
                return `
                  <div id="slide${i}" class="carousel-item w-full h-80 bg-base-200 flex items-center justify-center text-base-content/50">
                    (Không có ảnh)
                  </div>
                `;
              }
              return `
                <div id="slide${i}" class="carousel-item w-full h-80 bg-base-200">
                  <img src="${url}" class="w-full h-full object-contain" />
                </div>
              `;
            }).join("");
            const dots = imgs
              .map((_, i) => `<a href="#slide${i}" class="btn btn-xs rounded-full">${i + 1}</a>`)
              .join("");
            return `
              <div class="carousel w-full rounded-xl border bg-base-200">
                ${slides}
              </div>
              <div class="flex gap-2 justify-center mt-2">
                ${dots}
              </div>
            `;
          })()
        : `<div class="h-80 bg-base-200 rounded-xl flex items-center justify-center text-base-content/50">(Không có ảnh)</div>`;

      const maps = encodeURIComponent(item.address || `${item.street||""} ${item.district||""}`);
      const gmapEmbed = `<iframe class="w-full h-64 rounded-xl border" loading="lazy"
        src="https://www.google.com/maps?q=${maps}&output=embed"></iframe>`;

      const actions = `
        <div class="join join-horizontal">
          ${item.contact_phone ? `<a class="btn btn-primary btn-sm join-item" href="tel:${item.contact_phone}">Gọi</a>` : ''}
          ${item.contact_phone ? `<a class="btn btn-sm join-item" target="_blank" href="https://zalo.me/${(item.contact_phone||'').replace(/[^0-9]/g,'')}">Zalo</a>` : ''}
          <a class="btn btn-sm join-item" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${maps}">Mở Google Maps</a>
          <button class="btn btn-sm join-item" onclick="navigator.clipboard.writeText(location.origin + location.pathname + '#'+encodeURIComponent('${id}'));toast('Đã copy link mặt bằng')">Copy link</button>
        </div>`;

      const htmlDetail = `
        <div class="grid md:grid-cols-2 gap-6">
          <div class="space-y-3">
            ${gallery}
            <div class="mt-3">${gmapEmbed}</div>
          </div>
          <div class="space-y-3">
            <h2 class="text-xl font-bold">${item.address || `${item.street||""} ${item.district||""}`}</h2>
            <div class="text-sm opacity-70">${item.ward||""} ${item.district||""} • ${item.city||""}</div>
            <div class="flex flex-wrap gap-2 text-xs">
              ${item.frontage?`<span class="badge badge-outline">Mặt tiền</span>`:''}
              ${item.area?`<span class="badge badge-outline">${item.area} m²</span>`:''}
              ${(item.width&&item.length)?`<span class="badge badge-outline">${item.width}×${item.length} m</span>`:''}
              ${item.floors?`<span class="badge badge-outline">${item.floors} tầng</span>`:''}
              ${item.status?`<span class="badge ${item.status==='available'?'badge-success':item.status==='deposited'?'badge-warning':'badge-neutral'}">
                ${item.status==='available'?'Còn trống':item.status==='deposited'?'Giữ cọc':'Đã thuê'}
              </span>`:''}
            </div>

            <div class="text-3xl font-extrabold text-primary mt-2">${money(item.price)}</div>
            ${item.commission_note?`<div class="text-sm mt-1">Hoa hồng: <b>${item.commission_note}</b></div>`:''}

            ${
              (item.bedrooms || item.rooms || item.pn || item.bathrooms || item.wc || item.floors)
              ? `<div class="mt-3 space-y-1 text-sm">
                  ${item.bedrooms || item.rooms || item.pn ? `<div><b>Phòng ngủ:</b> ${item.bedrooms || item.rooms || item.pn}</div>` : ''}
                  ${item.bathrooms || item.wc ? `<div><b>WC:</b> ${item.bathrooms || item.wc}</div>` : ''}
                  ${item.floors ? `<div><b>Số tầng:</b> ${item.floors}</div>` : ''}
                </div>`
              : ''
            }

            ${
              item.detail || item.description || item.info_detail
              ? `<div class="mt-3 text-sm leading-relaxed">
                  <div class="font-semibold mb-1">Thông tin chi tiết</div>
                  <p>${(item.detail || item.description || item.info_detail).replace(/\n/g, '<br/>')}</p>
                </div>`
              : ''
            }

            ${item.suitable?.length?`<div class="flex flex-wrap gap-1 text-xs mt-3">
              ${item.suitable.map(s=>`<div class="badge badge-ghost">${s}</div>`).join('')}
            </div>`:''}

            ${(item.contact_phone||item.contact_name)?`
              <div class="space-x-2 text-sm mt-3">
                <span class="opacity-70">Liên hệ:</span>
                <b>${item.contact_name||""}</b>
                <a class="link" href="tel:${item.contact_phone||''}">${item.contact_phone||''}</a>
              </div>`:''}

            <div class="mt-4">
              ${actions}
            </div>
          </div>
        </div>`;

      document.getElementById("detailBody").innerHTML = htmlDetail;
      document.getElementById("detailDlg").showModal();
    }

    // ====== 6) UPLOAD ẢNH LÊN STORAGE ======
    async function uploadImages(files, prefix = '') {
      const urls = [];
      const total = files.length;
      if (!total) return urls;
      const bar = document.getElementById('upProgress');
      const hint = document.getElementById('upHint');
      bar.classList.remove('hidden');
      bar.value = 0;
      for (let i = 0; i < total; i++) {
        const f = files[i];
        const ext = (f.name.split('.').pop() || 'jpg').toLowerCase();
        const path = `${prefix}${Date.now()}_${i}.${ext}`;
        const { error: upErr } = await supabase
          .storage.from(STORAGE_BUCKET)
          .upload(path, f, { cacheControl: '3600', upsert: true });
        if (upErr) { console.error("Upload error:", upErr); throw upErr; }
        const { data: pub, error: urlErr } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(path);
        if (urlErr) { console.error("Public URL error:", urlErr); }
        urls.push(pub.publicUrl);
        bar.value = Math.round(((i + 1) / total) * 100);
        hint.textContent = `Đang tải ${i + 1}/${total}…`;
      }
      setTimeout(() => { bar.classList.add('hidden'); bar.value = 0; hint.textContent = 'Tải ảnh xong.'; }, 500);
      return urls;
    }

    // ====== 7) ADD ITEM ======
    async function addItem(){
      const g  = id => document.getElementById(id).value;
      const chk= id => document.getElementById(id).checked;
      const files = document.getElementById('f_images').files;
      try {
        const codePrefix = 'MB-' + Math.random().toString(36).slice(2,8);
        const imageUrls = await uploadImages(files, `${codePrefix}/`);
        const payload = {
          city:"TP.HCM",
          district: g("add-district") || "Quận 1",
          ward: g("add-ward") || "",
          street:g("f_street")||"",
          address:g("f_address")||"",
          width: g("f_width")?Number(g("f_width")):null,
          length:g("f_length")?Number(g("f_length")):null,
          area:  g("f_area")?Number(g("f_area")):null,
          floors:g("f_floors")?Number(g("f_floors")):null,
          frontage:chk("f_frontage"),
          price:Number(g("f_price")||0),
          commission_note:g("f_commission")||"",
          suitable:(g("f_suitable")||"").split(',').map(s=>s.trim()).filter(Boolean),
          status:g("f_status")||"available",
          contact_name:g("f_contact_name")||"",
          contact_phone:g("f_contact_phone")||"",
          images:imageUrls,
        };
        const { data: inserted, error } = await supabase.from('premises').insert(payload).select().single();
        if (error) throw error;
        toast('Đã thêm mặt bằng');
        document.getElementById('dlg').close();
        ['f_address','f_street','add-district','add-ward','f_width','f_length','f_area','f_floors','f_price','f_commission','f_suitable','f_contact_name','f_contact_phone'].forEach(id=>{ const el=document.getElementById(id); if (el) el.value=''; });
        document.getElementById('f_frontage').checked = false;
        document.getElementById('f_images').value = '';
        await openDetail(inserted.id);
        PAGE = 1;
        await applyFilters(true);
      } catch (e) {
        console.error("Insert error:", e);
        toast('Không thể thêm (kiểm tra policy INSERT của bảng và policy INSERT của Storage).');
      }
    }

    function openAdd(){ document.getElementById('dlg').showModal(); }

    // ====== 8) CSV EXPORT (gợi ý) ======
    function downloadCSV(){
      alert('Gợi ý: vào Supabase Table Editor → premises → Export → CSV để tải toàn bộ dữ liệu.');
    }

    // ====== 9) UI HELPERS ======
    // Resolve image path (URL or storage path) to final URL
    function resolveImageUrl(src){
      if (!src) return null;
      // Nếu đã là URL đầy đủ thì dùng luôn
      if (/^https?:\/\//i.test(src)) return src;
      try {
        const { data } = supabase
          .storage
          .from(STORAGE_BUCKET)
          .getPublicUrl(src);
        return data && data.publicUrl ? data.publicUrl : null;
      } catch (e) {
        console.error('resolveImageUrl error:', e);
        return null;
      }
    }

    // Định dạng ngày: 28/11/2025
    function formatDate(d) {
      if (!d) return "";
      const dt = new Date(d);
      if (isNaN(dt)) return "";
      const day = String(dt.getDate()).padStart(2, "0");
      const mon = String(dt.getMonth() + 1).padStart(2, "0");
      const yr  = dt.getFullYear();
      return `${day}/${mon}/${yr}`;
    }

    function toast(msg){
      const el = document.createElement("div");
      el.textContent = msg;
      el.className = "fixed bottom-4 right-4 bg-base-100 border shadow-lg rounded-2xl px-4 py-2 text-sm z-50";
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 2400);
    }

    function resetFilters(){
      ["kw","district","ward","minPrice","maxPrice","minArea","maxArea","frontage","status","suitable","sort","perPage"].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = '';
      });
      document.getElementById('sort').value = 'newest';
      document.getElementById('perPage').value = '24';
      applyFilters(true);
    }

    function debounce(fn, delay){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), delay); }; }

    // Quick filters
    function quickFilter(status) {
      document.getElementById('status').value = status;
      applyFilters(true);
    }
    function quickFilterDistrict(d) {
      document.getElementById('district').value = d;
      document.getElementById('ward').value = "";
      applyFilters(true);
    }

    // Events
    document.getElementById('btnApply').addEventListener('click', ()=>applyFilters(true));
    document.getElementById('btnMore').addEventListener('click', ()=>{ PAGE++; applyFilters(false); });
    document.getElementById('kw').addEventListener('input', debounce(()=>applyFilters(true), 400));

    // INIT
    (async () => {
      try{
        const { error } = await supabase.from('premises').select('id', { count: 'exact', head: true }).limit(1);
        if (error) throw error; document.getElementById('badgeEnv').classList.add('badge-success');
      }catch(e){ document.getElementById('badgeEnv').classList.add('badge-error'); }
      await applyFilters(true);

      const hashId = decodeURIComponent(location.hash.slice(1) || "");
      if (hashId) openDetail(hashId);
    })();
  </script>
</body>
</html>
