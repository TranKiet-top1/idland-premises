<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>ID-Land Premises</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
    rel="stylesheet"
  />

  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    .premise-card:hover {
      transform: translateY(-2px);
    }
  </style>
</head>
<body class="bg-base-200">

  <!-- ======== AUTH SECTION (LOGIN) ======== -->
  <section id="auth-section" class="min-h-screen flex items-center justify-center">
    <div class="card w-full max-w-md bg-base-100 shadow-xl">
      <div class="card-body">
        <div class="flex items-center gap-2 mb-4">
          <img src="logo.png" class="h-10 w-auto rounded-xl" alt="ID-Land" />
          <div>
            <h2 class="card-title">ID-Land Premises</h2>
            <p class="text-xs opacity-70">Đăng nhập để xem kho mặt bằng</p>
          </div>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Email</span>
          </label>
          <input id="login-email" type="email" placeholder="you@idland.vn" class="input input-bordered" />
        </div>

        <div class="form-control mt-2">
          <label class="label">
            <span class="label-text">Mật khẩu</span>
          </label>
          <input id="login-password" type="password" placeholder="••••••••" class="input input-bordered" />
        </div>

        <div class="form-control mt-4">
          <button id="btn-login" class="btn btn-primary w-full">Đăng nhập</button>
        </div>

        <p class="mt-3 text-xs opacity-70">
          Quyền <b>admin</b>: xem & chỉnh sửa full thông tin, số nhà & số chủ.<br/>
          Quyền <b>nhân sự</b>: bị ẩn số nhà & số điện thoại chủ nhà.
        </p>
      </div>
    </div>
  </section>

  <!-- ======== APP SECTION ======== -->
  <div id="app-root" class="hidden min-h-screen flex flex-col">
    <!-- NAVBAR -->
    <div class="navbar bg-base-100 shadow-sm px-4">
      <div class="flex-1 flex items-center gap-2">
        <img src="logo.png" class="h-9 w-auto rounded-xl" alt="ID-Land" />
        <div>
          <div class="font-bold text-lg leading-tight">ID-Land Premises</div>
          <div class="text-xs opacity-60">Kho mặt bằng cho thuê • TP.HCM</div>
        </div>
      </div>
      <div class="flex-none flex items-center gap-2 text-sm">
        <span id="role-badge" class="badge badge-outline"></span>
        <button id="btn-logout" class="btn btn-ghost btn-sm">Đăng xuất</button>
      </div>
    </div>

    <!-- CONTENT -->
    <main class="flex-1 max-w-6xl mx-auto w-full px-2 sm:px-4 py-4">
      <!-- Header + actions -->
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <div>
          <h1 class="text-xl sm:text-2xl font-bold">
            Bộ lọc mặt bằng cho thuê <span class="text-primary">ID-Land</span>
          </h1>
          <p class="text-xs sm:text-sm opacity-70">
            Nhân sự chỉ cần nhập yêu cầu của khách: <b>giá – diện tích – khu vực – mặt tiền</b>,
            bộ lọc sẽ trả về danh sách mặt bằng phù hợp kèm hình ảnh &amp; Google Maps.
          </p>
        </div>

        <div class="flex flex-wrap gap-2 justify-end">
          <button id="btn-add-premise" class="btn btn-primary btn-sm hidden">
            + Thêm mặt bằng
          </button>
        </div>
      </div>

      <!-- Quick filters -->
      <div class="flex flex-wrap items-center gap-2 mb-3">
        <span class="text-xs opacity-70">Lọc nhanh:</span>
        <button class="btn btn-xs" data-quick="available">Còn trống</button>
        <button class="btn btn-xs" data-quick="deposited">Giữ cọc</button>
        <button class="btn btn-xs" data-quick-district="Quận 1">Quận 1</button>
        <button class="btn btn-xs" data-quick-district="Quận 10">Quận 10</button>
        <button class="btn btn-xs btn-ghost btn-outline" id="btn-clear-quick">
          Xoá lọc nhanh
        </button>
      </div>

      <!-- Filters & list -->
      <div class="grid md:grid-cols-[260px,1fr] gap-4">
        <!-- FILTER PANEL -->
        <aside class="bg-base-100 rounded-2xl shadow-sm p-4">
          <div class="flex items-center gap-2 mb-3">
            <span class="w-2 h-2 rounded-full bg-success"></span>
            <h2 class="font-semibold text-sm">Bộ lọc</h2>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">Từ khoá</span>
            </label>
            <input
              id="filter-keyword"
              type="text"
              placeholder="VD: Trần Hưng Đạo, Q5..."
              class="input input-sm input-bordered"
            />
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">Quận</span>
            </label>
            <select id="filter-district" class="select select-sm select-bordered">
              <option value="">Tất cả</option>
            </select>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">Phường</span>
            </label>
            <select id="filter-ward" class="select select-sm select-bordered">
              <option value="">Tất cả</option>
            </select>
          </div>

          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Giá tối thiểu</span>
              </label>
              <input
                id="filter-price-min"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Giá tối đa</span>
              </label>
              <input
                id="filter-price-max"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">DT tối thiểu (m²)</span>
              </label>
              <input
                id="filter-area-min"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">DT tối đa (m²)</span>
              </label>
              <input
                id="filter-area-max"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">Mặt tiền</span>
            </label>
            <select id="filter-frontage" class="select select-sm select-bordered">
              <option value="">Tất cả</option>
              <option value="1">Chỉ mặt tiền</option>
            </select>
          </div>

          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text text-xs">Tình trạng</span>
            </label>
            <select id="filter-status" class="select select-sm select-bordered">
              <option value="">Tất cả</option>
              <option value="available">Còn trống</option>
              <option value="deposited">Giữ cọc</option>
              <option value="rented">Đã thuê</option>
            </select>
          </div>

          <div class="flex gap-2">
            <button id="btn-apply" class="btn btn-sm btn-primary flex-1">
              Lọc
            </button>
            <button id="btn-reset" class="btn btn-sm btn-ghost">
              Xoá lọc
            </button>
          </div>
        </aside>

        <!-- LIST PANEL -->
        <section class="flex flex-col gap-3">
          <div class="flex items-center justify-between mb-1 text-xs opacity-70">
            <span>
              Hiển thị <span id="count-show">0</span> / <span id="count-total">0</span>
            </span>
            <button
              id="btn-download-csv"
              class="btn btn-xs btn-ghost"
            >
              Tải CSV trên Supabase
            </button>
          </div>

          <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- cards here -->
          </div>

          <div class="mt-4 flex justify-center">
            <button id="btn-load-more" class="btn btn-sm btn-ghost">
              Hết dữ liệu
            </button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- ===== DETAIL DIALOG ===== -->
  <dialog id="detailDlg" class="modal">
    <div class="modal-box max-w-5xl p-4">
      <form method="dialog" class="modal-backdrop absolute inset-0" onclick="document.getElementById('detailDlg').close()"></form>
      <div id="detail-content"></div>
    </div>
  </dialog>

  <!-- ===== EDIT DIALOG (ADMIN) ===== -->
  <dialog id="editDlg" class="modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog" class="modal-backdrop absolute inset-0" onclick="document.getElementById('editDlg').close()"></form>
      <h3 class="font-bold text-lg mb-3">Chỉnh sửa mặt bằng</h3>

      <div class="grid md:grid-cols-2 gap-3">
        <div class="form-control md:col-span-2">
          <label class="label">
            <span class="label-text">Mã mặt bằng (code)</span>
          </label>
          <input id="edit-code" type="text" class="input input-bordered w-full" />
          <label class="label">
            <span class="label-text-alt text-xs opacity-70">
              Mỗi mã nên là duy nhất (MB 0001, MB 0002,...)
            </span>
          </label>
        </div>

        <div class="form-control md:col-span-2">
          <label class="label">
            <span class="label-text">Tiêu đề / Địa chỉ hiển thị</span>
          </label>
          <input id="edit-address" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Thành phố</span></label>
          <input id="edit-city" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Quận</span></label>
          <input id="edit-district" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Phường</span></label>
          <input id="edit-ward" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Tên đường</span></label>
          <input id="edit-street" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Giá thuê (đ)</span></label>
          <input id="edit-price" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Diện tích (m²)</span></label>
          <input id="edit-area" type="number" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Chiều ngang (m)</span></label>
          <input id="edit-width" type="number" step="0.1" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Chiều dài (m)</span></label>
          <input id="edit-length" type="number" step="0.1" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Số tầng</span></label>
          <input id="edit-floors" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Số PN</span></label>
          <input id="edit-bedrooms" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Số WC</span></label>
          <input id="edit-wc" type="number" class="input input-bordered w-full" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Kết cấu</span></label>
          <input id="edit-ket-cau" type="text" class="input input-bordered w-full" placeholder="VD: Trệt 3 lầu, trống suốt…" />
        </div>

        <div class="form-control flex items-center gap-2 mt-2">
          <input id="edit-frontage" type="checkbox" class="checkbox" />
          <span class="label-text">Nhà mặt tiền</span>
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Trạng thái</span></label>
          <select id="edit-status" class="select select-bordered w-full">
            <option value="available">Còn trống</option>
            <option value="deposited">Giữ cọc</option>
            <option value="rented">Đã thuê</option>
          </select>
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Hoa hồng / ghi chú HH</span></label>
          <input id="edit-commission" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Danh sách ảnh (mỗi dòng 1 path)</span></label>
          <textarea id="edit-images" class="textarea textarea-bordered w-full min-h-[80px]" placeholder="VD: MB0001/1.jpg&#10;MB0001/2.jpg"></textarea>
          <label class="label">
            <span class="label-text-alt text-xs opacity-70">
              Path bắt đầu từ bucket storage, ví dụ: <code>MB0001/1.jpg</code>
            </span>
          </label>
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Thông tin chi tiết mặt bằng</span></label>
          <textarea id="edit-detail" class="textarea textarea-bordered w-full min-h-[140px]"></textarea>
        </div>
      </div>

      <div class="modal-action">
        <button class="btn btn-ghost" onclick="document.getElementById('editDlg').close()">Huỷ</button>
        <button class="btn btn-primary" onclick="saveEditPremise()">Lưu thay đổi</button>
      </div>
    </div>
  </dialog>

  <!-- ===== TOAST ===== -->
  <div id="toast" class="toast toast-end z-50 hidden">
    <div class="alert alert-info text-sm" id="toast-text"></div>
  </div>

  <script>
    // ===== CONFIG =====
    const SUPABASE_URL = "https://xclncowkoedwqzcemhei.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbG5jb3drb2Vkd3F6Y2VtaGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNzcwOTUsImV4cCI6MjA3Nzg1MzA5NX0.jfNM46UgXIq9LrwSXcERJJULeKB7bl_c9R9LaVhRy1A";
    const STORAGE_BUCKET = "premise-images";
    const PAGE_SIZE = 24;

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let CURRENT_USER = null;
    let CURRENT_ROLE = "staff";
    let PAGE = 0;
    let TOTAL_COUNT = 0;
    let LAST_ROWS = [];
    let EDITING_ID = null;

    // ===== HELPERS =====
    function toast(msg) {
      const toastEl = document.getElementById("toast");
      const textEl = document.getElementById("toast-text");
      textEl.textContent = msg;
      toastEl.classList.remove("hidden");
      setTimeout(() => toastEl.classList.add("hidden"), 2500);
    }

    function money(v) {
      if (v == null || isNaN(v)) return "";
      return new Intl.NumberFormat("vi-VN").format(v) + " đ";
    }

    function formatDateVN(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleDateString("vi-VN");
    }

    function pickField(obj, names) {
      for (const n of names) {
        if (obj && obj[n] !== undefined && obj[n] !== null && obj[n] !== "") {
          return obj[n];
        }
      }
      return null;
    }

    function isAdmin() { return CURRENT_ROLE === "admin"; }
    function isStaff() { return CURRENT_ROLE === "staff"; }

    function maskAddress(row) {
      const full = row.address || "";
      if (!isStaff()) return full || [row.street, row.ward, row.district].filter(Boolean).join(", ");

      if (full) {
        const parts = full.split(" ");
        if (parts.length > 1) {
          parts.shift();
          return parts.join(" ");
        }
        return full;
      }
      return [row.street, row.ward, row.district].filter(Boolean).join(", ");
    }

    function buildImageUrl(path) {
      if (!path) return null;
      const { data } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(path);
      return data?.publicUrl || null;
    }

    // ===== AUTH =====
    async function initAuth() {
      const { data } = await supabase.auth.getUser();
      if (!data.user) {
        document.getElementById("auth-section").classList.remove("hidden");
        document.getElementById("app-root").classList.add("hidden");
        return;
      }
      CURRENT_USER = data.user;

      let role = "staff";
      const { data: profile } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", CURRENT_USER.id)
        .maybeSingle();
      if (profile && profile.role) role = profile.role;
      CURRENT_ROLE = role;

      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("app-root").classList.remove("hidden");
      document.getElementById("role-badge").textContent =
        role === "admin" ? "Admin" : "Nhân sự";
      if (isAdmin()) {
        document.getElementById("btn-add-premise").classList.remove("hidden");
      }

      await applyFilters(true);
      await buildDistrictWardOptions();
    }

    async function handleLogin() {
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value.trim();
      if (!email || !password) {
        toast("Vui lòng nhập email & mật khẩu");
        return;
      }
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        console.error(error);
        toast("Đăng nhập thất bại");
        return;
      }
      toast("Đăng nhập thành công");
      await initAuth();
    }

    async function handleLogout() {
      await supabase.auth.signOut();
      location.reload();
    }

    // ===== FILTERS =====
    function getFilterValues() {
      return {
        keyword: document.getElementById("filter-keyword").value.trim(),
        district: document.getElementById("filter-district").value,
        ward: document.getElementById("filter-ward").value,
        priceMin: Number(document.getElementById("filter-price-min").value) || null,
        priceMax: Number(document.getElementById("filter-price-max").value) || null,
        areaMin: Number(document.getElementById("filter-area-min").value) || null,
        areaMax: Number(document.getElementById("filter-area-max").value) || null,
        frontage: document.getElementById("filter-frontage").value,
        status: document.getElementById("filter-status").value,
      };
    }

    async function applyFilters(resetPage = false) {
      if (resetPage) PAGE = 0;

      const { keyword, district, ward, priceMin, priceMax, areaMin, areaMax, frontage, status } = getFilterValues();

      let query = supabase
        .from("premises")
        .select("*", { count: "exact" });

      if (keyword) {
        const kw = "%" + keyword + "%";
        query = query.or(
          [
            `address.ilike.${kw}`,
            `street.ilike.${kw}`,
            `ward.ilike.${kw}`,
            `district.ilike.${kw}`,
            `code.ilike.${kw}`,
          ].join(",")
        );
      }
      if (district) query = query.eq("district", district);
      if (ward) query = query.eq("ward", ward);
      if (status) query = query.eq("status", status);
      if (frontage === "1") query = query.eq("frontage", true);
      if (priceMin != null) query = query.gte("price", priceMin);
      if (priceMax != null) query = query.lte("price", priceMax);
      if (areaMin != null) query = query.gte("area", areaMin);
      if (areaMax != null) query = query.lte("area", areaMax);

      const from = PAGE * PAGE_SIZE;
      const to = from + PAGE_SIZE - 1;

      query = query
        .order("updated_at", { ascending: false })
        .order("created_at", { ascending: false })
        .range(from, to);

      const { data, error, count } = await query;
      if (error) {
        console.error(error);
        toast("Không tải được dữ liệu");
        return;
      }

      LAST_ROWS = data || [];
      TOTAL_COUNT = count || 0;

      if (PAGE === 0) {
        renderCards(LAST_ROWS, true);
      } else {
        renderCards(LAST_ROWS, false);
      }

      document.getElementById("count-total").textContent = TOTAL_COUNT;
      document.getElementById("count-show").textContent = Math.min(
        (PAGE + 1) * PAGE_SIZE,
        TOTAL_COUNT
      );

      const btnMore = document.getElementById("btn-load-more");
      if ((PAGE + 1) * PAGE_SIZE >= TOTAL_COUNT) {
        btnMore.textContent = "Hết dữ liệu";
        btnMore.classList.add("btn-disabled");
      } else {
        btnMore.textContent = "Tải thêm";
        btnMore.classList.remove("btn-disabled");
      }
    }

    function renderCards(rows, replace) {
      const grid = document.getElementById("grid");
      if (replace) grid.innerHTML = "";

      if (!rows || rows.length === 0) {
        if (PAGE === 0) {
          grid.innerHTML =
            `<div class="col-span-full text-center text-sm opacity-70 py-10">
              Chưa có mặt bằng nào khớp bộ lọc hiện tại. Thử nới lỏng điều kiện tìm kiếm.
            </div>`;
        }
        return;
      }

      const html = rows.map((row) => {
        const hasImages = Array.isArray(row.images) && row.images.length > 0;
        const firstPath = hasImages ? row.images[0] : null;
        const imgUrl = firstPath ? buildImageUrl(firstPath) : null;

        const pnVal = pickField(row, ["pn", "so_pn", "bedrooms", "rooms"]);
        const wcVal = pickField(row, ["wc", "bathrooms"]);
        const floorsVal = pickField(row, ["floors"]);
        const updatedLabel = formatDateVN(row.updated_at || row.created_at);

        return `
          <article class="card bg-base-100 border border-base-200 shadow-sm hover:shadow-md transition-all cursor-pointer premise-card overflow-hidden" data-id="${row.id}">
            <figure class="h-52 bg-base-200 flex items-center justify-center">
              ${
                imgUrl
                  ? `<img src="${imgUrl}" alt="${row.address || ""}" class="w-full h-full object-cover" />`
                  : `<div class="text-xs opacity-60">(Không có ảnh)</div>`
              }
            </figure>
            <div class="card-body p-4 gap-2">
              <h3 class="font-semibold text-sm line-clamp-2">${maskAddress(row)}</h3>
              <div class="text-[11px] opacity-70">
                ${[row.ward, row.district].filter(Boolean).join(" • ")}
              </div>
              <div class="flex flex-wrap items-center gap-2 text-[11px] mt-1">
                ${row.area ? `<span>${row.area} m²</span>` : ""}
                ${
                  row.width && row.length
                    ? `<span>${row.width}×${row.length} m</span>`
                    : ""
                }
                ${pnVal ? `<span>${pnVal} PN</span>` : ""}
                ${wcVal ? `<span>${wcVal} WC</span>` : ""}
                ${floorsVal ? `<span>${floorsVal} tầng</span>` : ""}
              </div>
              ${
                row.ket_cau
                  ? `<div class="text-[11px] opacity-70 line-clamp-1 mt-1">${row.ket_cau}</div>`
                  : ""
              }
              <div class="text-[11px] opacity-60">
                ${updatedLabel ? `Cập nhật ${updatedLabel}` : ""}
              </div>
              <div class="flex items-center justify-between mt-1">
                <div class="text-primary font-extrabold text-lg">${money(row.price)}</div>
                <div class="text-[11px] px-2 py-0.5 rounded-full border ${
                  row.status === "available"
                    ? "border-success text-success"
                    : row.status === "deposited"
                    ? "border-warning text-warning"
                    : "border-base-300 text-base-400"
                }">
                  ${
                    row.status === "available"
                      ? "Còn trống"
                      : row.status === "deposited"
                      ? "Giữ cọc"
                      : "Đã thuê"
                  }
                </div>
              </div>
            </div>
          </article>
        `;
      });

      grid.insertAdjacentHTML("beforeend", html.join(""));

      grid.querySelectorAll("[data-id]").forEach((el) => {
        el.onclick = () => openDetail(el.getAttribute("data-id"));
      });
    }

    async function buildDistrictWardOptions() {
      const { data, error } = await supabase
        .from("premises")
        .select("district, ward");
      if (error || !data) return;

      const districts = Array.from(
        new Set(data.map((r) => r.district).filter(Boolean))
      ).sort();

      const selectDistrict = document.getElementById("filter-district");
      const current = selectDistrict.value;
      selectDistrict.innerHTML = '<option value="">Tất cả</option>';
      districts.forEach((d) => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        selectDistrict.appendChild(opt);
      });
      if (current) selectDistrict.value = current;

      updateWardOptions();
    }

    function updateWardOptions() {
      const district = document.getElementById("filter-district").value;
      const selectWard = document.getElementById("filter-ward");
      selectWard.innerHTML = '<option value="">Tất cả</option>';
      if (!district) return;
      supabase
        .from("premises")
        .select("ward, district")
        .eq("district", district)
        .then(({ data }) => {
          if (!data) return;
          const wards = Array.from(
            new Set(data.map((r) => r.ward).filter(Boolean))
          ).sort();
          wards.forEach((w) => {
            const opt = document.createElement("option");
            opt.value = w;
            opt.textContent = w;
            selectWard.appendChild(opt);
          });
        });
    }

    // ===== DETAIL & EDIT =====
    async function openDetail(id) {
      const dlg = document.getElementById("detailDlg");
      const wrap = document.getElementById("detail-content");
      wrap.innerHTML = `<div class="py-10 text-center text-sm opacity-70">Đang tải...</div>`;
      dlg.showModal();

      const { data, error } = await supabase
        .from("premises")
        .select("*")
        .eq("id", id)
        .single();

      if (error || !data) {
        wrap.innerHTML =
          `<div class="py-10 text-center text-sm text-error">Không tải được dữ liệu.</div>`;
        return;
      }

      const item = data;
      const pnVal = pickField(item, ["pn", "so_pn", "bedrooms", "rooms"]);
      const wcVal = pickField(item, ["wc", "bathrooms"]);
      const floorsVal = pickField(item, ["floors"]);
      const detailText = pickField(item, [
        "detail",
        "thong_tin_chi_tiet",
        "chi_tiet",
        "description",
        "info_detail",
      ]) || "";

      const imgs = Array.isArray(item.images) ? item.images : [];
      const imgUrls = imgs.map(buildImageUrl).filter(Boolean);
      const firstImg = imgUrls[0] || null;

      const updatedLabel = formatDateVN(item.updated_at || item.created_at);

      const basicInfoLines = [];
      if (item.area) basicInfoLines.push(`Diện tích: <b>${item.area} m²</b>`);
      if (item.width && item.length)
        basicInfoLines.push(`Kích thước: <b>${item.width}×${item.length} m</b>`);
      if (floorsVal) basicInfoLines.push(`Số tầng: <b>${floorsVal}</b>`);
      if (pnVal) basicInfoLines.push(`Phòng ngủ: <b>${pnVal}</b>`);
      if (wcVal) basicInfoLines.push(`WC: <b>${wcVal}</b>`);
      if (item.ket_cau) basicInfoLines.push(`Kết cấu: <b>${item.ket_cau}</b>`);
      if (item.frontage === true) basicInfoLines.push(`<b>Nhà mặt tiền</b>`);
      if (item.status) {
        let st = "Không rõ";
        if (item.status === "available") st = "Còn trống";
        else if (item.status === "deposited") st = "Giữ cọc";
        else if (item.status === "rented") st = "Đã thuê";
        basicInfoLines.push(`Trạng thái: <b>${st}</b>`);
      }
      if (updatedLabel)
        basicInfoLines.push(`Cập nhật: <b>${updatedLabel}</b>`);

      const basicInfoBlock = basicInfoLines.length
        ? `
        <div class="mt-3 text-sm leading-relaxed space-y-1">
          <div class="font-semibold mb-1">Thông tin cơ bản</div>
          ${basicInfoLines.map((l) => `<div>${l}</div>`).join("")}
        </div>
      `
        : "";

      const detailBlock = detailText
        ? `
        <div class="mt-4 text-sm leading-relaxed">
          <div class="font-semibold mb-1">Thông tin chi tiết</div>
          <p>${detailText.replace(/\n/g, "<br/>")}</p>
        </div>
      `
        : "";

      const mapsQuery = encodeURIComponent(
        [item.address, item.ward, item.district, item.city]
          .filter(Boolean)
          .join(", ")
      );
      const mapEmbed = `
        <iframe
          class="w-full h-64 border-0 rounded-xl"
          loading="lazy"
          allowfullscreen
          referrerpolicy="no-referrer-when-downgrade"
          src="https://www.google.com/maps?q=${mapsQuery}&output=embed">
        </iframe>`;

      const actions = `
        <div class="join join-horizontal">
          ${
            item.contact_phone && !isStaff()
              ? `<a class="btn btn-primary btn-sm join-item" href="tel:${item.contact_phone}">Gọi</a>`
              : ""
          }
          ${
            item.contact_phone && !isStaff()
              ? `<a class="btn btn-sm join-item" target="_blank" href="https://zalo.me/${(item.contact_phone || "").replace(/[^0-9]/g, "")}">Zalo</a>`
              : ""
          }
          <a class="btn btn-sm join-item" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${mapsQuery}">Mở Google Maps</a>
          <button class="btn btn-sm join-item" onclick="navigator.clipboard.writeText(location.origin + location.pathname + '#'+encodeURIComponent('${id}'));toast('Đã copy link mặt bằng')">Copy link</button>
          ${
            isAdmin()
              ? `<button class="btn btn-outline btn-sm join-item" onclick="openEditPremise('${id}')">Chỉnh sửa</button>`
              : ""
          }
        </div>
      `;

      const gallery = `
        <div class="w-full flex flex-col items-center gap-2">
          <div class="w-full h-[340px] bg-base-200 flex items-center justify-center rounded-xl overflow-hidden">
            ${
              firstImg
                ? `<img src="${firstImg}" class="w-full h-full object-cover" />`
                : `<div class="text-xs opacity-60">(Không có ảnh)</div>`
            }
          </div>
          ${
            imgUrls.length > 1
              ? `<div class="flex gap-1">
                  ${imgUrls
                    .map(
                      (_, idx) =>
                        `<button class="btn btn-ghost btn-xs">${idx + 1}</button>`
                    )
                    .join("")}
                 </div>`
              : '<div class="text-xs opacity-50 mt-1">1</div>'
          }
        </div>
      `;

      const html = `
        <div class="grid md:grid-cols-2 gap-6">
          <div class="space-y-4">
            ${gallery}
            <div>${mapEmbed}</div>
          </div>

          <div class="space-y-3">
            <h2 class="text-xl font-bold">${maskAddress(item)}</h2>
            <div class="text-sm opacity-70">
              ${[item.ward, item.district, item.city].filter(Boolean).join(" • ")}
            </div>
            <div class="text-xs opacity-60 mt-1">
              Mã mặt bằng: <b>${item.code || "—"}</b>
            </div>

            <div class="flex flex-wrap gap-2 mt-2 text-xs">
              ${
                item.area
                  ? `<div class="badge badge-ghost">${item.area} m²</div>`
                  : ""
              }
              ${
                item.width && item.length
                  ? `<div class="badge badge-ghost">${item.width}×${item.length} m</div>`
                  : ""
              }
              ${
                item.status === "available"
                  ? `<div class="badge badge-success">Còn trống</div>`
                  : item.status === "deposited"
                  ? `<div class="badge badge-warning">Giữ cọc</div>`
                  : `<div class="badge badge-neutral">Đã thuê</div>`
              }
            </div>

            <div class="text-3xl font-extrabold text-primary mt-2">
              ${money(item.price)}
            </div>
            ${
              item.commission_note
                ? `<div class="text-sm mt-1">Hoa hồng: <b>${item.commission_note}</b></div>`
                : ""
            }

            ${basicInfoBlock}
            ${detailBlock}

            ${
              item.suitable && item.suitable.length
                ? `<div class="flex flex-wrap gap-1 text-xs mt-3">
                    ${item.suitable
                      .map((s) => `<div class="badge badge-ghost">${s}</div>`)
                      .join("")}
                   </div>`
                : ""
            }

            ${
              (item.contact_phone || item.contact_name) && !isStaff()
                ? `<div class="space-x-2 text-sm mt-3">
                    <span class="opacity-70">Liên hệ:</span>
                    <b>${item.contact_name || ""}</b>
                    <a class="link" href="tel:${item.contact_phone || ""}">${
                    item.contact_phone || ""
                  }</a>
                   </div>`
                : ""
            }

            ${
              isStaff()
                ? `<div class="mt-3 text-sm opacity-70">
                    Liên hệ admin để xem số điện thoại chủ nhà.
                   </div>`
                : ""
            }

            <div class="mt-4">
              ${actions}
            </div>
          </div>
        </div>
      `;

      wrap.innerHTML = html;
    }

    async function openEditPremise(id) {
      if (!isAdmin()) return;
      EDITING_ID = id;

      const { data, error } = await supabase
        .from("premises")
        .select("*")
        .eq("id", id)
        .single();

      if (error || !data) {
        console.error(error);
        toast("Không tải được dữ liệu để chỉnh sửa");
        return;
      }

      const item = data;
      document.getElementById("edit-code").value = item.code || "";
      document.getElementById("edit-address").value = item.address || "";
      document.getElementById("edit-city").value = item.city || "";
      document.getElementById("edit-district").value = item.district || "";
      document.getElementById("edit-ward").value = item.ward || "";
      document.getElementById("edit-street").value = item.street || "";

      document.getElementById("edit-price").value = item.price || "";
      document.getElementById("edit-area").value = item.area || "";
      document.getElementById("edit-width").value = item.width || "";
      document.getElementById("edit-length").value = item.length || "";
      document.getElementById("edit-floors").value = item.floors || "";

      const pnVal = pickField(item, ["pn", "so_pn", "bedrooms", "rooms"]);
      const wcVal = pickField(item, ["wc", "bathrooms"]);
      document.getElementById("edit-bedrooms").value = pnVal || "";
      document.getElementById("edit-wc").value = wcVal || "";

      document.getElementById("edit-ket-cau").value = item.ket_cau || "";

      document.getElementById("edit-frontage").checked = !!item.frontage;
      document.getElementById("edit-status").value = item.status || "available";
      document.getElementById("edit-commission").value =
        item.commission_note || "";

      const imgs = Array.isArray(item.images) ? item.images : [];
      document.getElementById("edit-images").value = imgs.join("\n");

      document.getElementById("edit-detail").value =
        pickField(item, [
          "detail",
          "thong_tin_chi_tiet",
          "chi_tiet",
          "description",
          "info_detail",
        ]) || "";

      document.getElementById("editDlg").showModal();
    }

    async function saveEditPremise() {
      if (!isAdmin() || !EDITING_ID) return;

      const payload = {
        code: document.getElementById("edit-code").value.trim() || null,
        address: document.getElementById("edit-address").value.trim() || null,
        city: document.getElementById("edit-city").value.trim() || null,
        district: document.getElementById("edit-district").value.trim() || null,
        ward: document.getElementById("edit-ward").value.trim() || null,
        street: document.getElementById("edit-street").value.trim() || null,
        price: Number(document.getElementById("edit-price").value) || null,
        area: Number(document.getElementById("edit-area").value) || null,
        width: Number(document.getElementById("edit-width").value) || null,
        length: Number(document.getElementById("edit-length").value) || null,
        floors: Number(document.getElementById("edit-floors").value) || null,
        status: document.getElementById("edit-status").value,
        frontage: document.getElementById("edit-frontage").checked,
        commission_note:
          document.getElementById("edit-commission").value.trim() || null,
        detail: document.getElementById("edit-detail").value.trim() || null,
        ket_cau: document.getElementById("edit-ket-cau").value.trim() || null,
        updated_at: new Date().toISOString(),
      };

      const pn = Number(document.getElementById("edit-bedrooms").value) || null;
      const wc = Number(document.getElementById("edit-wc").value) || null;
      if (pn) payload.pn = pn;
      if (wc) payload.wc = wc;

      const rawImages = document
        .getElementById("edit-images")
        .value.split("\n")
        .map((s) => s.trim())
        .filter(Boolean);
      payload.images = rawImages.length ? rawImages : null;

      const { error } = await supabase
        .from("premises")
        .update(payload)
        .eq("id", EDITING_ID);

      if (error) {
        console.error(error);
        toast("Lưu thất bại: " + (error.message || "Lỗi không xác định"));
        return;
      }

      toast("Đã lưu thay đổi");
      document.getElementById("editDlg").close();
      EDITING_ID = null;
      await applyFilters(true);
    }

    // ===== EVENTS =====
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btn-login").addEventListener("click", handleLogin);
      document.getElementById("btn-logout").addEventListener("click", handleLogout);

      document
        .getElementById("filter-district")
        .addEventListener("change", updateWardOptions);

      document
        .getElementById("btn-apply")
        .addEventListener("click", () => applyFilters(true));

      document.getElementById("btn-reset").addEventListener("click", () => {
        document.getElementById("filter-keyword").value = "";
        document.getElementById("filter-district").value = "";
        document.getElementById("filter-ward").value = "";
        document.getElementById("filter-price-min").value = "";
        document.getElementById("filter-price-max").value = "";
        document.getElementById("filter-area-min").value = "";
        document.getElementById("filter-area-max").value = "";
        document.getElementById("filter-frontage").value = "";
        document.getElementById("filter-status").value = "";
        applyFilters(true);
      });

      document
        .getElementById("btn-load-more")
        .addEventListener("click", async () => {
          PAGE++;
          await applyFilters(false);
        });

      document.querySelectorAll("[data-quick]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const v = btn.getAttribute("data-quick");
          document.getElementById("filter-status").value = v;
          applyFilters(true);
        });
      });
      document.querySelectorAll("[data-quick-district]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const v = btn.getAttribute("data-quick-district");
          document.getElementById("filter-district").value = v;
          updateWardOptions();
          applyFilters(true);
        });
      });
      document
        .getElementById("btn-clear-quick")
        .addEventListener("click", () => {
          document.getElementById("filter-status").value = "";
          document.getElementById("filter-district").value = "";
          document.getElementById("filter-ward").value = "";
          applyFilters(true);
        });

      initAuth();
    });
  </script>
</body>
</html>
