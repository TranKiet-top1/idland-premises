<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>ID-Land Premises</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
    rel="stylesheet"
  />

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    .premise-card:hover {
      transform: translateY(-2px);
    }
  </style>
</head>
<body class="bg-base-200">

  <section id="auth-section" class="min-h-screen flex items-center justify-center">
    <div class="card w-full max-w-md bg-base-100 shadow-xl">
      <div class="card-body">
        <div class="flex items-center gap-2 mb-4">
          <div class="h-10 w-10 rounded-xl bg-primary flex items-center justify-center text-white font-bold">ID</div>
          <div>
            <h2 class="card-title">ID-Land Premises</h2>
            <p class="text-xs opacity-70">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem kho m·∫∑t b·∫±ng</p>
          </div>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Email</span>
          </label>
          <input id="login-email" type="email" placeholder="you@idland.vn" class="input input-bordered" />
        </div>

        <div class="form-control mt-2">
          <label class="label">
            <span class="label-text">M·∫≠t kh·∫©u</span>
          </label>
          <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="input input-bordered" />
        </div>

        <div class="form-control mt-4">
          <button id="btn-login" class="btn btn-primary w-full">ƒêƒÉng nh·∫≠p</button>
        </div>

        <p class="mt-3 text-xs opacity-70">
          Quy·ªÅn <b>admin</b>: xem & ch·ªânh s·ª≠a full th√¥ng tin, s·ªë nh√† & s·ªë ch·ªß.<br/>
          Quy·ªÅn <b>nh√¢n s·ª±</b>: b·ªã ·∫©n s·ªë nh√† & s·ªë ƒëi·ªán tho·∫°i ch·ªß nh√†.
        </p>
      </div>
    </div>
  </section>

  <div id="app-root" class="hidden min-h-screen flex flex-col">
    <div class="navbar bg-base-100 shadow-sm px-4 sticky top-0 z-50">
      <div class="flex-1 flex items-center gap-2">
        <div class="h-9 w-9 rounded-xl bg-primary flex items-center justify-center text-white font-bold text-xs">ID</div>
        <div>
          <div class="font-bold text-lg leading-tight">ID-Land Premises</div>
          <div class="text-xs opacity-60">Kho m·∫∑t b·∫±ng cho thu√™ ‚Ä¢ TP.HCM</div>
        </div>
      </div>
      <div class="flex-none flex items-center gap-2 text-sm">
        <div class="text-right hidden sm:block mr-2">
             <div id="user-email-display" class="text-xs font-bold"></div>
             <span id="role-badge" class="badge badge-outline"></span>
        </div>
        <button id="btn-logout" class="btn btn-ghost btn-sm">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <main class="flex-1 max-w-6xl mx-auto w-full px-2 sm:px-4 py-4">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <div>
          <h1 class="text-xl sm:text-2xl font-bold">
            B·ªô l·ªçc m·∫∑t b·∫±ng <span class="text-primary">ID-Land</span>
          </h1>
          <p class="text-xs sm:text-sm opacity-70">
            Nh√¢n s·ª± ch·ªâ c·∫ßn nh·∫≠p y√™u c·∫ßu c·ªßa kh√°ch: <b>gi√° ‚Äì di·ªán t√≠ch ‚Äì khu v·ª±c...</b>
          </p>
        </div>

        <div class="flex flex-wrap gap-2 justify-end">
          <div id="admin-pending-controls" class="hidden flex gap-2">
               <button id="btn-toggle-pending" class="btn btn-warning btn-sm text-white">
                   C·∫ßn duy·ªát <span class="badge badge-sm bg-white text-warning ml-1 border-none" id="count-pending">0</span>
               </button>
               <button id="btn-approve-all" class="btn btn-success btn-sm text-white hidden">‚úî Duy·ªát t·∫•t c·∫£</button>
          </div>

          <button id="btn-open-add" class="btn btn-primary btn-sm">
            + Th√™m m·∫∑t b·∫±ng
          </button>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2 mb-3">
        <span class="text-xs opacity-70">L·ªçc nhanh:</span>
        <button class="btn btn-xs" data-quick="available">C√≤n tr·ªëng</button>
        <button class="btn btn-xs" data-quick="deposited">Gi·ªØ c·ªçc</button>
        <button class="btn btn-xs" data-quick-district="Qu·∫≠n 1">Qu·∫≠n 1</button>
        <button class="btn btn-xs" data-quick-district="Qu·∫≠n 10">Qu·∫≠n 10</button>
        <button class="btn btn-xs btn-ghost btn-outline" id="btn-clear-quick">
          Xo√° l·ªçc nhanh
        </button>
      </div>

      <div class="grid md:grid-cols-[260px,1fr] gap-4">
        <aside class="bg-base-100 rounded-2xl shadow-sm p-4">
          <div class="flex items-center gap-2 mb-3">
            <span class="w-2 h-2 rounded-full bg-success"></span>
            <h2 class="font-semibold text-sm">B·ªô l·ªçc</h2>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">T·ª´ kho√°</span>
            </label>
            <input
              id="filter-keyword"
              type="text"
              placeholder="VD: Tr·∫ßn H∆∞ng ƒê·∫°o, Q5..."
              class="input input-sm input-bordered"
            />
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">Qu·∫≠n</span>
            </label>
            <select id="filter-district" class="select select-sm select-bordered">
              <option value="">T·∫•t c·∫£</option>
            </select>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">Ph∆∞·ªùng</span>
            </label>
            <select id="filter-ward" class="select select-sm select-bordered">
              <option value="">T·∫•t c·∫£</option>
            </select>
          </div>

          <div class="grid grid-cols-1 gap-2 mb-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">S·ªë PN</span>
              </label>
              <select id="filter-pn" class="select select-sm select-bordered">
                <option value="">T·∫•t c·∫£</option>
                <option value="1">1 PN</option>
                <option value="2">2 PN</option>
                <option value="3">3 PN</option>
                <option value="4">4 PN</option>
                <option value="5">5 PN</option>
                <option value="6">6 PN</option>
                <option value=">6">> 6 PN</option>
              </select>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">S·ªë WC</span>
              </label>
              <select id="filter-wc" class="select select-sm select-bordered">
                <option value="">T·∫•t c·∫£</option>
                <option value="1">1 WC</option>
                <option value="2">2 WC</option>
                <option value="3">3 WC</option>
                <option value="4">4 WC</option>
                <option value="5">5 WC</option>
                <option value=">5">> 5 WC</option>
              </select>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">S·ªë t·∫ßng</span>
              </label>
              <select id="filter-floors" class="select select-sm select-bordered">
                <option value="">T·∫•t c·∫£</option>
                <option value="1">1 t·∫ßng</option>
                <option value="2">2 t·∫ßng</option>
                <option value="3">3 t·∫ßng</option>
                <option value="4">4 t·∫ßng</option>
                <option value="5">5 t·∫ßng</option>
                <option value=">5">> 5 t·∫ßng</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Gi√° t·ªëi thi·ªÉu</span>
              </label>
              <input
                id="filter-price-min"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Gi√° t·ªëi ƒëa</span>
              </label>
              <input
                id="filter-price-max"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">DT t·ªëi thi·ªÉu (m¬≤)</span>
              </label>
              <input
                id="filter-area-min"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">DT t·ªëi ƒëa (m¬≤)</span>
              </label>
              <input
                id="filter-area-max"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">V·ªã tr√≠</span>
            </label>
            <select id="filter-frontage-type" class="select select-sm select-bordered">
              <option value="">T·∫•t c·∫£</option>
              <option value="hem">Nh√† h·∫ªm</option>
              <option value="hxh">H·∫ªm xe h∆°i</option>
              <option value="mt">M·∫∑t ti·ªÅn</option>
            </select>
          </div>

          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text text-xs">T√¨nh tr·∫°ng</span>
            </label>
            <select id="filter-status" class="select select-sm select-bordered">
              <option value="">T·∫•t c·∫£</option>
              <option value="available">C√≤n tr·ªëng</option>
              <option value="deposited">Gi·ªØ c·ªçc</option>
              <option value="rented">ƒê√£ thu√™</option>
            </select>
          </div>

          <div class="flex gap-2">
            <button id="btn-apply" class="btn btn-sm btn-primary flex-1">
              L·ªçc
            </button>
            <button id="btn-reset" class="btn btn-sm btn-ghost">
              Xo√° l·ªçc
            </button>
          </div>
        </aside>

        <section class="flex flex-col gap-3">
          <div class="flex items-center justify-between mb-1 text-xs opacity-70">
            <span>
              Hi·ªÉn th·ªã <span id="count-show">0</span> / <span id="count-total">0</span>
            </span>
            <button id="btn-download-csv" class="btn btn-xs btn-ghost">
              T·∫£i CSV tr√™n Supabase
            </button>
          </div>

          <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            </div>

          <div class="mt-4 flex justify-center">
            <button id="btn-load-more" class="btn btn-sm btn-ghost">
              H·∫øt d·ªØ li·ªáu
            </button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <dialog id="detailDlg" class="modal">
    <div class="modal-box max-w-5xl p-4">
      <form method="dialog" class="modal-backdrop absolute inset-0" onclick="document.getElementById('detailDlg').close()"></form>
      <div id="detail-content"></div>
    </div>
  </dialog>

  <dialog id="editDlg" class="modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog" class="modal-backdrop absolute inset-0" onclick="document.getElementById('editDlg').close()"></form>
      <h3 class="font-bold text-lg mb-3">Ch·ªânh s·ª≠a m·∫∑t b·∫±ng</h3>

      <div class="grid md:grid-cols-2 gap-3">
        <div class="form-control md:col-span-2">
          <label class="label">
            <span class="label-text">M√£ m·∫∑t b·∫±ng (code)</span>
          </label>
          <input id="edit-code" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label">
            <span class="label-text">Ti√™u ƒë·ªÅ / ƒê·ªãa ch·ªâ hi·ªÉn th·ªã</span>
          </label>
          <input id="edit-address" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Th√†nh ph·ªë</span></label>
          <input id="edit-city" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Qu·∫≠n</span></label>
          <input id="edit-district" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Ph∆∞·ªùng</span></label>
          <input id="edit-ward" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">T√™n ƒë∆∞·ªùng</span></label>
          <input id="edit-street" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Gi√° thu√™ (ƒë)</span></label>
          <input id="edit-price" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Di·ªán t√≠ch (m¬≤)</span></label>
          <input id="edit-area" type="number" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Chi·ªÅu ngang (m)</span></label>
          <input id="edit-width" type="number" step="0.1" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Chi·ªÅu d√†i (m)</span></label>
          <input id="edit-length" type="number" step="0.1" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">S·ªë t·∫ßng</span></label>
          <input id="edit-floors" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">S·ªë PN</span></label>
          <input id="edit-bedrooms" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">S·ªë WC</span></label>
          <input id="edit-wc" type="number" class="input input-bordered w-full" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">K·∫øt c·∫•u</span></label>
          <input id="edit-ket-cau" type="text" class="input input-bordered w-full" placeholder="VD: Tr·ªát 3 l·∫ßu, tr·ªëng su·ªët‚Ä¶" />
        </div>
        
        <div class="form-control md:col-span-2">
            <label class="label"><span class="label-text">SƒêT Ch·ªß nh√† (Ch·ªâ Admin th·∫•y)</span></label>
            <input id="edit-contact-phone" type="text" class="input input-bordered w-full" placeholder="090..." />
        </div>

        <div class="form-control flex items-center gap-2 mt-2">
          <input id="edit-frontage" type="checkbox" class="checkbox" />
          <span class="label-text">Nh√† m·∫∑t ti·ªÅn</span>
        </div>

        <div class="form-control md:col-span-2 grid grid-cols-2 gap-2">
            <div class="form-control">
              <label class="label"><span class="label-text">Lo·∫°i h√¨nh</span></label>
              <select id="edit-road-type" class="select select-bordered w-full">
                <option value="H·∫ªm">H·∫ªm</option>
                <option value="H·∫ªm xe h∆°i">H·∫ªm xe h∆°i</option>
                <option value="M·∫∑t ti·ªÅn">M·∫∑t ti·ªÅn</option>
              </select>
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">Hoa h·ªìng (ng·∫Øn)</span></label>
              <input id="edit-commission-text" type="text" class="input input-bordered w-full" placeholder="VD: 1 th√°ng" />
            </div>
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Tr·∫°ng th√°i</span></label>
          <select id="edit-status" class="select select-bordered w-full">
            <option value="available">C√≤n tr·ªëng</option>
            <option value="deposited">Gi·ªØ c·ªçc</option>
            <option value="rented">ƒê√£ thu√™</option>
          </select>
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Hoa h·ªìng / ghi ch√∫ HH</span></label>
          <input id="edit-commission" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Danh s√°ch ·∫£nh (m·ªói d√≤ng 1 path)</span></label>
          <textarea id="edit-images" class="textarea textarea-bordered w-full min-h-[80px]" placeholder="VD: MB0001/1.jpg
MB0001/2.jpg"></textarea>
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Th√¥ng tin chi ti·∫øt m·∫∑t b·∫±ng</span></label>
          <textarea id="edit-detail" class="textarea textarea-bordered w-full min-h-[140px]"></textarea>
        </div>
      </div>

      <div class="modal-action">
        <button class="btn btn-ghost" onclick="document.getElementById('editDlg').close()">Hu·ª∑</button>
        <button class="btn btn-primary" onclick="saveEditPremise()">L∆∞u thay ƒë·ªïi</button>
      </div>
    </div>
  </dialog>

  <dialog id="addDlg" class="modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button></form>
      <h3 class="font-bold text-lg text-primary mb-4">ƒêƒÉng m·∫∑t b·∫±ng m·ªõi</h3>
      
      <div class="grid md:grid-cols-2 gap-4">
          <div>
             <div class="form-control mb-2">
                 <span class="label-text text-xs font-bold">ƒê·ªãa ch·ªâ (S·ªë nh√† + ƒê∆∞·ªùng) *</span>
                 <input id="add-address" type="text" class="input input-sm input-bordered" placeholder="VD: 123 Nguy·ªÖn Tr√£i"/>
             </div>
             <div class="grid grid-cols-2 gap-2 mb-2">
                 <div class="form-control">
                     <span class="label-text text-xs">Qu·∫≠n *</span>
                     <select id="add-district" class="select select-sm select-bordered">
                        <option value="">-- Ch·ªçn --</option>
                     </select>
                 </div>
                 <div class="form-control">
                     <span class="label-text text-xs">Ph∆∞·ªùng *</span>
                     <select id="add-ward" class="select select-sm select-bordered" disabled>
                        <option value="">-- Ch·ªçn Qu·∫≠n tr∆∞·ªõc --</option>
                     </select>
                 </div>
             </div>
             <div class="form-control mb-2">
                 <span class="label-text text-xs">T√™n ƒë∆∞·ªùng (ƒë·ªÉ l·ªçc)</span>
                 <input id="add-street" type="text" class="input input-sm input-bordered"/>
             </div>
             <div class="form-control mt-3">
                 <span class="label-text text-xs font-bold text-primary">Gi√° thu√™ (VNƒê) *</span>
                 <input id="add-price" type="text" class="input input-sm input-bordered font-bold" onkeyup="formatCurrencyInput(this)" placeholder="0"/>
             </div>
             
             <div class="grid grid-cols-2 gap-2 mt-3">
                 <div class="form-control">
                     <span class="label-text text-xs font-bold">Lo·∫°i h√¨nh *</span>
                     <select id="add-road-type" class="select select-sm select-bordered">
                        <option value="H·∫ªm">H·∫ªm</option>
                        <option value="H·∫ªm xe h∆°i">H·∫ªm xe h∆°i</option>
                        <option value="M·∫∑t ti·ªÅn">M·∫∑t ti·ªÅn</option>
                     </select>
                 </div>
                 <div class="form-control">
                     <span class="label-text text-xs font-bold text-success">Hoa h·ªìng</span>
                     <input id="add-commission" type="text" class="input input-sm input-bordered" placeholder="VD: 1 th√°ng"/>
                 </div>
             </div>
          </div>

          <div>
             <div class="grid grid-cols-3 gap-2 mb-2">
                 <div><span class="text-xs">DT (m¬≤)</span><input id="add-area" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">Ngang</span><input id="add-width" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">D√†i</span><input id="add-length" type="number" class="input input-sm input-bordered w-full"/></div>
             </div>
             <div class="grid grid-cols-3 gap-2 mb-2">
                 <div><span class="text-xs">T·∫ßng</span><input id="add-floors" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">PN</span><input id="add-bedrooms" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">WC</span><input id="add-wc" type="number" class="input input-sm input-bordered w-full"/></div>
             </div>
             <div class="form-control mb-2">
                 <span class="text-xs">K·∫øt c·∫•u</span>
                 <input id="add-ket-cau" type="text" class="input input-sm input-bordered" placeholder="VD: Tr·ªát 3 l·∫ßu..."/>
             </div>
             <div class="form-control mb-2">
                 <span class="text-xs font-bold text-error">SƒêT Ch·ªß (Admin xem)</span>
                 <input id="add-contact-phone" type="text" class="input input-sm input-bordered input-error" placeholder="090..."/>
             </div>
          </div>

          <div class="md:col-span-2 border-t pt-3 mt-2">
              <div class="flex justify-between items-center mb-2">
                  <span class="label-text font-bold">H√¨nh ·∫£nh th·ª±c t·∫ø</span>
                  <label for="inp-upload-files" class="btn btn-sm btn-primary text-white">
                      üì∑ T·∫£i ·∫£nh l√™n
                  </label>
                  <input type="file" id="inp-upload-files" multiple accept="image/*" class="hidden" onchange="handleSelectFiles(this)"/>
              </div>
              
              <div id="preview-container" class="flex flex-wrap gap-3 min-h-[100px] bg-base-200 p-2 rounded-lg border border-dashed border-gray-400">
                  <p class="text-xs text-gray-500 w-full text-center py-8 pointer-events-none">
                      Ch∆∞a c√≥ ·∫£nh n√†o. <br/> ·∫¢nh ƒë·∫ßu ti√™n s·∫Ω l√† <b>·∫¢nh B√¨a</b>. Click v√†o ·∫£nh ƒë·ªÉ ƒë·∫∑t l√†m b√¨a.
                  </p>
              </div>

              <div class="form-control mt-2">
                  <span class="text-xs">M√¥ t·∫£ chi ti·∫øt</span>
                  <textarea id="add-detail" class="textarea textarea-bordered w-full h-20 text-sm"></textarea>
              </div>
          </div>
      </div>

      <div class="modal-action">
        <button class="btn" onclick="document.getElementById('addDlg').close()">Hu·ª∑</button>
        <button id="btn-save-new" class="btn btn-primary" onclick="saveNewPremiseWithUpload()">
            L∆∞u tin
        </button>
      </div>
    </div>
  </dialog>

  <dialog id="demoNoticeDlg" class="modal">
    <div class="modal-box max-w-md">
      <h3 class="font-bold text-lg mb-2 text-error">L∆∞u √Ω: B·∫£n DEMO</h3>
      <p class="text-sm leading-relaxed">
        ƒê√¢y l√† b·∫£n <b>DEMO</b> n√™n c√≤n nhi·ªÅu l·ªói, ch·ª©c nƒÉng ch∆∞a ho√†n thi·ªán.<br/><br/>
        N·∫øu anh/ch·ªã c√≥ th·∫Øc m·∫Øc, ph√°t hi·ªán l·ªói ho·∫∑c c√≥ ƒë·ªÅ xu·∫•t c·∫£i ti·∫øn trang web,
        xin vui l√≤ng li√™n h·ªá Team <b>"VƒÉn H√≥a"</b> ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.
      </p>
      <div class="mt-4 flex justify-end gap-2">
        <button id="btn-demo-disagree" class="btn btn-outline btn-sm">
          toi khong dong tinh
        </button>
        <button id="btn-demo-agree" class="btn btn-primary btn-sm">
          toi dong tinh
        </button>
      </div>
    </div>
  </dialog>

  <div id="toast" class="toast toast-end z-50 hidden">
    <div class="alert alert-info text-sm" id="toast-text"></div>
  </div>

  <script>
    // ===== 1. CONFIG =====
    const SUPABASE_URL = "https://xclncowkoedwqzcemhei.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbG5jb3drb2Vkd3F6Y2VtaGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNzcwOTUsImV4cCI6MjA3Nzg1MzA5NX0.jfNM46UgXIq9LrwSXcERJJULeKB7bl_c9R9LaVhRy1A";
    const STORAGE_BUCKET = "premise-images";
    const PAGE_SIZE = 24;

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- D·ªÆ LI·ªÜU QU·∫¨N/PH∆Ø·ªúNG CHO FORM TH√äM M·ªöI (C·∫ßn d·ªØ li·ªáu ƒë·ªÉ ch·ªçn) ---
    const HCM_DATA = {
        "Qu·∫≠n 1": ["B·∫øn Ngh√©", "B·∫øn Th√†nh", "C√¥ Giang", "C·∫ßu Kho", "C·∫ßu √îng L√£nh", "ƒêa Kao", "Nguy·ªÖn C∆∞ Trinh", "Nguy·ªÖn Th√°i B√¨nh", "Ph·∫°m Ng≈© L√£o", "T√¢n ƒê·ªãnh"],
        "Qu·∫≠n 2": [
          "Th·∫£o ƒêi·ªÅn",
          "An Ph√∫",
          "B√¨nh An",
          "B√¨nh Tr∆∞ng ƒê√¥ng",
          "B√¨nh Tr∆∞ng T√¢y",
          "An Kh√°nh",
          "C√°t L√°i",
          "Th·∫°nh M·ªπ L·ª£i",
          "Th·ªß Thi√™m"
        ],

        "Qu·∫≠n 3": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "V√µ Th·ªã S√°u"],
        "Qu·∫≠n 4": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16", "Ph∆∞·ªùng 18"],
        "Qu·∫≠n 5": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14"],
        "Qu·∫≠n 6": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14"],
        "Qu·∫≠n 7": ["B√¨nh Thu·∫≠n", "Ph√∫ M·ªπ", "Ph√∫ Thu·∫≠n", "T√¢n H∆∞ng", "T√¢n Ki·ªÉng", "T√¢n Phong", "T√¢n Ph√∫", "T√¢n Quy", "T√¢n Thu·∫≠n ƒê√¥ng", "T√¢n Thu·∫≠n T√¢y"],
        "Qu·∫≠n 8": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16"],
        "Qu·∫≠n 9": [
            "Hi·ªáp Ph√∫",
            "Linh Trung",
            "Linh Chi·ªÉu",
            "Linh T√¢y",
            "Linh ƒê√¥ng",
            "Linh Xu√¢n",
            "TƒÉng Nh∆°n Ph√∫ A",
            "TƒÉng Nh∆°n Ph√∫ B",
            "Ph∆∞·ªõc Long A",
            "Ph∆∞·ªõc Long B",
            "T√¢n Ph√∫",
            "Ph∆∞·ªõc B√¨nh",
            "Long Th·∫°nh M·ªπ",
            "Tr∆∞·ªùng Th·∫°nh",
            "Long Ph∆∞·ªõc",
            "Long B√¨nh",
            "Ph√∫ H·ªØu"
        ],
        "Qu·∫≠n 10": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15"],
        "Qu·∫≠n 11": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16"],
        "Qu·∫≠n 12": ["An Ph√∫ ƒê√¥ng", "ƒê√¥ng H∆∞ng Thu·∫≠n", "Hi·ªáp Th√†nh", "T√¢n Ch√°nh Hi·ªáp", "T√¢n H∆∞ng Thu·∫≠n", "T√¢n Th·ªõi Hi·ªáp", "T√¢n Th·ªõi Nh·∫•t", "Th·∫°nh L·ªôc", "Th·∫°nh Xu√¢n", "Th·ªõi An", "Trung M·ªπ T√¢y"],
        "B√¨nh T√¢n": ["An L·∫°c", "An L·∫°c A", "B√¨nh H∆∞ng H√≤a", "B√¨nh H∆∞ng H√≤a A", "B√¨nh H∆∞ng H√≤a B", "B√¨nh Tr·ªã ƒê√¥ng", "B√¨nh Tr·ªã ƒê√¥ng A", "B√¨nh Tr·ªã ƒê√¥ng B", "T√¢n T·∫°o", "T√¢n T·∫°o A"],
        "B√¨nh Th·∫°nh": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 17", "Ph∆∞·ªùng 19", "Ph∆∞·ªùng 21", "Ph∆∞·ªùng 22", "Ph∆∞·ªùng 24", "Ph∆∞·ªùng 25", "Ph∆∞·ªùng 26", "Ph∆∞·ªùng 27", "Ph∆∞·ªùng 28"],
        "G√≤ V·∫•p": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16", "Ph∆∞·ªùng 17"],
        "Ph√∫ Nhu·∫≠n": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 17"],
        "T√¢n B√¨nh": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15"],
        "T√¢n Ph√∫": ["Hi·ªáp T√¢n", "H√≤a Th·∫°nh", "Ph√∫ Th·∫°nh", "Ph√∫ Th·ªç H√≤a", "Ph√∫ Trung", "S∆°n K·ª≥", "T√¢n Qu√Ω", "T√¢n S∆°n Nh√¨", "T√¢n Th√†nh", "T√¢n Th·ªõi H√≤a", "T√¢y Th·∫°nh"],
        "Th·ªß ƒê·ª©c": ["An Kh√°nh", "An L·ª£i ƒê√¥ng", "An Ph√∫", "B√¨nh Chi·ªÉu", "B√¨nh Th·ªç", "B√¨nh Tr∆∞ng ƒê√¥ng", "B√¨nh Tr∆∞ng T√¢y", "C√°t L√°i", "Hi·ªáp B√¨nh Ch√°nh", "Hi·ªáp B√¨nh Ph∆∞·ªõc", "Linh Chi·ªÉu", "Linh ƒê√¥ng", "Linh T√¢y", "Linh Trung", "Linh Xu√¢n", "Long B√¨nh", "Long Ph∆∞·ªõc", "Long Th·∫°nh M·ªπ", "Long Tr∆∞·ªùng", "Ph√∫ H·ªØu", "Ph∆∞·ªõc B√¨nh", "Ph∆∞·ªõc Long A", "Ph∆∞·ªõc Long B", "Tam B√¨nh", "Tam Ph√∫", "T√¢n Ph√∫", "TƒÉng Nh∆°n Ph√∫ A", "TƒÉng Nh∆°n Ph√∫ B", "Th·∫£o ƒêi·ªÅn", "Th·∫°nh M·ªπ L·ª£i", "Th·ªß Thi√™m", "Tr∆∞·ªùng Th·∫°nh", "Tr∆∞·ªùng Th·ªç"]
    };

    let CURRENT_USER = null;
    let CURRENT_ROLE = "staff";
    let PAGE = 0;
    let TOTAL_COUNT = 0;
    let LAST_ROWS = [];
    let EDITING_ID = null;
    
    // BI·∫æN M·ªöI CHO ADMIN DUY·ªÜT B√ÄI
    let SHOW_PENDING = false;

    // ===== HELPERS =====
    function toast(msg) {
      const toastEl = document.getElementById("toast");
      const textEl = document.getElementById("toast-text");
      textEl.textContent = msg;
      toastEl.classList.remove("hidden");
      setTimeout(() => toastEl.classList.add("hidden"), 2500);
    }

    function money(v) {
      if (v == null || isNaN(v)) return "";
      return new Intl.NumberFormat("vi-VN").format(v) + " ƒë";
    }

    function formatDateVN(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleDateString("vi-VN");
    }

    function pickField(obj, names) {
      for (const n of names) {
        if (obj && obj[n] !== undefined && obj[n] !== null && obj[n] !== "") {
          return obj[n];
        }
      }
      return null;
    }

    function isAdmin() { return CURRENT_ROLE === "admin"; }
    function isStaff() { return CURRENT_ROLE === "staff"; }

    function maskAddress(row) {
      const full = row.address || "";
      // N·∫æU L√Ä ADMIN TH√å HI·ªÜN H·∫æT
      if (isAdmin()) return full || row.street; 

      if (!isStaff()) return full || [row.street, row.ward, row.district].filter(Boolean).join(", ");

      if (full) {
        const parts = full.split(" ");
        if (parts.length > 1) {
          parts.shift();
          return parts.join(" ");
        }
        return full;
      }
      return [row.street, row.ward, row.district].filter(Boolean).join(", ");
    }

    function buildImageUrl(path) {
      if (!path) return null;
      if (path.startsWith('http')) return path; // H·ªó tr·ª£ link ƒë·∫ßy ƒë·ªß
      const { data } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(path);
      return data?.publicUrl || null;
    }

    function formatCurrencyInput(el) {
        let val = el.value.replace(/\D/g, '');
        if(val) el.value = new Intl.NumberFormat('vi-VN').format(val);
    }

    // ===== AUTH =====
    async function initAuth() {
      const { data } = await supabase.auth.getUser();
      if (!data.user) {
        document.getElementById("auth-section").classList.remove("hidden");
        document.getElementById("app-root").classList.add("hidden");
        return;
      }
      CURRENT_USER = data.user;

      // --- L·∫§Y ROLE T·ª™ B·∫¢NG PROFILES ---
      let role = "staff";
      let userEmail = CURRENT_USER.email;
      const { data: profile } = await supabase
        .from("profiles")
        .select("role, email")
        .eq("id", CURRENT_USER.id)
        .maybeSingle();
      
      if (profile) {
          if (profile.role) role = profile.role;
          if (profile.email) userEmail = profile.email;
      }
      CURRENT_ROLE = role;

      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("app-root").classList.remove("hidden");
      
      // Hi·ªÉn th·ªã t√™n/role
      document.getElementById("user-email-display").textContent = userEmail;
      document.getElementById("role-badge").textContent = (role === "admin" ? "Admin" : "Nh√¢n s·ª±");
      if (isAdmin()) document.getElementById("role-badge").className = "badge badge-error text-white";

      // N√∫t ch·ª©c nƒÉng
      // N·∫øu l√† Admin -> hi·ªán n√∫t duy·ªát b√†i
      if (isAdmin()) {
        document.getElementById("admin-pending-controls").classList.remove("hidden");
        checkPendingCount();
      }

      await applyFilters(true);
      await buildDistrictWardOptions();
      initAddFormDropdowns(); // Kh·ªüi t·∫°o dropdown cho form th√™m m·ªõi
    }

    
    function showDemoNotice() {
      const dlg = document.getElementById("demoNoticeDlg");
      if (dlg && typeof dlg.showModal === "function") {
        dlg.showModal();
      }
    }

    async function handleLogin() {
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value.trim();
      if (!email || !password) {
        toast("Vui l√≤ng nh·∫≠p email & m·∫≠t kh·∫©u");
        return;
      }
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        console.error(error);
        toast("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + error.message);
        return;
      }
      toast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng");
      showDemoNotice();
      await initAuth();
    }

    
    async function handleLogout() {
      await supabase.auth.signOut();
      location.reload();
    }

    // ===== FILTERS =====
    function getFilterValues() {
      return {
        keyword: document.getElementById("filter-keyword").value.trim(),
        district: document.getElementById("filter-district").value,
        ward: document.getElementById("filter-ward").value,
        priceMin: Number(document.getElementById("filter-price-min").value) || null,
        priceMax: Number(document.getElementById("filter-price-max").value) || null,
        areaMin: Number(document.getElementById("filter-area-min").value) || null,
        areaMax: Number(document.getElementById("filter-area-max").value) || null,
        pn: document.getElementById("filter-pn").value,
        wc: document.getElementById("filter-wc").value,
        floors: document.getElementById("filter-floors").value,
        frontageType: document.getElementById("filter-frontage-type").value,
        status: document.getElementById("filter-status").value,
      };
    }

    // --- H√ÄM T·∫¢I D·ªÆ LI·ªÜU CH√çNH (ƒê√£ s·ª≠a l·ªói JOIN) ---
    async function applyFilters(resetPage = false) {
      if (resetPage) PAGE = 0;

      const f = getFilterValues();

      // TH·ª¨ L·∫§Y D·ªÆ LI·ªÜU + JOIN PROFILES (L·∫•y email ng∆∞·ªùi t·∫°o)
      let query = supabase
        .from("premises")
        .select("*, profiles(email)", { count: "exact" });

      // --- LOGIC DUY·ªÜT B√ÄI ---
      if (SHOW_PENDING && isAdmin()) {
          query = query.eq("is_approved", false);
      } else {
          query = query.eq("is_approved", true);
      }

      // --- √ÅP D·ª§NG FILTER ---
      if (f.keyword) {
        const kw = "%" + f.keyword + "%";
        query = query.or(`address.ilike.${kw},street.ilike.${kw},ward.ilike.${kw},district.ilike.${kw},code.ilike.${kw}`);
      }
      if (f.district) query = query.eq("district", f.district);
      if (f.ward) query = query.eq("ward", f.ward);
      if (f.status) query = query.eq("status", f.status);

      if (f.priceMin != null) query = query.gte("price", f.priceMin * 1000000); // Nh√¢n 1tr v√¨ input l√† ƒë∆°n v·ªã tri·ªáu
      if (f.priceMax != null) query = query.lte("price", f.priceMax * 1000000);
      if (f.areaMin != null) query = query.gte("area", f.areaMin);
      if (f.areaMax != null) query = query.lte("area", f.areaMax);

      if (f.pn) {
        if (f.pn.includes(">")) query = query.gt("pn", parseInt(f.pn.replace(">","")));
        else query = query.eq("pn", parseInt(f.pn));
      }
      if (f.wc) {
        if (f.wc.includes(">")) query = query.gt("wc", parseInt(f.wc.replace(">","")));
        else query = query.eq("wc", parseInt(f.wc));
      }
      if (f.floors) {
        if (f.floors.includes(">")) query = query.gt("floors", parseInt(f.floors.replace(">","")));
        else query = query.eq("floors", parseInt(f.floors));
      }
      if (f.frontageType === "mt") {
        query = query.eq("frontage", true);
      }

      const from = PAGE * PAGE_SIZE;
      const to = from + PAGE_SIZE - 1;

      query = query
        .order("updated_at", { ascending: false })
        .order("created_at", { ascending: false })
        .range(from, to);

      let { data, error, count } = await query;

      // --- C∆† CH·∫æ T·ª∞ S·ª¨A L·ªñI (N·∫æU DB CH∆ØA FIX JOIN) ---
      if (error && error.message.includes("profiles")) {
         console.warn("L·ªói l·∫•y t√™n ng∆∞·ªùi ƒëƒÉng (Join Profiles). ƒêang t·∫£i l·∫°i ch·∫ø ƒë·ªô an to√†n...");
         // Th·ª≠ t·∫£i l·∫°i KH√îNG join profiles
         let safeQuery = supabase.from("premises").select("*", { count: "exact" });
         // (L·∫∑p l·∫°i filter logic ng·∫Øn g·ªçn ƒë·ªÉ code ch·∫°y ƒë∆∞·ª£c)
         if (SHOW_PENDING && isAdmin()) safeQuery = safeQuery.eq("is_approved", false);
         else safeQuery = safeQuery.eq("is_approved", true);
         
         safeQuery = safeQuery.order("created_at", { ascending: false }).range(from, to);
         const res = await safeQuery;
         data = res.data;
         error = res.error;
         count = res.count;
      }

      if (error) {
        console.error(error);
        toast("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu: " + error.message);
        return;
      }

      let rows = data || [];

      // Client filter: H·∫ªm / HXH
      if (f.frontageType === "hem" || f.frontageType === "hxh") {
        rows = rows.filter((row) => {
          const isFront = row.frontage === true;
          const txt = ((row.address || "") + " " + (row.detail || "")).toLowerCase();
          if (f.frontageType === "hxh") {
            if (isFront) return false;
            return txt.includes("hxh") || txt.includes("xe h∆°i");
          }
          if (f.frontageType === "hem") {
            if (isFront) return false;
            if (txt.includes("hxh") || txt.includes("h·∫ªm xe h∆°i")) return false;
            return true;
          }
          return true;
        });
      }

      LAST_ROWS = rows;
      TOTAL_COUNT = count || rows.length;

      if (PAGE === 0) {
        renderCards(LAST_ROWS, true);
      } else {
        renderCards(LAST_ROWS, false);
      }

      document.getElementById("count-total").textContent = TOTAL_COUNT;
      document.getElementById("count-show").textContent = Math.min(
        (PAGE + 1) * PAGE_SIZE,
        TOTAL_COUNT
      );

      const btnMore = document.getElementById("btn-load-more");
      if ((PAGE + 1) * PAGE_SIZE >= TOTAL_COUNT) {
        btnMore.textContent = "H·∫øt d·ªØ li·ªáu";
        btnMore.classList.add("btn-disabled");
      } else {
        btnMore.textContent = "T·∫£i th√™m";
        btnMore.classList.remove("btn-disabled");
      }
    }

    function renderCards(rows, replace) {
      const grid = document.getElementById("grid");
      if (replace) grid.innerHTML = "";

      if (!rows || rows.length === 0) {
        if (PAGE === 0) {
          grid.innerHTML =
            `<div class="col-span-full text-center text-sm opacity-70 py-10">
              Ch∆∞a c√≥ m·∫∑t b·∫±ng n√†o kh·ªõp b·ªô l·ªçc hi·ªán t·∫°i.
            </div>`;
        }
        return;
      }

      const html = rows.map((row) => {
        const hasImages = Array.isArray(row.images) && row.images.length > 0;
        const firstPath = hasImages ? row.images[0] : null;
        const imgUrl = firstPath ? buildImageUrl(firstPath) : null;

        const pnVal = pickField(row, ["pn", "so_pn", "bedrooms", "rooms"]);
        const wcVal = pickField(row, ["wc", "bathrooms"]);
        const floorsVal = pickField(row, ["floors"]);
        const updatedLabel = formatDateVN(row.updated_at || row.created_at);
        
        // L·∫•y t√™n ng∆∞·ªùi ƒëƒÉng (n·∫øu c√≥)
        const creatorEmail = row.profiles?.email || "";
        const shortName = creatorEmail.split("@")[0];

        // --- BADGE V·ªä TR√ç (LOGIC M·ªöI) ---
        let locationBadge = "";
        // ∆Øu ti√™n l·∫•y t·ª´ c·ªôt road_type m·ªõi, n·∫øu kh√¥ng c√≥ th√¨ d√πng logic c≈©
        const roadType = row.road_type || (row.frontage ? "M·∫∑t ti·ªÅn" : "H·∫ªm");

        if (roadType === "M·∫∑t ti·ªÅn") {
            locationBadge = `<span class="badge badge-xs badge-error text-white border-none">M·∫∑t ti·ªÅn</span>`;
        } else if (roadType === "H·∫ªm xe h∆°i") {
            locationBadge = `<span class="badge badge-xs badge-info text-white border-none">H·∫ªm xe h∆°i</span>`;
        } else {
            locationBadge = `<span class="badge badge-xs badge-ghost border-none opacity-70">Nh√† h·∫ªm</span>`;
        }

        // Badge Hoa h·ªìng
        const hhBadge = row.commission 
            ? `<span class="badge badge-xs badge-success text-white border-none ml-1">${row.commission}</span>` 
            : '';
                
        // --- N√öT DUY·ªÜT (N·∫æU ADMIN ƒêANG ·ªû CH·∫æ ƒê·ªò PENDING) ---
        let approveBtn = "";
        if (SHOW_PENDING && isAdmin()) {
            approveBtn = `<button onclick="approveOne('${row.id}', event)" class="btn btn-xs btn-success w-full mt-2 text-white">‚úî Duy·ªát ngay</button>`;
        }

        return `
          <article class="card bg-base-100 border border-base-200 shadow-sm hover:shadow-md transition-all cursor-pointer premise-card overflow-hidden" data-id="${row.id}">
            <figure class="h-52 bg-base-200 flex items-center justify-center relative">
              ${
                imgUrl
                  ? `<img src="${imgUrl}" alt="${row.address || ""}" class="w-full h-full object-cover" />`
                  : `<div class="text-xs opacity-60">(Kh√¥ng c√≥ ·∫£nh)</div>`
              }
               <div class="absolute top-2 right-2 shadow-sm">${locationBadge}${isAdmin() ? hhBadge : ''} </div>
               
               <div class="absolute bottom-0 left-0 w-full bg-black/50 text-white text-[10px] p-1 px-2 truncate">
                  ƒêƒÉng b·ªüi: <b>${shortName || '·∫®n danh'}</b>
               </div>
            </figure>
            <div class="card-body p-4 gap-2">
              <h3 class="font-semibold text-sm line-clamp-2">
                ${buildTitle(row)}
              </h3>

              
              <div class="flex items-center flex-wrap gap-2 text-[11px] opacity-70">
                <span>${[row.ward, row.district].filter(Boolean).join(" ‚Ä¢ ")}</span>
              </div>

              <div class="flex flex-wrap items-center gap-2 text-[11px] mt-1">
                ${row.area ? `<span>${row.area} m¬≤</span>` : ""}
                ${row.width && row.length ? `<span>${row.width}√ó${row.length} m</span>` : ""}
                ${pnVal ? `<span>${pnVal} PN</span>` : ""}
                ${wcVal ? `<span>${wcVal} WC</span>` : ""}
                ${floorsVal ? `<span>${floorsVal} t·∫ßng</span>` : ""}
              </div>
              
              <div class="flex items-center justify-between mt-1">
                <div class="text-primary font-extrabold text-lg">${money(row.price)}</div>
                <div class="text-[10px] opacity-60">${updatedLabel}</div>
              </div>
              
              ${approveBtn}
            </div>
          </article>
        `;
      });

      grid.insertAdjacentHTML("beforeend", html.join(""));

      grid.querySelectorAll("[data-id]").forEach((el) => {
        el.onclick = () => openDetail(el.getAttribute("data-id"));
      });
    }

    // === H√ÄM M·ªöI: L·∫§Y QU·∫¨N T·ª™ HCM_DATA ===
    async function buildDistrictWardOptions() {
      // L·∫•y danh s√°ch qu·∫≠n chu·∫©n t·ª´ HCM_DATA (kh√¥ng tr√πng, kh√¥ng qu·∫≠n ·∫£o)
      const selectDistrict = document.getElementById("filter-district");
      const current = selectDistrict.value;

      const districts = Object.keys(HCM_DATA).sort((a, b) =>
        a.localeCompare(b, "vi")
      );

      selectDistrict.innerHTML = '<option value="">T·∫•t c·∫£</option>';
      districts.forEach((d) => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        selectDistrict.appendChild(opt);
      });

      // Gi·ªØ l·∫°i qu·∫≠n ƒëang ch·ªçn n·∫øu c√≤n t·ªìn t·∫°i
      if (current && districts.includes(current)) {
        selectDistrict.value = current;
      }

      updateWardOptions();
    }

    // === H√ÄM M·ªöI: L·ªåC PH∆Ø·ªúNG THEO QU·∫¨N T·ª™ HCM_DATA ===
    function updateWardOptions() {
      const district = document.getElementById("filter-district").value;
      const selectWard = document.getElementById("filter-ward");
      selectWard.innerHTML = '<option value="">T·∫•t c·∫£</option>';

      if (!district || !HCM_DATA[district]) return;

      const wards = HCM_DATA[district];
      wards.forEach((w) => {
        const opt = document.createElement("option");
        opt.value = w;
        opt.textContent = w;
        selectWard.appendChild(opt);
      });
    }
    // ===== C√ÅC H√ÄM H·ªñ TR·ª¢ (UTILS) =====

    function buildTitle(item) {
      if (!item) return "";

      const street = item.street ? item.street.toUpperCase() : "";
      const detail = (item.detail || "").toLowerCase();
      const ket = (item.ket_cau || "").toLowerCase();

      // ==== 1. X√ÅC ƒê·ªäNH LO·∫†I H√åNH (MB / NNC) ====
      let type = "NNC"; // m·∫∑c ƒë·ªãnh NNC

      // M·∫∂T B·∫∞NG n·∫øu b√†i c√≥ MB / LDC / LDR trong m√¥ t·∫£
      if (
        detail.includes(" mb") || detail.startsWith("mb ") || detail.includes("mb ") ||
        detail.includes("ldc") ||
        detail.includes("ldr")
      ) {
        type = "MB";
      }

      // N·∫øu kh√¥ng c√≥ MB nh∆∞ng c√≥ k·∫øt c·∫•u nh√† ‚Üí NNC
      if (
        ket.includes("tr·ªát") || ket.includes("tret") ||
        ket.includes("l·∫ßu")  || ket.includes("lau") ||
        ket.includes("l·ª≠ng") || ket.includes("lung") ||
        ket.includes("tum")  ||
        ket.includes("pn")   ||
        ket.includes("wc")
      ) {
        type = "NNC";
      }

      // ==== 2. H∆Ø·ªöNG (MT / HXH / HEM) ====
      let huong = "HEM";
      const addr = (item.address || "").toLowerCase();

      if (item.frontage) huong = "MT";
      else if (addr.includes("/")) huong = "HXH";
      else if (detail.includes("hxh")) huong = "HXH";

      // ==== 3. PN / WC ====
      const pn = item.pn ? `${item.pn}PN` : "";
      const wc = item.wc ? `${item.wc}WC` : "";

      // ==== 4. DI·ªÜN T√çCH ====
      let dientich = "";
      if (item.width && item.length) {
        dientich = `${item.width}X${item.length}`;
      } else if (item.area) {
        dientich = `${item.area}M2`;
      }

      // ==== 5. K·∫æT C·∫§U ====
      const ketcau = item.ket_cau ? item.ket_cau.toUpperCase() : "";

      // ==== 6. QU·∫¨N ====
      let quan = "";
      if (item.district) {
        const q = item.district.replace("Q.", "").replace("Qu·∫≠n", "").trim();
        quan = `QU·∫¨N ${q}`;
      }

      // ==== GH√âP TI√äU ƒê·ªÄ ====
      const parts = [
        type,
        huong,
        street,
        pn,
        wc,
        dientich,
        ketcau,
        quan
      ].filter(p => p);

      return parts.join(" - ").toUpperCase();
    }

    // ===== CHI TI·∫æT & S·ª¨A =====
    async function openDetail(id) {
      const dlg = document.getElementById("detailDlg");
      const wrap = document.getElementById("detail-content");
      wrap.innerHTML = `<div class="py-10 text-center text-sm opacity-70">ƒêang t·∫£i...</div>`;
      dlg.showModal();

      const { data, error } = await supabase
        .from("premises")
        .select("*")
        .eq("id", id)
        .single();

      if (error || !data) {
        console.error(error);
        wrap.innerHTML = `<div class="py-10 text-center text-sm text-error">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu.</div>`;
        return;
      }

      const item = data;

      // ===== L·∫§Y TH√îNG TIN C∆† B·∫¢N =====
      const pnVal = pickField(item, ["pn", "so_pn", "bedrooms", "rooms"]);
      const wcVal = pickField(item, ["wc", "bathrooms"]);
      const floorsVal = pickField(item, ["floors"]);
      const detailText =
        pickField(item, [
          "detail",
          "thong_tin_chi_tiet",
          "chi_tiet",
          "description",
          "info_detail",
        ]) || "";

      const updatedLabel = formatDateVN(item.updated_at || item.created_at);
      const price =
        typeof item.price === "number"
          ? new Intl.NumberFormat("vi-VN").format(item.price) + " ƒë/th√°ng"
          : "";
      const area =
        typeof item.area === "number" ? item.area + " m¬≤" : "";
      const address =
        item.address ||
        [item.street, item.ward, item.district, item.city]
          .filter(Boolean)
          .join(", ");

      // ===== X·ª¨ L√ù H√åNH ·∫¢NH: ARRAY / JSON / CHU·ªñI NGƒÇN C√ÅCH ; , \n =====
      let rawImgs = item.images;
      let imgPaths = [];

      if (Array.isArray(rawImgs)) {
        imgPaths = rawImgs;
      } else if (typeof rawImgs === "string" && rawImgs.trim()) {
        const s = rawImgs.trim();
        try {
          if (s.startsWith("[") && s.endsWith("]")) {
            const parsed = JSON.parse(s);
            if (Array.isArray(parsed)) imgPaths = parsed;
          } else {
            imgPaths = s.split(/[\n;,]+/);
          }
        } catch (e) {
          console.warn("parse images error", e);
          imgPaths = s.split(/[\n;,]+/);
        }
      }

      // l√†m s·∫°ch path + log ra ƒë·ªÉ debug
      imgPaths = (imgPaths || [])
        .map((p) => (p || "").trim())
        .filter(Boolean);

      const imgUrls = imgPaths
        .map((p) => buildImageUrl(p))
        .filter(Boolean);

      console.log("IMAGES for", item.code || item.id, { imgPaths, imgUrls });


      // ===== MAP EMBED =====
      const mapsQuery = encodeURIComponent(
        [item.address, item.ward, item.district, item.city]
          .filter(Boolean)
          .join(", ")
      );
      const mapEmbed = `
        <iframe
          class="w-full h-64 border-0 rounded-xl"
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"
          src="https://www.google.com/maps?q=${mapsQuery}&output=embed">
        </iframe>
      `;

      // ===== ACTION BUTTONS =====
      const actions = `
        <div class="join join-horizontal flex flex-wrap gap-2">
          ${
            item.contact_phone && !isStaff()
              ? `<a class="btn btn-sm join-item" href="tel:${item.contact_phone}">G·ªçi</a>`
              : ""
          }
          ${
            item.contact_phone && !isStaff()
              ? `<a class="btn btn-sm join-item" target="_blank"
                     href="https://zalo.me/${(item.contact_phone || "")
                       .replace(/[^0-9]/g, "")}">
                    Zalo
                 </a>`
              : ""
          }
          <a class="btn btn-sm join-item" target="_blank"
             href="https://www.google.com/maps/search/?api=1&query=${mapsQuery}">
            M·ªü Map
          </a>
          <button
            class="btn btn-sm join-item"
            onclick="navigator.clipboard.writeText(window.location.origin + window.location.pathname + '?id=${encodeURIComponent(
              id
            )}');toast('ƒê√£ copy link')">
            Copy link
          </button>
          ${
            isAdmin()
              ? `<button class="btn btn-outline btn-sm join-item"
                         onclick="openEditPremise('${id}')">
                   S·ª≠a
                 </button>`
              : ""
          }
        </div>
      `;

      // ===== HTML HI·ªÇN TH·ªä CHI TI·∫æT + GALLERY =====
      const html = `
        <div class="relative">
          <button
            type="button"
            onclick="document.getElementById('detailDlg').close()"
            class="absolute top-3 right-3 z-50 w-9 h-9 flex items-center justify-center
                   bg-white rounded-full shadow hover:bg-gray-200 transition"
          >
            ‚úï
          </button>


          <div class="grid md:grid-cols-2 gap-6">

          <!-- C·ªòT H√åNH ·∫¢NH -->
          <div class="space-y-3">
            <div class="w-full h-[340px] bg-base-200 flex items-center justify-center rounded-xl overflow-hidden">
              ${
                imgUrls.length
                  ? `<img id="detail-main-img" src="${imgUrls[0]}" class="w-full h-full object-cover" />`
                  : `<div class="text-xs text-gray-500 italic">Ch∆∞a c√≥ h√¨nh ·∫£nh</div>`
              }
            </div>

            ${
              imgUrls.length > 1
                ? `
                  <div class="grid grid-cols-4 gap-2">
                    ${imgUrls
                      .slice(0, 8)
                      .map(
                        (url) => `
                      <div
                        class="cursor-pointer border border-base-200 rounded-lg overflow-hidden hover:border-primary"
                        onclick="(function(){
                          const m = document.getElementById('detail-main-img');
                          if (m) m.src='${url.replace(/'/g, "\\'")}';
                        })()">
                        <img src="${url}" class="w-full h-16 object-cover" />
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                `
                : ""
            }

            ${mapEmbed}
          </div>

          <!-- C·ªòT TH√îNG TIN -->
          <div class="space-y-3 text-sm">
            <div>
              <h3 class="font-semibold text-lg mb-1">
                ${buildTitle(item) || "(Kh√¥ng c√≥ ti√™u ƒë·ªÅ)"}
              </h3>
              <p class="text-gray-600">${address || ""}</p>
            </div>


            <div class="flex flex-wrap gap-2 text-xs">
              ${
                price
                  ? `<span class="badge badge-primary badge-outline">Gi√°: ${price}</span>`
                  : ""
              }
              ${
                area
                  ? `<span class="badge badge-outline">Di·ªán t√≠ch: ${area}</span>`
                  : ""
              }
              ${
                floorsVal
                  ? `<span class="badge badge-outline">T·∫ßng: ${floorsVal}</span>`
                  : ""
              }
              ${
                pnVal
                  ? `<span class="badge badge-outline">PN: ${pnVal}</span>`
                  : ""
              }
              ${
                wcVal
                  ? `<span class="badge badge-outline">WC: ${wcVal}</span>`
                  : ""
              }
              ${
                item.status
                  ? `<span class="badge badge-outline">Tr·∫°ng th√°i: ${item.status}</span>`
                  : ""
              }
            </div>

            <div class="text-xs text-gray-500">
              ${
                item.code
                  ? `M√£: <span class="font-mono">${item.code}</span><br/>`
                  : ""
              }
              ${updatedLabel ? `C·∫≠p nh·∫≠t: ${updatedLabel}` : ""}
            </div>

            <div class="grid grid-cols-2 gap-2 text-sm mt-2">
              <div>Di·ªán t√≠ch: <b>${item.area ?? '-'} m¬≤</b></div>
              <div>T·∫ßng: <b>${floorsVal ?? '-'}</b></div>

              <div>Ngang: <b>${item.width ?? '-'} m</b></div>
              <div>D√†i: <b>${item.length ?? '-'} m</b></div>

              <div>PN: <b>${pnVal ?? '-'}</b></div>
              <div>WC: <b>${wcVal ?? '-'}</b></div>

              <div>K·∫øt c·∫•u: <b>${item.ket_cau || '-'}</b></div>
              <div>Hoa h·ªìng: <b>${item.commission_note || '-'}</b></div>

              <div>H∆∞·ªõng: <b>${item.frontage ? 'M·∫∑t ti·ªÅn' : 'H·∫ªm'}</b></div>
            </div>

            ${
              item.contact_phone && !isStaff()
                ? `
                <div class="mt-2 text-sm">
                  Li√™n h·ªá: ${
                    item.contact_name
                      ? `<b>${item.contact_name}</b> - `
                      : ""
                  }${item.contact_phone}
                </div>
              `
                : ""
            }

            <div class="mt-4">
              <div class="font-semibold mb-1">Chi ti·∫øt:</div>
              <p class="whitespace-pre-line text-gray-700">
                ${detailText || "(Ch∆∞a c√≥ m√¥ t·∫£ chi ti·∫øt)"}
              </p>
            </div>

            <div class="mt-4">
              ${actions}
            </div>
          </div>
        </div>
        </div>
      `;

      wrap.innerHTML = html;
    }

    async function openEditPremise(id) {
      if (!isAdmin()) {
        toast("Ch·ªâ admin m·ªõi ƒë∆∞·ª£c s·ª≠a m·∫∑t b·∫±ng");
        return;
      }

      EDITING_ID = id;
      const dlg = document.getElementById("editDlg");

      const { data, error } = await supabase
        .from("premises")
        .select("*")
        .eq("id", id)
        .single();

      if (error || !data) {
        console.error(error);
        toast("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu ƒë·ªÉ s·ª≠a");
        return;
      }

      const item = data;
      const setVal = (elId, val) => {
        const el = document.getElementById(elId);
        if (el) el.value = val == null ? "" : String(val);
      };
      setVal("edit-road-type", item.road_type || (item.frontage ? "M·∫∑t ti·ªÅn" : "H·∫ªm"));
      setVal("edit-commission-text", item.commission || "");

      // ƒëi·ªÅn d·ªØ li·ªáu v√†o form edit
      setVal("edit-code", item.code || "");
      setVal("edit-address", item.address || "");
      setVal("edit-city", item.city || "TP.HCM");
      setVal("edit-district", item.district || "");
      setVal("edit-ward", item.ward || "");
      setVal("edit-street", item.street || "");

      setVal("edit-price", item.price ?? "");
      setVal("edit-area", item.area ?? "");
      setVal("edit-width", item.width ?? "");
      setVal("edit-length", item.length ?? "");
      setVal("edit-floors", item.floors ?? "");
      setVal("edit-bedrooms", item.pn ?? item.bedrooms ?? "");
      setVal("edit-wc", item.wc ?? "");
      setVal("edit-ket-cau", item.ket_cau || "");
      setVal("edit-contact-phone", item.contact_phone || "");
      setVal("edit-commission", item.commission_note || "");
      setVal("edit-detail", item.detail || "");

      const statusSelect = document.getElementById("edit-status");
      if (statusSelect) {
        statusSelect.value = item.status || "available";
      }

      const frontageCheckbox = document.getElementById("edit-frontage");
      if (frontageCheckbox) {
        frontageCheckbox.checked = !!item.frontage;
      }

      // x·ª≠ l√Ω field images: array / json / string
      let rawImgs = item.images;
      let imgPaths = [];

      if (Array.isArray(rawImgs)) {
        imgPaths = rawImgs;
      } else if (typeof rawImgs === "string" && rawImgs.trim()) {
        const s = rawImgs.trim();
        try {
          if (s.startsWith("[") && s.endsWith("]")) {
            const parsed = JSON.parse(s);
            if (Array.isArray(parsed)) imgPaths = parsed;
          } else {
            imgPaths = s.split(/[\n;,]+/);
          }
        } catch (e) {
          console.warn("parse images error in edit", e);
          imgPaths = s.split(/[\n;,]+/);
        }
      }

      const imagesTextarea = document.getElementById("edit-images");
      if (imagesTextarea) {
        imagesTextarea.value = (imgPaths || [])
          .map((p) => (p || "").trim())
          .filter(Boolean)
          .join("\n");
      }

      dlg.showModal();
    }
    
    async function saveEditPremise() {
      if (!isAdmin() || !EDITING_ID) return;
      const getVal = (id) => document.getElementById(id).value.trim();
      const getNum = (id) => { const v = getVal(id).replace(/[^\d.]/g, ""); return v ? Number(v) : 0; };

      const payload = {
        code: getVal("edit-code"),
        address: getVal("edit-address"),
        city: getVal("edit-city"),
        district: getVal("edit-district"),
        ward: getVal("edit-ward"),
        street: getVal("edit-street"),
        price: getNum("edit-price"),
        area: getNum("edit-area"),
        width: getNum("edit-width"),
        length: getNum("edit-length"),
        floors: getNum("edit-floors"),
        pn: getNum("edit-bedrooms"),
        wc: getNum("edit-wc"),
        ket_cau: getVal("edit-ket-cau"),
        contact_phone: getVal("edit-contact-phone"),
        frontage: document.getElementById("edit-frontage").checked,
        status: getVal("edit-status"),
        commission_note: getVal("edit-commission"),
        images: getVal("edit-images").split("\n").map(s => s.trim()).filter(Boolean),
        detail: getVal("edit-detail"),
        updated_at: new Date().toISOString(),
        road_type: document.getElementById("edit-road-type").value, // M·ªöI
        commission: getVal("edit-commission-text"), // M·ªöI
      };

      const { error } = await supabase.from("premises").update(payload).eq("id", EDITING_ID);
      if (error) { toast("L·ªói: " + error.message); return; }
      toast("ƒê√£ l∆∞u thay ƒë·ªïi!");
      document.getElementById("editDlg").close();
      await applyFilters(false);
    }

    // ===== LOGIC TH√äM M·ªöI (M·ªöI) =====
    function initAddFormDropdowns() {
        const distSelect = document.getElementById("add-district");
        const wardSelect = document.getElementById("add-ward");
        
        // Load Districts
        const dists = Object.keys(HCM_DATA).sort();
        distSelect.innerHTML = `<option value="">-- Ch·ªçn --</option>` + dists.map(d => `<option value="${d}">${d}</option>`).join("");
        
        // Event Change
        distSelect.addEventListener("change", () => {
            const val = distSelect.value;
            wardSelect.innerHTML = `<option value="">-- Ch·ªçn --</option>`;
            if(HCM_DATA[val]) {
                wardSelect.disabled = false;
                wardSelect.innerHTML += HCM_DATA[val].map(w => `<option value="${w}">${w}</option>`).join("");
            } else {
                wardSelect.disabled = true;
            }
        });
    }

    async function saveNewPremise() {
        const getVal = (id) => document.getElementById(id).value.trim();
        // L·∫•y gi√° ti·ªÅn t·ª´ input ƒë√£ format (x√≥a d·∫•u ch·∫•m/ph·∫©y ƒëi)
        const priceRaw = getVal("add-price").replace(/\D/g,'');
        const priceNum = priceRaw ? parseInt(priceRaw) : 0;

        if (!getVal("add-address") || !getVal("add-district") || !priceNum) {
            toast("Vui l√≤ng nh·∫≠p: ƒê·ªãa ch·ªâ, Qu·∫≠n v√† Gi√° thu√™!");
            return;
        }

        const payload = {
            address: getVal("add-address"),
            district: document.getElementById("add-district").value,
            ward: document.getElementById("add-ward").value,
            street: getVal("add-street"),
            price: priceNum,
            area: Number(getVal("add-area")) || null,
            width: Number(getVal("add-width")) || null,
            length: Number(getVal("add-length")) || null,
            floors: Number(getVal("add-floors")) || null,
            pn: Number(getVal("add-bedrooms")) || null,
            wc: Number(getVal("add-wc")) || null,
            ket_cau: getVal("add-ket-cau"),
            contact_phone: getVal("add-contact-phone"),
            frontage: document.getElementById("add-frontage").checked,
            images: getVal("add-images").split('\n').map(s=>s.trim()).filter(Boolean),
            detail: getVal("add-detail"),
            status: 'available',
            road_type: document.getElementById("add-road-type").value, // M·ªöI
              commission: getVal("add-commission"),
            // code, created_by, is_approved S·∫º ƒê∆Ø·ª¢C DB T·ª∞ ƒê·ªòNG X·ª¨ L√ù (N·∫æU ƒê√É CH·∫†Y SQL)
        };

        const { error } = await supabase.from("premises").insert([payload]);
        if (error) {
            toast("L·ªói: " + error.message);
        } else {
            toast(isAdmin() ? "ƒê√£ th√™m th√†nh c√¥ng!" : "ƒê√£ g·ª≠i duy·ªát!");
            document.getElementById("addDlg").close();
            applyFilters(true);
            if(isAdmin()) checkPendingCount();
        }
    }

    // ===== LOGIC ADMIN PENDING (M·ªöI) =====
    async function checkPendingCount() {
        const { count } = await supabase.from("premises").select("*", { count: 'exact', head: true }).eq("is_approved", false);
        const cnt = count || 0;
        document.getElementById("count-pending").textContent = cnt;
        if (cnt > 0 && SHOW_PENDING) document.getElementById("btn-approve-all").classList.remove("hidden");
        else document.getElementById("btn-approve-all").classList.add("hidden");
    }

    function togglePendingMode() {
        SHOW_PENDING = !SHOW_PENDING;
        const btn = document.getElementById("btn-toggle-pending");
        if (SHOW_PENDING) {
            btn.classList.replace("btn-warning", "btn-active");
            btn.textContent = "ƒêang xem Ch·ªù duy·ªát (Tho√°t)";
        } else {
            btn.classList.replace("btn-active", "btn-warning");
            btn.innerHTML = `C·∫ßn duy·ªát <span class="badge badge-sm bg-white text-warning ml-1 border-none" id="count-pending">...</span>`;
            checkPendingCount();
        }
        applyFilters(true);
    }

    async function approveOne(id, e) {
        e.stopPropagation();
        if(!confirm("Duy·ªát b√†i n√†y?")) return;
        await supabase.from("premises").update({ is_approved: true }).eq("id", id);
        toast("ƒê√£ duy·ªát!");
        applyFilters(true);
        checkPendingCount();
    }

    async function approveAll() {
        if(!confirm("Duy·ªát t·∫•t c·∫£ b√†i ƒëang ch·ªù?")) return;
        await supabase.from("premises").update({ is_approved: true }).eq("is_approved", false);
        toast("ƒê√£ duy·ªát t·∫•t c·∫£!");
        applyFilters(true);
        checkPendingCount();
    }

    // ===== INIT EVENTS =====
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btn-login").addEventListener("click", handleLogin);
      document.getElementById("btn-logout").addEventListener("click", handleLogout);
      
      document.getElementById("btn-apply").addEventListener("click", () => applyFilters(true));
      document.getElementById("btn-reset").addEventListener("click", () => {
         document.querySelectorAll("aside input, aside select").forEach(el => el.value = "");
         applyFilters(true);
      });

      document.getElementById("btn-load-more").addEventListener("click", () => {
          PAGE++; applyFilters(false);
      });

      // Admin / Add Events
      document.getElementById("btn-open-add").onclick = () => document.getElementById("addDlg").showModal();
      document.getElementById("btn-toggle-pending").onclick = togglePendingMode;
      document.getElementById("btn-approve-all").onclick = approveAll;

      // Quick filters
      document.querySelectorAll("[data-quick]").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.getElementById("filter-status").value = btn.getAttribute("data-quick");
          applyFilters(true);
        });
      });
      document.querySelectorAll("[data-quick-district]").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.getElementById("filter-district").value = btn.getAttribute("data-quick-district");
          updateWardOptions(); applyFilters(true);
        });
      });
      document.getElementById("btn-clear-quick").addEventListener("click", () => {
          document.getElementById("filter-status").value = "";
          document.getElementById("filter-district").value = "";
          document.getElementById("filter-ward").value = "";
          applyFilters(true);
      });

      // ===== DEMO NOTICE BUTTONS =====
      const demoAgreeBtn = document.getElementById("btn-demo-agree");
      const demoDisagreeBtn = document.getElementById("btn-demo-disagree");
      const demoDlg = document.getElementById("demoNoticeDlg");

      if (demoAgreeBtn && demoDlg) {
        demoAgreeBtn.addEventListener("click", () => {
          demoDlg.close();
        });
      }

      if (demoDisagreeBtn && demoDlg) {
        demoDisagreeBtn.addEventListener("click", async () => {
          demoDlg.close();
          await supabase.auth.signOut();
          location.reload();
        });
      }

      initAuth();
    });
    // === BI·∫æN TO√ÄN C·ª§C L∆ØU FILE CH·ªú UPLOAD ===
    let FILES_BUFFER = []; 

    // --- 1. H√ÄM SINH M√É MB T·ª∞ ƒê·ªòNG (D·ª±a tr√™n th·ªùi gian th·ª±c -> Lu√¥n duy nh·∫•t) ---
    function generatePremiseCode() {
        // L·∫•y 6 s·ªë cu·ªëi c·ªßa timestamp (th·ªùi gian hi·ªán t·∫°i)
        // V√≠ d·ª•: MB-839201
        const suffix = Date.now().toString().slice(-6); 
        return `MB-${suffix}`;
    }

    // --- 2. C√ÅC H√ÄM X·ª¨ L√ù GIAO DI·ªÜN ·∫¢NH (GI·ªÆ NGUY√äN) ---
    function handleSelectFiles(input) {
        if (!input.files || input.files.length === 0) return;
        const newFiles = Array.from(input.files);
        FILES_BUFFER = [...FILES_BUFFER, ...newFiles];
        input.value = '';
        renderPreview();
    }

    function renderPreview() {
        const container = document.getElementById("preview-container");
        container.innerHTML = ""; 
        if (FILES_BUFFER.length === 0) {
            container.innerHTML = `<p class="text-xs text-gray-500 w-full text-center py-8 pointer-events-none">Ch∆∞a c√≥ ·∫£nh n√†o.<br/>·∫¢nh ƒë·∫ßu ti√™n s·∫Ω l√† <b>·∫¢nh B√¨a</b>.</p>`;
            return;
        }
        FILES_BUFFER.forEach((file, index) => {
            const url = URL.createObjectURL(file);
            const div = document.createElement("div");
            div.className = `relative w-24 h-24 rounded-lg overflow-hidden border-2 cursor-pointer transition-all group ${index === 0 ? 'border-primary ring-2 ring-primary ring-offset-1' : 'border-gray-300 hover:border-primary'}`;
            div.title = index === 0 ? "·∫¢nh b√¨a hi·ªán t·∫°i" : "Click ƒë·ªÉ ƒë·∫∑t l√†m ·∫£nh b√¨a";
            div.onclick = () => makeCover(index);

            const img = document.createElement("img");
            img.src = url;
            img.className = "w-full h-full object-cover";
            
            const btnRemove = document.createElement("button");
            btnRemove.innerHTML = "‚úï";
            btnRemove.className = "absolute top-0 right-0 bg-red-500 text-white w-5 h-5 text-[10px] flex items-center justify-center rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity";
            btnRemove.onclick = (e) => { e.stopPropagation(); removeFile(index); };

            if (index === 0) {
                const badge = document.createElement("div");
                badge.innerText = "B√¨a";
                badge.className = "absolute bottom-0 left-0 right-0 bg-primary text-white text-[10px] text-center font-bold py-0.5";
                div.appendChild(badge);
            }
            div.appendChild(img); div.appendChild(btnRemove); container.appendChild(div);
        });
    }

    function makeCover(index) {
        if (index === 0) return;
        const item = FILES_BUFFER.splice(index, 1)[0];
        FILES_BUFFER.unshift(item);
        renderPreview();
    }

    function removeFile(index) {
        FILES_BUFFER.splice(index, 1);
        renderPreview();
    }

    // --- 3. H√ÄM UPLOAD (C·∫¨P NH·∫¨T: NH·∫¨N THAM S·ªê FOLDER NAME) ---
    async function uploadFilesToSupabase(folderName) {
        if (FILES_BUFFER.length === 0) return [];
        
        const uploadedPaths = [];
        // Kh√¥ng c·∫ßn timestamp ·ªü t√™n file n·ªØa v√¨ ƒë√£ c√≥ folder ri√™ng, nh∆∞ng v·∫´n th√™m random cho ch·∫Øc
        
        toast(`ƒêang t·∫£i ${FILES_BUFFER.length} ·∫£nh l√™n folder ${folderName}...`);

        for (let i = 0; i < FILES_BUFFER.length; i++) {
            const file = FILES_BUFFER[i];
            
            // L√†m s·∫°ch t√™n file (b·ªè d·∫•u ti·∫øng vi·ªát, k√Ω t·ª± l·∫°)
            const cleanName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
            
            // C·∫•u tr√∫c path: T√äN_FOLDER/T√äN_FILE
            // V√≠ d·ª•: MB-123456/hinh_nha_1.jpg
            const filePath = `${folderName}/${cleanName}`;
            
            const { data, error } = await supabase.storage
                .from(STORAGE_BUCKET)
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: false
                });

            if (error) {
                console.error("L·ªói upload:", file.name, error);
                continue; 
            }
            if (data) uploadedPaths.push(data.path);
        }
        return uploadedPaths;
    }

    // --- 4. H√ÄM L∆ØU TIN (C·∫¨P NH·∫¨T: SINH M√É TR∆Ø·ªöC KHI UPLOAD) ---
    async function saveNewPremiseWithUpload() {
        const btn = document.getElementById("btn-save-new");
        const getVal = (id) => document.getElementById(id).value.trim();
        const priceRaw = getVal("add-price").replace(/\D/g,'');
        const priceNum = priceRaw ? parseInt(priceRaw) : 0;

        if (!getVal("add-address") || !getVal("add-district") || !priceNum) {
            toast("Vui l√≤ng nh·∫≠p: ƒê·ªãa ch·ªâ, Qu·∫≠n v√† Gi√° thu√™!");
            return;
        }

        btn.disabled = true;
        btn.innerHTML = `<span class="loading loading-spinner"></span> ƒêang x·ª≠ l√Ω...`;

        try {
            // B∆Ø·ªöC 1: SINH M√É MB TR∆Ø·ªöC (ƒê·ªÉ d√πng l√†m t√™n folder)
            // B·∫°n c√≥ th·ªÉ ƒë·ªïi logic sinh m√£ ·ªü h√†m generatePremiseCode()
            const newCode = generatePremiseCode(); 

            // B∆Ø·ªöC 2: UPLOAD ·∫¢NH V√ÄO FOLDER C√ì T√äN L√Ä M√É MB
            const imagePaths = await uploadFilesToSupabase(newCode);

            // B∆Ø·ªöC 3: CHU·∫®N B·ªä DATA (ƒê√É C√ì CODE V√Ä ·∫¢NH)
            const rType = document.getElementById("add-road-type").value;
            const isFrontage = rType === "M·∫∑t ti·ªÅn";

            const payload = {
                code: newCode, // <-- L∆ØU M√É V·ª™A T·∫†O V√ÄO DB LU√îN
                
                address: getVal("add-address"),
                district: document.getElementById("add-district").value,
                ward: document.getElementById("add-ward").value,
                street: getVal("add-street"),
                price: priceNum,
                area: Number(getVal("add-area")) || null,
                width: Number(getVal("add-width")) || null,
                length: Number(getVal("add-length")) || null,
                floors: Number(getVal("add-floors")) || null,
                pn: Number(getVal("add-bedrooms")) || null,
                wc: Number(getVal("add-wc")) || null,
                ket_cau: getVal("add-ket-cau"),
                contact_phone: getVal("add-contact-phone"),
                
                road_type: rType,
                commission: getVal("add-commission"),
                frontage: isFrontage,

                images: imagePaths, // M·∫£ng ƒë∆∞·ªùng d·∫´n ·∫£nh (VD: ["MB-123/a.jpg", "MB-123/b.jpg"])
                
                detail: getVal("add-detail"),
                status: 'available',
                created_at: new Date().toISOString() // Th√™m c√°i n√†y cho ch·∫Øc
            };

            // B∆Ø·ªöC 4: L∆ØU V√ÄO DB
            const { error } = await supabase.from("premises").insert([payload]);

            if (error) throw error;

            toast(isAdmin() ? `ƒê√£ th√™m th√†nh c√¥ng! M√£: ${newCode}` : "ƒê√£ g·ª≠i duy·ªát!");
            
            // Reset form
            document.getElementById("addDlg").close();
            FILES_BUFFER = []; 
            renderPreview();
            applyFilters(true);
            if(isAdmin()) checkPendingCount();

        } catch (err) {
            console.error(err);
            toast("L·ªói: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = "L∆∞u tin";
        }
    }
  </script>
</body>
</html>
