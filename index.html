<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>ID-Land Premises</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>

  <style>
    .modal { display: none; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <!-- ================= NAVBAR ================= -->
  <nav class="navbar bg-base-100 shadow-sm px-4">
    <div class="flex-1 flex items-center gap-2">
      <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold">
        ID
      </div>
      <div>
        <div class="font-bold text-lg leading-tight">ID-Land Premises</div>
        <div class="text-xs text-gray-500">Kho mặt bằng cho thuê • TP.HCM</div>
      </div>
    </div>

    <div class="flex-none flex items-center gap-3">
      <span id="roleLabel" class="text-sm text-gray-600"></span>
      <button id="btnAdd" class="btn btn-sm btn-primary hidden">+ Thêm mặt bằng</button>
      <button id="btnLogout" class="btn btn-sm btn-outline hidden" onclick="logout()">Đăng xuất</button>
    </div>
  </nav>

  <!-- ================= MAIN ================= -->
  <main class="max-w-6xl mx-auto mt-5 mb-10 px-2 lg:px-0">
    <!-- Thanh nút trên -->
    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <div class="text-xl font-bold">
        Bộ lọc mặt bằng cho thuê <span class="text-blue-600">ID-Land</span>
      </div>
      <div class="flex flex-wrap gap-2 text-sm">
        <button class="btn btn-xs btn-outline" onclick="changeStatusFilter('available')">Còn trống</button>
        <button class="btn btn-xs btn-outline" onclick="changeStatusFilter('deposited')">Giữ cọc</button>
        <button class="btn btn-xs btn-outline" onclick="changeStatusFilter('rented')">Đã thuê</button>
        <button class="btn btn-xs" onclick="changeStatusFilter('all')">Tất cả</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-[280px_minmax(0,1fr)] gap-4">
      <!-- ========== SIDEBAR BỘ LỌC ========== -->
      <aside class="bg-white rounded-xl shadow p-4 space-y-4">
        <div class="font-bold text-lg mb-2 flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
          Bộ lọc
        </div>

        <!-- Từ khóa -->
        <div class="form-control">
          <label class="label"><span class="label-text text-xs font-semibold">TỪ KHÓA</span></label>
          <input id="filterKeyword" type="text" placeholder="VD: Trần Hưng Đạo, Q5..."
                 class="input input-sm input-bordered w-full"
                 oninput="applyFilters()" />
        </div>

        <!-- Quận -->
        <div class="form-control">
          <label class="label"><span class="label-text text-xs font-semibold">QUẬN</span></label>
          <select id="filterDistrict" class="select select-sm select-bordered w-full" onchange="onDistrictChange()">
            <option value="">Tất cả</option>
          </select>
        </div>

        <!-- Phường -->
        <div class="form-control">
          <label class="label"><span class="label-text text-xs font-semibold">PHƯỜNG</span></label>
          <select id="filterWard" class="select select-sm select-bordered w-full" onchange="applyFilters()">
            <option value="">Tất cả</option>
          </select>
        </div>

        <!-- Số PN -->
        <div class="form-control">
          <label class="label"><span class="label-text text-xs font-semibold">SỐ PN</span></label>
          <select id="filterPN" class="select select-sm select-bordered w-full" onchange="applyFilters()">
            <option value="">Tất cả</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
            <option>&gt;10</option>
          </select>
        </div>

        <!-- Số tầng -->
        <div class="form-control">
          <label class="label"><span class="label-text text-xs font-semibold">SỐ TẦNG</span></label>
          <select id="filterFloors" class="select select-sm select-bordered w-full" onchange="applyFilters()">
            <option value="">Tất cả</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
            <option>&gt;10</option>
          </select>
        </div>

        <!-- Số WC -->
        <div class="form-control">
          <label class="label"><span class="label-text text-xs font-semibold">SỐ WC</span></label>
          <select id="filterWC" class="select select-sm select-bordered w-full" onchange="applyFilters()">
            <option value="">Tất cả</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
            <option>&gt;10</option>
          </select>
        </div>

        <!-- Mặt tiền -->
        <div class="form-control">
          <label class="label"><span class="label-text text-xs font-semibold">MẶT TIỀN</span></label>
          <select id="filterFrontage" class="select select-sm select-bordered w-full" onchange="applyFilters()">
            <option value="">Tất cả</option>
            <option value="hem">Hẻm</option>
            <option value="hem_xh">Hẻm xe hơi</option>
            <option value="mt">Mặt tiền</option>
          </select>
        </div>

        <button class="btn btn-sm btn-outline mt-2 w-full" onclick="resetFilters()">Xóa lọc</button>
      </aside>

      <!-- ========== DANH SÁCH MẶT BẰNG ========== -->
      <section>
        <div class="flex justify-between items-center mb-3 text-sm text-gray-600">
          <div>Hiển thị <span id="countShowing">0</span> / <span id="countTotal">0</span> mặt bằng</div>
          <div class="text-xs text-right text-gray-400">
            Sắp xếp: mặt bằng cập nhật gần nhất hiển thị trước
          </div>
        </div>

        <div id="grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Cards render bằng JS -->
        </div>
      </section>
    </div>
  </main>

  <!-- ================= MODAL CHỌN VAI TRÒ ================= -->
  <div id="roleModal"
       class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-[1000]">
    <div class="bg-white rounded-xl shadow-xl p-6 w-[95%] max-w-md">
      <h2 class="text-xl font-bold mb-2">Chọn vai trò sử dụng</h2>
      <p class="text-sm text-gray-600 mb-4">
        Đây là phân quyền tạm thời trên trình duyệt (chỉ dùng nội bộ ID-Land).
      </p>
      <div class="flex flex-col gap-3">
        <button class="btn btn-primary" onclick="setRole('admin')">Tôi là ADMIN (xem & chỉnh sửa đầy đủ)</button>
        <button class="btn" onclick="setRole('staff')">Tôi là NHÂN SỰ (ẩn số nhà & sđt chủ nhà)</button>
      </div>
    </div>
  </div>

  <!-- ================= MODAL CHI TIẾT ================= -->
  <div id="detailModal"
       class="modal fixed inset-0 bg-black bg-opacity-40 flex justify-center items-start py-10 z-[900]">
    <div class="bg-white rounded-lg shadow-xl p-6 w-[95%] lg:w-[70%] relative max-h-[90vh] overflow-y-auto">

      <!-- Close button -->
      <button onclick="closeDetailModal()"
              class="absolute right-4 top-4 text-gray-600 hover:text-black text-xl">✕</button>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">

        <!-- Hình ảnh -->
        <div>
          <img id="detailImage" src="" class="w-full rounded-lg shadow max-h-[360px] object-cover" />
          <div id="detailImageList" class="flex gap-2 mt-2 overflow-x-auto"></div>
        </div>

        <!-- Thông tin mặt bằng -->
        <div>
          <h2 id="detailTitle" class="text-2xl font-bold mb-2"></h2>

          <div class="text-gray-600 space-y-1 text-[15px]">
            <p><b>Mã MB:</b> <span id="detailCode"></span></p>
            <p><b>Địa chỉ:</b> <span id="detailAddress"></span></p>
            <p><b>Quận:</b> <span id="detailDistrict"></span></p>
            <p><b>Phường:</b> <span id="detailWard"></span></p>
            <p><b>Kết cấu:</b> <span id="detailStructure"></span></p>
            <p><b>Số PN:</b> <span id="detailPN"></span></p>
            <p><b>Số WC:</b> <span id="detailWC"></span></p>
            <p><b>Số tầng:</b> <span id="detailFloors"></span></p>
            <p><b>Diện tích:</b> <span id="detailArea"></span></p>
            <p><b>Mặt tiền:</b> <span id="detailFrontage"></span></p>

            <p class="text-blue-600 font-bold text-xl mt-3">Giá thuê:
              <span id="detailPrice"></span> đ
            </p>

            <p class="mt-1"><b>Liên hệ:</b>
              <span id="detailContact" class="text-blue-700"></span>
            </p>

            <p><b>Ngày cập nhật:</b> <span id="detailUpdated"></span></p>
          </div>

          <!-- Button nhóm -->
          <div class="flex flex-wrap gap-2 mt-4">
            <a id="btnCall" href="#" class="btn btn-sm btn-primary">Gọi</a>
            <a id="btnZalo" href="#" class="btn btn-sm btn-info text-white">Zalo</a>
            <button id="btnCopyLink" class="btn btn-sm">Copy link</button>

            <button id="btnEdit" onclick="openEditModal()"
                    class="btn btn-sm btn-warning hidden">
              Chỉnh sửa
            </button>
          </div>

          <!-- Thông tin chi tiết -->
          <div class="mt-5 bg-gray-100 p-4 rounded-lg shadow-inner">
            <h3 class="font-semibold mb-2 text-lg">Thông tin chi tiết</h3>
            <p id="detailMore" class="text-gray-700 whitespace-pre-line"></p>
          </div>

        </div>
      </div>

      <!-- Map -->
      <div class="mt-6">
        <iframe id="detailMap" class="w-full h-72 rounded-xl"
                loading="lazy" allowfullscreen></iframe>
      </div>

    </div>
  </div>

  <!-- ================= MODAL CHỈNH SỬA (ADMIN) ================= -->
  <div id="editModal"
       class="modal fixed inset-0 bg-black bg-opacity-40 flex justify-center items-start py-10 z-[950]">
    <div class="bg-white rounded-lg shadow-xl p-6 w-[95%] lg:w-[60%] relative max-h-[90vh] overflow-y-auto">

      <button onclick="closeEditModal()"
              class="absolute right-4 top-4 text-gray-600 hover:text-black text-xl">✕</button>

      <h2 class="text-2xl font-bold mb-4">Chỉnh sửa mặt bằng</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <div>
          <label class="font-semibold text-sm">Mã mặt bằng</label>
          <input id="editCode" class="w-full px-3 py-2 border rounded-lg mb-3" />
        </div>

        <div>
          <label class="font-semibold text-sm">Địa chỉ</label>
          <input id="editAddress" class="w-full px-3 py-2 border rounded-lg mb-3" />
        </div>

        <div>
          <label class="font-semibold text-sm">Phường</label>
          <input id="editWard" class="w-full px-3 py-2 border rounded-lg mb-3" />
        </div>

        <div>
          <label class="font-semibold text-sm">Quận</label>
          <input id="editDistrict" class="w-full px-3 py-2 border rounded-lg mb-3" />
        </div>

        <div>
          <label class="font-semibold text-sm">Kết cấu</label>
          <input id="editStructure" class="w-full px-3 py-2 border rounded-lg mb-3" />
        </div>

        <div>
          <label class="font-semibold text-sm">Số PN</label>
          <input id="editPN" type="number" class="w-full px-3 py-2 border rounded-lg mb-3" />
        </div>

        <div>
          <label class="font-semibold text-sm">Số WC</label>
          <input id="editWC" type="number" class="w-full px-3 py-2 border rounded-lg mb-3" />
        </div>

        <div>
          <label class="font-semibold text-sm">Số tầng</label>
          <input id="editFloors" type="number" class="w-full px-3 py-2 border rounded-lg mb-3" />
        </div>

        <div>
          <label class="font-semibold text-sm">Diện tích (m²)</label>
          <input id="editArea" class="w-full px-3 py-2 border rounded-lg mb-3" />
        </div>

        <div>
          <label class="font-semibold text-sm">Mặt tiền</label>
          <input id="editFrontage" class="w-full px-3 py-2 border rounded-lg mb-3" />
        </div>

        <div>
          <label class="font-semibold text-sm">Giá thuê</label>
          <input id="editPrice" class="w-full px-3 py-2 border rounded-lg mb-3" />
        </div>

        <div>
          <label class="font-semibold text-sm">SĐT chủ nhà</label>
          <input id="editContact" class="w-full px-3 py-2 border rounded-lg mb-3" />
        </div>

        <div class="md:col-span-2">
          <label class="font-semibold text-sm">Thông tin chi tiết</label>
          <textarea id="editMore" class="w-full px-3 py-2 border rounded-lg h-32"></textarea>
        </div>

      </div>

      <button onclick="saveEdit()"
              class="btn btn-success mt-5">Lưu thay đổi</button>
    </div>
  </div>

  <!-- ================= SCRIPTS ================= -->
  <script>
    /* ============ SUPABASE CONFIG ============ */
    const SUPABASE_URL = "https://xclncowkoedwqzcemhei.supabase.co";             // <-- SỬA LẠI
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbG5jb3drb2Vkd3F6Y2VtaGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNzcwOTUsImV4cCI6MjA3Nzg1MzA5NX0.jfNM46UgXIq9LrwSXcERJJULeKB7bl_c9R9LaVhRy1A";   // <-- SỬA LẠI

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ============ ROLE / LOGIN ============ */
    let currentRole = localStorage.getItem("role") || "";

    function updateRoleUI() {
      const roleLabel = document.getElementById("roleLabel");
      const btnAdd = document.getElementById("btnAdd");
      const btnLogout = document.getElementById("btnLogout");

      if (!currentRole) {
        document.getElementById("roleModal").style.display = "flex";
        roleLabel.textContent = "";
        btnAdd.classList.add("hidden");
        btnLogout.classList.add("hidden");
        return;
      }

      document.getElementById("roleModal").style.display = "none";

      if (currentRole === "admin") {
        roleLabel.textContent = "Bạn đang đăng nhập với vai trò: ADMIN";
        btnAdd.classList.remove("hidden");
        btnLogout.classList.remove("hidden");
      } else {
        roleLabel.textContent = "Bạn đang đăng nhập với vai trò: NHÂN SỰ";
        btnAdd.classList.add("hidden");
        btnLogout.classList.remove("hidden");
      }
    }

    function setRole(role) {
      currentRole = role;
      localStorage.setItem("role", role);
      updateRoleUI();
      applyFilters(); // render lại theo quyền
    }

    function logout() {
      localStorage.removeItem("role");
      currentRole = "";
      updateRoleUI();
      applyFilters();
    }

    updateRoleUI();

    /* ============ DATA & FILTERS ============ */
    let allRows = [];
    let statusFilter = "all";

    async function loadPremises() {
      const { data, error } = await supabase
        .from("premises")
        .select("*")
        .order("updated_at", { ascending: false });

      if (error) {
        console.error(error);
        alert("Lỗi tải dữ liệu Supabase");
        return;
      }

      allRows = data || [];
      buildDistrictOptions();
      applyFilters();
    }

    loadPremises();

    function money(v) {
      if (!v) return "";
      return Number(v).toLocaleString("vi-VN");
    }

    function buildDistrictOptions() {
      const districtSelect = document.getElementById("filterDistrict");
      const wardsSelect = document.getElementById("filterWard");

      const districts = Array.from(
        new Set(allRows.map(r => r.district).filter(Boolean))
      ).sort();

      districtSelect.innerHTML = '<option value="">Tất cả</option>' +
        districts.map(d => `<option value="${d}">${d}</option>`).join("");

      wardsSelect.innerHTML = '<option value="">Tất cả</option>';
    }

    function onDistrictChange() {
      const district = document.getElementById("filterDistrict").value;
      const wardSelect = document.getElementById("filterWard");

      if (!district) {
        wardSelect.innerHTML = '<option value="">Tất cả</option>';
      } else {
        const wards = Array.from(
          new Set(allRows.filter(r => r.district === district).map(r => r.ward).filter(Boolean))
        ).sort();

        wardSelect.innerHTML = '<option value="">Tất cả</option>' +
          wards.map(w => `<option value="${w}">${w}</option>`).join("");
      }
      applyFilters();
    }

    function numFilterCheck(value, filterVal) {
      if (!filterVal) return true;
      const n = Number(value || 0);

      if (filterVal === ">10") return n > 10;
      return n === Number(filterVal);
    }

    function frontageMatch(frontage, type) {
      if (!type) return true;
      const s = (frontage || "").toLowerCase();

      if (type === "hem") {
        return s.includes("hẻm") || s.includes("hem");
      }
      if (type === "hem_xh") {
        return s.includes("xe hơi") || s.includes("hxh");
      }
      if (type === "mt") {
        return s.includes("mặt tiền") || s.includes("mat tien") || s === "mt";
      }
      return true;
    }

    function changeStatusFilter(st) {
      statusFilter = st;
      applyFilters();
    }

    function resetFilters() {
      document.getElementById("filterKeyword").value = "";
      document.getElementById("filterDistrict").value = "";
      document.getElementById("filterWard").innerHTML = '<option value="">Tất cả</option>';
      document.getElementById("filterPN").value = "";
      document.getElementById("filterFloors").value = "";
      document.getElementById("filterWC").value = "";
      document.getElementById("filterFrontage").value = "";
      statusFilter = "all";
      applyFilters();
    }

    async function applyFilters() {
      const kw = document.getElementById("filterKeyword").value.trim().toLowerCase();
      const district = document.getElementById("filterDistrict").value;
      const ward = document.getElementById("filterWard").value;
      const pnFilter = document.getElementById("filterPN").value;
      const floorsFilter = document.getElementById("filterFloors").value;
      const wcFilter = document.getElementById("filterWC").value;
      const frontageFilter = document.getElementById("filterFrontage").value;

      let list = allRows.slice();

      list = list.filter(r => {
        if (statusFilter !== "all") {
          if ((r.status || "") !== statusFilter) return false;
        }

        if (district && r.district !== district) return false;
        if (ward && r.ward !== ward) return false;

        if (!numFilterCheck(r.pn, pnFilter)) return false;
        if (!numFilterCheck(r.floors, floorsFilter)) return false;
        if (!numFilterCheck(r.wc, wcFilter)) return false;

        if (!frontageMatch(r.frontage, frontageFilter)) return false;

        if (kw) {
          const haystack = [
            r.code, r.address, r.street, r.district, r.ward
          ].join(" ").toLowerCase();
          if (!haystack.includes(kw)) return false;
        }

        return true;
      });

      document.getElementById("countTotal").textContent = allRows.length;
      document.getElementById("countShowing").textContent = list.length;

      renderCards(list);
    }

    async function getImageUrl(path) {
      if (!path) return null;
      const { data } = await supabase.storage
        .from("premise-images")
        .getPublicUrl(path);
      return data?.publicUrl || null;
    }

    async function renderCards(list) {
      const grid = document.getElementById("grid");
      grid.innerHTML = "";

      for (const item of list) {
        let imgHtml = "";
        if (Array.isArray(item.images) && item.images.length > 0) {
          const url = await getImageUrl(item.images[0]);
          imgHtml = `<img src="${url}" class="w-full h-56 object-cover rounded-xl" />`;
        } else {
          imgHtml = `<div class="w-full h-56 bg-gray-200 rounded-xl flex items-center justify-center text-gray-500">Không có ảnh</div>`;
        }

        const title = currentRole === "staff"
          ? (item.street || "")
          : (item.address || "");

        const updated = item.updated_at
          ? new Date(item.updated_at).toLocaleDateString("vi-VN")
          : "";

        grid.innerHTML += `
          <article class="border rounded-xl shadow-sm hover:shadow-md transition cursor-pointer bg-white"
                   onclick="openDetail('${item.id}')">
            ${imgHtml}
            <div class="p-3">
              <h3 class="font-bold text-lg line-clamp-1">${title || "(Chưa có địa chỉ)"}</h3>
              <div class="text-xs text-gray-600 mt-1 flex items-center gap-1">
                <span>${item.district || ""}</span>
                <span>•</span>
                <span>${item.area || ""} m²</span>
                <span>•</span>
                <span>Cập nhật ${updated}</span>
              </div>
              <div class="mt-2 text-blue-600 font-bold text-xl">
                ${money(item.price)} đ
              </div>
            </div>
          </article>
        `;
      }
    }

    /* ============ MODAL CHI TIẾT & EDIT ============ */
    let currentDetail = null;

    async function openDetail(id) {
      const row = allRows.find(r => r.id === id);
      if (!row) return;
      currentDetail = row;

      // Ảnh
      if (Array.isArray(row.images) && row.images.length > 0) {
        const first = await getImageUrl(row.images[0]);
        document.getElementById("detailImage").src = first || "";
        let thumbs = "";
        for (const p of row.images) {
          const url = await getImageUrl(p);
          thumbs += `<img onclick="changeDetailImage('${url}')"
                         src="${url}"
                         class="w-16 h-16 object-cover rounded-lg cursor-pointer border border-gray-200" />`;
        }
        document.getElementById("detailImageList").innerHTML = thumbs;
      } else {
        document.getElementById("detailImage").src = "";
        document.getElementById("detailImageList").innerHTML = "";
      }

      // Text
      document.getElementById("detailTitle").textContent = row.address || "";
      document.getElementById("detailCode").textContent = row.code || "";
      document.getElementById("detailAddress").textContent = row.address || "";
      document.getElementById("detailDistrict").textContent = row.district || "";
      document.getElementById("detailWard").textContent = row.ward || "";
      document.getElementById("detailStructure").textContent = row.structure || "";
      document.getElementById("detailPN").textContent = row.pn || 0;
      document.getElementById("detailWC").textContent = row.wc || 0;
      document.getElementById("detailFloors").textContent = row.floors || 0;
      document.getElementById("detailArea").textContent = row.area || "";
      document.getElementById("detailFrontage").textContent = row.frontage || "";
      document.getElementById("detailPrice").textContent = money(row.price);

      const contact = currentRole === "staff" ? "Ẩn" : (row.contact_phone || "");
      document.getElementById("detailContact").textContent = contact;

      const upd = row.updated_at
        ? new Date(row.updated_at).toLocaleDateString("vi-VN")
        : "";
      document.getElementById("detailUpdated").textContent = upd;

      document.getElementById("detailMore").textContent = row.detail || "";

      // Map
      const q = encodeURIComponent(row.address || (row.street || "") + " " + (row.district || "") + " TP.HCM");
      document.getElementById("detailMap").src =
        "https://www.google.com/maps?q=" + q + "&output=embed";

      // Nút gọi + Zalo + copy
      const phone = row.contact_phone || "";
      document.getElementById("btnCall").href = phone ? "tel:" + phone : "#";
      document.getElementById("btnZalo").href = phone ? "https://zalo.me/" + phone : "#";
      document.getElementById("btnCopyLink").onclick = () => {
        navigator.clipboard.writeText(window.location.href + "#premise=" + row.code);
        alert("Đã copy link!");
      };

      // Hiện nút Edit cho ADMIN
      if (currentRole === "admin")
        document.getElementById("btnEdit").classList.remove("hidden");
      else
        document.getElementById("btnEdit").classList.add("hidden");

      document.getElementById("detailModal").style.display = "flex";
    }

    function changeDetailImage(url) {
      document.getElementById("detailImage").src = url;
    }

    function closeDetailModal() {
      document.getElementById("detailModal").style.display = "none";
    }

    function openEditModal() {
      const r = currentDetail;
      if (!r) return;

      document.getElementById("editCode").value = r.code || "";
      document.getElementById("editAddress").value = r.address || "";
      document.getElementById("editWard").value = r.ward || "";
      document.getElementById("editDistrict").value = r.district || "";
      document.getElementById("editStructure").value = r.structure || "";
      document.getElementById("editPN").value = r.pn || "";
      document.getElementById("editWC").value = r.wc || "";
      document.getElementById("editFloors").value = r.floors || "";
      document.getElementById("editArea").value = r.area || "";
      document.getElementById("editFrontage").value = r.frontage || "";
      document.getElementById("editPrice").value = r.price || "";
      document.getElementById("editContact").value = r.contact_phone || "";
      document.getElementById("editMore").value = r.detail || "";

      document.getElementById("editModal").style.display = "flex";
    }

    function closeEditModal() {
      document.getElementById("editModal").style.display = "none";
    }

    async function saveEdit() {
      const payload = {
        code: document.getElementById("editCode").value.trim(),
        address: document.getElementById("editAddress").value.trim(),
        ward: document.getElementById("editWard").value.trim(),
        district: document.getElementById("editDistrict").value.trim(),
        structure: document.getElementById("editStructure").value.trim(),
        pn: Number(document.getElementById("editPN").value || 0),
        wc: Number(document.getElementById("editWC").value || 0),
        floors: Number(document.getElementById("editFloors").value || 0),
        area: Number(document.getElementById("editArea").value || 0),
        frontage: document.getElementById("editFrontage").value.trim(),
        price: Number(document.getElementById("editPrice").value.toString().replace(/[^\d]/g, "") || 0),
        contact_phone: document.getElementById("editContact").value.trim(),
        detail: document.getElementById("editMore").value,
        updated_at: new Date().toISOString()
      };

      const { error } = await supabase
        .from("premises")
        .update(payload)
        .eq("id", currentDetail.id);

      if (error) {
        console.error(error);
        alert("Lỗi khi lưu: " + error.message);
        return;
      }

      alert("Đã lưu thay đổi!");
      closeEditModal();
      closeDetailModal();
      loadPremises();
    }
  </script>
</body>
</html>
