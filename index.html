<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>ID-Land Premises</title>
  <link rel="icon" type="image/png" href="logo.png" />
  <link rel="apple-touch-icon" href="logo.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
    rel="stylesheet"
  />

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    /* CSS CHO GHIM GI√Å TI·ªÄN TR√äN B·∫¢N ƒê·ªí */
    .price-marker-label {
      background-color: white;
      border-radius: 12px;
      padding: 4px 8px;
      font-weight: bold;
      font-size: 12px;
      color: #333;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      border: 1px solid #ccc;
      white-space: nowrap;
      text-align: center;
      transition: transform 0.2s;
    }
    .price-marker-label:hover {
      background-color: #3b82f6; /* M√†u xanh primary khi hover */
      color: white;
      border-color: #2563eb;
      transform: scale(1.1);
      z-index: 999 !important;
    }
    /* M≈©i t√™n nh·ªè d∆∞·ªõi ghim (t√πy ch·ªçn) */
    .price-marker-label::after {
      content: "";
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 4px 4px 0;
      border-style: solid;
      border-color: white transparent transparent transparent;
    }
    .price-marker-label:hover::after {
      border-color: #2563eb transparent transparent transparent;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    .premise-card:hover {
      transform: translateY(-2px);
    }
    .modal-box {
      max-width: 95vw !important;  /* 95% chi·ªÅu r·ªông m√†n h√¨nh, b·∫°n c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh th√†nh 90vw, 98vw ho·∫∑c 100vw n·∫øu mu·ªën r·ªông h∆°n */
      width: 95% !important;       /* Override width ƒë·ªÉ ƒë·∫£m b·∫£o responsive */
    }
    
  </style>
</head>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>


<body class="bg-base-200">

  <section id="auth-section" class="min-h-screen flex flex-col bg-base-200">
    <!-- THANH NAVBAR TRANG CH·ª¶ -->
    <header id="landing-navbar" class="navbar bg-base-100 shadow-sm px-4 sticky top-0 z-50 transition-all duration-300 py-4 border-b border-base-200">
      <div class="flex-1 flex items-center gap-3">
        <img 
          id="landing-logo" 
          src="logo.png" 
          alt="ID Land" 
          class="h-16 w-auto object-contain transition-all duration-300" 
        />
        <div>
          <div class="font-bold text-lg leading-tight">ID-Land Premises</div>
          <div class="text-xs opacity-60">Kho m·∫∑t b·∫±ng cho thu√™ ‚Ä¢ TP.HCM</div>
        </div>
      </div>
      <div class="flex-none">
        <button id="btn-open-login" class="btn btn-outline btn-sm">
          ƒêƒÉng nh·∫≠p nh√¢n s·ª±
        </button>
      </div>
    </header>

    <!-- N·ªòI DUNG TRANG CH·ª¶ D√ÄNH CHO KH√ÅCH -->
    <div class="flex-1 w-full px-10 py-10 grid md:grid-cols-2 gap-10 items-center">
      <!-- C·ªòT B√äN TR√ÅI: HERO CHO KH√ÅCH -->
      <div>
        <p class="text-sm uppercase tracking-wide text-primary font-semibold mb-2">
          Trang tra c·ª©u m·∫∑t b·∫±ng ID-Land
        </p>
        <h1 class="text-3xl sm:text-4xl font-extrabold leading-tight mb-4">
          T√¨m m·∫∑t b·∫±ng kinh doanh<br class="hidden sm:block" />
          <span class="text-primary">nhanh ‚Äì r√µ r√†ng ‚Äì minh b·∫°ch</span>
        </h1>
        <p class="text-sm sm:text-base opacity-80 mb-4">
          ID-Land t·∫≠p trung m·∫∑t b·∫±ng cho thu√™ t·∫°i c√°c qu·∫≠n trung t√¢m TP.HCM.
          Kh√°ch h√†ng c√≥ th·ªÉ li√™n h·ªá nh√¢n s·ª± ƒë·ªÉ ƒë∆∞·ª£c g·ª≠i danh s√°ch ph√π h·ª£p theo
          <b>gi√° ‚Äì di·ªán t√≠ch ‚Äì khu v·ª±c ‚Äì m√¥ h√¨nh kinh doanh</b>.
        </p>
        <ul class="text-sm opacity-80 space-y-1 mb-6">
          <li>‚Ä¢ Th√¥ng tin m·∫∑t b·∫±ng c·∫≠p nh·∫≠t th∆∞·ªùng xuy√™n</li>
          <li>‚Ä¢ H·ªó tr·ª£ xin s·ªë ch·ªß &amp; th∆∞∆°ng l∆∞·ª£ng gi√° thu√™</li>
          <li>‚Ä¢ Ph√π h·ª£p nhi·ªÅu m√¥ h√¨nh: F&amp;B, showroom, spa, vƒÉn ph√≤ng‚Ä¶</li>
        </ul>
        <div class="flex flex-wrap gap-3">
          <a
            href="tel:0798905082"
            class="btn btn-primary btn-md"
          >
            G·ªçi t∆∞ v·∫•n ngay
          </a>
          <button
            type="button"
            class="btn btn-ghost btn-md"
            onclick="alert('Vui l√≤ng li√™n h·ªá nh√¢n s·ª± ID-Land ƒë·ªÉ ƒë∆∞·ª£c g·ª≠i danh s√°ch m·∫∑t b·∫±ng m·ªõi nh·∫•t.')"
          >
            Nh·∫≠n danh s√°ch m·∫∑t b·∫±ng
          </button>
        </div>
      </div>

      <!-- C·ªòT B√äN PH·∫¢I: FORM ƒêƒÇNG NH·∫¨P NH√ÇN S·ª∞ (·∫®N ƒê·∫æN KHI B·∫§M N√öT) -->
      <div id="login-card" class="card w-full max-w-md bg-base-100 shadow-xl ml-auto hidden">
        <div class="card-body">
          <div class="flex items-center gap-2 mb-4">
            <img 
              src="logo.png" 
              alt="Logo ID Land" 
              class="h-12 w-auto object-contain" 
            />
            <div>
              <h2 class="card-title">ƒêƒÉng nh·∫≠p nh√¢n s·ª±</h2>
              <p class="text-xs opacity-70">
                D√†nh cho n·ªôi b·ªô ID-Land ƒë·ªÉ xem &amp; qu·∫£n l√Ω kho m·∫∑t b·∫±ng.
              </p>
            </div>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Email</span>
            </label>
            <input
              id="login-email"
              type="email"
              placeholder="you@idland.vn"
              class="input input-bordered"
            />
          </div>

          <div class="form-control mt-2">
            <label class="label">
              <span class="label-text">M·∫≠t kh·∫©u</span>
            </label>
            <input
              id="login-password"
              type="password"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              class="input input-bordered"
            />
          </div>

          <div class="form-control mt-4">
            <button id="btn-login" class="btn btn-primary w-full">
              ƒêƒÉng nh·∫≠p
            </button>
          </div>

          <p class="mt-3 text-xs opacity-70">
            Quy·ªÅn <b>admin</b>: xem &amp; ch·ªânh s·ª≠a full th√¥ng tin, s·ªë nh√† &amp; s·ªë ch·ªß.<br />
            Quy·ªÅn <b>nh√¢n s·ª±</b>: xem th√¥ng tin ph·ª•c v·ª• kh√°ch, kh√¥ng ch·ªânh s·ª≠a c·∫•u h√¨nh h·ªá th·ªëng.
          </p>
        </div>
      </div>
    </div>
  </section>


  <div id="app-root" class="hidden min-h-screen flex flex-col">
    <div id="main-navbar" class="navbar bg-base-100 shadow-sm px-4 sticky top-0 z-50 transition-all duration-300 py-4 border-b border-base-200">
      <div class="flex-1 flex items-center gap-3">
        <img 
          id="navbar-logo" 
          src="logo.png" 
          alt="ID Land" 
          class="h-16 w-auto object-contain transition-all duration-300" 
        />
        
        <div>
          <div class="font-bold text-lg leading-tight hidden md:block">ID-Land Premises</div>
          <div class="text-xs opacity-60 hidden md:block">Kho m·∫∑t b·∫±ng cho thu√™ ‚Ä¢ TP.HCM</div>
        </div>
      </div>

      <div class="flex-none flex items-center gap-2 text-sm">
        <div class="text-right hidden sm:block mr-2">
             <div id="user-email-display" class="text-xs font-bold"></div>
             <span id="role-badge" class="badge badge-outline"></span>
        </div>
        <button id="btn-logout" class="btn btn-ghost btn-sm">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <<main class="flex-1 max-w-[98%] mx-auto w-full px-2 py-4">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <div>
          <h1 class="text-xl sm:text-2xl font-bold">
            B·ªô l·ªçc m·∫∑t b·∫±ng <span class="text-primary">ID-Land</span>
          </h1>
          <p class="text-xs sm:text-sm opacity-70">
            Nh√¢n s·ª± ch·ªâ c·∫ßn nh·∫≠p y√™u c·∫ßu c·ªßa kh√°ch: <b>gi√° ‚Äì di·ªán t√≠ch ‚Äì khu v·ª±c...</b>
          </p>
        </div>

        <div class="flex flex-wrap gap-2 justify-end">
          <div class="join">
            <button id="btn-view-list" class="btn btn-sm join-item btn-active">L∆∞·ªõi</button>
            <button id="btn-view-table" class="btn btn-sm join-item hidden md:block">B·∫£ng (Admin)</button>
            <button id="btn-view-map" class="btn btn-sm join-item">B·∫£n ƒë·ªì</button>
          </div>
          <div id="admin-pending-controls" class="hidden flex gap-2 overflow-x-auto whitespace-nowrap pb-2 md:pb-0 max-w-[100vw] md:max-w-auto px-2 md:px-0">
            <button id="btn-toggle-pending" class="btn btn-warning btn-sm text-white shrink-0">
              C·∫ßn duy·ªát
              <span class="badge badge-sm bg-white text-warning ml-1 border-none" id="count-pending">0</span>
            </button>

            <button id="btn-toggle-rented-reports" class="btn btn-error btn-sm text-white shrink-0">
              B√°o h·∫øt
              <span class="badge badge-sm bg-white text-error ml-1 border-none" id="count-rented-reports">0</span>
            </button>

            <button id="btn-toggle-reactivate" class="btn btn-info btn-sm text-white shrink-0">
              Duy·ªát ch·∫°y l·∫°i
              <span class="badge badge-sm bg-white text-info ml-1 border-none" id="count-reactivate">0</span>
            </button>

            <button id="btn-approve-all" class="btn btn-success btn-sm text-white hidden shrink-0">
              ‚úî Duy·ªát t·∫•t c·∫£
            </button>
            <button onclick="document.getElementById('toolDlg').showModal()" class="btn btn-neutral btn-sm text-white shrink-0">
              üõ† C√¥ng c·ª•
            </button>
          </div>
          <button id="btn-open-add" class="btn btn-primary btn-sm">
            + Th√™m m·∫∑t b·∫±ng
          </button>
        </div>

      </div>

      <div class="flex flex-wrap items-center gap-2 mb-3">
        <span class="text-xs opacity-70">L·ªçc nhanh:</span>
        <button class="btn btn-xs" data-quick="available">C√≤n tr·ªëng</button>
        <button class="btn btn-xs" data-quick="deposited">Gi·ªØ c·ªçc</button>
        <button class="btn btn-xs" data-quick-district="Qu·∫≠n 1">Qu·∫≠n 1</button>
        <button class="btn btn-xs" data-quick-district="Qu·∫≠n 10">Qu·∫≠n 10</button>
        <button class="btn btn-xs btn-ghost btn-outline" id="btn-clear-quick">
          Xo√° l·ªçc nhanh
        </button>

        <!-- N√öT XEM GHIM -->
        <button class="btn btn-xs btn-outline" id="btn-toggle-favorites">
          Xem m·∫∑t b·∫±ng ƒë√£ ghim
        </button>
      </div>


      <div class="grid md:grid-cols-[260px,1fr] gap-4">
        <aside class="bg-base-100 rounded-2xl shadow-sm p-4">
          <div class="flex items-center gap-2 mb-3">
            <span class="w-2 h-2 rounded-full bg-success"></span>
            <h2 class="font-semibold text-sm">B·ªô l·ªçc</h2>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">T·ª´ kho√°</span>
            </label>
            <input
              id="filter-keyword"
              type="text"
              placeholder="VD: Tr·∫ßn H∆∞ng ƒê·∫°o, Q5..."
              class="input input-sm input-bordered"
            />
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">Qu·∫≠n</span>
            </label>
            <div class="dropdown dropdown-bottom w-full" id="district-dropdown-container">
              <div tabindex="0" role="button" class="select select-sm select-bordered w-full flex items-center justify-between h-8 min-h-0 bg-white" id="district-display-btn">
                <span id="district-display-text" class="truncate text-xs">T·∫•t c·∫£</span>
                <span class="text-[10px] opacity-50">‚ñº</span>
              </div>
              <ul tabindex="0" class="dropdown-content z-[100] menu p-2 shadow bg-base-100 rounded-box w-60 h-64 overflow-y-auto flex-nowrap block border border-base-200" id="district-list-checkboxes">
                </ul>
            </div>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">Ph∆∞·ªùng</span>
            </label>
            <select id="filter-ward" class="select select-sm select-bordered">
              <option value="">T·∫•t c·∫£</option>
            </select>
          </div>

          <div class="form-control mb-3">
            <label class="label"><span class="label-text text-xs">S·ªë PN</span></label>
            <div class="dropdown dropdown-bottom w-full" id="pn-dropdown-container">
              <div tabindex="0" role="button" class="select select-sm select-bordered w-full flex items-center justify-between h-8 min-h-0 bg-white">
                <span id="pn-display-text" class="truncate text-xs">T·∫•t c·∫£</span>
                <span class="text-[10px] opacity-50">‚ñº</span>
              </div>
              <ul tabindex="0" class="dropdown-content z-[100] menu p-2 shadow bg-base-100 rounded-box w-40 h-auto max-h-60 overflow-y-auto block border border-base-200" id="pn-list-checkboxes">
                </ul>
            </div>
          </div>

          <div class="form-control mb-3">
            <label class="label"><span class="label-text text-xs">S·ªë WC</span></label>
            <div class="dropdown dropdown-bottom w-full" id="wc-dropdown-container">
              <div tabindex="0" role="button" class="select select-sm select-bordered w-full flex items-center justify-between h-8 min-h-0 bg-white">
                <span id="wc-display-text" class="truncate text-xs">T·∫•t c·∫£</span>
                <span class="text-[10px] opacity-50">‚ñº</span>
              </div>
              <ul tabindex="0" class="dropdown-content z-[100] menu p-2 shadow bg-base-100 rounded-box w-40 h-auto max-h-60 overflow-y-auto block border border-base-200" id="wc-list-checkboxes">
              </ul>
            </div>
          </div>

          <div class="form-control mb-3">
            <label class="label"><span class="label-text text-xs">S·ªë t·∫ßng</span></label>
            <div class="dropdown dropdown-bottom w-full" id="floors-dropdown-container">
              <div tabindex="0" role="button" class="select select-sm select-bordered w-full flex items-center justify-between h-8 min-h-0 bg-white">
                <span id="floors-display-text" class="truncate text-xs">T·∫•t c·∫£</span>
                <span class="text-[10px] opacity-50">‚ñº</span>
              </div>
              <ul tabindex="0" class="dropdown-content z-[100] menu p-2 shadow bg-base-100 rounded-box w-40 h-auto max-h-60 overflow-y-auto block border border-base-200" id="floors-list-checkboxes">
              </ul>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Gi√° t·ªëi thi·ªÉu</span>
              </label>
              <input
                id="filter-price-min"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Gi√° t·ªëi ƒëa</span>
              </label>
              <input
                id="filter-price-max"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">Ngang t·ªëi thi·ªÉu (m)</span>
              </label>
              <input
                id="filter-width-min"
                type="number"
                step="0.5"
                placeholder="VD: 5"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">D√†i t·ªëi thi·ªÉu (m)</span>
              </label>
              <input
                id="filter-length-min"
                type="number"
                step="1"
                placeholder="VD: 15"
                class="input input-sm input-bordered"
              />
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">DT t·ªëi thi·ªÉu (m¬≤)</span>
              </label>
              <input
                id="filter-area-min"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text text-xs">DT t·ªëi ƒëa (m¬≤)</span>
              </label>
              <input
                id="filter-area-max"
                type="number"
                class="input input-sm input-bordered"
              />
            </div>
          </div>

          <div class="form-control mb-3">
            <label class="label">
              <span class="label-text text-xs">V·ªã tr√≠</span>
            </label>
            <select id="filter-frontage-type" class="select select-sm select-bordered">
              <option value="">T·∫•t c·∫£</option>
              <option value="hem">Nh√† h·∫ªm</option>
              <option value="hxh">H·∫ªm xe h∆°i</option>
              <option value="mt">M·∫∑t ti·ªÅn</option>
            </select>
          </div>

          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text text-xs">T√¨nh tr·∫°ng</span>
            </label>
            <select id="filter-status" class="select select-sm select-bordered">
              <option value="">T·∫•t c·∫£</option>
              <option value="available">C√≤n tr·ªëng</option>
              <option value="deposited">Gi·ªØ c·ªçc</option>
              <option value="rented">ƒê√£ thu√™</option>
            </select>
          </div>

          <div class="flex gap-2">
            <div class="btn-group">
              <button id="btn-view-list" class="btn btn-sm btn-active">Danh s√°ch</button>
              <button id="btn-view-map" class="btn btn-sm btn-ghost">B·∫£n ƒë·ªì</button>
            </div>

            <button id="btn-apply" class="btn btn-sm btn-primary flex-1">
              L·ªçc
            </button>
            <button id="btn-reset" class="btn btn-sm btn-ghost">
              Xo√° l·ªçc
            </button>
          </div>
        </aside>

        <section class="flex flex-col gap-3">
          <div class="flex items-center justify-between mb-1 text-xs opacity-70">
            <span>Hi·ªÉn th·ªã <span id="count-show">0</span> / <span id="count-total">0</span></span>
            
          </div>

          <div id="list-view">
            <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
            <div class="mt-4 flex justify-center">
              <button id="btn-load-more" class="btn btn-sm btn-ghost">H·∫øt d·ªØ li·ªáu</button>
            </div>
          </div>

          <div id="table-view" class="hidden overflow-x-auto bg-white rounded-xl shadow border border-base-200">
            <table class="table table-xs table-pin-rows w-full">
              <thead>
                <tr class="bg-base-200">
                  <th>H√¨nh</th>
                  <th>M√£ / ƒê·ªãa ch·ªâ</th>
                  <th>K·∫øt c·∫•u / DT</th>
                  <th>Gi√° (Tri·ªáu)</th>
                  <th>Hoa h·ªìng</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="table-body">
                </tbody>
            </table>
          </div>

          <div id="map-view" class="hidden w-full h-[600px] rounded-xl border border-base-300 relative z-0">
            <div id="premises-map" class="w-full h-full rounded-xl"></div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <dialog id="detailDlg" class="modal">
    <div class="modal-box w-11/12 max-w-7xl p-4">
      <div id="detail-content"></div>
    </div>
    
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <dialog id="editDlg" class="modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog" class="modal-backdrop absolute inset-0" onclick="document.getElementById('editDlg').close()"></form>
      <h3 class="font-bold text-lg mb-3">Ch·ªânh s·ª≠a m·∫∑t b·∫±ng</h3>

      <div class="grid md:grid-cols-2 gap-3">
        <div class="form-control md:col-span-2">
          <label class="label">
            <span class="label-text">M√£ m·∫∑t b·∫±ng (code)</span>
          </label>
          <input id="edit-code" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label">
            <span class="label-text">Ti√™u ƒë·ªÅ / ƒê·ªãa ch·ªâ hi·ªÉn th·ªã</span>
          </label>
          <input id="edit-address" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Th√†nh ph·ªë</span></label>
          <input id="edit-city" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Qu·∫≠n</span></label>
          <input id="edit-district" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Ph∆∞·ªùng</span></label>
          <input id="edit-ward" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">T√™n ƒë∆∞·ªùng</span></label>
          <input id="edit-street" type="text" class="input input-bordered w-full" />
        </div>
        <div class="form-control md:col-span-2">
          <label class="label">
            <span class="label-text font-bold text-primary">C·∫≠p nh·∫≠t T·ªça ƒë·ªô (Lat / Lng)</span>
          </label>
          <div class="join w-full">
            <input id="edit-lat" type="text" class="input input-bordered join-item w-1/3" placeholder="Lat (Vƒ© ƒë·ªô)" />
            <input id="edit-lng" type="text" class="input input-bordered join-item w-1/3" placeholder="Lng (Kinh ƒë·ªô)" />
            <button type="button" class="btn btn-accent join-item w-1/3 text-white" onclick="autoFetchCoordsForEdit()">
              üìç D√≤ l·∫°i theo ƒë·ªãa ch·ªâ
            </button>
          </div>
          <div id="edit-map-picker" class="w-full h-64 mt-3 rounded-lg border border-gray-300 z-0"></div>
          <div class="text-[11px] text-gray-500 italic mt-1 text-right">* K√©o th·∫£ ghim ƒë·ªè ƒë·ªÉ ch·ªânh v·ªã tr√≠ ch√≠nh x√°c</div>
          <label class="label">
            <span class="label-text-alt text-gray-500">
              Admin c√≥ th·ªÉ nh·∫≠p th·ªß c√¥ng ho·∫∑c b·∫•m n√∫t "D√≤ l·∫°i" ƒë·ªÉ l·∫•y t·ªça ƒë·ªô t·ª´ ƒë·ªãa ch·ªâ b√™n tr√™n.
            </span>
          </label>
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Gi√° thu√™ (ƒë)</span></label>
          <input id="edit-price" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Di·ªán t√≠ch (m¬≤)</span></label>
          <input id="edit-area" type="number" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Chi·ªÅu ngang (m)</span></label>
          <input id="edit-width" type="number" step="0.1" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Chi·ªÅu d√†i (m)</span></label>
          <input id="edit-length" type="number" step="0.1" class="input input-bordered w-full" />
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">S·ªë t·∫ßng</span></label>
          <input id="edit-floors" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">S·ªë PN</span></label>
          <input id="edit-bedrooms" type="number" class="input input-bordered w-full" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">S·ªë WC</span></label>
          <input id="edit-wc" type="number" class="input input-bordered w-full" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">K·∫øt c·∫•u</span></label>
          <input id="edit-ket-cau" type="text" class="input input-bordered w-full" placeholder="VD: Tr·ªát 3 l·∫ßu, tr·ªëng su·ªët‚Ä¶" />
        </div>
        
        <div class="form-control md:col-span-2">
            <label class="label"><span class="label-text">SƒêT Ch·ªß nh√† (Ch·ªâ Admin th·∫•y)</span></label>
            <input id="edit-contact-phone" type="text" class="input input-bordered w-full" placeholder="090..." />
        </div>

        <div class="form-control flex items-center gap-2 mt-2">
          <input id="edit-frontage" type="checkbox" class="checkbox" />
          <span class="label-text">Nh√† m·∫∑t ti·ªÅn</span>
        </div>

        <div class="form-control md:col-span-2 grid grid-cols-2 gap-2">
            <div class="form-control">
              <label class="label"><span class="label-text">Lo·∫°i h√¨nh</span></label>
              <select id="edit-road-type" class="select select-bordered w-full">
                <option value="H·∫ªm">H·∫ªm</option>
                <option value="H·∫ªm xe h∆°i">H·∫ªm xe h∆°i</option>
                <option value="M·∫∑t ti·ªÅn">M·∫∑t ti·ªÅn</option>
              </select>
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">Hoa h·ªìng (ng·∫Øn)</span></label>
              <input id="edit-commission-text" type="text" class="input input-bordered w-full" placeholder="VD: 1 th√°ng" />
            </div>
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Tr·∫°ng th√°i</span></label>
          <select id="edit-status" class="select select-bordered w-full">
            <option value="available">C√≤n tr·ªëng</option>
            <option value="deposited">Gi·ªØ c·ªçc</option>
            <option value="rented">ƒê√£ thu√™</option>
          </select>
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Hoa h·ªìng / ghi ch√∫ HH</span></label>
          <input id="edit-commission" type="text" class="input input-bordered w-full" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Danh s√°ch ·∫£nh (m·ªói d√≤ng 1 path)</span></label>
          <textarea id="edit-images" class="textarea textarea-bordered w-full min-h-[80px]" placeholder="VD: MB0001/1.jpg
MB0001/2.jpg"></textarea>
        </div>

        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Th√¥ng tin chi ti·∫øt m·∫∑t b·∫±ng</span></label>
          <textarea id="edit-detail" class="textarea textarea-bordered w-full min-h-[140px]"></textarea>
        </div>
      </div>

      <div class="modal-action">
        <button class="btn btn-ghost" onclick="document.getElementById('editDlg').close()">Hu·ª∑</button>
        <button class="btn btn-primary" onclick="saveEditPremise()">L∆∞u thay ƒë·ªïi</button>
      </div>
    </div>
  </dialog>

  <dialog id="addDlg" class="modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button></form>
      <h3 class="font-bold text-lg text-primary mb-4">ƒêƒÉng m·∫∑t b·∫±ng m·ªõi</h3>
      
      <div class="grid md:grid-cols-2 gap-4">
          <div>
             <div class="form-control mb-2">
                 <span class="label-text text-xs font-bold">ƒê·ªãa ch·ªâ (S·ªë nh√† + ƒê∆∞·ªùng) *</span>
                 <input id="add-address" type="text" class="input input-sm input-bordered" placeholder="VD: 123 Nguy·ªÖn Tr√£i"/>
             </div>
             <div class="grid grid-cols-2 gap-2 mb-2">
                 <div class="form-control">
                     <span class="label-text text-xs">Qu·∫≠n *</span>
                     <select id="add-district" class="select select-sm select-bordered">
                        <option value="">-- Ch·ªçn --</option>
                     </select>
                 </div>
                 <div class="form-control">
                     <span class="label-text text-xs">Ph∆∞·ªùng *</span>
                     <select id="add-ward" class="select select-sm select-bordered" disabled>
                        <option value="">-- Ch·ªçn Qu·∫≠n tr∆∞·ªõc --</option>
                     </select>
                 </div>
             </div>
             <div class="form-control mb-2">
                 <span class="label-text text-xs">T√™n ƒë∆∞·ªùng (ƒë·ªÉ l·ªçc)</span>
                 <input id="add-street" type="text" class="input input-sm input-bordered"/>
             </div>
            <div class="form-control mb-2">
                <span class="label-text text-xs font-bold">T·ªça ƒë·ªô (Lat / Lng)</span>
                <div class="join w-full">
                    <input id="add-lat" type="text" class="input input-sm input-bordered join-item w-1/3" placeholder="Vƒ© ƒë·ªô (Lat)" />
                    <input id="add-lng" type="text" class="input input-sm input-bordered join-item w-1/3" placeholder="Kinh ƒë·ªô (Lng)" />
                    <button type="button" class="btn btn-sm btn-accent join-item w-1/3 text-white" onclick="autoFetchCoords()">
                        üìç L·∫•y t·ªça ƒë·ªô
                    </button>
                </div>
                <div id="add-map-picker" class="w-full h-64 mt-3 rounded-lg border border-gray-300 z-0"></div>
            </div>
             <div class="form-control mt-3">
                 <span class="label-text text-xs font-bold text-primary">Gi√° thu√™ (VNƒê) *</span>
                 <input id="add-price" type="text" class="input input-sm input-bordered font-bold" onkeyup="formatCurrencyInput(this)" placeholder="0"/>
             </div>
             
             <div class="grid grid-cols-2 gap-2 mt-3">
                 <div class="form-control">
                     <span class="label-text text-xs font-bold">Lo·∫°i h√¨nh *</span>
                     <select id="add-road-type" class="select select-sm select-bordered">
                        <option value="H·∫ªm">H·∫ªm</option>
                        <option value="H·∫ªm xe h∆°i">H·∫ªm xe h∆°i</option>
                        <option value="M·∫∑t ti·ªÅn">M·∫∑t ti·ªÅn</option>
                     </select>
                 </div>
                 <div class="form-control">
                     <span class="label-text text-xs font-bold text-success">Hoa h·ªìng</span>
                     <input id="add-commission" type="text" class="input input-sm input-bordered" placeholder="VD: 1 th√°ng"/>
                 </div>
             </div>
          </div>

          <div>
             <div class="grid grid-cols-3 gap-2 mb-2">
                 <div><span class="text-xs">DT (m¬≤)</span><input id="add-area" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">Ngang</span><input id="add-width" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">D√†i</span><input id="add-length" type="number" class="input input-sm input-bordered w-full"/></div>
             </div>
             <div class="grid grid-cols-3 gap-2 mb-2">
                 <div><span class="text-xs">T·∫ßng</span><input id="add-floors" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">PN</span><input id="add-bedrooms" type="number" class="input input-sm input-bordered w-full"/></div>
                 <div><span class="text-xs">WC</span><input id="add-wc" type="number" class="input input-sm input-bordered w-full"/></div>
             </div>
             <div class="form-control mb-2">
                 <span class="text-xs">K·∫øt c·∫•u</span>
                 <input id="add-ket-cau" type="text" class="input input-sm input-bordered" placeholder="VD: Tr·ªát 3 l·∫ßu..."/>
             </div>
             <div class="form-control mb-2">
                 <span class="text-xs font-bold text-error">SƒêT Ch·ªß (Admin xem)</span>
                 <input id="add-contact-phone" type="text" class="input input-sm input-bordered input-error" placeholder="090..."/>
             </div>

             <div class="md:col-span-2 border-t pt-3 mt-2">
                <div class="flex justify-between items-center mb-2">
                    <span class="label-text font-bold">H√¨nh ·∫£nh th·ª±c t·∫ø</span>
                    
                    <label for="inp-upload-files" class="btn btn-sm btn-primary text-white cursor-pointer hover:bg-primary-focus">
                        üì∑ T·∫£i ·∫£nh l√™n
                    </label>
                    <input id="inp-upload-files" type="file" multiple accept="image/*" class="hidden" onchange="handleSelectFiles(this)" />
                </div>
                
                <div id="preview-container" class="flex flex-wrap gap-3 min-h-[100px] bg-base-200 p-2 rounded-lg border border-dashed border-gray-400">
                    <p class="text-xs text-gray-500 w-full text-center py-8 pointer-events-none">
                        Ch∆∞a c√≥ ·∫£nh n√†o. <br/> ·∫¢nh ƒë·∫ßu ti√™n s·∫Ω l√† <b>·∫¢nh B√¨a</b>.
                    </p>
                </div>

                <div class="form-control mt-2 relative">
                    <div class="flex justify-between items-end mb-1">
                        <span class="text-xs">M√¥ t·∫£ chi ti·∫øt (D√°n n·ªôi dung v√†o ƒë√¢y)</span>
                        <button type="button" class="btn btn-xs btn-accent text-white animate-pulse" onclick="autoFillFromDesc()">
                            ‚ö° T·ª± ƒëi·ªÅn t·ª´ m√¥ t·∫£
                        </button>
                    </div>
                    <textarea id="add-detail" class="textarea textarea-bordered w-full h-32 text-sm" placeholder="Paste n·ªôi dung tin ƒëƒÉng v√†o ƒë√¢y r·ªìi b·∫•m n√∫t 'T·ª± ƒëi·ªÅn' ·ªü tr√™n..."></textarea>
                </div>
             </div>
          </div>
      </div>

      <div class="modal-action">
        <button class="btn" onclick="document.getElementById('addDlg').close()">Hu·ª∑</button>
        <button id="btn-save-new" class="btn btn-primary" onclick="saveNewPremiseWithUpload()">
            L∆∞u tin
        </button>
      </div>
    </div>
  </dialog>

  <dialog id="demoNoticeDlg" class="modal">
    <div class="modal-box max-w-md">
      <h3 class="font-bold text-lg mb-2 text-error">L∆∞u √Ω: B·∫£n DEMO</h3>
      <p class="text-sm leading-relaxed">
        ƒê√¢y l√† b·∫£n <b>DEMO</b> n√™n c√≤n nhi·ªÅu l·ªói, ch·ª©c nƒÉng ch∆∞a ho√†n thi·ªán.<br/><br/>

        Nh√¢n s·ª± xin s·ªë ch·ªß qua admin. H√†ng n√†o h·∫øt vui l√≤ng b√°o v·ªõi admin 
        ho·∫∑c b·∫•m n√∫t <b>‚ÄúB√°o h·∫øt‚Äù</b> tr√™n web ƒë·ªÉ admin ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i.<br/><br/>

        N·∫øu anh/ch·ªã c√≥ th·∫Øc m·∫Øc, ph√°t hi·ªán l·ªói ho·∫∑c c√≥ ƒë·ªÅ xu·∫•t c·∫£i ti·∫øn trang web,
        xin vui l√≤ng li√™n h·ªá Team <b>"VƒÉn H√≥a"</b> ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.<br/><br/>

        <b>Xin c·∫£m ∆°n!</b>
      </p>

      <div class="flex justify-center gap-4 mt-4">
        <button id="btn-demo-disagree" class="btn btn-outline w-40">toi khong dong tinh</button>
        <button id="btn-demo-agree" class="btn btn-outline w-40">toi dong tinh</button>
      </div>

    </div>
  </dialog>

  <div id="toast" class="toast toast-end z-50 hidden">
    <div class="alert alert-info text-sm" id="toast-text"></div>
  </div>

  <script>
    // ===== 1. CONFIG =====
    const SUPABASE_URL = "https://xclncowkoedwqzcemhei.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbG5jb3drb2Vkd3F6Y2VtaGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNzcwOTUsImV4cCI6MjA3Nzg1MzA5NX0.jfNM46UgXIq9LrwSXcERJJULeKB7bl_c9R9LaVhRy1A";
    const STORAGE_BUCKET = "premise-images";
    const PAGE_SIZE = 100;

    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- D·ªÆ LI·ªÜU QU·∫¨N/PH∆Ø·ªúNG CHO FORM TH√äM M·ªöI (C·∫ßn d·ªØ li·ªáu ƒë·ªÉ ch·ªçn) ---
    const HCM_DATA = {
        "Qu·∫≠n 1": ["B·∫øn Ngh√©", "B·∫øn Th√†nh", "C√¥ Giang", "C·∫ßu Kho", "C·∫ßu √îng L√£nh", "ƒêa Kao", "Nguy·ªÖn C∆∞ Trinh", "Nguy·ªÖn Th√°i B√¨nh", "Ph·∫°m Ng≈© L√£o", "T√¢n ƒê·ªãnh"],
        "Qu·∫≠n 2": [
          "Th·∫£o ƒêi·ªÅn",
          "An Ph√∫",
          "B√¨nh An",
          "B√¨nh Tr∆∞ng ƒê√¥ng",
          "B√¨nh Tr∆∞ng T√¢y",
          "An Kh√°nh",
          "C√°t L√°i",
          "Th·∫°nh M·ªπ L·ª£i",
          "Th·ªß Thi√™m"
        ],

        "Qu·∫≠n 3": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "V√µ Th·ªã S√°u"],
        "Qu·∫≠n 4": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16", "Ph∆∞·ªùng 18"],
        "Qu·∫≠n 5": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14"],
        "Qu·∫≠n 6": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14"],
        "Qu·∫≠n 7": ["B√¨nh Thu·∫≠n", "Ph√∫ M·ªπ", "Ph√∫ Thu·∫≠n", "T√¢n H∆∞ng", "T√¢n Ki·ªÉng", "T√¢n Phong", "T√¢n Ph√∫", "T√¢n Quy", "T√¢n Thu·∫≠n ƒê√¥ng", "T√¢n Thu·∫≠n T√¢y"],
        "Qu·∫≠n 8": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16"],
        "Qu·∫≠n 9": [
            "Hi·ªáp Ph√∫",
            "Linh Trung",
            "Linh Chi·ªÉu",
            "Linh T√¢y",
            "Linh ƒê√¥ng",
            "Linh Xu√¢n",
            "TƒÉng Nh∆°n Ph√∫ A",
            "TƒÉng Nh∆°n Ph√∫ B",
            "Ph∆∞·ªõc Long A",
            "Ph∆∞·ªõc Long B",
            "T√¢n Ph√∫",
            "Ph∆∞·ªõc B√¨nh",
            "Long Th·∫°nh M·ªπ",
            "Tr∆∞·ªùng Th·∫°nh",
            "Long Ph∆∞·ªõc",
            "Long B√¨nh",
            "Ph√∫ H·ªØu"
        ],
        "Qu·∫≠n 10": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15"],
        "Qu·∫≠n 11": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16"],
        "Qu·∫≠n 12": ["An Ph√∫ ƒê√¥ng", "ƒê√¥ng H∆∞ng Thu·∫≠n", "Hi·ªáp Th√†nh", "T√¢n Ch√°nh Hi·ªáp", "T√¢n H∆∞ng Thu·∫≠n", "T√¢n Th·ªõi Hi·ªáp", "T√¢n Th·ªõi Nh·∫•t", "Th·∫°nh L·ªôc", "Th·∫°nh Xu√¢n", "Th·ªõi An", "Trung M·ªπ T√¢y"],
        "B√¨nh T√¢n": ["An L·∫°c", "An L·∫°c A", "B√¨nh H∆∞ng H√≤a", "B√¨nh H∆∞ng H√≤a A", "B√¨nh H∆∞ng H√≤a B", "B√¨nh Tr·ªã ƒê√¥ng", "B√¨nh Tr·ªã ƒê√¥ng A", "B√¨nh Tr·ªã ƒê√¥ng B", "T√¢n T·∫°o", "T√¢n T·∫°o A"],
        "B√¨nh Th·∫°nh": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 17", "Ph∆∞·ªùng 19", "Ph∆∞·ªùng 21", "Ph∆∞·ªùng 22", "Ph∆∞·ªùng 24", "Ph∆∞·ªùng 25", "Ph∆∞·ªùng 26", "Ph∆∞·ªùng 27", "Ph∆∞·ªùng 28"],
        "G√≤ V·∫•p": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 16", "Ph∆∞·ªùng 17"],
        "Ph√∫ Nhu·∫≠n": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 15", "Ph∆∞·ªùng 17"],
        "T√¢n B√¨nh": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5", "Ph∆∞·ªùng 6", "Ph∆∞·ªùng 7", "Ph∆∞·ªùng 8", "Ph∆∞·ªùng 9", "Ph∆∞·ªùng 10", "Ph∆∞·ªùng 11", "Ph∆∞·ªùng 12", "Ph∆∞·ªùng 13", "Ph∆∞·ªùng 14", "Ph∆∞·ªùng 15"],
        "T√¢n Ph√∫": ["Hi·ªáp T√¢n", "H√≤a Th·∫°nh", "Ph√∫ Th·∫°nh", "Ph√∫ Th·ªç H√≤a", "Ph√∫ Trung", "S∆°n K·ª≥", "T√¢n Qu√Ω", "T√¢n S∆°n Nh√¨", "T√¢n Th√†nh", "T√¢n Th·ªõi H√≤a", "T√¢y Th·∫°nh"],
        "Th·ªß ƒê·ª©c": ["An Kh√°nh", "An L·ª£i ƒê√¥ng", "An Ph√∫", "B√¨nh Chi·ªÉu", "B√¨nh Th·ªç", "B√¨nh Tr∆∞ng ƒê√¥ng", "B√¨nh Tr∆∞ng T√¢y", "C√°t L√°i", "Hi·ªáp B√¨nh Ch√°nh", "Hi·ªáp B√¨nh Ph∆∞·ªõc", "Linh Chi·ªÉu", "Linh ƒê√¥ng", "Linh T√¢y", "Linh Trung", "Linh Xu√¢n", "Long B√¨nh", "Long Ph∆∞·ªõc", "Long Th·∫°nh M·ªπ", "Long Tr∆∞·ªùng", "Ph√∫ H·ªØu", "Ph∆∞·ªõc B√¨nh", "Ph∆∞·ªõc Long A", "Ph∆∞·ªõc Long B", "Tam B√¨nh", "Tam Ph√∫", "T√¢n Ph√∫", "TƒÉng Nh∆°n Ph√∫ A", "TƒÉng Nh∆°n Ph√∫ B", "Th·∫£o ƒêi·ªÅn", "Th·∫°nh M·ªπ L·ª£i", "Th·ªß Thi√™m", "Tr∆∞·ªùng Th·∫°nh", "Tr∆∞·ªùng Th·ªç"]
    };

    let CURRENT_USER = null;
    let CURRENT_ROLE = "staff";
    let PAGE = 0;
    let TOTAL_COUNT = 0;
    let LAST_ROWS = [];
    let EDITING_ID = null;

    // --- LOGIC M·ªöI: MULTI-SELECT QU·∫¨N ---

    // 1. H√†m l·∫•y danh s√°ch c√°c qu·∫≠n ƒëang ƒë∆∞·ª£c t√≠ch ch·ªçn (tr·∫£ v·ªÅ M·∫£ng)
    function getSelectedDistricts() {
        const checkboxes = document.querySelectorAll('#district-list-checkboxes input[type="checkbox"]:checked');
        const values = Array.from(checkboxes).map(cb => cb.value);
        return values; // VD: ["Qu·∫≠n 1", "Qu·∫≠n 3"]
    }

    // 2. H√†m v·∫Ω danh s√°ch checkbox Qu·∫≠n & X·ª≠ l√Ω s·ª± ki·ªán
    function buildDistrictDropdown() {
        const listContainer = document.getElementById("district-list-checkboxes");
        const displayLabel = document.getElementById("district-display-text");
        if (!listContainer) return;

        listContainer.innerHTML = "";
        const dists = Object.keys(HCM_DATA).sort();

        // T·∫°o c√°c d√≤ng checkbox
        dists.forEach(d => {
            const li = document.createElement("li");
            li.innerHTML = `
                <label class="label cursor-pointer justify-start gap-2 py-1 px-2 hover:bg-base-200 rounded">
                    <input type="checkbox" class="checkbox checkbox-xs checkbox-primary district-cb" value="${d}" />
                    <span class="label-text text-xs">${d}</span>
                </label>
            `;
            listContainer.appendChild(li);
        });

        // B·∫Øt s·ª± ki·ªán khi click v√†o checkbox
        const checkboxes = listContainer.querySelectorAll(".district-cb");
        checkboxes.forEach(cb => {
            cb.addEventListener("change", () => {
                // A. C·∫≠p nh·∫≠t ch·ªØ hi·ªÉn th·ªã tr√™n n√∫t
                const selected = getSelectedDistricts();
                if (selected.length === 0) {
                    displayLabel.textContent = "T·∫•t c·∫£";
                } else if (selected.length <= 2) {
                    displayLabel.textContent = selected.join(", ");
                } else {
                    displayLabel.textContent = `ƒê√£ ch·ªçn ${selected.length} Qu·∫≠n`;
                }

                // B. C·∫≠p nh·∫≠t dropdown Ph∆∞·ªùng (G·ªôp ph∆∞·ªùng c·ªßa c√°c qu·∫≠n ƒë√£ ch·ªçn)
                updateWardOptionsMulti();

                // C. G·ªçi l·ªçc d·ªØ li·ªáu ngay l·∫≠p t·ª©c
                applyFilters(true);
            });
        });
    }


    // --- H√ÄM CHUNG: T·∫†O DROPDOWN CHO PN, WC, T·∫¶NG ---
    function buildMultiSelectDropdown(config) {
        const { listId, displayId, options, suffix } = config;
        const listContainer = document.getElementById(listId);
        const displayLabel = document.getElementById(displayId);
        
        if (!listContainer) return;
        listContainer.innerHTML = "";

        options.forEach(opt => {
            const val = opt.value; // VD: "1", "2", ">6"
            const label = opt.label; // VD: "1 PN", "> 6 PN"
            
            const li = document.createElement("li");
            li.innerHTML = `
                <label class="label cursor-pointer justify-start gap-2 py-1 px-2 hover:bg-base-200 rounded">
                    <input type="checkbox" class="checkbox checkbox-xs checkbox-primary multi-cb" value="${val}" />
                    <span class="label-text text-xs">${label}</span>
                </label>
            `;
            listContainer.appendChild(li);
        });

        // X·ª≠ l√Ω s·ª± ki·ªán click
        const checkboxes = listContainer.querySelectorAll(".multi-cb");
        checkboxes.forEach(cb => {
            cb.addEventListener("change", () => {
                // L·∫•y danh s√°ch ƒëang ch·ªçn
                const checkedBoxes = listContainer.querySelectorAll('.multi-cb:checked');
                const values = Array.from(checkedBoxes).map(c => c.value);
                
                // C·∫≠p nh·∫≠t text hi·ªÉn th·ªã
                if (values.length === 0) {
                    displayLabel.textContent = "T·∫•t c·∫£";
                } else {
                    // N·∫øu ch·ªçn √≠t th√¨ hi·ªán s·ªë, ch·ªçn nhi·ªÅu th√¨ hi·ªán t·ªïng s·ªë
                    if (values.length <= 2) {
                        displayLabel.textContent = values.map(v => v.includes(">") ? v : v + suffix).join(", ");
                    } else {
                        displayLabel.textContent = `ƒê√£ ch·ªçn ${values.length}`;
                    }
                }
                
                // G·ªçi l·ªçc ngay l·∫≠p t·ª©c
                applyFilters(true);
            });
        });
    }

    // H√†m l·∫•y gi√° tr·ªã (d√πng chung cho 3 c√°i)
    function getMultiValues(listId) {
        const checkboxes = document.querySelectorAll(`#${listId} input[type="checkbox"]:checked`);
        return Array.from(checkboxes).map(cb => cb.value);
    }

    // H√†m kh·ªüi t·∫°o 3 b·ªô l·ªçc n√†y (S·∫Ω g·ªçi ·ªü cu·ªëi)
    function initAllMultiFilters() {
        // 1. PN
        buildMultiSelectDropdown({
            listId: "pn-list-checkboxes",
            displayId: "pn-display-text",
            suffix: " PN",
            options: [
                {value: "1", label: "1 PN"}, {value: "2", label: "2 PN"}, 
                {value: "3", label: "3 PN"}, {value: "4", label: "4 PN"}, 
                {value: "5", label: "5 PN"}, {value: "6", label: "6 PN"}, 
                {value: ">6", label: "> 6 PN"}
            ]
        });
        // 2. WC
        buildMultiSelectDropdown({
            listId: "wc-list-checkboxes",
            displayId: "wc-display-text",
            suffix: " WC",
            options: [
                {value: "1", label: "1 WC"}, {value: "2", label: "2 WC"}, 
                {value: "3", label: "3 WC"}, {value: "4", label: "4 WC"}, 
                {value: "5", label: "5 WC"}, {value: ">5", label: "> 5 WC"}
            ]
        });
        // 3. T·∫ßng
        buildMultiSelectDropdown({
            listId: "floors-list-checkboxes",
            displayId: "floors-display-text",
            suffix: " T·∫ßng",
            options: [
                {value: "1", label: "1 T·∫ßng"}, {value: "2", label: "2 T·∫ßng"}, 
                {value: "3", label: "3 T·∫ßng"}, {value: "4", label: "4 T·∫ßng"}, 
                {value: "5", label: "5 T·∫ßng"}, {value: ">5", label: "> 5 T·∫ßng"}
            ]
        });
    }
    // 3. H√†m c·∫≠p nh·∫≠t Ph∆∞·ªùng (Khi ch·ªçn nhi·ªÅu qu·∫≠n, hi·ªÉn th·ªã t·∫•t c·∫£ ph∆∞·ªùng c·ªßa c√°c qu·∫≠n ƒë√≥)
    function updateWardOptionsMulti() {
        const selectedDistricts = getSelectedDistricts();
        const selectWard = document.getElementById("filter-ward");
        selectWard.innerHTML = '<option value="">T·∫•t c·∫£</option>';

        if (selectedDistricts.length === 0) return; // N·∫øu kh√¥ng ch·ªçn qu·∫≠n n√†o th√¨ th√¥i

        let allWards = [];
        selectedDistricts.forEach(dist => {
            if (HCM_DATA[dist]) {
                // Th√™m prefix t√™n qu·∫≠n v√†o ƒë·ªÉ d·ªÖ nh√¨n n·∫øu danh s√°ch qu√° d√†i (Tu·ª≥ ch·ªçn)
                // Ho·∫∑c c·ª© ƒë·∫©y th·∫≥ng t√™n ph∆∞·ªùng v√†o
                allWards = [...allWards, ...HCM_DATA[dist]];
            }
        });
        
        // Lo·∫°i b·ªè tr√πng l·∫∑p v√† s·∫Øp x·∫øp
        allWards = [...new Set(allWards)].sort();

        allWards.forEach((w) => {
            const opt = document.createElement("option");
            opt.value = w;
            opt.textContent = w;
            selectWard.appendChild(opt);
        });
    }
// ============================================================
    // C·∫§U H√åNH B·∫¢N ƒê·ªí LEAFLET (OPENSTREETMAP - MI·ªÑN PH√ç)
    // ============================================================
    let MAP_INSTANCE = null;
    let MAP_MARKERS = [];
    let MARKER_CLUSTER_GROUP = null;
    // 1. H√†m kh·ªüi t·∫°o b·∫£n ƒë·ªì
    function initStaffMap() {
      // N·∫øu map ƒë√£ t·∫°o r·ªìi th√¨ kh√¥ng t·∫°o l·∫°i
      if (MAP_INSTANCE) return;

      const el = document.getElementById("premises-map");
      if (!el) return;

      // T·∫°o map, set trung t√¢m l√† TP.HCM (10.7769, 106.7009), zoom 13
      MAP_INSTANCE = L.map('premises-map').setView([10.7769, 106.7009], 13);

      // QUAN TR·ªåNG: Th√™m l·ªõp n·ªÅn OpenStreetMap (c√°i n√†y Google Maps kh√¥ng c·∫ßn nh∆∞ng Leaflet b·∫Øt bu·ªôc)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(MAP_INSTANCE);
    }

    // 2. H√†m x√≥a c√°c marker c≈© khi l·ªçc l·∫°i
    function clearMapMarkers() {
      if (MAP_MARKERS.length > 0) {
        MAP_MARKERS.forEach(marker => marker.remove()); // L·ªánh x√≥a c·ªßa Leaflet
        MAP_MARKERS = [];
      }
    }

    // 3. H√†m v·∫Ω marker l√™n b·∫£n ƒë·ªì
// 3. H√†m v·∫Ω marker (S·ª¨ D·ª§NG CLUSTER ƒê·ªÇ CH·ªêNG CH·ªíNG CH√âO)
    function renderMapMarkers(rows) {
      const mapView = document.getElementById("map-view");
      if (mapView && mapView.classList.contains("hidden")) return;

      initStaffMap();

      // Fix l·ªói map x√°m khi resize
      setTimeout(() => {
         if(MAP_INSTANCE) MAP_INSTANCE.invalidateSize();
      }, 100);

      // --- X√ìA LAYER C≈® ---
      // N·∫øu ƒë√£ c√≥ nh√≥m cluster c≈© th√¨ x√≥a kh·ªèi b·∫£n ƒë·ªì v√† clear d·ªØ li·ªáu
      if (MARKER_CLUSTER_GROUP) {
          MARKER_CLUSTER_GROUP.clearLayers();
          MAP_INSTANCE.removeLayer(MARKER_CLUSTER_GROUP);
      }
      
      // Reset m·∫£ng markers qu·∫£n l√Ω th·ªß c√¥ng (n·∫øu c·∫ßn)
      MAP_MARKERS = [];

      if (!rows || !rows.length || !MAP_INSTANCE) return;

      // --- KH·ªûI T·∫†O CLUSTER GROUP M·ªöI ---
      MARKER_CLUSTER_GROUP = L.markerClusterGroup({
          maxClusterRadius: 40, // B√°n k√≠nh gom nh√≥m (px). S·ªë nh·ªè th√¨ gom √≠t, s·ªë l·ªõn gom nhi·ªÅu.
          spiderfyOnMaxZoom: true, // Quan tr·ªçng: N·∫øu tr√πng v·ªã tr√≠, click v√†o s·∫Ω xo√® ra
          showCoverageOnHover: false, // T·∫Øt hi·ªÉn th·ªã v√πng bao ph·ªß khi hover (cho ƒë·∫πp)
          zoomToBoundsOnClick: true, // Click v√†o nh√≥m s·∫Ω zoom v√†o
          
          // T√πy ch·ªânh icon c·ªßa nh√≥m (Optional - n·∫øu mu·ªën ƒë·∫πp h∆°n m·∫∑c ƒë·ªãnh)
          
          iconCreateFunction: function(cluster) {
              return L.divIcon({ 
                  html: '<div style="background:#3b82f6; color:white; border-radius:50%; width:30px; height:30px; display:flex; justify-content:center; align-items:center; font-weight:bold; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3)">' + cluster.getChildCount() + '</div>', 
                  className: 'my-cluster-icon', 
                  iconSize: L.point(30, 30) 
              });
          }
          
      });

      rows.forEach((row) => {
        if (!row.lat || !row.lng) return;
        const lat = Number(row.lat);
        const lng = Number(row.lng);

        // X·ª≠ l√Ω hi·ªÉn th·ªã gi√°
        let displayPrice = "TL";
        if (row.price) {
           if (row.price >= 1000000000) {
             displayPrice = (row.price / 1000000000).toFixed(1) + " T·ª∑";
           } else if (row.price >= 1000000) {
             displayPrice = (row.price / 1000000).toFixed(1) + " Tr";
           } else {
             displayPrice = new Intl.NumberFormat('vi-VN').format(row.price);
           }
           displayPrice = displayPrice.replace(".0 ", " ");
        }

        const title = (typeof buildTitle === 'function' ? buildTitle(row) : row.address) || "M·∫∑t b·∫±ng";
        
        // T·∫°o icon gi√° ti·ªÅn
        const priceIcon = L.divIcon({
          className: '', 
          html: `<div class="price-marker-label">${displayPrice}</div>`,
          iconSize: [null, null],
          iconAnchor: [20, 10]
        });

        // T·∫°o marker nh∆∞ng KH√îNG addTo(MAP_INSTANCE) ngay l·∫≠p t·ª©c
        const marker = L.marker([lat, lng], { icon: priceIcon });

        // T·∫°o Popup
        const infoContent = `
          <div style="min-width: 200px; font-family: system-ui, sans-serif;">
            <div style="font-weight: bold; color: #000; margin-bottom: 4px; font-size: 13px;">
                ${title}
            </div>
            <div style="color: #d32f2f; font-weight: bold; margin-bottom: 6px;">
                ${money(row.price)}
            </div>
            <div style="font-size: 12px; color: #555; margin-bottom: 8px;">
               ${row.address || row.street || "ƒêang c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ..."}
            </div>
            <button 
              onclick="openDetail('${row.id}')"
              class="btn btn-xs btn-primary w-full text-white" 
              style="width: 100%; padding: 6px; background-color: #4f46e5; color: white; border-radius: 4px; border: none; cursor: pointer;">
              Xem chi ti·∫øt
            </button>
          </div>
        `;

        marker.bindPopup(infoContent);
        
        // Hi·ªáu ·ª©ng hover marker
        marker.on('mouseover', function (e) { this.setZIndexOffset(1000); });
        marker.on('mouseout', function (e) { this.setZIndexOffset(0); });

        // QUAN TR·ªåNG: Th√™m marker v√†o Cluster Group
        MARKER_CLUSTER_GROUP.addLayer(marker);
        
        // (T√πy ch·ªçn) V·∫´n ƒë·∫©y v√†o m·∫£ng qu·∫£n l√Ω n·∫øu c·∫ßn x·ª≠ l√Ω logic kh√°c
        MAP_MARKERS.push(marker);
      });

      // Cu·ªëi c√πng: Th√™m Cluster Group v√†o b·∫£n ƒë·ªì
      MAP_INSTANCE.addLayer(MARKER_CLUSTER_GROUP);

      // Fit bounds ƒë·ªÉ nh√¨n th·∫•y t·∫•t c·∫£ c√°c ƒëi·ªÉm
      if (MAP_MARKERS.length > 0) {
        MAP_INSTANCE.fitBounds(MARKER_CLUSTER_GROUP.getBounds(), { padding: [50, 50] });
      }
    }
    // BI·∫æN M·ªöI CHO ADMIN DUY·ªÜT B√ÄI
    let SHOW_PENDING = false;
    // üëâ ch·∫ø ƒë·ªô xem danh s√°ch tin nh√¢n s·ª± ƒë√£ b√°o h·∫øt (admin)
    let SHOW_REPORTED = false;
    // ƒê·∫øm s·ªë m·∫∑t b·∫±ng nh√¢n s·ª± ƒë√£ b√°o h·∫øt nh∆∞ng admin ch∆∞a x√°c nh·∫≠n
    async function checkRentedReportCount() {
      const { count } = await db
        .from("premises")
        .select("*", { count: "exact", head: true })
        .not("rented_reported_at", "is", null)
        .is("rented_confirmed_at", null);

      const cnt = count || 0;
      const span = document.getElementById("count-rented-reports");
      if (span) span.textContent = cnt;
    }

    function toggleReportedMode() {
      SHOW_REPORTED = !SHOW_REPORTED;
      const btn = document.getElementById("btn-toggle-rented-reports");
      if (!btn) return;

      if (SHOW_REPORTED) {
        btn.classList.add("btn-active");
        btn.textContent = "ƒêang xem B√°o h·∫øt (Tho√°t)";
      } else {
        btn.classList.remove("btn-active");
        btn.innerHTML =
          `B√°o h·∫øt <span class="badge badge-sm bg-white text-error ml-1 border-none" id="count-rented-reports">...</span>`;
        checkRentedReportCount();
      }
      applyFilters(true);
    }
    // üëâ ch·∫ø ƒë·ªô xem danh s√°ch tin y√™u c·∫ßu ch·∫°y l·∫°i (admin)
    let SHOW_REACTIVATE = false;

    // ƒê·∫øm s·ªë m·∫∑t b·∫±ng y√™u c·∫ßu ch·∫°y l·∫°i, admin ch∆∞a duy·ªát
    async function checkReactivateCount() {
      try {
        const { count, error } = await db
          .from("premises")
          .select("*", { count: "exact", head: true })
          .not("reactivate_reported_at", "is", null)
          .is("reactivate_confirmed_at", null);

        if (error) throw error;
        const cnt = count || 0;
        const span = document.getElementById("count-reactivate");
        if (span) span.textContent = cnt;
      } catch (err) {
        console.error("checkReactivateCount error", err);
      }
    }

    function toggleReactivateMode() {
      SHOW_REACTIVATE = !SHOW_REACTIVATE;
      const btn = document.getElementById("btn-toggle-reactivate");
      if (!btn) return;

      if (SHOW_REACTIVATE) {
        btn.classList.add("btn-active");
        btn.textContent = "ƒêang xem Duy·ªát ch·∫°y l·∫°i (Tho√°t)";
      } else {
        btn.classList.remove("btn-active");
        btn.innerHTML =
          `Duy·ªát ch·∫°y l·∫°i <span class="badge badge-sm bg-white text-info ml-1 border-none" id="count-reactivate">...</span>`;
        checkReactivateCount();
      }

      applyFilters(true);
    }
    // ===== HELPERS =====
    function toast(msg) {
      const toastEl = document.getElementById("toast");
      const textEl = document.getElementById("toast-text");
      textEl.textContent = msg;
      toastEl.classList.remove("hidden");
      setTimeout(() => toastEl.classList.add("hidden"), 2500);
    }

    function money(v) {
      if (v == null || isNaN(v)) return "";
      return new Intl.NumberFormat("vi-VN").format(v) + " ƒë";
    }

    function formatDateVN(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleDateString("vi-VN");
    }

    function pickField(obj, names) {
      for (const n of names) {
        if (obj && obj[n] !== undefined && obj[n] !== null && obj[n] !== "") {
          return obj[n];
        }
      }
      return null;
    }

    function isAdmin() { return CURRENT_ROLE === "admin"; }
    function isStaff() { return CURRENT_ROLE === "staff"; }
    // --- GHIM M·∫∂T B·∫∞NG THEO NH√ÇN S·ª∞ (L∆ØU LOCAL) ---
    let FAVORITES_MODE = false;

    function getFavoriteStorageKey() {
      if (CURRENT_USER && CURRENT_USER.id) {
        return "idland_favorites_" + CURRENT_USER.id;
      }
      // fallback n·∫øu ch∆∞a login (√≠t d√πng)
      return "idland_favorites_guest";
    }

    function getFavoriteIds() {
      try {
        const raw = localStorage.getItem(getFavoriteStorageKey());
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch (e) {
        console.warn("getFavoriteIds error", e);
        return [];
      }
    }

    function saveFavoriteIds(ids) {
      try {
        localStorage.setItem(getFavoriteStorageKey(), JSON.stringify(ids));
      } catch (e) {
        console.warn("saveFavoriteIds error", e);
      }
    }

    function toggleFavorite(e, id) {
      if (e) e.stopPropagation(); // ‚¨Ö ƒë·ªÉ khi b·∫•m sao kh√¥ng b·ªã m·ªü popup

      if (!CURRENT_USER) {
        toast("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ghim s·∫£n ph·∫©m.");
        return;
      }

      let ids = getFavoriteIds();
      const idx = ids.indexOf(id);
      let isFav = false;

      if (idx === -1) {
        ids.push(id);
        isFav = true;
      } else {
        ids.splice(idx, 1);
        isFav = false;
      }

      saveFavoriteIds(ids);

      // C·∫≠p nh·∫≠t icon / m√†u cho t·∫•t c·∫£ n√∫t sao c·ªßa id n√†y
      document.querySelectorAll(`.fav-btn[data-id="${id}"]`).forEach(btn => {
        btn.classList.toggle("btn-error", isFav);
        btn.classList.toggle("text-white", isFav);
        btn.classList.toggle("btn-ghost", !isFav);
        btn.textContent = isFav ? "‚òÖ" : "‚òÜ";
      });

      // N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô ch·ªâ xem ghim th√¨ render l·∫°i
      if (FAVORITES_MODE) {
        const favSet = new Set(ids);
        const filtered = (LAST_ROWS || []).filter(r => favSet.has(r.id));
        renderCards(filtered, true);
        const showEl = document.getElementById("count-show");
        if (showEl) showEl.textContent = filtered.length;
      }
    }


    function toggleFavoriteMode() {
      FAVORITES_MODE = !FAVORITES_MODE;
      const btn = document.getElementById("btn-toggle-favorites");
      if (!btn) return;

      if (FAVORITES_MODE) {
        btn.classList.add("btn-active");
        btn.textContent = "ƒêang xem: M·∫∑t b·∫±ng ƒë√£ ghim (tho√°t)";

        const favSet = new Set(getFavoriteIds());
        const filtered = (LAST_ROWS || []).filter(r => favSet.has(r.id));
        renderCards(filtered, true);

        const showEl = document.getElementById("count-show");
        if (showEl) showEl.textContent = filtered.length;
      } else {
        btn.classList.remove("btn-active");
        btn.textContent = "Xem m·∫∑t b·∫±ng ƒë√£ ghim";

        renderCards(LAST_ROWS || [], true);
        const showEl = document.getElementById("count-show");
        if (showEl) {
          showEl.textContent = Math.min((PAGE + 1) * PAGE_SIZE, TOTAL_COUNT);
        }
      }
    }


    function maskAddress(row) {
      const full = row.address || "";
      // N·∫æU L√Ä ADMIN TH√å HI·ªÜN H·∫æT
      if (isAdmin()) return full || row.street; 

      if (!isStaff()) return full || [row.street, row.ward, row.district].filter(Boolean).join(", ");

      if (full) {
        const parts = full.split(" ");
        if (parts.length > 1) {
          parts.shift();
          return parts.join(" ");
        }
        return full;
      }
      return [row.street, row.ward, row.district].filter(Boolean).join(", ");
    }

    function buildImageUrl(path) {
      if (!path) return null;
      if (path.startsWith('http')) return path; // H·ªó tr·ª£ link ƒë·∫ßy ƒë·ªß
      const { data } = db.storage.from(STORAGE_BUCKET).getPublicUrl(path);
      return data?.publicUrl || null;
    }

    function formatCurrencyInput(el) {
        let val = el.value.replace(/\D/g, '');
        if(val) el.value = new Intl.NumberFormat('vi-VN').format(val);
    }

    // ===== AUTH =====
    async function initAuth() {
      // S·ª¨A: d√πng db thay v√¨ supabase
      const { data } = await db.auth.getUser();
      
      if (!data.user) {
        document.getElementById("auth-section").classList.remove("hidden");
        document.getElementById("app-root").classList.add("hidden");
        return;
      }

      // N·∫øu l√† Admin -> hi·ªán n√∫t duy·ªát b√†i + n√∫t B√°o h·∫øt
      if (isAdmin()) {
        document.getElementById("admin-pending-controls").classList.remove("hidden");
        // L∆∞u √Ω: C√°c h√†m con b√™n d∆∞·ªõi c≈©ng c·∫ßn s·ª≠a supabase -> db
        checkPendingCount();
        checkRentedReportCount();
        checkReactivateCount();
      }

      CURRENT_USER = data.user;

      // --- L·∫§Y ROLE T·ª™ B·∫¢NG PROFILES ---
      let role = "staff";
      let userEmail = CURRENT_USER.email;
      
      // S·ª¨A: Ch·ªó n√†y file c≈© c·ªßa b·∫°n ƒëang d√πng 'supabase' -> G√¢y l·ªói vƒÉng ra
      const { data: profile } = await db
        .from("profiles")
        .select("role, email")
        .eq("id", CURRENT_USER.id)
        .maybeSingle();
      
      if (profile) {
          if (profile.role) role = profile.role;
          if (profile.email) userEmail = profile.email;
      }
      CURRENT_ROLE = role;

      // ƒêO·∫†N QUAN TR·ªåNG NH·∫§T: CHUY·ªÇN M√ÄN H√åNH
      // V√¨ code tr√™n ƒë√£ s·ª≠a xong, d√≤ng n√†y s·∫Ω ch·∫°y ƒë∆∞·ª£c
      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("app-root").classList.remove("hidden");
      
      // Hi·ªÉn th·ªã t√™n/role
      document.getElementById("user-email-display").textContent = userEmail;
      const roleBadge = document.getElementById("role-badge");
      roleBadge.textContent = (role === "admin" ? "Admin" : "Nh√¢n s·ª±");
      
      if (role === "admin") {
          roleBadge.className = "badge badge-error text-white";
          document.getElementById("admin-pending-controls").classList.remove("hidden");
          checkPendingCount();
      } else {
          roleBadge.className = "badge badge-outline";
      }

      await applyFilters(true);
      await buildDistrictWardOptions();
      initAddFormDropdowns();
    }

    
    function showDemoNotice() {
      const dlg = document.getElementById("demoNoticeDlg");
      if (dlg && typeof dlg.showModal === "function") {
        dlg.showModal();
      }
    }

    async function handleLogin() {
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value.trim();
      if (!email || !password) {
        toast("Vui l√≤ng nh·∫≠p email & m·∫≠t kh·∫©u");
        return;
      }
      const { error } = await db.auth.signInWithPassword({ email, password });
      if (error) {
        console.error(error);
        toast("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + error.message);
        return;
      }
      toast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng");
      showDemoNotice();
      await initAuth();
    }

    
    async function handleLogout() {
      await db.auth.signOut();
      location.reload();
    }

    // ===== FILTERS =====
    function getFilterValues() {
      return {
        keyword: document.getElementById("filter-keyword").value.trim(),
        
        // --- S·ª¨A D√íNG N√ÄY: G·ªçi h√†m l·∫•y m·∫£ng thay v√¨ .value ---
        district: getSelectedDistricts(), 
        
        ward: document.getElementById("filter-ward").value,
        priceMin: Number(document.getElementById("filter-price-min").value) || null,
        priceMax: Number(document.getElementById("filter-price-max").value) || null,
        areaMin: Number(document.getElementById("filter-area-min").value) || null,
        areaMax: Number(document.getElementById("filter-area-max").value) || null,
        widthMin: Number(document.getElementById("filter-width-min").value) || null,
        lengthMin: Number(document.getElementById("filter-length-min").value) || null,
        pn: getMultiValues("pn-list-checkboxes"),
        wc: getMultiValues("wc-list-checkboxes"),
        floors: getMultiValues("floors-list-checkboxes"),
        frontageType: document.getElementById("filter-frontage-type").value,
        status: document.getElementById("filter-status").value,
      };
    }

    // --- C·∫¨P NH·∫¨T: applyFilters (V·∫º FULL B·∫¢N ƒê·ªí) ---

    // --- C·∫¨P NH·∫¨T: applyFilters (ƒê√É S·ª¨A LOGIC ADMIN) ---
    async function applyFilters(resetPage = false) {
      if (resetPage) PAGE = 0;
      const f = getFilterValues();

      // 1. T·∫°o Query c∆° s·ªü (D√πng chung cho c·∫£ List v√† Map)
      const buildBaseQuery = () => {
          let q = db.from("premises").select("*", { count: "exact" });
          
          // --- LOGIC QUAN TR·ªåNG: X·ª¨ L√ù C√ÅC CH·∫æ ƒê·ªò ADMIN ---
          
          // 1. N·∫øu ƒëang xem "B√°o h·∫øt" (Nh√¢n s·ª± b√°o, ch·ªù Admin duy·ªát)
          if (typeof SHOW_REPORTED !== 'undefined' && SHOW_REPORTED) {
             q = q.not("rented_reported_at", "is", null)  // C√≥ ng√†y b√°o h·∫øt
                  .is("rented_confirmed_at", null);       // Ch∆∞a ƒë∆∞·ª£c duy·ªát
          }
          // 2. N·∫øu ƒëang xem "Duy·ªát ch·∫°y l·∫°i" (H√†ng h·∫øt mu·ªën ch·∫°y l·∫°i)
          else if (typeof SHOW_REACTIVATE !== 'undefined' && SHOW_REACTIVATE) {
             q = q.not("reactivate_reported_at", "is", null) // C√≥ ng√†y b√°o ch·∫°y l·∫°i
                  .is("reactivate_confirmed_at", null);      // Ch∆∞a ƒë∆∞·ª£c duy·ªát
          }
          // 3. N·∫øu ƒëang xem "C·∫ßn duy·ªát" (Tin m·ªõi t·∫°o)
          else if (typeof SHOW_PENDING !== 'undefined' && SHOW_PENDING && isAdmin()) {
             q = q.eq("is_approved", false);
          }
          // 4. M·∫∑c ƒë·ªãnh: Ch·ªâ hi·ªán tin ƒê√É DUY·ªÜT
          else {
             q = q.eq("is_approved", true);
          }

          // -- √Åp d·ª•ng ti·∫øp c√°c b·ªô l·ªçc (ƒë·ªÉ Admin c√≥ th·ªÉ t√¨m ki·∫øm trong danh s√°ch c·∫ßn duy·ªát) --
          if (f.keyword) {
            const kw = "%" + f.keyword + "%";
            q = q.or(`address.ilike.${kw},street.ilike.${kw},ward.ilike.${kw},district.ilike.${kw},code.ilike.${kw}`);
          }
          if (f.district && f.district.length > 0) {
              q = q.in("district", f.district);
          }
          if (f.ward) q = q.eq("ward", f.ward);
          
          // L∆∞u √Ω: Khi ƒëang xem "B√°o h·∫øt" ho·∫∑c "Ch·∫°y l·∫°i", ta kh√¥ng l·ªçc theo status 
          // v√¨ status l√∫c ƒë√≥ c√≥ th·ªÉ l√† 'rented' ho·∫∑c 'available' t√πy ng·ªØ c·∫£nh.
          // Ch·ªâ l·ªçc status khi ·ªü ch·∫ø ƒë·ªô xem b√¨nh th∆∞·ªùng
          if (!SHOW_REPORTED && !SHOW_REACTIVATE && f.status) {
              q = q.eq("status", f.status);
          }

          if (f.priceMin != null) q = q.gte("price", f.priceMin * 1000000);
          if (f.priceMax != null) q = q.lte("price", f.priceMax * 1000000);
          if (f.areaMin != null) q = q.gte("area", f.areaMin);
          if (f.areaMax != null) q = q.lte("area", f.areaMax);
          if (f.widthMin != null) {
              q = q.gte("width", f.widthMin); // L·ªçc chi·ªÅu ngang >= gi√° tr·ªã nh·∫≠p
          }
          if (f.lengthMin != null) {
              q = q.gte("length", f.lengthMin); // L·ªçc chi·ªÅu d√†i >= gi√° tr·ªã nh·∫≠p
          }
          // --- X·ª¨ L√ù S·ªê PN (ƒêA L·ª∞A CH·ªåN) ---
          if (f.pn && f.pn.length > 0) {
             const exactNums = f.pn.filter(x => !x.includes(">")); // L·∫•y s·ªë th∆∞·ªùng: ["2", "3"]
             const hasGt = f.pn.find(x => x.includes(">"));        // L·∫•y d·∫•u >: ">6"
             
             if (hasGt) {
                 // N·∫øu ch·ªçn c·∫£ s·ªë c·ª• th·ªÉ V√Ä >6 (VD: Ch·ªçn 2, 3 v√† >6)
                 // Logic: (pn IN (2,3)) HO·∫∂C (pn > 6)
                 const gtVal =parseInt(hasGt.replace(">", ""));
                 if (exactNums.length > 0) {
                     q = q.or(`pn.in.(${exactNums.join(',')}),pn.gt.${gtVal}`);
                 } else {
                     q = q.gt("pn", gtVal); // Ch·ªâ ch·ªçn >6
                 }
             } else {
                 // Ch·ªâ ch·ªçn s·ªë c·ª• th·ªÉ
                 q = q.in("pn", exactNums);
             }
          }

          // --- X·ª¨ L√ù S·ªê WC (ƒêA L·ª∞A CH·ªåN) ---
          if (f.wc && f.wc.length > 0) {
             const exactNums = f.wc.filter(x => !x.includes(">"));
             const hasGt = f.wc.find(x => x.includes(">"));
             
             if (hasGt) {
                 const gtVal = parseInt(hasGt.replace(">", ""));
                 if (exactNums.length > 0) {
                     q = q.or(`wc.in.(${exactNums.join(',')}),wc.gt.${gtVal}`);
                 } else {
                     q = q.gt("wc", gtVal);
                 }
             } else {
                 q = q.in("wc", exactNums);
             }
          }

          // --- X·ª¨ L√ù S·ªê T·∫¶NG (ƒêA L·ª∞A CH·ªåN) ---
          if (f.floors && f.floors.length > 0) {
             const exactNums = f.floors.filter(x => !x.includes(">"));
             const hasGt = f.floors.find(x => x.includes(">"));
             
             if (hasGt) {
                 const gtVal = parseInt(hasGt.replace(">", ""));
                 if (exactNums.length > 0) {
                     q = q.or(`floors.in.(${exactNums.join(',')}),floors.gt.${gtVal}`);
                 } else {
                     q = q.gt("floors", gtVal);
                 }
             } else {
                 q = q.in("floors", exactNums);
             }
          }

          return q;
      };

      // --- NHI·ªÜM V·ª§ 1: L·∫§Y D·ªÆ LI·ªÜU DANH S√ÅCH ---
      const from = PAGE * PAGE_SIZE;
      const to = from + PAGE_SIZE - 1;
      
      let listQuery = buildBaseQuery()
        .order("updated_at", { ascending: false }) // ∆Øu ti√™n c√°i m·ªõi c·∫≠p nh·∫≠t
        .range(from, to);

      const { data, error, count } = await listQuery;

      if (error) {
        console.error(error);
        toast("L·ªói t·∫£i d·ªØ li·ªáu: " + error.message);
        return;
      }

      // Filter Client-side (H·∫ªm/HXH)
      let rows = data || [];
      if (f.frontageType === "hem" || f.frontageType === "hxh") {
         rows = rows.filter((row) => {
            const isFront = row.frontage === true;
            const txt = ((row.address || "") + " " + (row.detail || "")).toLowerCase();
            if (f.frontageType === "hxh") return !isFront && (txt.includes("hxh") || txt.includes("xe h∆°i"));
            if (f.frontageType === "hem") return !isFront && !txt.includes("hxh") && !txt.includes("xe h∆°i");
            return true;
         });
      }

      // N·∫øu KH√îNG ph·∫£i ch·∫ø ƒë·ªô Admin, s·∫Øp x·∫øp status (C√≤n tr·ªëng l√™n ƒë·∫ßu)
      if (!SHOW_REPORTED && !SHOW_REACTIVATE && !SHOW_PENDING) {
          const STATUS_ORDER = { available: 0, deposited: 1, rented: 2 };
          rows.sort((a, b) => (STATUS_ORDER[a.status] ?? 99) - (STATUS_ORDER[b.status] ?? 99));
      }

      LAST_ROWS = rows;
      TOTAL_COUNT = count || 0;

      // Render
      if (PAGE === 0) renderCards(LAST_ROWS, true);
      else renderCards(LAST_ROWS, false);
      
      if (CURRENT_VIEW === 'table') {
          renderTable(LAST_ROWS);
      }
      // UI update
      const showCountEl = document.getElementById("count-show");
      const totalCountEl = document.getElementById("count-total");
      if(showCountEl) showCountEl.textContent = Math.min((PAGE + 1) * PAGE_SIZE, TOTAL_COUNT);
      if(totalCountEl) totalCountEl.textContent = TOTAL_COUNT;
      
      const btnMore = document.getElementById("btn-load-more");
      if(btnMore) {
          if ((PAGE + 1) * PAGE_SIZE >= TOTAL_COUNT) {
              btnMore.textContent = "H·∫øt d·ªØ li·ªáu";
              btnMore.classList.add("btn-disabled");
          } else {
              btnMore.textContent = "T·∫£i th√™m";
              btnMore.classList.remove("btn-disabled");
          }
      }

      // --- NHI·ªÜM V·ª§ 2: L·∫§Y D·ªÆ LI·ªÜU B·∫¢N ƒê·ªí ---
      if (PAGE === 0) {
          let mapQuery = buildBaseQuery() 
            .select("id, lat, lng, price, address, street, district, ward") 
            .not("lat", "is", null);

          const { data: mapData } = await mapQuery;
          
          if (mapData && mapData.length > 0) {
              renderMapMarkers(mapData);
          } else {
              clearMapMarkers();
          }
      }
    }

    function renderCards(rows, replace) {
      const grid = document.getElementById("grid");
      if (replace) grid.innerHTML = "";

      if (!rows || rows.length === 0) {
        if (PAGE === 0) {
          grid.innerHTML = `
            <div class="col-span-full text-center text-sm opacity-70 py-10">
              Ch∆∞a c√≥ m·∫∑t b·∫±ng n√†o kh·ªõp b·ªô l·ªçc hi·ªán t·∫°i.
            </div>`;
        }
        return;
      }

      const favSet = new Set(getFavoriteIds());
      const sortedRows = [...rows].sort((a, b) => {
        const af = favSet.has(a.id);
        const bf = favSet.has(b.id);
        if (af === bf) return 0;
        return af ? -1 : 1; 
      });

      const html = sortedRows.map((row) => {
        // --- 1. T√çNH TO√ÅN D·ªÆ LI·ªÜU ---
        let firstPath = null;
        if (Array.isArray(row.images) && row.images.length > 0) firstPath = row.images[0];
        else if (typeof row.images === "string" && row.images.trim()) {
          try {
            if (row.images.startsWith("[")) firstPath = JSON.parse(row.images)[0];
            else firstPath = row.images.split(/[\n;,]+/)[0];
          } catch (e) {}
        }
        const imgUrl = firstPath ? buildImageUrl(firstPath) : null;

        let title = "ƒêang c·∫≠p nh·∫≠t";
        try { title = buildTitle(row); } catch(e) {}
        if (!title || title === "") title = row.address || "M·∫∑t b·∫±ng ch∆∞a c√≥ t√™n";

        const pnVal = row.pn || row.so_pn || row.bedrooms || row.rooms || "";
        const updatedLabel = formatDateVN(row.updated_at || row.created_at);

        const staffReportBadge =
          row.rented_reported_at && row.status !== "rented"
            ? `<span class="badge badge-xs badge-warning border-none ml-1">NS b√°o h·∫øt</span>`
            : "";

        let approveBtn = "";
        if (typeof SHOW_PENDING !== 'undefined' && SHOW_PENDING && isAdmin()) {
          approveBtn = `
            <button onclick="approveOne('${row.id}', event)" 
              class="btn btn-xs btn-success text-white px-2 shadow-sm z-30 relative ml-auto">
              ‚úî Duy·ªát
            </button>`;
        }

        const isFav = favSet.has(row.id);
        const favBtnHtml = `
            <button 
              type="button"
              class="fav-btn btn btn-sm btn-circle border-none shadow-md ${isFav ? 'bg-white text-yellow-500' : 'bg-white/90 text-gray-400 hover:bg-white text-lg'}"
              data-id="${row.id}" 
              onclick="toggleFavorite(event, '${row.id}')"
              title="${isFav ? 'B·ªè ghim' : 'Ghim tin n√†y'}"
            >
              ${isFav ? '‚òÖ' : '‚òÜ'}
            </button>
        `;

        // --- X·ª¨ L√ù FORMAT S·ªê LI·ªÜU ---
        // Di·ªán t√≠ch: L√†m tr√≤n 2 s·ªë th·∫≠p ph√¢n, n·∫øu .00 th√¨ b·ªè ƒëi cho g·ªçn
        const areaDisplay = row.area 
            ? Number(row.area).toFixed(2).replace(/\.00$/, '') 
            : "";
        // ... (ƒêo·∫°n code c≈© trong renderCards) ...
        const updatedLabel = formatDateVN(row.updated_at || row.created_at);

        // --- ƒêO·∫†N CODE M·ªöI: X√ÅC ƒê·ªäNH NG∆Ø·ªúI B√ÅO ---
        let reporterInfo = "";
        
        // Tr∆∞·ªùng h·ª£p 1: ƒêang ch·ªù duy·ªát b√°o h·∫øt
        if (row.rented_reported_at && !row.rented_confirmed_at) {
             reporterInfo = `<div class="mt-1 text-[10px] font-bold text-error bg-red-50 p-1 rounded border border-red-100 truncate">
                                üë§ B√°o h·∫øt: ${row.rented_reporter_email || '·∫®n danh'}
                             </div>`;
        } 
        // Tr∆∞·ªùng h·ª£p 2: ƒêang ch·ªù duy·ªát ch·∫°y l·∫°i
        else if (row.reactivate_reported_at && !row.reactivate_confirmed_at) {
             reporterInfo = `<div class="mt-1 text-[10px] font-bold text-info bg-blue-50 p-1 rounded border border-blue-100 truncate">
                                üë§ B√°o ch·∫°y l·∫°i: ${row.reactivate_reporter_email || '·∫®n danh'}
                             </div>`;
        }
        // Tr∆∞·ªùng h·ª£p 3: Tin m·ªõi ch·ªù duy·ªát (Pending)
        else if (row.is_approved === false) {
             reporterInfo = `<div class="mt-1 text-[10px] font-bold text-warning bg-yellow-50 p-1 rounded border border-yellow-100 truncate">
                                üë§ Ng∆∞·ªùi ƒëƒÉng: ${row.creator_email || '·∫®n danh'}
                             </div>`;
        }

        return `
          <article 
            class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer premise-card overflow-hidden flex flex-row md:flex-col h-[125px] md:h-auto group relative mb-2"
            data-id="${row.id}">
            
            <figure class="w-[120px] md:w-full md:h-52 bg-gray-100 shrink-0 relative border-r md:border-r-0 md:border-b border-gray-100">
              <div id="thumb-box-${row.id}" 
                class="w-full h-full flex items-center justify-center overflow-hidden">
                ${
                  imgUrl
                    ? `<img src="${imgUrl}" alt="img" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />`
                    : `<div class="text-[10px] text-gray-400 flex flex-col items-center gap-1"><span>üì∑ No IMG</span></div>`
                }
              </div>
              <div class="absolute top-1.5 right-1.5 z-20 flex flex-col gap-1 items-end pointer-events-auto">
                 ${staffReportBadge}
                 ${favBtnHtml}
              </div>
            </figure>

            <div class="flex-1 p-2 md:p-3 flex flex-col justify-between min-w-0 bg-white relative">
              <div>
                <h3 class="font-bold text-xs md:text-sm line-clamp-2 leading-tight text-gray-800 mb-1">
                    ${title}
                </h3>
                <div class="flex items-center gap-1 text-[10px] md:text-xs text-gray-500 truncate mb-1">
                   <span class="opacity-70">üìç</span>
                   <span class="truncate">${[row.ward, row.district].filter(Boolean).join(", ")}</span>
                </div>
                <div class="flex flex-wrap items-center gap-1 text-[10px] text-gray-600 font-medium">
                  ${areaDisplay ? `<span class="bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200">${areaDisplay}m¬≤</span>` : ""}
                  ${row.width ? `<span class="bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200">${row.width}x${row.length}</span>` : ""}
                  ${pnVal ? `<span class="text-gray-400 ml-1">‚Ä¢ ${pnVal}PN</span>` : ""}
                </div>
              </div>

              <div class="flex items-end justify-between mt-1 pt-1 border-t md:border-none border-gray-50">
                <div>
                   <div class="text-blue-600 font-extrabold text-sm md:text-lg leading-none">
                     ${money(row.price)}
                   </div>
                   <div class="text-[9px] text-gray-400 mt-0.5 hidden md:block">
                     ${updatedLabel}
                   </div>
                </div>
                ${approveBtn}
              </div>
            </div>
          </article>
        `;
      });

      grid.insertAdjacentHTML("beforeend", html.join(""));
      
      grid.querySelectorAll(".premise-card").forEach((el) => {
        el.onclick = (e) => {
          if(e.target.closest('button')) { e.stopPropagation(); return; }
          const id = el.getAttribute("data-id");
          if (id) openDetail(id);
        };
      });

      if (typeof scanGridImages === "function") {
        setTimeout(() => {
            scanGridImages(sortedRows).catch(err => console.warn("L·ªói qu√©t ·∫£nh:", err));
        }, 1000);
      }
    }
    // --- H√ÄM KH√îI PH·ª§C: N·∫†P DANH S√ÅCH QU·∫¨N V√ÄO B·ªò L·ªåC ---
    async function buildDistrictWardOptions() {
      const distSelect = document.getElementById("filter-district");
      if (!distSelect) return;

      // Gi·ªØ l·∫°i option ƒë·∫ßu ti√™n (T·∫•t c·∫£) v√† x√≥a c√°c option c≈© n·∫øu c√≥
      distSelect.innerHTML = '<option value="">T·∫•t c·∫£</option>';

      // L·∫•y danh s√°ch t√™n Qu·∫≠n t·ª´ bi·∫øn HCM_DATA (ƒë√£ khai b√°o ·ªü ƒë·∫ßu file)
      const dists = Object.keys(HCM_DATA).sort();
      
      // T·∫°o t·ª´ng d√≤ng option cho Qu·∫≠n
      dists.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        distSelect.appendChild(opt);
      });
      
      console.log("ƒê√£ n·∫°p xong danh s√°ch Qu·∫≠n v√†o b·ªô l·ªçc.");
    }
    // === H√ÄM M·ªöI: L·ªåC PH∆Ø·ªúNG THEO QU·∫¨N T·ª™ HCM_DATA ===
    function updateWardOptions() {
      const district = document.getElementById("filter-district").value;
      const selectWard = document.getElementById("filter-ward");
      selectWard.innerHTML = '<option value="">T·∫•t c·∫£</option>';

      if (!district || !HCM_DATA[district]) return;

      const wards = HCM_DATA[district];
      wards.forEach((w) => {
        const opt = document.createElement("option");
        opt.value = w;
        opt.textContent = w;
        selectWard.appendChild(opt);
      });
    }
    // ===== C√ÅC H√ÄM H·ªñ TR·ª¢ (UTILS) =====

    function buildTitle(item) {
      if (!item) return "";

      const street = item.street ? item.street.toUpperCase() : "";
      const detail = (item.detail || "").toLowerCase();
      const ket = (item.ket_cau || "").toLowerCase();

      // ==== 1. X√ÅC ƒê·ªäNH LO·∫†I H√åNH (MB / NNC) ====
      let type = "NNC"; // m·∫∑c ƒë·ªãnh NNC

      // M·∫∂T B·∫∞NG n·∫øu b√†i c√≥ MB / LDC / LDR trong m√¥ t·∫£
      if (
        detail.includes(" mb") || detail.startsWith("mb ") || detail.includes("mb ") ||
        detail.includes("ldc") ||
        detail.includes("ldr")
      ) {
        type = "MB";
      }

      // N·∫øu kh√¥ng c√≥ MB nh∆∞ng c√≥ k·∫øt c·∫•u nh√† ‚Üí NNC
      if (
        ket.includes("tr·ªát") || ket.includes("tret") ||
        ket.includes("l·∫ßu")  || ket.includes("lau") ||
        ket.includes("l·ª≠ng") || ket.includes("lung") ||
        ket.includes("tum")  ||
        ket.includes("pn")   ||
        ket.includes("wc")
      ) {
        type = "NNC";
      }

      // ==== 2. H∆Ø·ªöNG (MT / HXH / HEM) ====
      let huong = "HEM";
      const addr = (item.address || "").toLowerCase();

      if (item.frontage) huong = "MT";
      else if (addr.includes("/")) huong = "HXH";
      else if (detail.includes("hxh")) huong = "HXH";

      // ==== 3. PN / WC ====
      const pn = item.pn ? `${item.pn}PN` : "";
      const wc = item.wc ? `${item.wc}WC` : "";

      // ==== 4. DI·ªÜN T√çCH ====
      let dientich = "";
      if (item.width && item.length) {
        dientich = `${item.width}X${item.length}`;
      } else if (item.area) {
        dientich = `${item.area}M2`;
      }

      // ==== 5. K·∫æT C·∫§U ====
      const ketcau = item.ket_cau ? item.ket_cau.toUpperCase() : "";

      // ==== 6. QU·∫¨N ====
      let quan = "";
      if (item.district) {
        const q = item.district.replace("Q.", "").replace("Qu·∫≠n", "").trim();
        quan = `QU·∫¨N ${q}`;
      }

      // ==== GH√âP TI√äU ƒê·ªÄ ====
      const parts = [
        type,
        huong,
        street,
        pn,
        wc,
        dientich,
        ketcau,
        quan
      ].filter(p => p);

      return parts.join(" - ").toUpperCase();
    }
    // --- BI·∫æN TO√ÄN C·ª§C CHO B·∫¢N ƒê·ªí CH·ªåN ---
    let PICKER_MAP = null;
    let PICKER_MARKER = null;

    // H√†m kh·ªüi t·∫°o b·∫£n ƒë·ªì ch·ªçn v·ªã tr√≠
    function initPickerMap(mapId, latInputId, lngInputId, initialLat, initialLng) {
        // 1. X√≥a map c≈© n·∫øu ƒë√£ c√≥ (ƒë·ªÉ tr√°nh l·ªói kh·ªüi t·∫°o l·∫°i)
        if (PICKER_MAP) {
            PICKER_MAP.remove();
            PICKER_MAP = null;
            PICKER_MARKER = null;
        }

        const mapEl = document.getElementById(mapId);
        if (!mapEl) return;

        // 2. X√°c ƒë·ªãnh t√¢m b·∫£n ƒë·ªì: ∆Øu ti√™n input > tham s·ªë truy·ªÅn v√†o > M·∫∑c ƒë·ªãnh (HCM)
        let lat = document.getElementById(latInputId).value || initialLat || 10.7769;
        let lng = document.getElementById(lngInputId).value || initialLng || 106.7009;

        // 3. T·∫°o Map
        PICKER_MAP = L.map(mapId).setView([lat, lng], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(PICKER_MAP);

        // 4. T·∫°o Marker c√≥ th·ªÉ k√©o th·∫£ (draggable: true)
        PICKER_MARKER = L.marker([lat, lng], { draggable: true }).addTo(PICKER_MAP);

        // --- S·ª∞ KI·ªÜN QUAN TR·ªåNG: KHI K√âO GHIM ---
        PICKER_MARKER.on('dragend', function(e) {
            const coord = e.target.getLatLng();
            // C·∫≠p nh·∫≠t ng∆∞·ª£c l·∫°i v√†o √¥ Input
            document.getElementById(latInputId).value = coord.lat.toFixed(6);
            document.getElementById(lngInputId).value = coord.lng.toFixed(6);
        });

        // S·ª± ki·ªán click v√†o b·∫£n ƒë·ªì c≈©ng di chuy·ªÉn ghim t·ªõi ƒë√≥
        PICKER_MAP.on('click', function(e) {
            PICKER_MARKER.setLatLng(e.latlng);
            document.getElementById(latInputId).value = e.latlng.lat.toFixed(6);
            document.getElementById(lngInputId).value = e.latlng.lng.toFixed(6);
        });

        // Fix l·ªói hi·ªÉn th·ªã map trong modal (b·ªã x√°m)
        setTimeout(() => { PICKER_MAP.invalidateSize(); }, 300);
    }
    // --- C·∫¨P NH·∫¨T: H√ÄM T√åM T·ªåA ƒê·ªò TH√îNG MINH (FALLBACK) ---
    async function autoFetchCoords() {
        const addressInput = document.getElementById("add-address").value; // VD: 490/8 L√™ VƒÉn S·ªπ
        const district = document.getElementById("add-district").value;    // VD: Qu·∫≠n 3
        const streetInput = document.getElementById("add-street").value;   // VD: L√™ VƒÉn S·ªπ (n·∫øu c√≥ nh·∫≠p)
        const city = "H·ªì Ch√≠ Minh";

        if (!district) {
            alert("Vui l√≤ng ch·ªçn Qu·∫≠n tr∆∞·ªõc!");
            return;
        }

        const btn = document.querySelector("button[onclick='autoFetchCoords()']");
        const originalText = btn.innerText;
        btn.innerText = "ƒêang d√≤...";
        btn.disabled = true;

        // H√†m con ƒë·ªÉ g·ªçi API
        const callApi = async (query) => {
            try {
                console.log("ƒêang t√¨m: " + query);
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                const res = await fetch(url);
                const data = await res.json();
                return (data && data.length > 0) ? data[0] : null;
            } catch (e) {
                return null;
            }
        };

        try {
            let result = null;

            // --- CHI·∫æN THU·∫¨T 1: T√¨m ch√≠nh x√°c c·∫£ s·ªë nh√† ---
            // ∆Øu ti√™n l·∫•y t√™n ƒë∆∞·ªùng t·ª´ √¥ "T√™n ƒë∆∞·ªùng" n·∫øu nh√¢n vi√™n c√≥ nh·∫≠p, v√¨ n√≥ chu·∫©n h∆°n
            let streetName = streetInput; 
            if (!streetName && addressInput) {
                // C·ªë g·∫Øng ƒëo√°n t√™n ƒë∆∞·ªùng t·ª´ ƒë·ªãa ch·ªâ (B·ªè s·ªë nh√† ·ªü ƒë·∫ßu)
                // VD: "490/8 L√™ VƒÉn S·ªπ" -> l·∫•y "L√™ VƒÉn S·ªπ" (c√°ch ƒë∆°n gi·∫£n)
                const parts = addressInput.split(" ");
                if (parts.length > 1 && /^\d/.test(parts[0])) { 
                    parts.shift(); // B·ªè ph·∫ßn s·ªë (VD: 490/8)
                    streetName = parts.join(" ");
                } else {
                    streetName = addressInput;
                }
            }

            // Th·ª≠ t√¨m full ƒë·ªãa ch·ªâ tr∆∞·ªõc: "490/8 L√™ VƒÉn S·ªπ, Qu·∫≠n 3, H·ªì Ch√≠ Minh"
            const fullQuery = `${addressInput}, ${district}, ${city}`;
            result = await callApi(fullQuery);

            // --- CHI·∫æN THU·∫¨T 2: N·∫øu th·∫•t b·∫°i, t√¨m theo T√äN ƒê∆Ø·ªúNG + QU·∫¨N ---
            if (!result && streetName) {
                toast("Kh√¥ng t√¨m th·∫•y s·ªë nh√†, ƒëang t√¨m theo t√™n ƒë∆∞·ªùng...");
                // Query: "ƒê∆∞·ªùng L√™ VƒÉn S·ªπ, Qu·∫≠n 3, H·ªì Ch√≠ Minh"
                const streetQuery = `${streetName}, ${district}, ${city}`;
                result = await callApi(streetQuery);
            }

            // --- K·∫æT QU·∫¢ ---
            if (result) {
                const lat = result.lat;
                const lng = result.lon; // API tr·∫£ v·ªÅ 'lon'

                // 1. ƒêi·ªÅn v√†o √¥ input
                document.getElementById("add-lat").value = lat;
                document.getElementById("add-lng").value = lng;

                // 2. C·∫≠p nh·∫≠t b·∫£n ƒë·ªì ch·ªçn (Picker Map) n·∫øu ƒë√£ c√†i ƒë·∫∑t ·ªü b∆∞·ªõc tr∆∞·ªõc
                if (typeof PICKER_MAP !== 'undefined' && PICKER_MAP && PICKER_MARKER) {
                    const newLatLng = new L.LatLng(lat, lng);
                    PICKER_MARKER.setLatLng(newLatLng);
                    PICKER_MAP.setView(newLatLng, 16);
                }

                toast(`ƒê√£ ghim t·∫°i: ${result.display_name.split(',')[0]}`);
            } else {
                alert("Kh√¥ng t√¨m th·∫•y c·∫£ ƒë∆∞·ªùng l·∫´n s·ªë nh√†. Vui l√≤ng nh·∫≠p th·ªß c√¥ng ho·∫∑c ki·ªÉm tra l·∫°i t√™n ƒë∆∞·ªùng.");
            }

        } catch (e) {
            console.error(e);
            toast("L·ªói k·∫øt n·ªëi b·∫£n ƒë·ªì.");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
    // ===== CHI TI·∫æT & S·ª¨A =====
    // ===== CHI TI·∫æT & S·ª¨A (ƒê√É N√ÇNG C·∫§P T·ª∞ QU√âT ·∫¢NH STORAGE) =====
    async function openDetail(id) {
      const dlg = document.getElementById("detailDlg");
      const wrap = document.getElementById("detail-content");
      wrap.innerHTML = `<div class="py-10 text-center text-sm opacity-70"><span class="loading loading-spinner"></span> ƒêang t·∫£i d·ªØ li·ªáu v√† qu√©t h√¨nh ·∫£nh...</div>`;
      dlg.showModal();

      // 1. L·∫•y th√¥ng tin cƒÉn nh√† t·ª´ Database
      const { data, error } = await db
        .from("premises")
        .select("*")
        .eq("id", id)
        .single();

      if (error || !data) {
        console.error(error);
        wrap.innerHTML = `<div class="py-10 text-center text-sm text-error">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu.</div>`;
        return;
      }

      const item = data;

      // 2. X·ª¨ L√ù H√åNH ·∫¢NH:
      // ∆Øu ti√™n 1: L·∫•y t·ª´ c·ªôt 'images' trong Database (n·∫øu c√≥)
      // ∆Øu ti√™n 2: N·∫øu Database tr·ªëng, t·ª± ƒë·ªông qu√©t Storage theo M√É CƒÇN (item.code)
      
      let imgUrls = [];
      let rawImgs = item.images;

      // B∆∞·ªõc 2a: Th·ª≠ l·∫•y t·ª´ Database tr∆∞·ªõc
      if (Array.isArray(rawImgs) && rawImgs.length > 0) {
        imgUrls = rawImgs.map(p => buildImageUrl(p)).filter(Boolean);
      } 
      else if (typeof rawImgs === "string" && rawImgs.trim()) {
         // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p l∆∞u d·∫°ng chu·ªói JSON ho·∫∑c xu·ªëng d√≤ng
         let paths = [];
         try {
            if (rawImgs.startsWith("[")) paths = JSON.parse(rawImgs);
            else paths = rawImgs.split(/[\n;,]+/).map(s => s.trim());
         } catch(e) { paths = []; }
         imgUrls = paths.map(p => buildImageUrl(p)).filter(Boolean);
      }

      // B∆∞·ªõc 2b: N·∫øu v·∫´n ch∆∞a c√≥ ·∫£nh n√†o -> QU√âT STORAGE
      if (imgUrls.length === 0 && item.code) {
          console.log("Database kh√¥ng c√≥ ·∫£nh, ƒëang qu√©t Storage folder:", item.code);
          
          // T√¨m folder c√≥ t√™n tr√πng v·ªõi M√£ cƒÉn
          const { data: files, error: listError } = await db.storage
            .from(STORAGE_BUCKET)
            .list(item.code, { // T√™n folder = item.code
                limit: 50,
                offset: 0,
                sortBy: { column: 'name', order: 'asc' },
            });

          if (!listError && files && files.length > 0) {
              // L·ªçc b·ªè file r√°c h·ªá th·ªëng (n·∫øu c√≥)
              const validFiles = files.filter(f => f.name !== '.emptyFolderPlaceholder');
              
              // T·∫°o ƒë∆∞·ªùng d·∫´n public
              imgUrls = validFiles.map(f => {
                  const fullPath = `${item.code}/${f.name}`;
                  const { data } = db.storage.from(STORAGE_BUCKET).getPublicUrl(fullPath);
                  return data.publicUrl;
              });
              console.log("ƒê√£ t√¨m th·∫•y ·∫£nh trong Storage:", imgUrls);
          }
      }

      // --- C√ÅC PH·∫¶N D∆Ø·ªöI GI·ªÆ NGUY√äN ---
      const pnVal = pickField(item, ["pn", "so_pn", "bedrooms", "rooms"]);
      const wcVal = pickField(item, ["wc", "bathrooms"]);
      const floorsVal = pickField(item, ["floors"]);
      const detailText = item.detail || item.description || "";
      const updatedLabel = formatDateVN(item.updated_at || item.created_at);
      
      const price = typeof item.price === "number" ? new Intl.NumberFormat("vi-VN").format(item.price) + " ƒë/th√°ng" : "";
      const area = typeof item.area === "number" ? item.area + " m¬≤" : "";
            // GH√âP ƒê·ªäA CH·ªà ƒê·∫¶Y ƒê·ª¶: S·ªê NH√Ä / ƒê∆Ø·ªúNG + PH∆Ø·ªúNG + QU·∫¨N + TP
      const addressParts = [];

      if (item.address) {
        // address th∆∞·ªùng l√† "591/8 L√™ Quang ƒê·ªãnh"
        addressParts.push(item.address);
      } else if (item.street) {
        addressParts.push(item.street);
      }

      if (item.ward) addressParts.push(item.ward);
      if (item.district) addressParts.push(item.district);
      if (item.city) addressParts.push(item.city);

      const address = addressParts.join(", ");


      // Embed Map
      const mapsQuery = encodeURIComponent([item.address, item.ward, item.district, item.city].filter(Boolean).join(", "));
      const mapEmbed = `<iframe class="w-full h-64 border-0 rounded-xl" loading="lazy" referrerpolicy="no-referrer-when-downgrade" src="https://maps.google.com/maps?q=${mapsQuery}&t=&z=15&ie=UTF8&iwloc=&output=embed"></iframe>`;

      // N√∫t h√†nh ƒë·ªông
      const isRented = item.status === "rented";
      const isAvailableLike =
        item.status === "available" || item.status === "deposited";

      const actions = `
        <div class="join join-horizontal flex flex-wrap gap-2">
          ${
            item.contact_phone && !isStaff()
              ? `<a class="btn btn-sm join-item" href="tel:${item.contact_phone}">
                   G·ªçi
                 </a>`
              : ""
          }
          ${
            item.contact_phone && !isStaff()
              ? `<a class="btn btn-sm join-item" target="_blank"
                   href="https://zalo.me/${(item.contact_phone || "")
                     .replace(/[^0-9]/g, "")}">
                   Zalo
                 </a>`
              : ""
          }

          <a class="btn btn-sm join-item" target="_blank"
             href="https://www.google.com/maps/search/?api=1&query=${mapsQuery}">
            M·ªü Map
          </a>

          <button class="btn btn-sm join-item"
            onclick="navigator.clipboard.writeText(window.location.href);toast('ƒê√£ copy link')">
            Copy link
          </button>

          ${
            // üî¥ B√ÅO H·∫æT ‚Äì NH√ÇN S·ª∞: ch·ªâ b√°o, ch·ªù admin duy·ªát
            isStaff() &&
            isAvailableLike &&
            !item.rented_reported_at &&
            !item.rented_confirmed_at
              ? `<button class="btn btn-sm btn-error btn-outline join-item"
                         onclick="reportRentedStaff('${id}')">
                   B√°o h·∫øt
                 </button>`
              : ""
          }

          ${
            // üî¥ B√ÅO H·∫æT ‚Äì ADMIN: chuy·ªÉn th·∫≥ng sang "rented", kh√¥ng c·∫ßn duy·ªát
            isAdmin() && isAvailableLike
              ? `<button class="btn btn-sm btn-error join-item"
                         onclick="reportRentedDirect('${id}')">
                   B√°o h·∫øt
                 </button>`
              : ""
          }


          ${
            // üü° B√ÅO CH·∫†Y L·∫†I ‚Äì ch·ªâ hi·ªán khi ƒëang ·ªü tr·∫°ng th√°i ƒë√£ h·∫øt
            isRented && !item.reactivate_reported_at
              ? `<button class="btn btn-sm btn-outline join-item"
                         onclick="requestReactivate('${id}')">
                   B√°o ch·∫°y l·∫°i
                 </button>`
              : ""
          }

          ${
            // ‚úÖ DUY·ªÜT CH·∫†Y L·∫†I ‚Äì ch·ªâ admin th·∫•y khi c√≥ y√™u c·∫ßu ch·∫°y l·∫°i
            isAdmin() && item.reactivate_reported_at && !item.reactivate_confirmed_at
              ? `<button class="btn btn-sm btn-success join-item"
                         onclick="confirmReactivate('${id}')">
                   Duy·ªát ch·∫°y l·∫°i
                 </button>`
              : ""
          }

          ${
            isAdmin()
              ? `<button class="btn btn-outline btn-sm join-item"
                         onclick="openEditPremise('${id}')">
                   S·ª≠a
                 </button>`
              : ""
          }
        </div>
      `;



      // Render HTML
      const html = `
        <div class="relative">
          <button type="button" onclick="document.getElementById('detailDlg').close()" class="absolute top-3 right-3 z-50 w-9 h-9 flex items-center justify-center bg-white rounded-full shadow hover:bg-gray-200 transition">‚úï</button>

          <div class="grid md:grid-cols-2 gap-6">
            <div class="space-y-3">
              <div class="w-full h-[340px] bg-base-200 flex items-center justify-center rounded-xl overflow-hidden bg-black/5">
                ${imgUrls.length 
                  ? `<img id="detail-main-img" src="${imgUrls[0]}" class="w-full h-full object-contain" />` 
                  : `<div class="flex flex-col items-center opacity-40"><span class="text-4xl">üì∑</span><span class="text-xs mt-2">Ch∆∞a c√≥ h√¨nh ·∫£nh trong folder "${item.code || '...'}"</span></div>`
                }
              </div>

              ${imgUrls.length > 1 ? `
                  <div class="grid grid-cols-5 gap-2">
                    ${imgUrls.slice(0, 10).map(url => `
                      <div class="cursor-pointer border border-base-200 rounded-lg overflow-hidden hover:border-primary h-14 bg-base-100" 
                           onclick="document.getElementById('detail-main-img').src='${url}'">
                        <img src="${url}" class="w-full h-full object-cover" />
                      </div>
                    `).join("")}
                  </div>
                ` : ""}
              ${mapEmbed}
            </div>

            <div class="space-y-3 text-sm">
              <div>
                <h3 class="font-semibold text-lg mb-1 leading-snug">${buildTitle(item) || "(Kh√¥ng c√≥ ti√™u ƒë·ªÅ)"}</h3>
                <p class="text-gray-600">${address || ""}</p>
              </div>

              <div class="flex flex-wrap gap-2 text-xs">
                ${price ? `<span class="badge badge-primary badge-outline font-bold">Gi√°: ${price}</span>` : ""}
                ${area ? `<span class="badge badge-outline">DT: ${area}</span>` : ""}
                ${item.status ? `<span class="badge badge-ghost">${item.status}</span>` : ""}
              </div>

              <div class="text-xs text-gray-500 flex justify-between items-end border-b pb-2">
                 <span>M√£: <span class="font-mono font-bold text-black">${item.code || '---'}</span></span>
                 <span>C·∫≠p nh·∫≠t: ${updatedLabel}</span>
              </div>

              <div class="grid grid-cols-2 gap-y-1 gap-x-4 text-sm mt-2">
                <div>Di·ªán t√≠ch: <b>${item.area ?? '-'} m¬≤</b></div>
                <div>T·∫ßng: <b>${floorsVal ?? '-'}</b></div>
                <div>Ngang: <b>${item.width ?? '-'} m</b></div>
                <div>D√†i: <b>${item.length ?? '-'} m</b></div>
                <div>PN: <b>${pnVal ?? '-'}</b></div>
                <div>WC: <b>${wcVal ?? '-'}</b></div>
                <div>K·∫øt c·∫•u: <b>${item.ket_cau || '-'}</b></div>
                <div>Hoa h·ªìng: <b class="text-success">${item.commission_note || '-'}</b></div>
                <div>H∆∞·ªõng: <b>${item.frontage ? 'M·∫∑t ti·ªÅn' : (item.direction || '-')}</b></div>
              </div>

              ${
                item.status === "rented" && item.rented_confirmed_at
                  ? `<div class="mt-2 text-xs text-error">
                       Ng√†y b√°o h·∫øt: <b>${formatDateVN(item.rented_confirmed_at)}</b>
                     </div>`
                  : ""
              }

              ${
                item.rented_reported_at && !item.rented_confirmed_at
                  ? `<div class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-error">
                       ‚ö†Ô∏è <b>${item.rented_reporter_email || 'Nh√¢n s·ª±'}</b> ƒë√£ b√°o h·∫øt ng√†y ${formatDateVN(item.rented_reported_at)}.
                       <br/>Ch·ªù Admin x√°c nh·∫≠n.
                     </div>`
                  : ""
              }

              ${
                item.reactivate_reported_at && !item.reactivate_confirmed_at
                  ? `<div class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded text-xs text-info">
                       üîÑ <b>${item.reactivate_reporter_email || 'Nh√¢n s·ª±'}</b> ƒë√£ b√°o ch·∫°y l·∫°i ng√†y ${formatDateVN(item.reactivate_reported_at)}.
                       <br/>Ch·ªù Admin duy·ªát.
                     </div>`
                  : ""
              }
              
              ${
                item.is_approved === false
                  ? `<div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-warning">
                       a‚è≥ Tin n√†y do <b>${item.creator_email || 'Nh√¢n s·ª±'}</b> ƒëƒÉng, ƒëang ch·ªù duy·ªát.
                     </div>`
                  : ""
              }

              ${item.contact_phone && !isStaff() ? `

                <div class="mt-3 p-3 bg-base-200 rounded-lg text-sm border border-base-300">
                  Li√™n h·ªá ch·ªß nh√†: <br/>
                  <b class="text-lg">${item.contact_phone}</b> ${item.contact_name ? `(${item.contact_name})` : ""}
                </div>
              ` : ""}

              <div class="mt-4">
                <div class="font-semibold mb-1 opacity-70 uppercase text-xs">Chi ti·∫øt:</div>
                <p class="whitespace-pre-line text-gray-700 leading-relaxed">${detailText || "(Ch∆∞a c√≥ m√¥ t·∫£ chi ti·∫øt)"}</p>
              </div>

              <div class="mt-4 pt-4 border-t">
                ${actions}
              </div>
            </div>
          </div>
        </div>
      `;
      wrap.innerHTML = html;
    }

    async function openEditPremise(id) {
      if (!isAdmin()) {
        toast("Ch·ªâ admin m·ªõi ƒë∆∞·ª£c s·ª≠a m·∫∑t b·∫±ng");
        return;
      }

      EDITING_ID = id;
      const dlg = document.getElementById("editDlg");

      const { data, error } = await db
        .from("premises")
        .select("*")
        .eq("id", id)
        .single();

      if (error || !data) {
        console.error(error);
        toast("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu ƒë·ªÉ s·ª≠a");
        return;
      }

      const item = data;
      const setVal = (elId, val) => {
        const el = document.getElementById(elId);
        if (el) el.value = val == null ? "" : String(val);
      };
      setVal("edit-road-type", item.road_type || (item.frontage ? "M·∫∑t ti·ªÅn" : "H·∫ªm"));
      setVal("edit-commission-text", item.commission || "");

      // ƒëi·ªÅn d·ªØ li·ªáu v√†o form edit
      setVal("edit-code", item.code || "");
      setVal("edit-address", item.address || "");
      setVal("edit-city", item.city || "TP.HCM");
      setVal("edit-district", item.district || "");
      setVal("edit-ward", item.ward || "");
      setVal("edit-street", item.street || "");

      setVal("edit-price", item.price ?? "");
      setVal("edit-area", item.area ?? "");
      setVal("edit-width", item.width ?? "");
      setVal("edit-length", item.length ?? "");
      setVal("edit-floors", item.floors ?? "");
      setVal("edit-bedrooms", item.pn ?? item.bedrooms ?? "");
      setVal("edit-wc", item.wc ?? "");
      setVal("edit-ket-cau", item.ket_cau || "");
      setVal("edit-contact-phone", item.contact_phone || "");
      setVal("edit-commission", item.commission_note || "");
      setVal("edit-detail", item.detail || "");
      setVal("edit-lat", item.lat || "");
      setVal("edit-lng", item.lng || "");
      const statusSelect = document.getElementById("edit-status");
      if (statusSelect) {
        statusSelect.value = item.status || "available";
      }

      const frontageCheckbox = document.getElementById("edit-frontage");
      if (frontageCheckbox) {
        frontageCheckbox.checked = !!item.frontage;
      }

      // x·ª≠ l√Ω field images: array / json / string
      let rawImgs = item.images;
      let imgPaths = [];

      if (Array.isArray(rawImgs)) {
        imgPaths = rawImgs;
      } else if (typeof rawImgs === "string" && rawImgs.trim()) {
        const s = rawImgs.trim();
        try {
          if (s.startsWith("[") && s.endsWith("]")) {
            const parsed = JSON.parse(s);
            if (Array.isArray(parsed)) imgPaths = parsed;
          } else {
            imgPaths = s.split(/[\n;,]+/);
          }
        } catch (e) {
          console.warn("parse images error in edit", e);
          imgPaths = s.split(/[\n;,]+/);
        }
      }

      const imagesTextarea = document.getElementById("edit-images");
      if (imagesTextarea) {
        imagesTextarea.value = (imgPaths || [])
          .map((p) => (p || "").trim())
          .filter(Boolean)
          .join("\n");
      }

      dlg.showModal();
      initPickerMap('edit-map-picker', 'edit-lat', 'edit-lng', item.lat, item.lng);
    }
    
    async function saveEditPremise() {
      if (!isAdmin() || !EDITING_ID) return;
      const getVal = (id) => document.getElementById(id).value.trim();
      const getNum = (id) => { const v = getVal(id).replace(/[^\d.]/g, ""); return v ? Number(v) : 0; };

      const payload = {
        code: getVal("edit-code"),
        address: getVal("edit-address"),
        city: getVal("edit-city"),
        district: getVal("edit-district"),
        ward: getVal("edit-ward"),
        street: getVal("edit-street"),
        price: getNum("edit-price"),
        area: getNum("edit-area"),
        width: getNum("edit-width"),
        length: getNum("edit-length"),
        floors: getNum("edit-floors"),
        pn: getNum("edit-bedrooms"),
        wc: getNum("edit-wc"),
        ket_cau: getVal("edit-ket-cau"),
        contact_phone: getVal("edit-contact-phone"),
        frontage: document.getElementById("edit-frontage").checked,
        status: getVal("edit-status"),
        commission_note: getVal("edit-commission"),
        images: getVal("edit-images").split("\n").map(s => s.trim()).filter(Boolean),
        detail: getVal("edit-detail"),
        updated_at: new Date().toISOString(),
        road_type: document.getElementById("edit-road-type").value, // M·ªöI
        commission: getVal("edit-commission-text"), // M·ªöI
        lat: getVal("edit-lat") ? Number(getVal("edit-lat")) : null,
        lng: getVal("edit-lng") ? Number(getVal("edit-lng")) : null,
      };
      // N·∫øu admin ch·ªânh tr·∫°ng th√°i kh√°c "rented" -> xo√° ng√†y b√°o h·∫øt & y√™u c·∫ßu ch·∫°y l·∫°i
      if (payload.status && payload.status !== "rented") {
        payload.rented_reported_at = null;
        payload.rented_confirmed_at = null;
        payload.reactivate_reported_at = null;
        payload.reactivate_confirmed_at = null;
      }

      const { error } = await db
        .from("premises")
        .update(payload)
        .eq("id", EDITING_ID); // <--- S·ª¨A L·∫†I TH√ÄNH BI·∫æN TO√ÄN C·ª§C VI·∫æT HOA

      if (error) { toast("L·ªói: " + error.message); return; }
      toast("ƒê√£ l∆∞u thay ƒë·ªïi!");
      document.getElementById("editDlg").close();
      await applyFilters(false);
    }
    // ===== B√ÅO H·∫æT (KH√îNG C·∫¶N DUY·ªÜT) =====
    async function reportRentedDirect(id) {
      if (!isAdmin()) return;  // ch·ªâ admin ƒë∆∞·ª£c d√πng
      if (!confirm("X√°c nh·∫≠n m·∫∑t b·∫±ng n√†y ƒë√£ h·∫øt / ƒë√£ cho thu√™?")) return;
      const nowIso = new Date().toISOString();
      const { error } = await db
        .from("premises")
        .update({
          status: "rented",
          rented_reported_at: nowIso,
          rented_confirmed_at: nowIso, // coi nh∆∞ duy·ªát lu√¥n
          reactivate_reported_at: null,
          reactivate_confirmed_at: null,
        })
        .eq("id", id);

      if (error) {
        console.error(error);
        toast("L·ªói b√°o h·∫øt: " + error.message);
        return;
      }

      toast("ƒê√£ b√°o h·∫øt m·∫∑t b·∫±ng n√†y.");
      document.getElementById("detailDlg").close();
      applyFilters(true);
    }

    // ===== B√ÅO CH·∫†Y L·∫†I (NS & ADMIN) =====
    async function requestReactivate(id) {
      if (!confirm("B√°o ch·∫°y l·∫°i m·∫∑t b·∫±ng n√†y?")) return;

      const { error } = await db
        .from("premises")
        .update({
          reactivate_reported_at: new Date().toISOString(),
          reactivate_reporter_email: CURRENT_USER.email
        })
        .eq("id", id);

      if (error) {
        console.error(error);
        toast("L·ªói b√°o ch·∫°y l·∫°i: " + error.message);
        return;
      }

      toast("ƒê√£ b√°o ch·∫°y l·∫°i ‚Äì ch·ªù admin duy·ªát.");
      document.getElementById("detailDlg").close();
      applyFilters(true);
    }

    // ===== ADMIN DUY·ªÜT CH·∫†Y L·∫†I =====
    async function confirmReactivate(id) {
      if (!isAdmin()) return;
      if (!confirm("Duy·ªát cho m·∫∑t b·∫±ng n√†y ch·∫°y l·∫°i?")) return;

      const { error } = await db
        .from("premises")
        .update({
          status: "available",
          reactivate_confirmed_at: new Date().toISOString(),
          reactivate_reported_at: null,
          // xo√° d·∫•u v·∫øt 'Ng√†y b√°o h·∫øt' ƒë·ªÉ ·∫©n d√≤ng ƒë√≥
          rented_reported_at: null,
          rented_confirmed_at: null,
        })
        .eq("id", id);

      if (error) {
        console.error(error);
        toast("L·ªói duy·ªát ch·∫°y l·∫°i: " + error.message);
        return;
      }

      toast("ƒê√£ duy·ªát cho m·∫∑t b·∫±ng ch·∫°y l·∫°i.");
      document.getElementById("detailDlg").close();
      applyFilters(true);
    }


    async function confirmRented(id) {
      if (!isAdmin()) return;
      if (!confirm("X√°c nh·∫≠n m·∫∑t b·∫±ng n√†y ƒë√£ h·∫øt / ƒë√£ thu√™?")) return;

      const { error } = await db
        .from("premises")
        .update({
          status: "rented",
          rented_confirmed_at: new Date().toISOString()
        })
        .eq("id", id);

      if (error) {
        console.error(error);
        toast("L·ªói x√°c nh·∫≠n: " + error.message);
        return;
      }
      toast("ƒê√£ x√°c nh·∫≠n m·∫∑t b·∫±ng h·∫øt");
      document.getElementById("detailDlg").close();
      applyFilters(true);
    }

    async function cancelRented(id) {
      if (!isAdmin()) return;
      if (!confirm("Hu·ª∑ y√™u c·∫ßu b√°o h·∫øt m·∫∑t b·∫±ng n√†y?")) return;

      const { error } = await db
        .from("premises")
        .update({
          rented_reported_at: null,
          rented_confirmed_at: null
        })
        .eq("id", id);

      if (error) {
        console.error(error);
        toast("L·ªói hu·ª∑ b√°o h·∫øt: " + error.message);
        return;
      }
      toast("ƒê√£ hu·ª∑ b√°o h·∫øt");
      document.getElementById("detailDlg").close();
      applyFilters(true);
    }

    // ===== LOGIC TH√äM M·ªöI (M·ªöI) =====
    function initAddFormDropdowns() {
        const distSelect = document.getElementById("add-district");
        const wardSelect = document.getElementById("add-ward");
        
        // Load Districts
        const dists = Object.keys(HCM_DATA).sort();
        distSelect.innerHTML = `<option value="">-- Ch·ªçn --</option>` + dists.map(d => `<option value="${d}">${d}</option>`).join("");
        
        // Event Change
        distSelect.addEventListener("change", () => {
            const val = distSelect.value;
            wardSelect.innerHTML = `<option value="">-- Ch·ªçn --</option>`;
            if(HCM_DATA[val]) {
                wardSelect.disabled = false;
                wardSelect.innerHTML += HCM_DATA[val].map(w => `<option value="${w}">${w}</option>`).join("");
            } else {
                wardSelect.disabled = true;
            }
        });
    }
    // ====================== GLOBAL VARIABLES ======================
    let FILES_BUFFER = [];  // L∆∞u file khi ch·ªçn ·∫£nh b·∫±ng input


    // ====================== H√ÄM T·∫†O M√É M·∫∂T B·∫∞NG ======================
    async function generateNextCode() {
      const { data, error } = await db
        .from("premises")
        .select("code")
        .order("code", { ascending: false })
        .limit(1);

      if (error) throw error;

      let nextNumber = 1;
      if (data && data.length > 0) {
        const lastCode = data[0].code; // VD: MBKD 56780001345
        const num = parseInt(lastCode.replace(/\D/g, ""), 10);
        nextNumber = num + 1;
      }

      return "MBKD " + nextNumber.toString().padStart(11, "0");
    }


    // ====================== H√ÄM CH·ªåN FILE ·∫¢NH ======================
    function handleSelectFiles(input) {
      const files = Array.from(input.files || []);
      if (!files.length) return;

      for (const file of files) {
        FILES_BUFFER.push(file);
      }

      renderImagePreview();
    }
    function renderImagePreview() {
      const previewBox = document.getElementById("new-images-preview");
      if (!previewBox) return;

      if (FILES_BUFFER.length === 0) {
        previewBox.innerHTML = `
          <div class="text-center text-gray-400 py-6">
            Ch∆∞a c√≥ ·∫£nh n√†o. ·∫¢nh ƒë·∫ßu ti√™n s·∫Ω l√† <b>·∫¢nh B√¨a</b>.
          </div>`;
        return;
      }

      previewBox.innerHTML = FILES_BUFFER.map((file, i) => {
        const url = URL.createObjectURL(file);
        return `
          <div class="relative inline-block m-1">
            <img src="${url}" class="h-24 w-24 object-cover rounded-lg border" />
            <button class="btn btn-xs btn-circle absolute -top-2 -right-2 bg-white"
                    onclick="deleteImageFromBuffer(${i})">‚úï</button>
          </div>
        `;
      }).join("");
    }

    function deleteImageFromBuffer(index) {
      FILES_BUFFER.splice(index, 1);
      renderImagePreview();
    }

    async function saveNewPremise() {
        const getVal = (id) => document.getElementById(id).value.trim();
        // L·∫•y gi√° ti·ªÅn t·ª´ input ƒë√£ format (x√≥a d·∫•u ch·∫•m/ph·∫©y ƒëi)
        const priceRaw = getVal("add-price").replace(/\D/g,'');
        const priceNum = priceRaw ? parseInt(priceRaw) : 0;

        if (!getVal("add-address") || !getVal("add-district") || !priceNum) {
            toast("Vui l√≤ng nh·∫≠p: ƒê·ªãa ch·ªâ, Qu·∫≠n v√† Gi√° thu√™!");
            return;
        }

        const payload = {
            address: getVal("add-address"),
            district: document.getElementById("add-district").value,
            ward: document.getElementById("add-ward").value,
            street: getVal("add-street"),
            price: priceNum,
            area: Number(getVal("add-area")) || null,
            width: Number(getVal("add-width")) || null,
            length: Number(getVal("add-length")) || null,
            floors: Number(getVal("add-floors")) || null,
            pn: Number(getVal("add-bedrooms")) || null,
            wc: Number(getVal("add-wc")) || null,
            ket_cau: getVal("add-ket-cau"),
            contact_phone: getVal("add-contact-phone"),
            frontage: document.getElementById("add-frontage").checked,
            images: getVal("add-images").split('\n').map(s=>s.trim()).filter(Boolean),
            detail: getVal("add-detail"),
            status: 'available',
            road_type: document.getElementById("add-road-type").value, // M·ªöI
              commission: getVal("add-commission"),
            // code, created_by, is_approved S·∫º ƒê∆Ø·ª¢C DB T·ª∞ ƒê·ªòNG X·ª¨ L√ù (N·∫æU ƒê√É CH·∫†Y SQL)
        };

        const { error } = await db.from("premises").insert([payload]);
        if (error) {
            toast("L·ªói: " + error.message);
        } else {
            toast(isAdmin() ? "ƒê√£ th√™m th√†nh c√¥ng!" : "ƒê√£ g·ª≠i duy·ªát!");
            document.getElementById("addDlg").close();
            applyFilters(true);
            if(isAdmin()) checkPendingCount();
        }
    }
      // ===== NH√ÇN S·ª∞: B√ÅO H·∫æT (CH·ªú ADMIN DUY·ªÜT) =====
    async function reportRentedStaff(id) {
      if (!isStaff()) return;
      if (!confirm("X√°c nh·∫≠n b√°o h·∫øt m·∫∑t b·∫±ng n√†y ƒë·ªÉ admin duy·ªát?")) return;

      const { error } = await db
        .from("premises")
        .update({
          rented_reported_at: new Date().toISOString(),
          rented_reporter_email: CURRENT_USER.email,
          rented_confirmed_at: null   // ch·∫Øc ch·∫Øn l√† ch∆∞a duy·ªát
        })
        .eq("id", id);

      if (error) {
        console.error(error);
        toast("L·ªói b√°o h·∫øt: " + error.message);
        return;
      }

      toast("ƒê√£ b√°o h·∫øt ‚Äì ch·ªù admin x√°c nh·∫≠n.");
      document.getElementById("detailDlg").close();
      applyFilters(true);
    }

    // ===== LOGIC ADMIN PENDING (M·ªöI) =====
    async function checkPendingCount() {
        const { count } = await db.from("premises").select("*", { count: 'exact', head: true }).eq("is_approved", false);
        const cnt = count || 0;
        document.getElementById("count-pending").textContent = cnt;
        if (cnt > 0 && SHOW_PENDING) document.getElementById("btn-approve-all").classList.remove("hidden");
        else document.getElementById("btn-approve-all").classList.add("hidden");
    }

    function togglePendingMode() {
        SHOW_PENDING = !SHOW_PENDING;
        const btn = document.getElementById("btn-toggle-pending");
        if (SHOW_PENDING) {
            btn.classList.replace("btn-warning", "btn-active");
            btn.textContent = "ƒêang xem Ch·ªù duy·ªát (Tho√°t)";
        } else {
            btn.classList.replace("btn-active", "btn-warning");
            btn.innerHTML = `C·∫ßn duy·ªát <span class="badge badge-sm bg-white text-warning ml-1 border-none" id="count-pending">...</span>`;
            checkPendingCount();
        }
        applyFilters(true);
    }

    async function approveOne(id, e) {
        e.stopPropagation();
        if(!confirm("Duy·ªát b√†i n√†y?")) return;
        await db.from("premises").update({ is_approved: true }).eq("id", id);
        toast("ƒê√£ duy·ªát!");
        applyFilters(true);
        checkPendingCount();
    }

    async function approveAll() {
        if(!confirm("Duy·ªát t·∫•t c·∫£ b√†i ƒëang ch·ªù?")) return;
        await db.from("premises").update({ is_approved: true }).eq("is_approved", false);
        toast("ƒê√£ duy·ªát t·∫•t c·∫£!");
        applyFilters(true);
        checkPendingCount();
    }

    // ===== INIT EVENTS =====
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btn-login").addEventListener("click", handleLogin);
      document.getElementById("btn-logout").addEventListener("click", handleLogout);
      
      document.getElementById("btn-apply").addEventListener("click", () => applyFilters(true));
      document.getElementById("btn-reset").addEventListener("click", () => {
        document.querySelectorAll("aside input, aside select").forEach(el => {
            if(el.type === 'checkbox') el.checked = false; // B·ªè check h·∫øt
            else el.value = "";
        });
        document.getElementById("district-display-text").textContent = "T·∫•t c·∫£";
        document.getElementById("pn-display-text").textContent = "T·∫•t c·∫£";
        document.getElementById("wc-display-text").textContent = "T·∫•t c·∫£";
        document.getElementById("floors-display-text").textContent = "T·∫•t c·∫£";
        document.getElementById("district-display-text").textContent = "T·∫•t c·∫£";
        buildDistrictDropdown(); // V·∫Ω l·∫°i s·∫°ch s·∫Ω
        applyFilters(true);
      });
      // N√∫t m·ªü form ƒêƒÉng nh·∫≠p nh√¢n s·ª± tr√™n trang ch·ªß
      const btnOpenLogin = document.getElementById("btn-open-login");
      const loginCard = document.getElementById("login-card");
      if (btnOpenLogin && loginCard) {
        btnOpenLogin.addEventListener("click", () => {
          loginCard.classList.remove("hidden");
          loginCard.scrollIntoView({ behavior: "smooth", block: "center" });
        });
      }

      document.getElementById("btn-load-more").addEventListener("click", () => {
        PAGE++;
        applyFilters(false);
      });

      // Khi ch·ªçn QU·∫¨N trong b·ªô l·ªçc -> c·∫≠p nh·∫≠t PH∆Ø·ªúNG + l·ªçc l·∫°i
      const filterDistrict = document.getElementById("filter-district");
      if (filterDistrict) {
        filterDistrict.addEventListener("change", () => {
          if (typeof updateWardOptions === "function") {
            updateWardOptions();
          }
          applyFilters(true);
        });
      }

      // Admin / Add Events
      // T√¨m d√≤ng n√†y: document.getElementById("btn-open-add").onclick = ...
      // S·ª≠a th√†nh:
      document.getElementById("btn-open-add").onclick = () => {
          document.getElementById("addDlg").showModal();
          // G·ªçi h√†m t·∫°o map cho form th√™m (m·∫∑c ƒë·ªãnh l·∫•y t√¢m HCM n·∫øu ch∆∞a nh·∫≠p g√¨)
          initPickerMap('add-map-picker', 'add-lat', 'add-lng');
      };
      document.getElementById("btn-toggle-pending").onclick = togglePendingMode;
      const btnToggleReported = document.getElementById("btn-toggle-rented-reports");
      if (btnToggleReported) btnToggleReported.onclick = toggleReportedMode;

      const btnToggleReactivate = document.getElementById("btn-toggle-reactivate");
      if (btnToggleReactivate) btnToggleReactivate.onclick = toggleReactivateMode;

      document.getElementById("btn-approve-all").onclick = approveAll;
      
      const btnToggleRented = document.getElementById("btn-toggle-rented-reports");
      if (btnToggleRented) {
        btnToggleRented.onclick = toggleReportedMode;
      }

      // Quick filters
      document.querySelectorAll("[data-quick-district]").forEach((btn) => {
        btn.addEventListener("click", () => {
          // 1. Reset h·∫øt checkbox tr∆∞·ªõc
          document.querySelectorAll('.district-cb').forEach(cb => cb.checked = false);
          
          // 2. Tick v√†o qu·∫≠n ƒë∆∞·ª£c ch·ªçn
          const targetDist = btn.getAttribute("data-quick-district");
          const cb = document.querySelector(`.district-cb[value="${targetDist}"]`);
          if(cb) {
              cb.checked = true;
              // Trigger s·ª± ki·ªán change ƒë·ªÉ c·∫≠p nh·∫≠t label v√† ph∆∞·ªùng
              cb.dispatchEvent(new Event('change'));
          }
        });
      });
      // N√∫t xem danh s√°ch m·∫∑t b·∫±ng ƒë√£ ghim
      const btnToggleFavorites = document.getElementById("btn-toggle-favorites");
      if (btnToggleFavorites) {
        btnToggleFavorites.addEventListener("click", toggleFavoriteMode);
      }

      // ===== DEMO NOTICE BUTTONS =====
      const demoAgreeBtn = document.getElementById("btn-demo-agree");
      const demoDisagreeBtn = document.getElementById("btn-demo-disagree");
      const demoDlg = document.getElementById("demoNoticeDlg");
      if (demoAgreeBtn && demoDlg) {
        demoAgreeBtn.addEventListener("click", () => demoDlg.close());
      }
      if (demoDisagreeBtn && demoDlg) {
        demoDisagreeBtn.addEventListener("click", async () => {
          demoDlg.close();
          await db.auth.signOut();
          location.reload();
        });
      }

      // Lu√¥n build dropdown QU·∫¨N/PH∆Ø·ªúNG khi load trang
      buildDistrictDropdown()
      initAllMultiFilters();
      // R·ªìi m·ªõi x·ª≠ l√Ω login / role / d·ªØ li·ªáu
      initAuth();
    });
// --- X·ª¨ L√ù CHUY·ªÇN TAB LIST / MAP (LEAFLET VERSION) ---
      const btnList = document.getElementById("btn-view-list");
      const btnMap = document.getElementById("btn-view-map");
      const divList = document.getElementById("list-view");
      const divMap = document.getElementById("map-view");

      // --- S·ª¨A L·ªñI: H√ÄM CHUY·ªÇN TAB M·ªöI ---
      let CURRENT_VIEW = 'list'; // Bi·∫øn theo d√µi ch·∫ø ƒë·ªô hi·ªán t·∫°i

      function switchView(mode) {
          CURRENT_VIEW = mode; // L∆∞u l·∫°i mode

          const btnList = document.getElementById("btn-view-list");
          const btnTable = document.getElementById("btn-view-table"); // M·ªõi
          const btnMap = document.getElementById("btn-view-map");
          
          const divList = document.getElementById("list-view");
          const divTable = document.getElementById("table-view"); // M·ªõi
          const divMap = document.getElementById("map-view");

          // Reset t·∫•t c·∫£ v·ªÅ ·∫©n
          [divList, divTable, divMap].forEach(el => el && el.classList.add("hidden"));
          [btnList, btnTable, btnMap].forEach(btn => btn && btn.classList.remove("btn-active"));

          if (mode === 'list') {
              if(divList) divList.classList.remove("hidden");
              if(btnList) btnList.classList.add("btn-active");
              renderCards(LAST_ROWS, true); // V·∫Ω l·∫°i grid
          } 
          else if (mode === 'table') {
              if(divTable) divTable.classList.remove("hidden");
              if(btnTable) btnTable.classList.add("btn-active");
              renderTable(LAST_ROWS); // V·∫Ω b·∫£ng
          }
          else if (mode === 'map') {
              if(divMap) divMap.classList.remove("hidden");
              if(btnMap) btnMap.classList.add("btn-active");
              
              initStaffMap();
              setTimeout(() => { if(MAP_INSTANCE) MAP_INSTANCE.invalidateSize(); }, 200);
              if (LAST_ROWS && LAST_ROWS.length > 0) renderMapMarkers(LAST_ROWS);
          }
      }

      // G·∫Øn s·ª± ki·ªán click cho n√∫t B·∫£ng (Table)
      const btnTableEl = document.getElementById("btn-view-table");
      if(btnTableEl) btnTableEl.onclick = () => switchView('table');

      // G·∫Øn s·ª± ki·ªán click
      if(btnList) btnList.onclick = () => switchView('list');
      if(btnMap) btnMap.onclick = () => switchView('map');

    // --- 2. C√ÅC H√ÄM X·ª¨ L√ù GIAO DI·ªÜN ·∫¢NH (GI·ªÆ NGUY√äN) ---
    function handleSelectFiles(input) {
        if (!input.files || input.files.length === 0) return;
        const newFiles = Array.from(input.files);
        FILES_BUFFER = [...FILES_BUFFER, ...newFiles];
        input.value = '';
        renderPreview();
    }

    function renderPreview() {
        const container = document.getElementById("preview-container");
        container.innerHTML = ""; 
        if (FILES_BUFFER.length === 0) {
            container.innerHTML = `<p class="text-xs text-gray-500 w-full text-center py-8 pointer-events-none">Ch∆∞a c√≥ ·∫£nh n√†o.<br/>·∫¢nh ƒë·∫ßu ti√™n s·∫Ω l√† <b>·∫¢nh B√¨a</b>.</p>`;
            return;
        }
        FILES_BUFFER.forEach((file, index) => {
            const url = URL.createObjectURL(file);
            const div = document.createElement("div");
            div.className = `relative w-24 h-24 rounded-lg overflow-hidden border-2 cursor-pointer transition-all group ${index === 0 ? 'border-primary ring-2 ring-primary ring-offset-1' : 'border-gray-300 hover:border-primary'}`;
            div.title = index === 0 ? "·∫¢nh b√¨a hi·ªán t·∫°i" : "Click ƒë·ªÉ ƒë·∫∑t l√†m ·∫£nh b√¨a";
            div.onclick = () => makeCover(index);

            const img = document.createElement("img");
            img.src = url;
            img.className = "w-full h-full object-cover";
            
            const btnRemove = document.createElement("button");
            btnRemove.innerHTML = "‚úï";
            btnRemove.className = "absolute top-0 right-0 bg-red-500 text-white w-5 h-5 text-[10px] flex items-center justify-center rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity";
            btnRemove.onclick = (e) => { e.stopPropagation(); removeFile(index); };

            if (index === 0) {
                const badge = document.createElement("div");
                badge.innerText = "B√¨a";
                badge.className = "absolute bottom-0 left-0 right-0 bg-primary text-white text-[10px] text-center font-bold py-0.5";
                div.appendChild(badge);
            }
            div.appendChild(img); div.appendChild(btnRemove); container.appendChild(div);
        });
    }

    function makeCover(index) {
        if (index === 0) return;
        const item = FILES_BUFFER.splice(index, 1)[0];
        FILES_BUFFER.unshift(item);
        renderPreview();
    }

    function removeFile(index) {
        FILES_BUFFER.splice(index, 1);
        renderPreview();
    }

    // --- 3. H√ÄM UPLOAD (C·∫¨P NH·∫¨T: NH·∫¨N THAM S·ªê FOLDER NAME) ---
    async function uploadFilesToSupabase(folderName) {
        if (FILES_BUFFER.length === 0) return [];
        
        const uploadedPaths = [];
        // Kh√¥ng c·∫ßn timestamp ·ªü t√™n file n·ªØa v√¨ ƒë√£ c√≥ folder ri√™ng, nh∆∞ng v·∫´n th√™m random cho ch·∫Øc
        
        toast(`ƒêang t·∫£i ${FILES_BUFFER.length} ·∫£nh l√™n folder ${folderName}...`);

        for (let i = 0; i < FILES_BUFFER.length; i++) {
            const file = FILES_BUFFER[i];
            
            // L√†m s·∫°ch t√™n file (b·ªè d·∫•u ti·∫øng vi·ªát, k√Ω t·ª± l·∫°)
            const cleanName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
            
            // C·∫•u tr√∫c path: T√äN_FOLDER/T√äN_FILE
            // V√≠ d·ª•: MB-123456/hinh_nha_1.jpg
            const filePath = `${folderName}/${cleanName}`;
            
            const { data, error } = await db.storage
                .from(STORAGE_BUCKET)
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: false
                });

            if (error) {
                console.error("L·ªói upload:", file.name, error);
                continue; 
            }
            if (data) uploadedPaths.push(data.path);
        }
        return uploadedPaths;
    }

    // --- 4. H√ÄM L∆ØU TIN (ƒê√É C·∫¨P NH·∫¨T LOGIC TƒÇNG M√É) ---
    async function saveNewPremiseWithUpload() {
        const btn = document.getElementById("btn-save-new");
        
        // Validate c∆° b·∫£n
        const getVal = (id) => document.getElementById(id).value.trim();
        const priceRaw = getVal("add-price").replace(/\D/g,'');
        const priceNum = priceRaw ? parseInt(priceRaw) : 0;

        if (!getVal("add-address") || !getVal("add-district") || !priceNum) {
            toast("Vui l√≤ng nh·∫≠p: ƒê·ªãa ch·ªâ, Qu·∫≠n v√† Gi√° thu√™!");
            return;
        }

        // Disable n√∫t ƒë·ªÉ tr√°nh click ƒë√∫p
        btn.disabled = true;
        btn.innerHTML = `<span class="loading loading-spinner"></span> ƒêang l·∫•y m√£ MB...`;

        try {
            // B∆Ø·ªöC 1: L·∫§Y M√É MB TI·∫æP THEO T·ª™ DATABASE (Async)
            const newCode = await generateNextCode();
            console.log("M√£ m·ªõi s·∫Ω l√†:", newCode);

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t b·∫•m
            btn.innerHTML = `<span class="loading loading-spinner"></span> ƒêang up ·∫£nh l√™n ${newCode}...`;

            // B∆Ø·ªöC 2: UPLOAD ·∫¢NH V√ÄO FOLDER C√ì T√äN L√Ä M√É MB V·ª™A T·∫†O
            const imagePaths = await uploadFilesToSupabase(newCode);

            // B∆Ø·ªöC 3: CHU·∫®N B·ªä DATA
            const rType = document.getElementById("add-road-type").value;
            const isFrontage = rType === "M·∫∑t ti·ªÅn";

            const payload = {
                code: newCode, // <-- M√É T·ª∞ TƒÇNG
                creator_email: CURRENT_USER.email,
                
                address: getVal("add-address"),
                district: document.getElementById("add-district").value,
                ward: document.getElementById("add-ward").value,
                street: getVal("add-street"),
                lat: document.getElementById("add-lat").value || null,
                lng: document.getElementById("add-lng").value || null,
                price: priceNum,
                area: Number(getVal("add-area")) || null,
                width: Number(getVal("add-width")) || null,
                length: Number(getVal("add-length")) || null,
                floors: Number(getVal("add-floors")) || null,
                pn: Number(getVal("add-bedrooms")) || null,
                wc: Number(getVal("add-wc")) || null,
                ket_cau: getVal("add-ket-cau"),
                contact_phone: getVal("add-contact-phone"),
                
                road_type: rType,
                commission: getVal("add-commission"),
                frontage: isFrontage,

                images: imagePaths, 
                detail: getVal("add-detail"),
                status: 'available',
                created_at: new Date().toISOString()
            };

            // B∆Ø·ªöC 4: INSERT V√ÄO DB
            const { error } = await db.from("premises").insert([payload]);

            if (error) throw error;

            toast(isAdmin() ? `Th√™m th√†nh c√¥ng! M√£: ${newCode}` : "ƒê√£ g·ª≠i duy·ªát!");
            
            // Reset form
            document.getElementById("addDlg").close();
            FILES_BUFFER = []; 
            renderPreview();
            applyFilters(true);
            if(isAdmin()) checkPendingCount();

        } catch (err) {
            console.error(err);
            toast("L·ªói: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = "L∆∞u tin";
        }
    }
    async function cancelRentedStaff(id) {
      if (!isStaff()) return;
      if (!confirm("B·∫°n mu·ªën hu·ª∑ b√°o h·∫øt m·∫∑t b·∫±ng n√†y?")) return;

      const { error } = await db
        .from("premises")
        .update({
          rented_reported_at: null
        })
        .eq("id", id);

      if (error) {
        console.error(error);
        toast("L·ªói: " + error.message);
        return;
      }

      toast("ƒê√£ hu·ª∑ b√°o h·∫øt");
      document.getElementById("detailDlg").close();
      applyFilters(true);
    }
    // === QU√âT ·∫¢NH T·ª™ STORAGE THEO M√É (PHI√äN B·∫¢N T·ªêI ∆ØU) ===
    async function scanGridImages(rows) {
      if (!rows || !rows.length) return;

      // S·ª≠ d·ª•ng map ƒë·ªÉ t·∫°o m·∫£ng c√°c Promise ch·∫°y song song -> T·ªëc ƒë·ªô nhanh h∆°n g·∫•p 10 l·∫ßn
      const promises = rows.map(async (row) => {
        // 1. Ki·ªÉm tra ƒëi·ªÅu ki·ªán ƒë·∫ßu v√†o
        if (!row || !row.code) return;

        // 2. T√¨m th·∫ª ch·ª©a ·∫£nh b·∫±ng ID (L∆∞u √Ω: ph·∫£i d√πng row.id nh∆∞ b∆∞·ªõc 1 ƒë√£ s·ª≠a)
        const imgContainer = document.getElementById(`thumb-box-${row.id}`);
        if (!imgContainer) return;

        // N·∫øu ƒë√£ c√≥ ·∫£nh (do load t·ª´ DB ra tr∆∞·ªõc ƒë√≥) th√¨ b·ªè qua kh√¥ng qu√©t n·ªØa
        if (imgContainer.querySelector("img")) return;

        try {
          // 3. G·ªçi Supabase list file trong folder c√≥ t√™n l√† row.code
          // VD: M√£ l√† "MBKD 001" th√¨ trong bucket ph·∫£i c√≥ folder t√™n "MBKD 001"
          const { data: files, error } = await db.storage
            .from(STORAGE_BUCKET)
            .list(row.code, {
              limit: 1, // Ch·ªâ c·∫ßn l·∫•y 1 h√¨nh ƒë·∫ßu ti√™n l√†m ·∫£nh b√¨a
              sortBy: { column: "name", order: "asc" },
            });

          if (error || !files || files.length === 0) {
            // N·∫øu kh√¥ng c√≥ ·∫£nh, hi·ªán ch·ªØ b√°o l·ªói nh·∫π ho·∫∑c ƒë·ªÉ tr·ªëng
            imgContainer.innerHTML = `<div class="text-[10px] text-gray-400">Kh√¥ng c√≥ ·∫£nh</div>`;
            return;
          }

          // 4. L·ªçc b·ªè file r√°c h·ªá th·ªëng (n·∫øu c√≥)
          const validFile = files.find(f => f.name !== ".emptyFolderPlaceholder") || files[0];
          if (!validFile) return;

          // 5. T·∫°o ƒë∆∞·ªùng d·∫´n public
          const fullPath = `${row.code}/${validFile.name}`;
          const { data } = db.storage.from(STORAGE_BUCKET).getPublicUrl(fullPath);

          // 6. C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c
          if (data && data.publicUrl) {
            imgContainer.innerHTML = `
              <img src="${data.publicUrl}" 
                   class="w-full h-full object-cover animate-fade-in transition-opacity duration-500" 
                   alt="${row.code}" />
            `;
            imgContainer.classList.remove("opacity-60");
          }

        } catch (err) {
          console.warn("L·ªói qu√©t ·∫£nh cho:", row.code, err);
        }
      });

      // Ch·ªù t·∫•t c·∫£ ch·∫°y xong (nh∆∞ng giao di·ªán s·∫Ω update d·∫ßn t·ª´ng c√°i xong tr∆∞·ªõc)
      await Promise.all(promises);
    }

    // ==== TOOL 1 L·∫¶N: ƒê·ªíNG B·ªò ·∫¢NH T·ª™ STORAGE -> C·ªòT images ====
    async function syncImagesFromStorage() {
      if (!isAdmin || !isAdmin()) {
        alert("Ch·ªâ admin m·ªõi ƒë∆∞·ª£c ch·∫°y sync images.");
        return;
      }

      const PAGE_SIZE = 100;
      let from = 0;
      let totalUpdated = 0;

      alert("B·∫Øt ƒë·∫ßu sync ·∫£nh, m·ªü Console ƒë·ªÉ xem log. ƒê·ª´ng t·∫Øt tab cho t·ªõi khi xong.");

      while (true) {
        const { data: rows, error } = await db
          .from("premises")
          .select("id, code, images", { count: "exact" })
          .range(from, from + PAGE_SIZE - 1);

        if (error) {
          console.error("L·ªói load premises:", error);
          break;
        }
        if (!rows || rows.length === 0) break;

        console.log(`ƒêang x·ª≠ l√Ω t·ª´ row ${from} t·ªõi ${from + rows.length - 1}`);

        for (const row of rows) {
          // N·∫øu ƒë√£ c√≥ images r·ªìi th√¨ b·ªè qua
          let hasImg = false;
          if (Array.isArray(row.images) && row.images.length > 0) hasImg = true;
          else if (typeof row.images === "string" && row.images.trim().length > 0) hasImg = true;
          if (hasImg) continue;
          if (!row.code) continue;

          console.log("‚Üí Qu√©t folder:", row.code);

          const { data: files, error: err2 } = await db.storage
            .from(STORAGE_BUCKET) // v√≠ d·ª• "premise-images"
            .list(row.code, {
              limit: 50,
              sortBy: { column: "name", order: "asc" },
            });

          if (err2) {
            console.error("   L·ªói list storage", row.code, err2);
            continue;
          }
          if (!files || !files.length) {
            console.log("   Kh√¥ng c√≥ file n√†o trong storage cho", row.code);
            continue;
          }

          // B·ªè file placeholder n·∫øu c√≥
          const validFiles = files.filter(f => f.name !== ".emptyFolderPlaceholder");
          if (!validFiles.length) continue;

          // L∆∞u ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi v√†o c·ªôt images (Postgres text[] ho·∫∑c jsonb ƒë·ªÅu ok)
          const paths = validFiles.map(f => `${row.code}/${f.name}`);

          const { error: err3 } = await db
            .from("premises")
            .update({ images: paths })
            .eq("id", row.id);

          if (err3) {
            console.error("   L·ªói update images cho", row.code, err3);
          } else {
            totalUpdated++;
            console.log("   ƒê√£ update images cho", row.code, paths);
          }
        }

        from += PAGE_SIZE;
      }

      alert("Sync ·∫£nh xong. T·ªïng s·ªë m·∫∑t b·∫±ng ƒë∆∞·ª£c c·∫≠p nh·∫≠t: " + totalUpdated);
    }
    // --- BI·∫æN TO√ÄN C·ª§C ƒê·ªÇ ƒêI·ªÄU KHI·ªÇN ---
    let STOP_SYNC = false;

    // --- TOOL QU√âT T·ªåA ƒê·ªò SI√äU C·∫§P (KH√îNG BAO GI·ªú B·ªé S√ìT) ---
    async function startSyncCoordinates() {
      if (!isAdmin()) { alert("Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c d√πng!"); return; }

      const btn = document.getElementById("btn-start-sync");
      const logBox = document.getElementById("sync-log");
      
      // 1. Ki·ªÉm tra th·ªëng k√™ tr∆∞·ªõc khi ch·∫°y
      const { count: total } = await db.from("premises").select("*", { count: 'exact', head: true });
      const { count: missing } = await db.from("premises").select("*", { count: 'exact', head: true }).is("lat", null);
      
      if (missing === 0) {
          alert(`Tuy·ªát v·ªùi! To√†n b·ªô ${total} m·∫∑t b·∫±ng ƒë√£ c√≥ t·ªça ƒë·ªô. Kh√¥ng c·∫ßn qu√©t.`);
          return;
      }

      if(!confirm(`T·ªïng: ${total} cƒÉn.\nHi·ªán c√≥ ${missing} cƒÉn ƒêANG M·∫§T T·ªåA ƒê·ªò (kh√¥ng hi·ªán tr√™n map).\nB·∫°n c√≥ mu·ªën qu√©t l·∫°i to√†n b·ªô ${missing} cƒÉn n√†y kh√¥ng?`)) return;

      // 2. B·∫Øt ƒë·∫ßu x·ª≠ l√Ω
      document.getElementById("sync-status").classList.remove("hidden");
      btn.disabled = true;
      STOP_SYNC = false;
      logBox.innerHTML = "<div>ƒêang t·∫£i danh s√°ch c·∫ßn x·ª≠ l√Ω...</div>";

      // L·∫•y danh s√°ch ch∆∞a c√≥ t·ªça ƒë·ªô
      const { data: list } = await db
        .from("premises")
        .select("id, address, district, ward, street")
        .is("lat", null);

      document.getElementById("sync-total").innerText = list.length;
      let processed = 0;

      for (const item of list) {
        if (STOP_SYNC) break;
        processed++;
        document.getElementById("sync-count").innerText = processed;
        document.getElementById("sync-bar").style.width = (processed / list.length * 100) + "%";

        // --- C√ÅC CHI·∫æN THU·∫¨T T√åM KI·∫æM ---
        const city = "Ho Chi Minh City";
        const district = item.district || "";
        const ward = item.ward || "";
        
        // X·ª≠ l√Ω t√™n ƒë∆∞·ªùng: B·ªè "G√≥c", "H·∫ªm", s·ªë nh√† r·∫Øc r·ªëi
        let cleanStreet = "";
        if (item.street) cleanStreet = item.street;
        else if (item.address) {
             cleanStreet = item.address.replace(/^[0-9\/A-Za-z]+\s+(.*)$/, "$1"); // B·ªè s·ªë nh√† ƒë·∫ßu
             cleanStreet = cleanStreet.replace(/^(G√≥c|H·∫ªm|Nh√†|L√¥)\s+/i, "");
        }

        const queries = [
            // 1. T√¨m ch√≠nh x√°c (S·ªë nh√† + ƒê∆∞·ªùng + Qu·∫≠n)
            `${item.address}, ${district}, ${city}`,
            
            // 2. T√¨m ƒê∆∞·ªùng + Ph∆∞·ªùng + Qu·∫≠n (B·ªè s·ªë nh√†)
            `ƒê∆∞·ªùng ${cleanStreet}, ${ward}, ${district}, ${city}`,
            
            // 3. T√¨m ƒê∆∞·ªùng + Qu·∫≠n (B·ªè ph∆∞·ªùng lu√¥n)
            `ƒê∆∞·ªùng ${cleanStreet}, ${district}, ${city}`,
            
            // 4. T√¨m Ph∆∞·ªùng + Qu·∫≠n (N·∫øu t√™n ƒë∆∞·ªùng sai, l·∫•y t√¢m Ph∆∞·ªùng) - FALLBACK 1
            `UBND ${ward}, ${district}, ${city}`,
            
            // 5. T√¨m Qu·∫≠n (N·∫øu ph∆∞·ªùng c≈©ng sai, l·∫•y t√¢m Qu·∫≠n) - FALLBACK 2
            `${district}, ${city}`
        ];

        logBox.innerHTML += `<div class="border-t mt-1 pt-1 font-bold text-gray-500">${item.address || cleanStreet}</div>`;
        logBox.scrollTop = logBox.scrollHeight;

        let found = null;
        let method = 0;

        for (const q of queries) {
            method++;
            try {
                // logBox.innerHTML += `<div class="text-[9px] text-gray-400">... th·ª≠ c√°ch ${method}</div>`;
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data && data.length > 0) {
                    found = data[0];
                    break; // T√¨m th·∫•y th√¨ d·ª´ng ngay
                }
            } catch(e) {}
            await new Promise(r => setTimeout(r, 1200)); // Ngh·ªâ 1.2s ƒë·ªÉ kh√¥ng b·ªã kh√≥a IP
        }

        if (found) {
            await db.from("premises").update({ lat: found.lat, lng: found.lon }).eq("id", item.id);
            
            let color = "text-success"; // Xanh: T√¨m ch√≠nh x√°c
            if(method >= 4) color = "text-warning"; // V√†ng: Ch·ªâ t√¨m th·∫•y Ph∆∞·ªùng/Qu·∫≠n
            
            logBox.innerHTML += `<div class="${color} text-[10px] pl-2">-> OK (C√°ch ${method}): ${found.display_name.substring(0,40)}...</div>`;
        } else {
            logBox.innerHTML += `<div class="text-error text-[10px] pl-2">-> V·∫™N TH·∫§T B·∫†I (Check l·∫°i t√™n Qu·∫≠n)</div>`;
        }
      }

      btn.disabled = false;
      alert("Ho√†n t·∫•t! H√£y t·∫£i l·∫°i trang ƒë·ªÉ xem b·∫£n ƒë·ªì.");
      applyFilters(true);
    }

    // H√†m g·ªçi API ri√™ng l·∫ª
    async function fetchOpenStreetMap(query) {
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
        const res = await fetch(url);
        const data = await res.json();
        if (data && data.length > 0) return data[0];
        return null;
      } catch (e) {
        return null;
      }
    }
    // H√ÄM D√í T·ªåA ƒê·ªò CHO FORM S·ª¨A (ADMIN)
    async function autoFetchCoordsForEdit() {
        const address = document.getElementById("edit-address").value;
        const district = document.getElementById("edit-district").value;
        const street = document.getElementById("edit-street").value;
        const city = document.getElementById("edit-city").value || "H·ªì Ch√≠ Minh";

        if (!district) {
            alert("Vui l√≤ng nh·∫≠p Qu·∫≠n trong form s·ª≠a tr∆∞·ªõc!");
            return;
        }

        const btn = document.querySelector("button[onclick='autoFetchCoordsForEdit()']");
        const oldText = btn.innerText;
        btn.innerText = "ƒêang d√≤...";
        btn.disabled = true;

        try {
            // Logic t√¨m ki·∫øm gi·ªëng h·ªát l√∫c th√™m m·ªõi
            let query = `${address}, ${district}, ${city}`;
            // N·∫øu ƒë·ªãa ch·ªâ qu√° ng·∫Øn ho·∫∑c kh√¥ng c√≥ s·ªë nh√†, ∆∞u ti√™n t√¨m theo ƒë∆∞·ªùng
            if (!address || (address.split(' ').length < 2 && street)) {
                 query = `${street}, ${district}, ${city}`;
            }

            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
            const res = await fetch(url);
            const data = await res.json();

            if (data && data.length > 0) {
                document.getElementById("edit-lat").value = data[0].lat;
                document.getElementById("edit-lng").value = data[0].lon;
                toast(`ƒê√£ t√¨m th·∫•y: ${data[0].display_name.split(',')[0]}`);
            } else {
                // Th·ª≠ l·∫°i l·∫ßn 2 ch·ªâ v·ªõi T√™n ƒë∆∞·ªùng + Qu·∫≠n (fallback)
                if (street) {
                    const url2 = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(street + ", " + district + ", " + city)}&limit=1`;
                    const res2 = await fetch(url2);
                    const data2 = await res2.json();
                    if (data2 && data2.length > 0) {
                         document.getElementById("edit-lat").value = data2[0].lat;
                         document.getElementById("edit-lng").value = data2[0].lon;
                         toast(`ƒê√£ t√¨m th·∫•y (theo ƒë∆∞·ªùng): ${data2[0].display_name.split(',')[0]}`);
                         return;
                    }
                }
                alert("Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô. Vui l√≤ng nh·∫≠p tay ho·∫∑c ki·ªÉm tra l·∫°i ƒë·ªãa ch·ªâ.");
            }
        } catch (e) {
            console.error(e);
            toast("L·ªói k·∫øt n·ªëi b·∫£n ƒë·ªì.");
        } finally {
            btn.innerText = oldText;
            btn.disabled = false;
        }
    }
    // --- CODE M·ªöI: HI·ªÜU ·ª®NG CO GI√ÉN MENU ---
    window.addEventListener("scroll", function() {
      const navbar = document.getElementById("main-navbar");
      const logo = document.getElementById("navbar-logo");
      
      if (!navbar || !logo) return;

      if (window.scrollY > 20) {
        // KHI K√âO XU·ªêNG: Thu nh·ªè l·∫°i
        navbar.classList.remove("py-4"); 
        navbar.classList.add("py-2", "shadow-md"); 
        
        logo.classList.remove("h-16");
        logo.classList.add("h-10"); // Thu v·ªÅ 40px
      } else {
        // KHI ·ªû ƒê·∫¶U TRANG: Ph√≥ng to ra
        navbar.classList.add("py-4");
        navbar.classList.remove("py-2", "shadow-md");
        
        logo.classList.add("h-16");
        logo.classList.remove("h-10");
      }
    });
    // --- C·∫§P C·ª®U: KH√îI PH·ª§C CH·ª®C NƒÇNG L·ªåC QU·∫¨N ---
    setTimeout(() => {
        // 1. N·∫°p l·∫°i danh s√°ch Qu·∫≠n t·ª´ d·ªØ li·ªáu ngu·ªìn
        if (typeof buildDistrictWardOptions === 'function') {
            console.log("ƒêang n·∫°p l·∫°i danh s√°ch Qu·∫≠n...");
            buildDistrictDropdown();
        }

        // 2. K·∫øt n·ªëi l·∫°i s·ª± ki·ªán: Ch·ªçn Qu·∫≠n -> T·ª± ƒë·ªïi Ph∆∞·ªùng & L·ªçc b√†i
        const districtSelect = document.getElementById("filter-district");
        if (districtSelect) {
            // X√≥a s·ª± ki·ªán c≈© (ƒë·ªÉ tr√°nh b·ªã tr√πng) r·ªìi g√°n m·ªõi
            const newSelect = districtSelect.cloneNode(true);
            districtSelect.parentNode.replaceChild(newSelect, districtSelect);
            
            newSelect.addEventListener("change", function() {
                // C·∫≠p nh·∫≠t ph∆∞·ªùng t∆∞∆°ng ·ª©ng
                if (typeof updateWardOptions === 'function') {
                    updateWardOptions();
                }
                // G·ªçi h√†m l·ªçc
                if (typeof applyFilters === 'function') {
                    applyFilters(true);
                }
            });
            
            // N·∫øu ƒëang c√≥ qu·∫≠n ƒë∆∞·ª£c ch·ªçn s·∫µn (v√≠ d·ª• load l·∫°i trang), h√£y n·∫°p ph∆∞·ªùng lu√¥n
            if (newSelect.value) {
                 if (typeof updateWardOptions === 'function') updateWardOptions();
            }
        }
    }, 1000); // Ch·ªù 1 gi√¢y ƒë·ªÉ ƒë·∫£m b·∫£o HTML ƒë√£ v·∫Ω xong  
// --- LOGIC TABLE VIEW (EXCEL MODE) ---

    // 1. H√†m v·∫Ω b·∫£ng
    function renderTable(rows) {
      const tbody = document.getElementById("table-body");
      if (!tbody) return;
      tbody.innerHTML = "";

      if (!rows || rows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
        return;
      }

      const html = rows.map(row => {
        let thumb = "";
        if (row.images && row.images.length > 0) {
            let path = Array.isArray(row.images) ? row.images[0] : (JSON.parse(row.images || "[]")[0] || ""); 
            if(path) thumb = `<img src="${buildImageUrl(path)}" class="w-8 h-8 object-cover rounded border" />`;
        }

        const isAdminUser = isAdmin(); 

        // --- X·ª¨ L√ù GI√Å TI·ªÄN (INPUT TEXT C√ì FORMAT) ---
        // Chuy·ªÉn gi√° th√†nh chu·ªói c√≥ d·∫•u ch·∫•m (VD: 10.000.000)
        const formattedPrice = row.price ? new Intl.NumberFormat('vi-VN').format(row.price) : "";
        
        const priceCell = isAdminUser 
          ? `<input type="text" class="input input-ghost input-xs w-28 font-bold text-right" 
               value="${formattedPrice}" 
               onkeyup="formatCurrencyInput(this)" 
               onchange="quickUpdate('${row.id}', 'price', this.value)" />`
          : `<span class="font-bold text-primary">${money(row.price)}</span>`;

        // --- X·ª¨ L√ù DI·ªÜN T√çCH (L√ÄM TR√íN 2 S·ªê) ---
        const areaVal = row.area ? Number(row.area).toFixed(2).replace(/\.00$/, '') : "0";

        const commCell = isAdminUser
          ? `<input type="text" class="input input-ghost input-xs w-20" 
               value="${row.commission_note || ''}" placeholder="..." 
               onchange="quickUpdate('${row.id}', 'commission_note', this.value)" />`
          : `<span>${row.commission_note || '-'}</span>`;

        const statusOpts = `
            <option value="available" ${row.status==='available'?'selected':''}>Tr·ªëng</option>
            <option value="deposited" ${row.status==='deposited'?'selected':''}>C·ªçc</option>
            <option value="rented" ${row.status==='rented'?'selected':''}>Thu√™</option>
        `;
        const statusCell = isAdminUser
          ? `<select class="select select-ghost select-xs" onchange="quickUpdate('${row.id}', 'status', this.value)">${statusOpts}</select>`
          : `<span class="badge badge-xs">${row.status}</span>`;

        return `
          <tr class="hover">
            <td>${thumb}</td>
            <td>
                <div class="font-bold text-xs">${row.code || '---'}</div>
                <div class="text-[10px] opacity-70 truncate max-w-[150px]" title="${row.address}">${maskAddress(row)}</div>
            </td>
            <td>
                <div class="text-[10px]">
                    ${row.width || 0}x${row.length || 0}m | <b>${areaVal}m¬≤</b><br/>
                    ${row.ket_cau || '-'}
                </div>
            </td>
            <td class="text-right">${priceCell}</td>
            <td>${commCell}</td>
            <td>${statusCell}</td>
            <td>
               <button class="btn btn-xs btn-square btn-ghost" onclick="openDetail('${row.id}')">üëÅ</button>
               ${isAdminUser ? `<button class="btn btn-xs btn-square btn-ghost text-blue-600" onclick="openEditPremise('${row.id}')">‚úèÔ∏è</button>` : ''}
            </td>
          </tr>
        `;
      }).join("");

      tbody.innerHTML = html;
    }

    // 2. H√†m l∆∞u nhanh (Auto Save khi s·ª≠a √¥ input)
    // 2. H√†m l∆∞u nhanh (Auto Save khi s·ª≠a √¥ input)
    async function quickUpdate(id, field, value) {
        if(!isAdmin()) { toast("Kh√¥ng c√≥ quy·ªÅn!"); return; }
        
        toast(`ƒêang l∆∞u ${field}...`);

        let payload = {};
        
        // --- X·ª¨ L√ù ƒê·∫∂C BI·ªÜT CHO GI√Å ---
        if(field === 'price') {
            // X√≥a h·∫øt d·∫•u ch·∫•m, ph·∫©y ho·∫∑c ch·ªØ, ch·ªâ gi·ªØ l·∫°i s·ªë
            // VD: "10.000.000" -> 10000000
            const rawVal = value.toString().replace(/\D/g, '');
            payload[field] = rawVal ? Number(rawVal) : 0;
        } else {
            payload[field] = value;
        }

        if(field === 'status' && value === 'rented') {
             payload['rented_confirmed_at'] = new Date().toISOString();
        }

        const { error } = await db.from('premises').update(payload).eq('id', id);
        
        if(error) {
            toast("L·ªói l∆∞u: " + error.message);
        } else {
            // C·∫≠p nh·∫≠t l·∫°i d·ªØ li·ªáu local ƒë·ªÉ kh√¥ng c·∫ßn reload trang
            const row = LAST_ROWS.find(r => r.id === id);
            if(row) row[field] = payload[field];
            toast("ƒê√£ l∆∞u ‚úÖ");
        }
    }
    // === H√ÄM H·ªñ TR·ª¢: Ch·ªçn item trong dropdown theo t√™n g·∫ßn ƒë√∫ng ===
    function setSelectOptionByText(selectId, textToFind) {
        const select = document.getElementById(selectId);
        if (!select || !textToFind) return false;
        
        const cleanText = textToFind.toLowerCase().trim()
            .replace(/^q\.|^q\s|^qu·∫≠n\s/g, "") // B·ªè ch·ªØ Qu·∫≠n, Q.
            .replace(/^p\.|^p\s|^ph∆∞·ªùng\s/g, ""); // B·ªè ch·ªØ Ph∆∞·ªùng, P.

        for (let i = 0; i < select.options.length; i++) {
            const optText = select.options[i].text.toLowerCase();
            const optVal = select.options[i].value.toLowerCase();
            
            // So s√°nh t√¨m chu·ªói con (VD: t√¨m "G√≤ V·∫•p" trong "Qu·∫≠n G√≤ V·∫•p")
            if (optText.includes(cleanText) || optVal.includes(cleanText)) {
                select.selectedIndex = i;
                select.dispatchEvent(new Event('change')); // K√≠ch ho·∫°t s·ª± ki·ªán ƒë·ªÉ load Ph∆∞·ªùng
                return true;
            }
        }
        return false;
    }

    // === T√çNH NƒÇNG: T·ª∞ ƒê·ªòNG ƒêI·ªÄN FORM T·ª™ M√î T·∫¢ (B·∫¢N N√ÇNG C·∫§P) ===
    function autoFillFromDesc() {
        const text = document.getElementById("add-detail").value;
        if (!text) {
            toast("Vui l√≤ng d√°n n·ªôi dung v√†o √¥ M√¥ t·∫£ chi ti·∫øt tr∆∞·ªõc!");
            return;
        }

        const setVal = (id, val) => {
            const el = document.getElementById(id);
            if (el && val) el.value = val; // Ghi ƒë√® lu√¥n ƒë·ªÉ s·ª≠a n·∫øu sai
        };

        // --- 1. X·ª¨ L√ù C√ÅC TR∆Ø·ªúNG C∆† B·∫¢N (S·ªê) ---
        
        // SƒêT
        const phoneMatch = text.match(/(0[3|5|7|8|9][0-9]{8})\b/);
        if (phoneMatch) setVal("add-contact-phone", phoneMatch[1]);

        // K√≠ch th∆∞·ªõc (Ngang x D√†i)
        const dimMatch = text.match(/(\d+(?:[.,]\d+)?)\s*[m]?\s*[xX*]\s*(\d+(?:[.,]\d+)?)/);
        if (dimMatch) {
            const w = parseFloat(dimMatch[1].replace(',', '.'));
            const l = parseFloat(dimMatch[2].replace(',', '.'));
            setVal("add-width", w);
            setVal("add-length", l);
            // T·ª± t√≠nh di·ªán t√≠ch n·∫øu ch∆∞a c√≥
            if(!document.getElementById("add-area").value) {
                setVal("add-area", w * l);
            }
        } else {
            // T√¨m di·ªán t√≠ch l·∫ª (DT: 100m2)
            const areaMatch = text.match(/(?:dt|di·ªán t√≠ch)[:\s]*(\d+(?:[.,]\d+)?)\s*(?:m2|m¬≤)/i);
            if (areaMatch) setVal("add-area", areaMatch[1].replace(',', '.'));
        }

        // K·∫øt c·∫•u (L·∫•y h·∫øt n·ªôi dung sau ch·ªØ "K·∫øt c·∫•u:" ƒë·∫øn h·∫øt d√≤ng ho·∫∑c d·∫•u ph·∫©y xa nh·∫•t)
        // VD: "K·∫øt c·∫•u: Tr·ªát, 2 l·∫ßu, ST" -> L·∫•y "Tr·ªát, 2 l·∫ßu, ST"
        const structMatch = text.match(/(?:k·∫øt c·∫•u|kc)[:\s]+(.+?)(?:\n|$|\.)/i);
        if (structMatch) {
            setVal("add-ket-cau", structMatch[1].trim());
        }

        // S·ªë t·∫ßng, PN, WC (Gi·ªØ nguy√™n logic c≈© v√¨ kh√° ·ªïn)
        const floorMatch = text.match(/(\d+)\s*(?:l·∫ßu|t·∫ßng|lau|tang)/i);
        if (floorMatch) setVal("add-floors", floorMatch[1]);

        const pnMatch = text.match(/(\d+)\s*(?:pn|ph√≤ng|phong)/i);
        if (pnMatch) setVal("add-bedrooms", pnMatch[1]);

        const wcMatch = text.match(/(\d+)\s*(?:wc|toilet)/i);
        if (wcMatch) setVal("add-wc", wcMatch[1]);

        // Hoa h·ªìng (T√¨m ch·ªØ HH, Hoa h·ªìng, Ph√≠ MG)
        const commMatch = text.match(/(?:hoa h·ªìng|hh|ph√≠ mg|ph√≠)[:\s]+(.+?)(?:\n|$|\.)/i);
        if (commMatch) {
             setVal("add-commission", commMatch[1].trim());
        }

        // Gi√° thu√™
        let price = 0;
        const tyMatch = text.match(/(\d+(?:[.,]\d+)?)\s*(?:t·ª∑|ty)\b/i);
        if (tyMatch) price = parseFloat(tyMatch[1].replace(',', '.')) * 1000000000;
        else {
            const trMatch = text.match(/(\d+(?:[.,]\d+)?)\s*(?:tr|tri·ªáu|trieu)\b/i);
            if (trMatch) price = parseFloat(trMatch[1].replace(',', '.')) * 1000000;
        }
        if (price > 0) {
            const inputPrice = document.getElementById("add-price");
            inputPrice.value = new Intl.NumberFormat('vi-VN').format(price);
        }

        // --- 2. X·ª¨ L√ù ƒê·ªäA CH·ªà & QU·∫¨N/PH∆Ø·ªúNG (PH·ª®C T·∫†P) ---
        
        // T√¨m d√≤ng ch·ª©a ƒë·ªãa ch·ªâ (Th∆∞·ªùng c√≥ ch·ªØ "ƒê∆∞·ªùng", "Ph∆∞·ªùng", "Qu·∫≠n" ho·∫∑c n·∫±m ngay ƒë·∫ßu)
        // Chi·∫øn thu·∫≠t: T√¨m Qu·∫≠n tr∆∞·ªõc, sau ƒë√≥ suy ng∆∞·ª£c ra Ph∆∞·ªùng v√† ƒê∆∞·ªùng
        
        let districtName = "";
        let wardName = "";
        let streetName = "";
        let fullAddr = "";

        // Regex t√¨m Qu·∫≠n (VD: Qu·∫≠n 1, Q.1, Qu·∫≠n G√≤ V·∫•p, Q.GV)
        const distMatch = text.match(/(?:qu·∫≠n|q\.|q)\s*([\p{L}\d\s]+?)(?:,|$|\n|ph∆∞·ªùng|p\.)/iu);
        
        if (distMatch) {
            // L·∫•y t√™n qu·∫≠n th√¥
            let rawDist = distMatch[1].trim().replace(/,$/, "");
            
            // X·ª≠ l√Ω map Qu·∫≠n t√™n t·∫Øt th√†nh t√™n ƒë·∫ßy ƒë·ªß n·∫øu c·∫ßn
            if(rawDist.toLowerCase() === 'gv') rawDist = "G√≤ V·∫•p";
            if(rawDist.toLowerCase() === 'pn') rawDist = "Ph√∫ Nhu·∫≠n";
            if(rawDist.toLowerCase() === 'tb') rawDist = "T√¢n B√¨nh";
            if(rawDist.toLowerCase() === 'tp') rawDist = "T√¢n Ph√∫";
            
            // 1. CH·ªåN QU·∫¨N TR√äN DROPDOWN
            const foundDist = setSelectOptionByText("add-district", rawDist);
            
            if(foundDist) {
                districtName = rawDist;
                // N·∫øu ch·ªçn ƒë∆∞·ª£c Qu·∫≠n, t√¨m ti·∫øp Ph∆∞·ªùng trong text
                // Regex t√¨m Ph∆∞·ªùng (VD: Ph∆∞·ªùng 9, P.9)
                const wardMatch = text.match(/(?:ph∆∞·ªùng|p\.|p)\s*(\d+|[\p{L}\s]+)(?:,|$|\n|qu·∫≠n|q\.)/iu);
                if(wardMatch) {
                    wardName = wardMatch[1].trim().replace(/,$/, "");
                    // 2. CH·ªåN PH∆Ø·ªúNG (C·∫ßn setTimeout nh·ªè ƒë·ªÉ dropdown Ph∆∞·ªùng k·ªãp render sau khi ch·ªçn Qu·∫≠n)
                    setTimeout(() => {
                        setSelectOptionByText("add-ward", wardName);
                    }, 100);
                }
            }
        }

        // T√¨m t√™n ƒë∆∞·ªùng v√† S·ªë nh√† (Logic: L·∫•y ph·∫ßn text ƒë·ª©ng tr∆∞·ªõc Ph∆∞·ªùng/Qu·∫≠n)
        // VD: "123 Nguy·ªÖn Tr√£i, Ph∆∞·ªùng 2, Qu·∫≠n 5" -> L·∫•y "123 Nguy·ªÖn Tr√£i"
        const addressLineMatch = text.match(/(?:ƒë·ªãa ch·ªâ|ƒëc|nh√†)[:\s]*(.*?)(?:,?\s*(?:ph∆∞·ªùng|p\.|qu·∫≠n|q\.))/i);
        
        if (addressLineMatch) {
            fullAddr = addressLineMatch[1].trim();
        } else {
            // N·∫øu kh√¥ng c√≥ t·ª´ kh√≥a "ƒê·ªãa ch·ªâ", qu√©t d√≤ng ƒë·∫ßu ti√™n c√≥ ch·ª©a "ƒê∆∞·ªùng" ho·∫∑c t√™n ƒë∆∞·ªùng
            // C√°ch ƒë∆°n gi·∫£n: L·∫•y d√≤ng ƒë·∫ßu ti√™n c·ªßa m√¥ t·∫£ l√†m ƒë·ªãa ch·ªâ n·∫øu ch∆∞a t√¨m th·∫•y
            const firstLine = text.split('\n')[0];
            // L·ªçc b·ªõt c√°c t·ª´ qu·∫£ng c√°o "Cho thu√™ nh√†..."
            fullAddr = firstLine.replace(/^(cho thu√™|b√°n|sang)\s+(nh√†|mb|m·∫∑t b·∫±ng)\s+/i, "").trim();
            // C·∫Øt b·ªè ph·∫ßn Ph∆∞·ªùng/Qu·∫≠n ·ªü ƒëu√¥i n·∫øu d√≠nh v√†o
            fullAddr = fullAddr.split(/,|ph∆∞·ªùng|qu·∫≠n/i)[0].trim();
        }

        if(fullAddr) {
            setVal("add-address", fullAddr); // ƒêi·ªÅn full ƒë·ªãa ch·ªâ
            
            // T√°ch t√™n ƒë∆∞·ªùng (B·ªè s·ªë nh√† ·ªü ƒë·∫ßu: "123 Nguy·ªÖn Tr√£i" -> "Nguy·ªÖn Tr√£i")
            const streetOnly = fullAddr.replace(/^\d+[\/\w]*\s+/, "").replace(/^(h·∫ªm|ƒë∆∞·ªùng)\s+/i, "");
            setVal("add-street", streetOnly);
        }

        // Lo·∫°i h√¨nh (M·∫∑t ti·ªÅn / H·∫ªm)
        const isMT = text.toLowerCase().includes("m·∫∑t ti·ªÅn") || text.toLowerCase().includes("mt");
        const isHXH = text.toLowerCase().includes("hxh") || text.toLowerCase().includes("xe h∆°i");
        const roadSelect = document.getElementById("add-road-type");
        if(isMT) roadSelect.value = "M·∫∑t ti·ªÅn";
        else if(isHXH) roadSelect.value = "H·∫ªm xe h∆°i";
        else roadSelect.value = "H·∫ªm";

        toast("ƒê√£ qu√©t v√† ƒëi·ªÅn th√¥ng tin chi ti·∫øt!");
    }
  </script>
  <dialog id="toolDlg" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">C√¥ng c·ª• Admin</h3>
      
      <div class="border p-4 rounded-xl bg-base-200">
        <h4 class="font-bold text-sm mb-2">T·ª± ƒë·ªông c·∫≠p nh·∫≠t T·ªça ƒë·ªô (Lat/Lng)</h4>
        <p class="text-xs opacity-70 mb-3">
          H·ªá th·ªëng s·∫Ω t√¨m nh·ªØng m·∫∑t b·∫±ng <b>ch∆∞a c√≥ t·ªça ƒë·ªô</b> v√† t·ª± ƒë·ªông qu√©t t·ª´ ƒë·ªãa ch·ªâ.
          <br/><span class="text-error">L∆∞u √Ω: T·ªëc ƒë·ªô ch·∫≠m (1.5s/cƒÉn) ƒë·ªÉ tr√°nh b·ªã kh√≥a IP. Vui l√≤ng kh√¥ng t·∫Øt tab.</span>
        </p>
        
        <div class="flex items-center gap-2">
          <button id="btn-start-sync" class="btn btn-primary btn-sm" onclick="startSyncCoordinates()">
            ‚ñ∂ B·∫Øt ƒë·∫ßu qu√©t
          </button>
          <button class="btn btn-sm btn-ghost" onclick="STOP_SYNC = true">‚èπ D·ª´ng l·∫°i</button>
        </div>

        <div id="sync-status" class="mt-3 text-xs font-mono hidden">
          ƒêang x·ª≠ l√Ω: <span id="sync-count" class="font-bold text-primary">0</span> / <span id="sync-total">0</span>
          <div class="w-full bg-gray-300 h-2 rounded mt-1 overflow-hidden">
             <div id="sync-bar" class="bg-primary h-full w-0 transition-all duration-300"></div>
          </div>
          <div id="sync-log" class="mt-2 max-h-32 overflow-y-auto border p-2 bg-white rounded text-[10px]"></div>
        </div>
      </div>

      <div class="modal-action">
        <form method="dialog"><button class="btn">ƒê√≥ng</button></form>
      </div>
    </div>
  </dialog>
</body>
</html>