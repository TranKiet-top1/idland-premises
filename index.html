<!doctype html>
<html lang="vi" data-theme="corporate">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ID-Land ‚Äì B·ªô l·ªçc m·∫∑t b·∫±ng (Supabase)</title>
  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .line-clamp-1{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}
  </style>
</head>
<body class="bg-base-200">

  <!-- AUTH WRAPPER -->
  <div id="auth-section" class="min-h-screen flex items-center justify-center hidden">
    <div class="card w-full max-w-sm bg-base-100 shadow-xl">
      <div class="card-body space-y-3">
        <h2 class="card-title mb-2">ƒêƒÉng nh·∫≠p ID-Land Premises</h2>
        <input id="auth-email" type="email" placeholder="Email"
               class="input input-bordered w-full" />
        <input id="auth-password" type="password" placeholder="M·∫≠t kh·∫©u"
               class="input input-bordered w-full" />
        <button id="btn-login" class="btn btn-primary w-full">ƒêƒÉng nh·∫≠p</button>
        <p id="auth-error" class="text-error text-sm mt-1 hidden"></p>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app-root" class="hidden min-h-screen bg-gradient-to-b from-base-200 to-base-100 text-base-content">

    <!-- NAV -->
    <header class="sticky top-0 z-20 bg-base-100/90 backdrop-blur border-b shadow-sm">
      <div class="max-w-7xl mx-auto px-4">
        <div class="navbar p-0 min-h-14">
          <div class="flex-1 gap-3 items-center">
            <div class="flex items-center gap-2">
              <div class="w-9 h-9 rounded-xl bg-primary/10 flex items-center justify-center">
                <span class="font-black text-primary text-lg">ID</span>
              </div>
              <div class="flex flex-col leading-tight">
                <span class="font-bold text-lg">ID-Land Premises</span>
                <span class="text-xs opacity-70 hidden sm:block">Kho m·∫∑t b·∫±ng cho thu√™ ‚Ä¢ TP.HCM</span>
              </div>
            </div>
            <div id="badgeEnv" class="badge badge-outline text-xs">Supabase</div>
          </div>
          <div class="flex-none flex items-center gap-3">
            <div class="hidden sm:flex flex-col items-end text-[11px] leading-tight">
              <span id="countGlobal" class="opacity-70">‚Äî</span>
              <span class="opacity-40">ƒê·ªìng b·ªô Google Sheet</span>
            </div>
            <button class="btn btn-primary btn-sm rounded-full shadow-md" onclick="openAdd()">
              + Th√™m m·∫∑t b·∫±ng
            </button>
            <!-- N√öT ƒêƒÇNG XU·∫§T -->
            <button id="btn-logout" class="btn btn-ghost text-sm opacity-70 hover:opacity-100">
              ƒêƒÉng xu·∫•t
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- HERO -->
    <section class="bg-base-100/80 border-b">
      <div class="max-w-7xl mx-auto px-4 py-4 sm:py-5 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div class="space-y-1">
          <h1 class="text-xl sm:text-2xl font-bold">
            B·ªô l·ªçc m·∫∑t b·∫±ng cho thu√™ <span class="text-primary">ID-Land</span>
          </h1>
          <p class="text-sm sm:text-[13px] opacity-70 max-w-2xl">
            Nh√¢n s·ª± ch·ªâ c·∫ßn nh·∫≠p y√™u c·∫ßu c·ªßa kh√°ch: <b>gi√° ‚Äì di·ªán t√≠ch ‚Äì khu v·ª±c ‚Äì m·∫∑t ti·ªÅn</b>, b·ªô l·ªçc s·∫Ω tr·∫£ v·ªÅ danh s√°ch m·∫∑t b·∫±ng ph√π h·ª£p k√®m h√¨nh ·∫£nh & Google Maps.
          </p>
          <div class="flex flex-wrap gap-2 pt-1">
            <div class="badge badge-ghost badge-sm gap-1">
              <span class="w-1.5 h-1.5 rounded-full bg-success"></span> Realtime t·ª´ Supabase
            </div>
            <div class="badge badge-ghost badge-sm">ƒê·ªìng b·ªô Google Sheet</div>
            <div class="badge badge-ghost badge-sm">Upload ·∫£nh m·∫∑t b·∫±ng</div>
          </div>
        </div>
        <div class="flex gap-2 items-center text-xs mt-2 md:mt-0">
          <span class="hidden sm:inline opacity-60">L·ªçc nhanh:</span>
          <button class="btn btn-xs btn-outline rounded-full" onclick="quickFilter('available')">C√≤n tr·ªëng</button>
          <button class="btn btn-xs btn-outline rounded-full" onclick="quickFilter('deposited')">Gi·ªØ c·ªçc</button>
          <button class="btn btn-xs btn-outline rounded-full" onclick="quickFilterDistrict('Qu·∫≠n 1')">Qu·∫≠n 1</button>
          <button class="btn btn-xs btn-outline rounded-full" onclick="quickFilterDistrict('Qu·∫≠n 10')">Qu·∫≠n 10</button>
        </div>
      </div>
    </section>

    <!-- BODY -->
    <main class="max-w-7xl mx-auto px-4 py-5 grid grid-cols-1 lg:grid-cols-5 gap-5">
      <!-- FILTERS -->
      <aside class="lg:col-span-1 bg-base-100 rounded-2xl p-4 sm:p-5 shadow-sm border space-y-3 sticky top-[108px] h-fit">
        <div class="flex items-center justify-between gap-2">
          <div class="text-base font-semibold flex items-center gap-2">
            <span class="inline-flex w-6 h-6 rounded-full bg-primary/10 items-center justify-center">
              <span class="w-1.5 h-1.5 rounded-full bg-primary"></span>
            </span>
            B·ªô l·ªçc
          </div>
        </div>

        <div class="form-control">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide">T·ª´ kh√≥a</span>
          </label>
          <input id="kw" class="input input-bordered input-sm w-full rounded-xl" placeholder="VD: Tr·∫ßn H∆∞ng ƒê·∫°o, Q5..." />
        </div>

        <div class="form-control">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide">Qu·∫≠n</span>
          </label>
          <select id="district" class="select select-bordered select-sm w-full rounded-xl">
            <option value="">T·∫•t c·∫£</option>
          </select>
        </div>

        <!-- PH∆Ø·ªúNG FILTER -->
        <div class="form-control">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide">Ph∆∞·ªùng</span>
          </label>
          <select id="ward" class="select select-bordered select-sm w-full rounded-xl">
            <option value="">T·∫•t c·∫£</option>
          </select>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text text-[11px] font-semibold uppercase tracking-wide">Gi√° t·ªëi thi·ªÉu</span>
            </label>
            <input id="minPrice" type="number" class="input input-bordered input-sm w-full rounded-xl" />
          </div>
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text text-[11px] font-semibold uppercase tracking-wide">Gi√° t·ªëi ƒëa</span>
            </label>
            <input id="maxPrice" type="number" class="input input-bordered input-sm w-full rounded-xl" />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text text-[11px] font-semibold uppercase tracking-wide">DT t·ªëi thi·ªÉu (m¬≤)</span>
            </label>
            <input id="minArea" type="number" class="input input-bordered input-sm w-full rounded-xl" />
          </div>
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text text-[11px] font-semibold uppercase tracking-wide">DT t·ªëi ƒëa (m¬≤)</span>
            </label>
            <input id="maxArea" type="number" class="input input-bordered input-sm w-full rounded-xl" />
          </div>
        </div>

        <div class="form-control">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide">M·∫∑t ti·ªÅn</span>
          </label>
          <select id="frontage" class="select select-bordered select-sm w-full rounded-xl">
            <option value="">T·∫•t c·∫£</option>
            <option value="yes">C√≥</option>
            <option value="no">Kh√¥ng</option>
          </select>
        </div>

        <div class="form-control">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide">T√¨nh tr·∫°ng</span>
          </label>
          <select id="status" class="select select-bordered select-sm w-full rounded-xl">
            <option value="">T·∫•t c·∫£</option>
            <option value="available">C√≤n tr·ªëng</option>
            <option value="deposited">Gi·ªØ c·ªçc</option>
            <option value="rented">ƒê√£ thu√™</option>
          </select>
        </div>

        <div class="form-control">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide">Ng√†nh ph√π h·ª£p</span>
          </label>
          <input id="suitable" class="input input-bordered input-sm w-full rounded-xl" placeholder="VD: cafe, ph·ªü..." />
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text text-xs font-semibold uppercase tracking-wide">S·∫Øp x·∫øp</span>
            </label>
            <select id="sort" class="select select-bordered select-sm w-full rounded-xl">
              <option value="newest">M·ªõi nh·∫•t</option>
              <option value="price_asc">Gi√° tƒÉng d·∫ßn</option>
              <option value="price_desc">Gi√° gi·∫£m d·∫ßn</option>
            </select>
          </div>
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text text-xs font-semibold uppercase tracking-wide">M·ªói trang</span>
            </label>
            <select id="perPage" class="select select-bordered select-sm w-full rounded-xl">
              <option>24</option><option>48</option><option>96</option>
            </select>
          </div>
        </div>

        <div class="flex gap-2 pt-1">
          <button id="btnApply" class="btn btn-primary btn-sm flex-1 rounded-full">L·ªçc</button>
          <button class="btn btn-sm flex-1 rounded-full" onclick="resetFilters()">X√≥a l·ªçc</button>
        </div>
        <p class="text-[11px] opacity-60 pt-1">
          G·ª£i √Ω: nh·∫≠p ƒë√∫ng <b>ƒë∆∞·ªùng + qu·∫≠n</b> ƒë·ªÉ l·ªçc nhanh (VD: ‚ÄúL√™ ƒê·ª©c Th·ªç Q. G√≤ V·∫•p‚Äù).
        </p>
      </aside>

      <!-- LIST -->
      <section class="lg:col-span-4 space-y-3">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
          <div id="countPage" class="text-xs sm:text-sm opacity-70">‚Äî</div>
          <div class="flex items-center gap-2 justify-between sm:justify-end">
            <button class="btn btn-ghost btn-xs rounded-full" onclick="downloadCSV()">
              T·∫£i CSV tr√™n Supabase
            </button>
          </div>
        </div>

        <div id="grid" class="grid sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>

        <div class="flex justify-center mt-4">
          <button id="btnMore" class="btn btn-sm rounded-full px-6" disabled>‚Äî</button>
        </div>
      </section>
    </main>

    <!-- ADD MODAL -->
    <dialog id="dlg" class="modal">
      <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg mb-3">Th√™m m·∫∑t b·∫±ng m·ªõi</h3>
        <p class="text-xs opacity-60 mb-3">
          ƒêi·ªÅn t·ªëi ƒëa th√¥ng tin c√≥ th·ªÉ. ·∫¢nh m·∫∑t b·∫±ng s·∫Ω ƒë∆∞·ª£c upload l√™n Supabase Storage (bucket <b>premise-images</b>).
        </p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <input id="f_address" class="input input-bordered input-sm" placeholder="ƒê·ªãa ch·ªâ (ghi r√µ s·ªë, ƒë∆∞·ªùng)">
          <input id="f_street" class="input input-bordered input-sm" placeholder="ƒê∆∞·ªùng">

          <!-- QU·∫¨N -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text text-xs font-semibold uppercase tracking-wide">Qu·∫≠n</span>
            </label>
            <select id="add-district" class="select select-bordered select-sm w-full rounded-xl">
              <option value="">Ch·ªçn qu·∫≠n</option>
            </select>
          </div>

          <!-- PH∆Ø·ªúNG -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text text-xs font-semibold uppercase tracking-wide">Ph∆∞·ªùng</span>
            </label>
            <select id="add-ward" class="select select-bordered select-sm w-full rounded-xl">
              <option value="">Ch·ªçn ph∆∞·ªùng</option>
            </select>
          </div>

          <input id="f_width" type="number" class="input input-bordered input-sm" placeholder="Ngang (m)">
          <input id="f_length" type="number" class="input input-bordered input-sm" placeholder="D√†i (m)">
          <input id="f_area" type="number" class="input input-bordered input-sm" placeholder="Di·ªán t√≠ch (m¬≤)">
          <input id="f_floors" type="number" class="input input-bordered input-sm" placeholder="S·ªë t·∫ßng">
          <input id="f_price" type="number" class="input input-bordered input-sm" placeholder="Gi√° thu√™ (VND)">
          <input id="f_commission" class="input input-bordered input-sm" placeholder="Hoa h·ªìng (vd: hh1/2)">
          <input id="f_suitable" class="input input-bordered input-sm" placeholder="Ng√†nh ph√π h·ª£p (c√°ch nhau d·∫•u ph·∫©y)">
          <select id="f_status" class="select select-bordered select-sm">
            <option value="available">C√≤n tr·ªëng</option>
            <option value="deposited">Gi·ªØ c·ªçc</option>
            <option value="rented">ƒê√£ thu√™</option>
          </select>
          <input id="f_contact_name" class="input input-bordered input-sm" placeholder="T√™n li√™n h·ªá">
          <input id="f_contact_phone" class="input input-bordered input-sm" placeholder="SƒêT li√™n h·ªá">
          <label class="label cursor-pointer gap-2">
            <span class="label-text text-sm">M·∫∑t ti·ªÅn</span>
            <input id="f_frontage" type="checkbox" class="toggle toggle-sm">
          </label>
        </div>
        <div class="divider my-3">·∫¢nh m·∫∑t b·∫±ng</div>
        <input id="f_images" type="file" class="file-input file-input-bordered file-input-sm w-full" multiple accept="image/*" />
        <progress id="upProgress" class="progress progress-primary w-full hidden mt-2" value="0" max="100"></progress>
        <p id="upHint" class="text-[11px] opacity-60 mt-1">
          Ch·ªçn 1‚Äì10 ·∫£nh. ∆Øu ti√™n ·∫£nh m·∫∑t ti·ªÅn, t·ªïng th·ªÉ, layout b√™n trong.
        </p>
        <div class="modal-action">
          <form method="dialog" class="flex gap-2">
            <button class="btn btn-sm">ƒê√≥ng</button>
            <button class="btn btn-primary btn-sm" onclick="addItem()">L∆∞u m·∫∑t b·∫±ng</button>
          </form>
        </div>
      </div>
    </dialog>

    <!-- DETAIL MODAL -->
    <dialog id="detailDlg" class="modal">
      <div class="modal-box max-w-4xl">
        <form method="dialog">
          <button class="btn btn-sm btn-circle absolute right-2 top-2">‚úï</button>
        </form>
        <div id="detailBody" class="space-y-4"></div>
      </div>
    </dialog>

    <footer class="text-center text-[11px] text-base-content/60 py-6 border-t mt-4">
      ¬© <span id="yr"></span> ID-Land ‚Ä¢ B·ªô l·ªçc m·∫∑t b·∫±ng (Supabase + Google Sheet)
    </footer>
  </div> <!-- /#app-root -->

  <script>
    // ====== CONFIG SUPABASE & AUTH STATE ======
    const SUPABASE_URL = "https://xclncowkoedwqzcemhei.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbG5jb3drb2Vkd3F6Y2VtaGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNzcwOTUsImV4cCI6MjA3Nzg1MzA5NX0.jfNM46UgXIq9LrwSXcERJJULeKB7bl_c9R9LaVhRy1A";
    const STORAGE_BUCKET = "premise-images";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let CURRENT_USER = null;
    let CURRENT_ROLE = null; // 'admin' | 'staff'

    // ====== STATE ======
    document.getElementById('yr').textContent = new Date().getFullYear();

    const DISTRICTS = [
      "Qu·∫≠n 1","Qu·∫≠n 3","Qu·∫≠n 4","Qu·∫≠n 5","Qu·∫≠n 6","Qu·∫≠n 7","Qu·∫≠n 8",
      "Qu·∫≠n 10","Qu·∫≠n 11","Qu·∫≠n B√¨nh Th·∫°nh","Qu·∫≠n Ph√∫ Nhu·∫≠n",
      "Qu·∫≠n G√≤ V·∫•p","Qu·∫≠n T√¢n B√¨nh","Qu·∫≠n T√¢n Ph√∫","Qu·∫≠n 12",
      "Th√†nh ph·ªë Th·ªß ƒê·ª©c","Huy·ªán B√¨nh Ch√°nh","Huy·ªán H√≥c M√¥n",
      "Huy·ªán Nh√† B√®","Huy·ªán C·ªß Chi","Huy·ªán C·∫ßn Gi·ªù"
    ];

    const WARDS_BY_DISTRICT = {
      "Qu·∫≠n 1": ["B·∫øn Ngh√©","B·∫øn Th√†nh","C√¥ Giang","C·∫ßu √îng L√£nh","ƒêa Kao","Nguy·ªÖn C∆∞ Trinh","Nguy·ªÖn Th√°i B√¨nh","Ph·∫°m Ng≈© L√£o","T√¢n ƒê·ªãnh"],
      "Qu·∫≠n 3": ["V√µ Th·ªã S√°u","Ph∆∞·ªùng 1","Ph∆∞·ªùng 2","Ph∆∞·ªùng 3","Ph∆∞·ªùng 4","Ph∆∞·ªùng 5","Ph∆∞·ªùng 9","Ph∆∞·ªùng 10","Ph∆∞·ªùng 11","Ph∆∞·ªùng 12","Ph∆∞·ªùng 13","Ph∆∞·ªùng 14"],
      "Qu·∫≠n 4": [],
      "Qu·∫≠n 5": [],
      "Qu·∫≠n 6": [],
      "Qu·∫≠n 7": [],
      "Qu·∫≠n 8": [],
      "Qu·∫≠n 10": [],
      "Qu·∫≠n 11": [],
      "Qu·∫≠n B√¨nh Th·∫°nh": [],
      "Qu·∫≠n Ph√∫ Nhu·∫≠n": [],
      "Qu·∫≠n G√≤ V·∫•p": [],
      "Qu·∫≠n T√¢n B√¨nh": [],
      "Qu·∫≠n T√¢n Ph√∫": [],
      "Qu·∫≠n 12": [],
      "Th√†nh ph·ªë Th·ªß ƒê·ª©c": [],
      "Huy·ªán B√¨nh Ch√°nh": [],
      "Huy·ªán H√≥c M√¥n": [],
      "Huy·ªán Nh√† B√®": [],
      "Huy·ªán C·ªß Chi": [],
      "Huy·ªán C·∫ßn Gi·ªù": []
    };

    function setupDistrictWardPair(districtId, wardId, allLabel = "T·∫•t c·∫£") {
      const districtSelect = document.getElementById(districtId);
      const wardSelect = document.getElementById(wardId);
      if (!districtSelect || !wardSelect) return;

      districtSelect.innerHTML = "";
      const optAllDistrict = document.createElement("option");
      optAllDistrict.value = "";
      optAllDistrict.textContent = allLabel === "T·∫•t c·∫£" ? "T·∫•t c·∫£" : "Ch·ªçn qu·∫≠n";
      districtSelect.appendChild(optAllDistrict);

      DISTRICTS.forEach(d => {
        const o = document.createElement("option");
        o.value = d;
        o.textContent = d;
        districtSelect.appendChild(o);
      });

      function refreshWardOptions() {
        wardSelect.innerHTML = "";
        const optAllWard = document.createElement("option");
        optAllWard.value = "";
        optAllWard.textContent = allLabel === "T·∫•t c·∫£" ? "T·∫•t c·∫£" : "Ch·ªçn ph∆∞·ªùng";
        wardSelect.appendChild(optAllWard);

        const wards = WARDS_BY_DISTRICT[districtSelect.value] || [];
        wards.forEach(w => {
          const o = document.createElement("option");
          o.value = w;
          o.textContent = w;
          wardSelect.appendChild(o);
        });
      }

      districtSelect.addEventListener("change", refreshWardOptions);
      refreshWardOptions();
    }

    setupDistrictWardPair("district", "ward", "T·∫•t c·∫£");
    setupDistrictWardPair("add-district", "add-ward", "Ch·ªçn");

    let PAGE = 1;
    let TOTAL = 0;

    function getFilters(){
      return {
        kw: document.getElementById("kw").value.trim(),
        district: document.getElementById("district").value,
        ward: document.getElementById("ward").value,
        minPrice: Number(document.getElementById("minPrice").value||0),
        maxPrice: Number(document.getElementById("maxPrice").value||0),
        minArea: Number(document.getElementById("minArea").value||0),
        maxArea: Number(document.getElementById("maxArea").value||0),
        frontage: document.getElementById("frontage").value,
        status: document.getElementById("status").value,
        suitable: document.getElementById("suitable").value.trim(),
        sort: document.getElementById("sort").value,
        perPage: Number(document.getElementById("perPage").value||24),
      };
    }

    function money(v){ return Number(v||0).toLocaleString("vi-VN",{style:"currency",currency:"VND",maximumFractionDigits:0}); }

    // ====== QUERY BUILDER ======
    async function fetchPremises({kw='', district='', ward='', status='', frontage='', minPrice=0, maxPrice=0, minArea=0, maxArea=0, suitable='', sort='newest', page=1, perPage=24}) {
      let q = supabase.from('premises').select('*', { count: 'exact' });

      if (district) q = q.eq('district', district);
      if (ward)     q = q.eq('ward', ward);
      if (status)   q = q.eq('status', status);
      if (frontage) q = q.eq('frontage', frontage === 'yes');
      if (minPrice) q = q.gte('price', minPrice);
      if (maxPrice) q = q.lte('price', maxPrice);
      if (minArea)  q = q.gte('area', minArea);
      if (maxArea)  q = q.lte('area', maxArea);
      if (suitable) q = q.contains('suitable', [suitable]);

      if (kw) {
        const safe = kw.replaceAll(",", " ");
        q = q.or(
          `address.ilike.%${safe}%,street.ilike.%${safe}%,district.ilike.%${safe}%`
        );
      }

      if (sort === 'price_asc') {
        q = q.order('price', { ascending: true });
      } else if (sort === 'price_desc') {
        q = q.order('price', { ascending: false });
      } else {
        // b·∫£ng kh√¥ng c√≥ updated_at ‚Üí ch·ªâ d√πng created_at
        q = q.order('created_at', { ascending: false });
      }

      const from = (page-1)*perPage;
      const to   = from + perPage - 1;
      q = q.range(from, to);

      const { data, count, error } = await q;
      if (error) { console.error("Query error:", error); toast('L·ªói t·∫£i d·ªØ li·ªáu'); return { data: [], count: 0 }; }
      return { data, count: count||0 };
    }

    // ====== RENDER LIST ======
    function renderCards(rows){
      const grid = document.getElementById("grid");

      if (!rows.length && PAGE === 1) {
        grid.innerHTML = `
          <div class="col-span-full">
            <div class="rounded-2xl border border-dashed bg-base-100/80 p-6 text-center text-sm opacity-80">
              Ch∆∞a c√≥ m·∫∑t b·∫±ng n√†o kh·ªõp b·ªô l·ªçc hi·ªán t·∫°i. Th·ª≠ n·ªõi l·ªèng ƒëi·ªÅu ki·ªán t√¨m ki·∫øm.
            </div>
          </div>`;
        return;
      }

      const htmlCards = rows.map(it => {
        const imgUrl = Array.isArray(it.images) && it.images.length > 0
          ? resolveImageUrl(it.images[0])
          : null;

        const statusLabel =
          it.status === 'available' ? 'C√≤n tr·ªëng' :
          it.status === 'deposited' ? 'Gi·ªØ c·ªçc' :
          it.status === 'rented' ? 'ƒê√£ thu√™' :
          (it.status || '');

        const statusClass =
          it.status === 'available' ? 'badge-success' :
          it.status === 'deposited' ? 'badge-warning' :
          it.status === 'rented' ? 'badge-neutral' :
          '';

        const titleAddr = maskAddress(it.address, it.ward, it.street);

        const metaParts = [];
        if (it.district) metaParts.push(it.district);
        if (it.area) metaParts.push(`${it.area} m¬≤`);
        if (it.width && it.length) metaParts.push(`${it.width}√ó${it.length} m`);

        const bedrooms = it.bedrooms || it.rooms || it.pn;
        if (bedrooms) metaParts.push(`${bedrooms} PN`);

        const updated = it.updated_at || it.created_at;
        if (updated) metaParts.push(`C·∫≠p nh·∫≠t ${formatDate(updated)}`);

        if (it.frontage) metaParts.push('M·∫∑t ti·ªÅn');

        const metaLine = metaParts.join(" ‚Ä¢ ");

        return `
          <article class="card bg-base-100/95 border border-base-200 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer premise-card rounded-2xl overflow-hidden" data-id="${encodeURIComponent(it.id)}">
            <figure class="h-44 bg-base-200 flex items-center justify-center text-base-content/50">
              ${
                imgUrl
                  ? `<img src="${imgUrl}" class="w-full h-full object-cover" onerror="this.parentNode.innerHTML='(Kh√¥ng c√≥ ·∫£nh)'" />`
                  : `(Kh√¥ng c√≥ ·∫£nh)`
              }
            </figure>
            <div class="card-body p-4 space-y-2">
              <div class="flex items-start justify-between gap-3">
                <h3 class="card-title text-[15px] leading-snug line-clamp-1">${titleAddr}</h3>
                ${
                  statusLabel
                    ? `<div class="badge badge-outline badge-sm ${statusClass}">${statusLabel}</div>`
                    : ''
                }
              </div>
              <div class="text-[12px] opacity-70">
                ${metaLine}
              </div>
              <div class="flex items-center justify-between pt-1">
                <div class="text-xl sm:text-2xl font-extrabold text-primary">${money(it.price)}</div>
                ${
                  it.commission_note
                    ? `<div class="badge badge-outline badge-secondary badge-sm">HH: ${it.commission_note}</div>`
                    : ''
                }
              </div>
            </div>
          </article>
        `;
      }).join("");

      if (PAGE === 1) grid.innerHTML = htmlCards;
      else grid.insertAdjacentHTML('beforeend', htmlCards);

      grid.querySelectorAll('.premise-card').forEach(card => {
        card.addEventListener('click', () => {
          const id = decodeURIComponent(card.dataset.id || '');
          openDetail(id);
        });
      });
    }

    async function applyFilters(resetPage=true){
      if (resetPage) PAGE = 1;
      const f = getFilters();
      const btnMore = document.getElementById('btnMore');
      btnMore.disabled = true; btnMore.textContent = 'ƒêang t·∫£i...';

      const { data, count } = await fetchPremises({ ...f, page: PAGE, perPage: f.perPage });
      TOTAL = count;
      document.getElementById('countGlobal').textContent = `${count.toLocaleString('vi-VN')} m·∫∑t b·∫±ng`;
      document.getElementById('countPage').textContent = `Hi·ªÉn th·ªã ${(Math.min(PAGE*f.perPage, count)).toLocaleString('vi-VN')} / ${count.toLocaleString('vi-VN')}`;

      renderCards(data||[]);

      const more = PAGE * f.perPage < count;
      btnMore.disabled = !more;
      btnMore.textContent = more ? 'T·∫£i th√™m' : 'H·∫øt d·ªØ li·ªáu';
    }

    // ====== DETAIL POPUP ======
    async function openDetail(id){
      const { data, error } = await supabase
        .from('premises')
        .select('*')
        .eq('id', id)
        .single();
      if (error) { console.error(error); return; }
      const item = data;
      const imgs = Array.isArray(item.images) ? item.images : [];

      const gallery = imgs.length
        ? (() => {
            const slides = imgs.map((src, i) => {
              const url = resolveImageUrl(src);
              if (!url) {
                return `
                  <div id="slide${i}" class="carousel-item w-full h-80 bg-base-200 flex items-center justify-center text-base-content/50">
                    (Kh√¥ng c√≥ ·∫£nh)
                  </div>
                `;
              }
              return `
                <div id="slide${i}" class="carousel-item w-full h-80 bg-base-200">
                  <img src="${url}" class="w-full h-full object-contain" />
                </div>
              `;
            }).join("");
            const dots = imgs
              .map((_, i) => `<a href="#slide${i}" class="btn btn-xs rounded-full">${i + 1}</a>`)
              .join("");
            return `
              <div class="carousel w-full rounded-xl border bg-base-200">
                ${slides}
              </div>
              <div class="flex gap-2 justify-center mt-2">
                ${dots}
              </div>
            `;
          })()
        : `<div class="h-80 bg-base-200 rounded-xl flex items-center justify-center text-base-content/50">(Kh√¥ng c√≥ ·∫£nh)</div>`;

      const maps = encodeURIComponent(item.address || `${item.street||""} ${item.district||""}`);
      const gmapEmbed = `<iframe class="w-full h-64 rounded-xl border" loading="lazy"
        src="https://www.google.com/maps?q=${maps}&output=embed"></iframe>`;

      const actions = `
        <div class="join join-horizontal">
          ${item.contact_phone ? `<a class="btn btn-primary btn-sm join-item" href="tel:${item.contact_phone}">G·ªçi</a>` : ''}
          ${item.contact_phone ? `<a class="btn btn-sm join-item" target="_blank" href="https://zalo.me/${(item.contact_phone||'').replace(/[^0-9]/g,'')}">Zalo</a>` : ''}
          <a class="btn btn-sm join-item" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${maps}">M·ªü Google Maps</a>
          <button class="btn btn-sm join-item" onclick="navigator.clipboard.writeText(location.origin + location.pathname + '#'+encodeURIComponent('${id}'));toast('ƒê√£ copy link m·∫∑t b·∫±ng')">Copy link</button>
        </div>`;

      const htmlDetail = `
        <div class="grid md:grid-cols-2 gap-6">
          <div class="space-y-3">
            ${gallery}
            <div class="mt-3">${gmapEmbed}</div>
          </div>
          <div class="space-y-3">
            <h2 class="text-xl font-bold">${maskAddress(item.address, item.ward, item.street)}</h2>
            <div class="text-sm opacity-70">${item.ward||""} ${item.district||""} ‚Ä¢ ${item.city||""}</div>
            <div class="flex flex-wrap gap-2 text-xs">
              ${item.frontage?`<span class="badge badge-outline">M·∫∑t ti·ªÅn</span>`:''}
              ${item.area?`<span class="badge badge-outline">${item.area} m¬≤</span>`:''}
              ${(item.width&&item.length)?`<span class="badge badge-outline">${item.width}√ó${item.length} m</span>`:''}
              ${item.floors?`<span class="badge badge-outline">${item.floors} t·∫ßng</span>`:''}
              ${item.status?`<span class="badge ${item.status==='available'?'badge-success':item.status==='deposited'?'badge-warning':'badge-neutral'}">
                ${item.status==='available'?'C√≤n tr·ªëng':item.status==='deposited'?'Gi·ªØ c·ªçc':'ƒê√£ thu√™'}
              </span>`:''}
            </div>

            <div class="text-3xl font-extrabold text-primary mt-2">${money(item.price)}</div>
            ${item.commission_note?`<div class="text-sm mt-1">Hoa h·ªìng: <b>${item.commission_note}</b></div>`:''}

            ${
              (item.bedrooms || item.rooms || item.pn || item.bathrooms || item.wc || item.floors)
              ? `<div class="mt-3 space-y-1 text-sm">
                  ${item.bedrooms || item.rooms || item.pn ? `<div><b>Ph√≤ng ng·ªß:</b> ${item.bedrooms || item.rooms || item.pn}</div>` : ''}
                  ${item.bathrooms || item.wc ? `<div><b>WC:</b> ${item.bathrooms || item.wc}</div>` : ''}
                  ${item.floors ? `<div><b>S·ªë t·∫ßng:</b> ${item.floors}</div>` : ''}
                </div>`
              : ''
            }

            ${
              item.detail || item.description || item.info_detail
              ? `<div class="mt-3 text-sm leading-relaxed">
                  <div class="font-semibold mb-1">Th√¥ng tin chi ti·∫øt</div>
                  <p>${(item.detail || item.description || item.info_detail).replace(/\n/g, '<br/>')}</p>
                </div>`
              : ''
            }

            ${item.suitable?.length?`<div class="flex flex-wrap gap-1 text-xs mt-3">
              ${item.suitable.map(s=>`<div class="badge badge-ghost">${s}</div>`).join('')}
            </div>`:''}

            ${
              (item.contact_phone||item.contact_name) && !isStaff()
              ? `<div class="space-x-2 text-sm mt-3">
                  <span class="opacity-70">Li√™n h·ªá:</span>
                  <b>${item.contact_name||""}</b>
                  <a class="link" href="tel:${item.contact_phone||''}">${item.contact_phone||''}</a>
                </div>`
              : ''
            }
            ${
              isStaff()
              ? `<div class="mt-3 text-sm opacity-70">
                  Li√™n h·ªá admin ƒë·ªÉ xem s·ªë ƒëi·ªán tho·∫°i ch·ªß nh√†.
                </div>`
              : ''
            }

            <div class="mt-4">
              ${actions}
            </div>
          </div>
        </div>`;

      document.getElementById("detailBody").innerHTML = htmlDetail;
      document.getElementById("detailDlg").showModal();
    }

    // ====== UPLOAD ·∫¢NH ======
    async function uploadImages(files, prefix = '') {
      const urls = [];
      const total = files.length;
      if (!total) return urls;
      const bar = document.getElementById('upProgress');
      const hint = document.getElementById('upHint');
      bar.classList.remove('hidden');
      bar.value = 0;
      for (let i = 0; i < total; i++) {
        const f = files[i];
        const ext = (f.name.split('.').pop() || 'jpg').toLowerCase();
        const path = `${prefix}${Date.now()}_${i}.${ext}`;
        const { error: upErr } = await supabase
          .storage.from(STORAGE_BUCKET)
          .upload(path, f, { cacheControl: '3600', upsert: true });
        if (upErr) { console.error("Upload error:", upErr); throw upErr; }
        const { data: pub, error: urlErr } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(path);
        if (urlErr) { console.error("Public URL error:", urlErr); }
        urls.push(pub.publicUrl);
        bar.value = Math.round(((i + 1) / total) * 100);
        hint.textContent = `ƒêang t·∫£i ${i + 1}/${total}‚Ä¶`;
      }
      setTimeout(() => { bar.classList.add('hidden'); bar.value = 0; hint.textContent = 'T·∫£i ·∫£nh xong.'; }, 500);
      return urls;
    }

    // ====== ADD ITEM ======
    async function addItem(){
      const g  = id => document.getElementById(id).value;
      const chk= id => document.getElementById(id).checked;
      const files = document.getElementById('f_images').files;
      try {
        const codePrefix = 'MB-' + Math.random().toString(36).slice(2,8);
        const imageUrls = await uploadImages(files, `${codePrefix}/`);
        const payload = {
          city:"TP.HCM",
          district: g("add-district") || "Qu·∫≠n 1",
          ward: g("add-ward") || "",
          street:g("f_street")||"",
          address:g("f_address")||"",
          width: g("f_width")?Number(g("f_width")):null,
          length:g("f_length")?Number(g("f_length")):null,
          area:  g("f_area")?Number(g("f_area")):null,
          floors:g("f_floors")?Number(g("f_floors")):null,
          frontage:chk("f_frontage"),
          price:Number(g("f_price")||0),
          commission_note:g("f_commission")||"",
          suitable:(g("f_suitable")||"").split(',').map(s=>s.trim()).filter(Boolean),
          status:g("f_status")||"available",
          contact_name:g("f_contact_name")||"",
          contact_phone:g("f_contact_phone")||"",
          images:imageUrls,
        };
        const { data: inserted, error } = await supabase.from('premises').insert(payload).select().single();
        if (error) throw error;
        toast('ƒê√£ th√™m m·∫∑t b·∫±ng');
        document.getElementById('dlg').close();
        ['f_address','f_street','add-district','add-ward','f_width','f_length','f_area','f_floors','f_price','f_commission','f_suitable','f_contact_name','f_contact_phone'].forEach(id=>{ const el=document.getElementById(id); if (el) el.value=''; });
        document.getElementById('f_frontage').checked = false;
        document.getElementById('f_images').value = '';
        await openDetail(inserted.id);
        PAGE = 1;
        await applyFilters(true);
      } catch (e) {
        console.error("Insert error:", e);
        toast('Kh√¥ng th·ªÉ th√™m (ki·ªÉm tra policy INSERT c·ªßa b·∫£ng v√† policy INSERT c·ªßa Storage).');
      }
    }

    function openAdd(){ document.getElementById('dlg').showModal(); }

    // ====== CSV EXPORT ======
    function downloadCSV(){
      alert('G·ª£i √Ω: v√†o Supabase Table Editor ‚Üí premises ‚Üí Export ‚Üí CSV ƒë·ªÉ t·∫£i to√†n b·ªô d·ªØ li·ªáu.');
    }

    // ====== HELPERS ======
    function resolveImageUrl(src){
      if (!src) return null;
      if (/^https?:\/\//i.test(src)) return src;
      try {
        const { data } = supabase
          .storage
          .from(STORAGE_BUCKET)
          .getPublicUrl(src);
        return data && data.publicUrl ? data.publicUrl : null;
      } catch (e) {
        console.error('resolveImageUrl error:', e);
        return null;
      }
    }

    // ƒê·ªãnh d·∫°ng ng√†y: 28/11/2025
    function formatDate(d) {
      if (!d) return "";
      const dt = new Date(d);
      if (isNaN(dt)) return "";
      const day = String(dt.getDate()).padStart(2, "0");
      const mon = String(dt.getMonth() + 1).padStart(2, "0");
      const yr  = dt.getFullYear();
      return `${day}/${mon}/${yr}`;
    }

    function isStaff() {
      return CURRENT_ROLE === "staff";
    }

    function maskAddress(addr, ward, street) {
      if (!addr && !ward && !street) return "";
      const full = addr || [street, ward].filter(Boolean).join(", ");
      if (!isStaff()) return full;
      return full.replace(/^[0-9\/\- ]+/, "").trim();
    }

    function maskPhone(phone) {
      if (!phone) return "";
      if (!isStaff()) return phone;
      return "Li√™n h·ªá admin ƒë·ªÉ xem s·ªë";
    }

    function toast(msg){
      const el = document.createElement("div");
      el.textContent = msg;
      el.className = "fixed bottom-4 right-4 bg-base-100 border shadow-lg rounded-2xl px-4 py-2 text-sm z-50";
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 2400);
    }

    function resetFilters(){
      ["kw","district","ward","minPrice","maxPrice","minArea","maxArea","frontage","status","suitable","sort","perPage"].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = '';
      });
      document.getElementById('sort').value = 'newest';
      document.getElementById('perPage').value = '24';
      applyFilters(true);
    }

    function debounce(fn, delay){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), delay); }; }

    function quickFilter(status) {
      document.getElementById('status').value = status;
      applyFilters(true);
    }
    function quickFilterDistrict(d) {
      document.getElementById('district').value = d;
      document.getElementById('ward').value = "";
      applyFilters(true);
    }

    // ====== AUTH ======
    async function initAuth() {
      // check env badge
      try {
        const { error } = await supabase.from('premises').select('id', { count: 'exact', head: true }).limit(1);
        if (error) throw error;
        document.getElementById('badgeEnv').classList.add('badge-success');
      } catch (e) {
        document.getElementById('badgeEnv').classList.add('badge-error');
      }

      const { data } = await supabase.auth.getUser();

      if (!data.user) {
        document.getElementById("auth-section").classList.remove("hidden");
        document.getElementById("app-root").classList.add("hidden");
        return;
      }

      CURRENT_USER = data.user;

      const { data: profile } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", CURRENT_USER.id)
        .maybeSingle();

      CURRENT_ROLE = profile?.role || "staff";

      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("app-root").classList.remove("hidden");

      // üî• load list sau khi login
      await applyFilters(true);

      const hashId = decodeURIComponent(location.hash.slice(1) || "");
      if (hashId) openDetail(hashId);
    }

    async function handleLogin() {
      const email = document.getElementById("auth-email").value.trim();
      const password = document.getElementById("auth-password").value;
      const errEl = document.getElementById("auth-error");
      errEl.classList.add("hidden");
      errEl.textContent = "";

      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });

      if (error) {
        errEl.textContent = error.message || "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i";
        errEl.classList.remove("hidden");
        return;
      }

      CURRENT_USER = data.user;
      await initAuth();
    }

    async function handleLogout() {
      await supabase.auth.signOut();
      CURRENT_USER = null;
      CURRENT_ROLE = null;
      location.reload(); // reload v·ªÅ m√†n login
    }

    // ====== EVENTS & INIT ======
    document.getElementById('btnApply').addEventListener('click', ()=>applyFilters(true));
    document.getElementById('btnMore').addEventListener('click', ()=>{ PAGE++; applyFilters(false); });
    document.getElementById('kw').addEventListener('input', debounce(()=>applyFilters(true), 400));

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btn-login").addEventListener("click", handleLogin);
      document.getElementById("btn-logout").addEventListener("click", handleLogout);
      initAuth();
    });
  </script>
</body>
</html>
