<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>ID-Land Premises - Quản lý mặt bằng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
  
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    /* Hiệu ứng hover cho thẻ card */
    .premise-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    /* CSS cho phần xem trước ảnh upload */
    .img-preview-box {
        position: relative;
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
    }
    .img-preview-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .img-preview-box .btn-remove {
        position: absolute;
        top: 2px;
        right: 2px;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        border: none;
    }
    .img-preview-box .btn-remove:hover {
        background: #dc2626;
    }
  </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

  <section id="auth-section" class="flex-1 flex items-center justify-center p-4">
    <div class="card w-full max-w-md bg-base-100 shadow-xl">
      <div class="card-body">
        <div class="flex items-center gap-3 mb-6">
          <div class="h-12 w-12 rounded-xl bg-primary flex items-center justify-center text-white font-bold text-2xl">ID</div>
          <div>
            <h2 class="card-title text-2xl font-bold">ID-Land</h2>
            <p class="text-sm opacity-70">Hệ thống kho mặt bằng nội bộ</p>
          </div>
        </div>

        <div class="form-control w-full">
          <label class="label">
            <span class="label-text font-semibold">Email đăng nhập</span>
          </label>
          <input id="login-email" type="email" placeholder="admin@idland.vn" class="input input-bordered w-full" />
        </div>

        <div class="form-control w-full mt-4">
          <label class="label">
            <span class="label-text font-semibold">Mật khẩu</span>
          </label>
          <input id="login-password" type="password" placeholder="••••••••" class="input input-bordered w-full" />
        </div>
        
        <div class="form-control mt-8">
          <button id="btn-login" class="btn btn-primary w-full text-lg text-white shadow-lg">
            Đăng nhập hệ thống
          </button>
        </div>

        <div id="login-msg" class="alert alert-error mt-4 hidden text-sm py-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span id="login-msg-text">Thông báo lỗi</span>
        </div>
      </div>
    </div>
  </section>

  <div id="app-root" class="hidden flex-col min-h-screen">
    
    <div class="navbar bg-base-100 shadow-md px-4 sticky top-0 z-40">
      <div class="flex-1 flex items-center gap-3">
        <div class="h-10 w-10 rounded-lg bg-primary flex items-center justify-center text-white font-bold text-lg shadow">ID</div>
        <div class="leading-tight hidden sm:block">
          <div class="font-bold text-lg text-gray-800">ID-Land Premises</div>
          <div class="text-[11px] opacity-60 uppercase tracking-wider font-semibold">Kho dữ liệu TP.HCM</div>
        </div>
      </div>
      <div class="flex-none flex items-center gap-4">
        <div class="text-right hidden sm:block">
          <div id="user-email-display" class="text-xs font-bold text-gray-700">Đang tải...</div>
          <div id="role-badge" class="badge badge-xs badge-outline uppercase font-semibold mt-1">Staff</div>
        </div>
        <button id="btn-logout" class="btn btn-ghost btn-sm text-error hover:bg-error/10">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
          Đăng xuất
        </button>
      </div>
    </div>

    <main class="flex-1 max-w-[1600px] mx-auto w-full px-3 sm:px-6 py-6">
      
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Danh sách mặt bằng</h1>
          <p class="text-sm text-gray-500 mt-1">Quản lý, tìm kiếm và kiểm duyệt tin đăng.</p>
        </div>
        
        <div class="flex flex-wrap gap-3">
          <div id="admin-controls" class="hidden flex gap-2">
            <button id="btn-toggle-pending" class="btn btn-warning btn-sm text-white shadow-md gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>
              Cần duyệt <span class="badge badge-sm bg-white text-warning border-none font-bold" id="count-pending">0</span>
            </button>
            <button id="btn-approve-all" class="btn btn-success btn-sm text-white shadow-md hidden gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
              Duyệt tất cả
            </button>
          </div>
          
          <button id="btn-open-add" class="btn btn-primary btn-sm shadow-lg text-white gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
            Đăng tin mới
          </button>
        </div>
      </div>

      <div class="grid md:grid-cols-[280px,1fr] gap-6">
        
        <aside class="bg-base-100 rounded-2xl shadow-sm border border-base-200 p-5 h-fit sticky top-20">
          <div class="flex items-center gap-2 mb-4 border-b pb-2">
            <span class="w-3 h-3 rounded-full bg-success animate-pulse"></span>
            <h2 class="font-bold text-gray-700">Bộ lọc tìm kiếm</h2>
          </div>
          
          <div class="form-control mb-3">
            <label class="label py-1"><span class="label-text text-xs font-bold text-gray-500">Từ khoá / Mã MB</span></label>
            <input id="filter-keyword" type="text" placeholder="VD: Nguyễn Trãi, Q1..." class="input input-sm input-bordered w-full" />
          </div>

          <div class="form-control mb-3">
            <label class="label py-1"><span class="label-text text-xs font-bold text-gray-500">Khu vực</span></label>
            <select id="filter-district" class="select select-sm select-bordered w-full mb-2">
                <option value="">Tất cả Quận</option>
            </select>
            <select id="filter-ward" class="select select-sm select-bordered w-full" disabled>
                <option value="">Tất cả Phường</option>
            </select>
          </div>

          <div class="form-control mb-3">
             <label class="label py-1"><span class="label-text text-xs font-bold text-gray-500">Mức giá (Triệu đồng)</span></label>
             <div class="grid grid-cols-2 gap-2">
               <input id="filter-price-min" type="number" placeholder="Từ" class="input input-sm input-bordered" />
               <input id="filter-price-max" type="number" placeholder="Đến" class="input input-sm input-bordered" />
             </div>
          </div>

          <div class="form-control mb-3">
             <label class="label py-1"><span class="label-text text-xs font-bold text-gray-500">Diện tích (m²)</span></label>
             <div class="grid grid-cols-2 gap-2">
               <input id="filter-area-min" type="number" placeholder="Từ" class="input input-sm input-bordered" />
               <input id="filter-area-max" type="number" placeholder="Đến" class="input input-sm input-bordered" />
             </div>
          </div>

          <div class="form-control mb-3">
             <label class="label py-1"><span class="label-text text-xs font-bold text-gray-500">Kết cấu</span></label>
             <div class="grid grid-cols-3 gap-2">
                 <select id="filter-pn" class="select select-sm select-bordered text-[11px] px-1">
                    <option value="">PN</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5+">5+</option>
                 </select>
                 <select id="filter-wc" class="select select-sm select-bordered text-[11px] px-1">
                    <option value="">WC</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5+">5+</option>
                 </select>
                 <select id="filter-floors" class="select select-sm select-bordered text-[11px] px-1">
                    <option value="">Tầng</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5+">5+</option>
                 </select>
             </div>
          </div>

          <div class="form-control mb-3">
             <label class="label py-1"><span class="label-text text-xs font-bold text-gray-500">Loại hình</span></label>
             <select id="filter-frontage-type" class="select select-sm select-bordered w-full">
                <option value="">Tất cả</option>
                <option value="mt">Mặt tiền</option>
                <option value="hxh">Hẻm xe hơi</option>
                <option value="hem">Hẻm thường</option>
             </select>
          </div>

          <div class="form-control mb-5">
             <label class="label py-1"><span class="label-text text-xs font-bold text-gray-500">Trạng thái</span></label>
             <select id="filter-status" class="select select-sm select-bordered w-full">
                <option value="">Tất cả</option>
                <option value="available">Còn trống</option>
                <option value="deposited">Giữ cọc</option>
                <option value="rented">Đã thuê</option>
             </select>
          </div>

          <div class="flex gap-2">
             <button id="btn-apply" class="btn btn-sm btn-primary flex-1 text-white">Áp dụng</button>
             <button id="btn-reset" class="btn btn-sm btn-outline">Xoá lọc</button>
          </div>
        </aside>

        <section class="flex flex-col gap-4">
           <div class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-base-200 text-sm">
              <span class="opacity-70">Kết quả hiển thị: <b id="result-count">Đang tải...</b></span>
              <div class="flex gap-2">
                  </div>
           </div>
           
           <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-5">
              </div>

           <div class="text-center mt-6 mb-10">
              <button id="btn-load-more" class="btn btn-outline btn-sm px-6">Tải thêm dữ liệu</button>
           </div>
        </section>
      </div>
    </main>
  </div>

  <dialog id="addDlg" class="modal">
    <div class="modal-box max-w-5xl">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 text-lg">✕</button>
      </form>
      
      <h3 class="font-bold text-2xl text-primary mb-1">Đăng mặt bằng mới</h3>
      <p class="text-xs opacity-60 mb-6 italic">Mã mặt bằng (MB-xxxx) sẽ được hệ thống tự động khởi tạo.</p>
      
      <div class="grid md:grid-cols-12 gap-6">
        
        <div class="md:col-span-7 space-y-4">
            <div class="form-control">
                <label class="label pt-0"><span class="label-text font-bold">Địa chỉ (Số nhà + Tên đường) <span class="text-error">*</span></span></label>
                <input id="add-address" type="text" placeholder="VD: 123 Nguyễn Trãi" class="input input-bordered" />
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text font-bold">Quận <span class="text-error">*</span></span></label>
                    <select id="add-district" class="select select-bordered w-full">
                        <option value="">-- Chọn Quận --</option>
                    </select>
                </div>
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text font-bold">Phường <span class="text-error">*</span></span></label>
                    <select id="add-ward" class="select select-bordered w-full" disabled>
                        <option value="">-- Chọn Quận trước --</option>
                    </select>
                </div>
            </div>

            <div class="form-control">
                <label class="label pt-0"><span class="label-text font-bold">Tên đường (để lọc)</span></label>
                <input id="add-street" type="text" class="input input-bordered" placeholder="VD: Nguyễn Trãi" />
            </div>
            
            <div class="form-control">
                <label class="label pt-0"><span class="label-text font-bold text-primary">Giá thuê (VNĐ) <span class="text-error">*</span></span></label>
                <input id="add-price" type="text" class="input input-bordered font-bold text-lg text-primary" onkeyup="formatCurrencyInput(this)" placeholder="0" />
            </div>

            <div class="form-control mt-2">
                 <label class="cursor-pointer flex items-center gap-3 border p-3 rounded-lg bg-base-100 hover:bg-base-200 transition">
                    <input id="add-frontage" type="checkbox" class="checkbox checkbox-primary" /> 
                    <span class="font-medium">Đánh dấu là Nhà mặt tiền</span>
                 </label>
            </div>

            <div class="form-control border border-dashed border-primary/50 rounded-xl p-4 bg-blue-50/30 mt-4">
                 <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-bold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                        Hình ảnh
                    </span>
                    <span id="upload-status" class="text-xs text-primary hidden flex items-center gap-1">
                        <span class="loading loading-spinner loading-xs"></span> Đang tải lên...
                    </span>
                 </div>
                 
                 <input type="file" id="inp-upload-img" class="file-input file-input-sm file-input-primary w-full mb-3" multiple accept="image/*" onchange="handleImageUpload(this)" />
                 
                 <div id="preview-container" class="flex flex-wrap gap-3 min-h-[80px]">
                     <div class="text-xs opacity-50 w-full text-center py-4">Chưa có ảnh nào được chọn.</div>
                 </div>
            </div>
        </div>

        <div class="md:col-span-5 space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text text-xs">Diện tích (m²)</span></label>
                    <input id="add-area" type="number" class="input input-bordered input-sm" />
                </div>
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text text-xs">Số tầng</span></label>
                    <input id="add-floors" type="number" class="input input-bordered input-sm" />
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text text-xs">Ngang (m)</span></label>
                    <input id="add-width" type="number" step="0.1" class="input input-bordered input-sm" />
                </div>
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text text-xs">Dài (m)</span></label>
                    <input id="add-length" type="number" step="0.1" class="input input-bordered input-sm" />
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text text-xs">Phòng ngủ</span></label>
                    <input id="add-bedrooms" type="number" class="input input-bordered input-sm" />
                </div>
                <div class="form-control">
                    <label class="label pt-0"><span class="label-text text-xs">Toilet</span></label>
                    <input id="add-wc" type="number" class="input input-bordered input-sm" />
                </div>
            </div>

            <div class="form-control">
                <label class="label pt-0"><span class="label-text text-xs">Kết cấu (VD: Trệt 3 lầu)</span></label>
                <input id="add-ket-cau" type="text" class="input input-bordered input-sm" />
            </div>

            <div class="form-control">
                <label class="label pt-0"><span class="label-text text-xs font-bold text-error">SĐT Chủ nhà (Bảo mật)</span></label>
                <input id="add-contact-phone" type="text" class="input input-bordered input-sm input-error" placeholder="Chỉ Admin thấy..." />
            </div>

            <div class="form-control">
                <label class="label pt-0"><span class="label-text text-xs">Mô tả chi tiết</span></label>
                <textarea id="add-detail" class="textarea textarea-bordered h-32 text-sm"></textarea>
            </div>
        </div>

      </div>

      <div class="modal-action pt-4 border-t mt-4">
        <button class="btn" onclick="document.getElementById('addDlg').close()">Đóng</button>
        <button class="btn btn-primary px-8 text-white" onclick="saveNewPremise()">
           Lưu tin đăng
        </button>
      </div>
    </div>
  </dialog>

  <dialog id="editDlg" class="modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
      <h3 class="font-bold text-lg mb-3 text-primary">Chỉnh sửa thông tin mặt bằng</h3>

      <div class="grid md:grid-cols-2 gap-3">
        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text font-bold">Mã mặt bằng</span></label>
          <input id="edit-code" type="text" class="input input-bordered w-full bg-base-200" readonly />
        </div>
        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text">Địa chỉ hiển thị</span></label>
          <input id="edit-address" type="text" class="input input-bordered w-full" />
        </div>
        
        <div class="form-control"><label class="label"><span class="label-text">Quận</span></label><input id="edit-district" type="text" class="input input-bordered w-full" /></div>
        <div class="form-control"><label class="label"><span class="label-text">Phường</span></label><input id="edit-ward" type="text" class="input input-bordered w-full" /></div>
        <div class="form-control"><label class="label"><span class="label-text">Tên đường</span></label><input id="edit-street" type="text" class="input input-bordered w-full" /></div>
        
        <div class="form-control"><label class="label"><span class="label-text font-bold text-primary">Giá thuê</span></label><input id="edit-price" type="number" class="input input-bordered w-full font-bold" /></div>
        
        <div class="form-control"><label class="label"><span class="label-text">Diện tích</span></label><input id="edit-area" type="number" class="input input-bordered w-full" /></div>
        <div class="form-control"><label class="label"><span class="label-text">Ngang</span></label><input id="edit-width" type="number" class="input input-bordered w-full" /></div>
        <div class="form-control"><label class="label"><span class="label-text">Dài</span></label><input id="edit-length" type="number" class="input input-bordered w-full" /></div>
        <div class="form-control"><label class="label"><span class="label-text">Số tầng</span></label><input id="edit-floors" type="number" class="input input-bordered w-full" /></div>
        <div class="form-control"><label class="label"><span class="label-text">Số PN</span></label><input id="edit-bedrooms" type="number" class="input input-bordered w-full" /></div>
        <div class="form-control"><label class="label"><span class="label-text">Số WC</span></label><input id="edit-wc" type="number" class="input input-bordered w-full" /></div>
        
        <div class="form-control md:col-span-2"><label class="label"><span class="label-text">Kết cấu</span></label><input id="edit-ket-cau" type="text" class="input input-bordered w-full" /></div>
        <div class="form-control md:col-span-2"><label class="label"><span class="label-text font-bold text-error">SĐT Chủ nhà</span></label><input id="edit-contact-phone" type="text" class="input input-bordered w-full input-error" /></div>
        
        <div class="form-control flex flex-row items-center gap-2 mt-2">
            <input id="edit-frontage" type="checkbox" class="checkbox checkbox-primary" />
            <span class="label-text font-bold">Là nhà mặt tiền</span>
        </div>

        <div class="form-control"><label class="label"><span class="label-text">Trạng thái</span></label>
            <select id="edit-status" class="select select-bordered w-full">
                <option value="available">Còn trống</option>
                <option value="deposited">Giữ cọc</option>
                <option value="rented">Đã thuê</option>
            </select>
        </div>
        <div class="form-control md:col-span-2"><label class="label"><span class="label-text">Hoa hồng / Ghi chú</span></label><input id="edit-commission" type="text" class="input input-bordered w-full" /></div>
        
        <div class="form-control md:col-span-2">
            <label class="label"><span class="label-text">Link Ảnh (Mỗi dòng 1 link/path)</span></label>
            <textarea id="edit-images" class="textarea textarea-bordered w-full min-h-[100px]"></textarea>
        </div>
        <div class="form-control md:col-span-2"><label class="label"><span class="label-text">Mô tả chi tiết</span></label><textarea id="edit-detail" class="textarea textarea-bordered w-full min-h-[140px]"></textarea></div>
        
        <input id="edit-city" type="hidden" />
      </div>
      
      <div class="modal-action">
        <button class="btn" onclick="document.getElementById('editDlg').close()">Huỷ bỏ</button>
        <button class="btn btn-primary" onclick="saveEditPremise()">Lưu thay đổi</button>
      </div>
    </div>
  </dialog>

  <dialog id="detailDlg" class="modal">
    <div class="modal-box max-w-6xl p-0 overflow-hidden relative bg-white h-[90vh]">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-4 top-4 z-20 bg-white/80 hover:bg-white">✕</button>
        </form>
        <div id="detail-content" class="h-full flex flex-col justify-center items-center">
            <span class="loading loading-spinner loading-lg text-primary"></span>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <div id="toast" class="toast toast-top toast-end z-[100] hidden">
    <div class="alert alert-info shadow-lg" id="toast-text">
      <span>Message here</span>
    </div>
  </div>

  <script>
    // --- CẤU HÌNH KẾT NỐI SUPABASE ---
    const SUPABASE_URL = "https://xclncowkoedwqzcemhei.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbG5jb3drb2Vkd3F6Y2VtaGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNzcwOTUsImV4cCI6MjA3Nzg1MzA5NX0.jfNM46UgXIq9LrwSXcERJJULeKB7bl_c9R9LaVhRy1A";
    const STORAGE_BUCKET = "premise-images";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const PAGE_SIZE = 24;
    
    // --- DỮ LIỆU QUẬN/PHƯỜNG TP.HCM (ĐẦY ĐỦ) ---
    const HCM_DATA = {
        "Quận 1": ["Bến Nghé", "Bến Thành", "Cô Giang", "Cầu Kho", "Cầu Ông Lãnh", "Đa Kao", "Nguyễn Cư Trinh", "Nguyễn Thái Bình", "Phạm Ngũ Lão", "Tân Định"],
        "Quận 2": ["Thảo Điền", "An Phú", "Bình An", "Bình Trưng Đông", "Bình Trưng Tây", "Bình Khánh", "An Khánh", "Cát Lái", "Thạnh Mỹ Lợi", "An Lợi Đông", "Thủ Thiêm"],
        "Quận 3": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Võ Thị Sáu"],
        "Quận 4": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 6", "Phường 8", "Phường 9", "Phường 10", "Phường 13", "Phường 14", "Phường 15", "Phường 16", "Phường 18"],
        "Quận 5": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14"],
        "Quận 6": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14"],
        "Quận 7": ["Bình Thuận", "Phú Mỹ", "Phú Thuận", "Tân Hưng", "Tân Kiểng", "Tân Phong", "Tân Phú", "Tân Quy", "Tân Thuận Đông", "Tân Thuận Tây"],
        "Quận 8": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Phường 15", "Phường 16"],
        "Quận 9": ["Hiệp Phú", "Long Bình", "Long Phước", "Long Thạnh Mỹ", "Long Trường", "Phú Hữu", "Phước Bình", "Phước Long A", "Phước Long B", "Tân Phú", "Tăng Nhơn Phú A", "Tăng Nhơn Phú B", "Trường Thạnh"],
        "Quận 10": ["Phường 1", "Phường 2", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Phường 15"],
        "Quận 11": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Phường 15", "Phường 16"],
        "Quận 12": ["An Phú Đông", "Đông Hưng Thuận", "Hiệp Thành", "Tân Chánh Hiệp", "Tân Hưng Thuận", "Tân Thới Hiệp", "Tân Thới Nhất", "Thạnh Lộc", "Thạnh Xuân", "Thới An", "Trung Mỹ Tây"],
        "Bình Tân": ["An Lạc", "An Lạc A", "Bình Hưng Hòa", "Bình Hưng Hòa A", "Bình Hưng Hòa B", "Bình Trị Đông", "Bình Trị Đông A", "Bình Trị Đông B", "Tân Tạo", "Tân Tạo A"],
        "Bình Thạnh": ["Phường 1", "Phường 2", "Phường 3", "Phường 5", "Phường 6", "Phường 7", "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Phường 15", "Phường 17", "Phường 19", "Phường 21", "Phường 22", "Phường 24", "Phường 25", "Phường 26", "Phường 27", "Phường 28"],
        "Gò Vấp": ["Phường 1", "Phường 3", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Phường 15", "Phường 16", "Phường 17"],
        "Phú Nhuận": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 13", "Phường 15", "Phường 17"],
        "Tân Bình": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Phường 15"],
        "Tân Phú": ["Hiệp Tân", "Hòa Thạnh", "Phú Thạnh", "Phú Thọ Hòa", "Phú Trung", "Sơn Kỳ", "Tân Quý", "Tân Sơn Nhì", "Tân Thành", "Tân Thới Hòa", "Tây Thạnh"],
        "Thủ Đức": ["An Khánh", "An Lợi Đông", "An Phú", "Bình Chiểu", "Bình Thọ", "Bình Trưng Đông", "Bình Trưng Tây", "Cát Lái", "Hiệp Bình Chánh", "Hiệp Bình Phước", "Linh Chiểu", "Linh Đông", "Linh Tây", "Linh Trung", "Linh Xuân", "Long Bình", "Long Phước", "Long Thạnh Mỹ", "Long Trường", "Phú Hữu", "Phước Bình", "Phước Long A", "Phước Long B", "Tam Bình", "Tam Phú", "Tân Phú", "Tăng Nhơn Phú A", "Tăng Nhơn Phú B", "Thảo Điền", "Thạnh Mỹ Lợi", "Thủ Thiêm", "Trường Thạnh", "Trường Thọ"]
    };

    // Biến trạng thái toàn cục
    let CURRENT_USER = null;
    let CURRENT_ROLE = "staff";
    let PAGE = 0;
    let TOTAL_COUNT = 0;
    let SHOW_PENDING = false; // Chế độ duyệt bài
    let EDITING_ID = null; // ID bài đang sửa
    let UPLOADED_IMAGES = []; // Danh sách ảnh đã upload cho bài mới

    // ================== KHỞI TẠO (INIT) ==================
    document.addEventListener("DOMContentLoaded", () => {
        // Setup Dropdown cho các form
        initAddFormDropdowns();
        initFilterDropdowns();
        
        // Kiểm tra đăng nhập
        checkSession();

        // Sự kiện nút Đăng nhập / Đăng xuất
        document.getElementById("btn-login").onclick = handleLogin;
        document.getElementById("btn-logout").onclick = async () => { 
            await supabase.auth.signOut(); 
            location.reload(); 
        };

        // Sự kiện nút Chức năng
        document.getElementById("btn-open-add").onclick = openAddModal;
        document.getElementById("btn-apply").onclick = () => loadData(true);
        document.getElementById("btn-reset").onclick = resetFilters;
        document.getElementById("btn-load-more").onclick = () => { PAGE++; loadData(false); };

        // Sự kiện Admin
        document.getElementById("btn-toggle-pending").onclick = togglePendingMode;
        document.getElementById("btn-approve-all").onclick = approveAll;

        // Sự kiện thay đổi Quận -> Load Phường
        document.getElementById("filter-district").onchange = (e) => updateWards("filter-ward", e.target.value);
        document.getElementById("add-district").onchange = (e) => updateWards("add-ward", e.target.value);
    });

    // ================== XỬ LÝ AUTH (ĐĂNG NHẬP/QUYỀN) ==================
    async function checkSession() {
        const { data } = await supabase.auth.getUser();
        if (data.user) {
            CURRENT_USER = data.user;
            
            // Lấy thông tin Role từ bảng profiles
            const { data: profile } = await supabase
                .from("profiles")
                .select("role, email")
                .eq("id", CURRENT_USER.id)
                .maybeSingle();
            
            CURRENT_ROLE = profile?.role || "staff";
            const displayEmail = profile?.email || CURRENT_USER.email;

            // Cập nhật giao diện
            document.getElementById("user-email-display").textContent = displayEmail;
            document.getElementById("role-badge").textContent = CURRENT_ROLE === 'admin' ? "Admin" : "Nhân sự";
            
            if (CURRENT_ROLE === 'admin') {
                document.getElementById("role-badge").classList.remove("badge-outline");
                document.getElementById("role-badge").classList.add("badge-error", "text-white");
                document.getElementById("admin-controls").classList.remove("hidden");
                checkPendingCount();
            }

            // Ẩn màn hình login, hiện màn hình chính
            document.getElementById("auth-section").classList.add("hidden");
            document.getElementById("app-root").classList.remove("hidden");
            document.getElementById("app-root").classList.add("flex");

            // Tải dữ liệu
            loadData(true);
        } else {
            document.getElementById("auth-section").classList.remove("hidden");
            document.getElementById("app-root").classList.remove("flex");
            document.getElementById("app-root").classList.add("hidden");
        }
    }

    async function handleLogin() {
        const email = document.getElementById("login-email").value.trim();
        const password = document.getElementById("login-password").value.trim();
        const msgEl = document.getElementById("login-msg");
        const msgText = document.getElementById("login-msg-text");

        msgEl.classList.add("hidden");

        if (!email || !password) {
            msgText.textContent = "Vui lòng nhập đầy đủ email và mật khẩu";
            msgEl.classList.remove("hidden");
            return;
        }

        const { error } = await supabase.auth.signInWithPassword({ email, password });
        
        if (error) {
            msgText.textContent = "Đăng nhập thất bại: " + error.message;
            msgEl.classList.remove("hidden");
        } else {
            checkSession();
        }
    }

    // ================== XỬ LÝ UPLOAD ẢNH (MỚI & QUAN TRỌNG) ==================
    async function handleImageUpload(input) {
        const files = input.files;
        if (!files || files.length === 0) return;
        
        const statusEl = document.getElementById("upload-status");
        statusEl.classList.remove("hidden");

        for (const file of files) {
            // Tạo tên file ngẫu nhiên để tránh trùng: timestamp + random string
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 15)}.${fileExt}`;
            const filePath = `public/${fileName}`;

            // Upload lên Supabase Storage
            const { data, error } = await supabase.storage
                .from(STORAGE_BUCKET)
                .upload(filePath, file);
            
            if (error) {
                console.error("Lỗi upload:", error);
                toast(`Lỗi upload ảnh: ${file.name}`, 'error');
                continue;
            }

            // Thành công -> Lưu đường dẫn vào mảng
            UPLOADED_IMAGES.push(data.path);
        }
        
        // Ẩn trạng thái loading và reset input
        statusEl.classList.add("hidden");
        input.value = ""; 
        
        // Render lại danh sách ảnh preview
        renderImagePreview();
    }

    function renderImagePreview() {
        const container = document.getElementById("preview-container");
        container.innerHTML = ""; // Xóa cũ

        if (UPLOADED_IMAGES.length === 0) {
            container.innerHTML = `<div class="text-xs opacity-50 w-full text-center py-4">Chưa có ảnh nào được chọn.</div>`;
            return;
        }

        UPLOADED_IMAGES.forEach((path, index) => {
            const url = buildImageUrl(path);
            
            // Tạo HTML cho từng ảnh preview
            const div = document.createElement("div");
            div.className = "img-preview-box";
            div.innerHTML = `
                <img src="${url}" alt="preview" />
                <button class="btn-remove" onclick="removeImage(${index})">✕</button>
            `;
            container.appendChild(div);
        });
    }

    // Hàm xóa ảnh khỏi danh sách upload (được gọi từ HTML onclick)
    window.removeImage = function(index) {
        UPLOADED_IMAGES.splice(index, 1); // Xóa khỏi mảng
        renderImagePreview(); // Render lại
    }

    // ================== TÍNH NĂNG: THÊM MỚI MẶT BẰNG ==================
    function openAddModal() {
        // Reset toàn bộ form về trắng
        document.querySelectorAll("#addDlg input").forEach(i => { 
            if (i.type === 'checkbox') i.checked = false;
            else if (i.type !== 'file') i.value = ""; 
        });
        document.querySelectorAll("#addDlg textarea").forEach(i => i.value = "");
        
        // Reset dropdown quận/phường
        document.getElementById("add-district").value = "";
        document.getElementById("add-ward").innerHTML = "<option value=''>-- Chọn Quận trước --</option>";
        document.getElementById("add-ward").disabled = true;
        
        // Reset phần ảnh upload
        UPLOADED_IMAGES = [];
        renderImagePreview();
        document.getElementById("inp-upload-img").value = "";

        document.getElementById("addDlg").showModal();
    }

    async function saveNewPremise() {
        // Lấy giá trị từ form
        const getVal = (id) => document.getElementById(id).value.trim();
        const getNum = (id) => {
            const v = document.getElementById(id).value.replace(/[^\d]/g, ''); // Xóa dấu chấm phẩy
            return v ? parseInt(v) : null;
        };

        const address = getVal("add-address");
        const district = document.getElementById("add-district").value;
        const price = getNum("add-price");

        // Validate cơ bản
        if (!address || !district || !price) {
            toast("Vui lòng nhập đủ: Địa chỉ, Quận và Giá thuê!", 'error');
            return;
        }

        // Tạo object dữ liệu để gửi lên
        const payload = {
            address: address,
            district: district,
            ward: document.getElementById("add-ward").value,
            street: getVal("add-street"),
            price: price,
            area: getNum("add-area"),
            width: Number(document.getElementById("add-width").value) || null,
            length: Number(document.getElementById("add-length").value) || null,
            floors: getNum("add-floors"),
            pn: getNum("add-bedrooms"),
            wc: getNum("add-wc"),
            ket_cau: getVal("add-ket-cau"),
            contact_phone: getVal("add-contact-phone"),
            frontage: document.getElementById("add-frontage").checked,
            detail: getVal("add-detail"),
            status: 'available', // Mặc định là còn trống
            images: UPLOADED_IMAGES // Mảng ảnh từ việc upload
        };

        // Gửi lệnh INSERT lên Supabase
        const { error } = await supabase.from("premises").insert([payload]);

        if (error) {
            console.error(error);
            toast("Lỗi khi lưu: " + error.message, 'error');
        } else {
            const successMsg = (CURRENT_ROLE === 'admin') 
                ? "Đã đăng tin thành công!" 
                : "Đã gửi tin! Chờ Admin duyệt.";
            toast(successMsg, 'success');
            
            document.getElementById("addDlg").close();
            loadData(true); // Tải lại danh sách
            
            if(CURRENT_ROLE === 'admin') checkPendingCount(); // Cập nhật số lượng chờ duyệt
        }
    }

    // ================== TÍNH NĂNG: TẢI DỮ LIỆU & HIỂN THỊ ==================
    async function loadData(reset = false) {
        if (reset) PAGE = 0;
        const grid = document.getElementById("grid");
        if (reset) grid.innerHTML = "";
        
        const btnMore = document.getElementById("btn-load-more");
        btnMore.innerText = "Đang tải...";
        btnMore.disabled = true;

        // Tạo query cơ bản
        let query = supabase.from("premises").select("*, profiles(email)", { count: 'exact' });

        // --- XỬ LÝ LỌC THEO CHẾ ĐỘ ADMIN ---
        if (SHOW_PENDING && CURRENT_ROLE === 'admin') {
            query = query.eq("is_approved", false); // Xem bài chưa duyệt
        } else {
            query = query.eq("is_approved", true); // Xem bài đã duyệt (mặc định)
        }

        // --- XỬ LÝ BỘ LỌC TỪ SIDEBAR ---
        const k = document.getElementById("filter-keyword").value.trim();
        if (k) query = query.or(`address.ilike.%${k}%,code.ilike.%${k}%`);
        
        const dist = document.getElementById("filter-district").value;
        if (dist) query = query.eq("district", dist);
        
        const ward = document.getElementById("filter-ward").value;
        if (ward) query = query.eq("ward", ward);

        const pMin = document.getElementById("filter-price-min").value;
        if (pMin) query = query.gte("price", pMin * 1000000);
        
        const pMax = document.getElementById("filter-price-max").value;
        if (pMax) query = query.lte("price", pMax * 1000000);

        const aMin = document.getElementById("filter-area-min").value;
        if (aMin) query = query.gte("area", aMin);
        
        const aMax = document.getElementById("filter-area-max").value;
        if (aMax) query = query.lte("area", aMax);

        const ft = document.getElementById("filter-frontage-type").value;
        if (ft === 'mt') query = query.eq("frontage", true);

        const st = document.getElementById("filter-status").value;
        if (st) query = query.eq("status", st);

        // Phân trang
        const from = PAGE * PAGE_SIZE;
        const to = from + PAGE_SIZE - 1;
        query = query.order("created_at", { ascending: false }).range(from, to);

        // Thực thi Query
        let { data, error, count } = await query;

        // --- CƠ CHẾ SAFE MODE (Nếu chưa chạy SQL fix profile) ---
        if (error && error.message.includes("profiles")) {
             console.warn("Lỗi join profiles. Chuyển sang chế độ safe mode.");
             // Thử lại mà không join bảng profiles
             query = supabase.from("premises").select("*", { count: 'exact' });
             if(SHOW_PENDING) query = query.eq("is_approved", false); else query = query.eq("is_approved", true);
             query = query.order("created_at", { ascending: false }).range(from, to);
             const res = await query;
             data = res.data;
             count = res.count;
        }

        if (!data || data.length === 0) {
            if (PAGE === 0) grid.innerHTML = `<div class="col-span-full text-center opacity-50 py-10 italic">Không tìm thấy dữ liệu phù hợp.</div>`;
            btnMore.style.display = "none";
            return;
        }

        // Client-side filter cho Hẻm / Hẻm xe hơi (vì DB không có cột loại hẻm)
        if (ft === 'hem' || ft === 'hxh') {
            data = data.filter(r => {
                const txt = (r.address + (r.detail || "")).toLowerCase();
                const isHXH = txt.includes("hxh") || txt.includes("xe hơi");
                return ft === 'hxh' ? (!r.frontage && isHXH) : (!r.frontage && !isHXH);
            });
        }

        // Render thẻ
        document.getElementById("result-count").innerText = count || data.length;
        data.forEach(item => {
            const html = createCardHTML(item);
            grid.insertAdjacentHTML("beforeend", html);
        });

        // Trạng thái nút tải thêm
        btnMore.style.display = "inline-flex";
        if (data.length < PAGE_SIZE) {
            btnMore.innerText = "Đã hiển thị hết";
            btnMore.disabled = true;
        } else {
            btnMore.innerText = "Tải thêm";
            btnMore.disabled = false;
        }
    }

    function createCardHTML(item) {
        // Xử lý ảnh đại diện
        const imgUrl = buildImageUrl(item.images?.[0]) || "https://placehold.co/400x300?text=No+Image";
        
        // Xử lý tên người đăng
        const creatorEmail = item.profiles?.email || "";
        const creatorName = creatorEmail.split('@')[0] || "Ẩn danh";

        // Xử lý Badge (Mặt tiền/Hẻm)
        let badgeHtml = "";
        if (item.frontage) {
            badgeHtml = `<span class="badge badge-xs badge-error text-white border-none shadow-sm">Mặt tiền</span>`;
        } else {
            const txt = (item.address + (item.detail||"")).toLowerCase();
            if (txt.includes("hxh") || txt.includes("xe hơi")) {
                badgeHtml = `<span class="badge badge-xs badge-info text-white border-none shadow-sm">Hẻm xe hơi</span>`;
            } else {
                badgeHtml = `<span class="badge badge-xs badge-ghost border-none opacity-80 bg-white/80">Hẻm</span>`;
            }
        }

        // Nút Duyệt (chỉ hiện khi Admin đang ở chế độ duyệt)
        const approveBtn = (SHOW_PENDING && CURRENT_ROLE === 'admin') 
            ? `<button onclick="approveOne('${item.id}', event)" class="btn btn-xs btn-success w-full mt-2 text-white shadow-md">✔ Duyệt ngay</button>` 
            : "";

        return `
        <div class="card bg-base-100 border border-gray-200 shadow-sm hover:shadow-lg transition-all cursor-pointer premise-card flex flex-col h-full group" onclick="openDetail('${item.id}')">
            <figure class="h-48 bg-gray-100 relative overflow-hidden">
                <img src="${imgUrl}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy"/>
                
                <div class="absolute top-2 right-2 flex gap-1">
                    ${badgeHtml}
                </div>

                <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/70 to-transparent text-white text-[10px] px-3 py-2 pt-6">
                    Đăng bởi: <span class="font-bold">${creatorName}</span>
                </div>
            </figure>
            
            <div class="card-body p-4 gap-2 flex-1">
                <div class="flex justify-between items-start">
                    <div class="text-xs opacity-60 font-bold tracking-wide text-gray-500 uppercase">
                        ${item.code || 'MB-NEW'} • ${item.district}
                    </div>
                </div>

                <h3 class="font-bold text-sm leading-snug line-clamp-2 min-h-[2.5rem] text-gray-800">
                    ${maskAddress(item)}
                </h3>
                
                <div class="mt-auto pt-2 border-t border-dashed border-gray-200">
                    <div class="text-lg font-extrabold text-primary flex items-baseline gap-1">
                        ${money(item.price)}
                    </div>
                    
                    <div class="flex gap-3 text-xs text-gray-500 mt-1 font-medium">
                        <span class="flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg> ${item.area || 0}m²</span>
                        <span>${item.width || 0}x${item.length || 0}</span>
                        <span>${item.pn || 0} PN</span>
                    </div>
                </div>
                ${approveBtn}
            </div>
        </div>`;
    }

    // ================== TÍNH NĂNG: ADMIN (DUYỆT BÀI & SỬA) ==================
    async function checkPendingCount() {
        // Đếm số bài chưa duyệt
        const { count } = await supabase
            .from("premises")
            .select("*", { count: 'exact', head: true })
            .eq("is_approved", false);
            
        const cnt = count || 0;
        document.getElementById("count-pending").innerText = cnt;
        
        // Ẩn hiện nút duyệt tất cả
        if (cnt > 0 && SHOW_PENDING) {
            document.getElementById("btn-approve-all").classList.remove("hidden");
        } else {
            document.getElementById("btn-approve-all").classList.add("hidden");
        }
    }

    function togglePendingMode() {
        SHOW_PENDING = !SHOW_PENDING;
        const btn = document.getElementById("btn-toggle-pending");
        
        if (SHOW_PENDING) {
            btn.classList.replace("btn-warning", "btn-active");
            btn.innerText = "Thoát chế độ duyệt";
        } else {
            btn.classList.replace("btn-active", "btn-warning");
            btn.innerHTML = `Cần duyệt <span class="badge badge-sm bg-white text-warning border-none ml-1" id="count-pending">...</span>`;
            checkPendingCount();
        }
        loadData(true);
    }

    async function approveOne(id, e) {
        e.stopPropagation(); // Ngăn click vào card mở detail
        if (!confirm("Duyệt bài đăng này?")) return;
        
        await supabase.from("premises").update({ is_approved: true }).eq("id", id);
        toast("Đã duyệt bài thành công!", 'success');
        loadData(true);
        checkPendingCount();
    }

    async function approveAll() {
        if (!confirm("Bạn chắc chắn muốn duyệt TẤT CẢ bài đang chờ?")) return;
        
        await supabase.from("premises").update({ is_approved: true }).eq("is_approved", false);
        toast("Đã duyệt toàn bộ bài!", 'success');
        loadData(true);
        checkPendingCount();
    }

    // --- CHỨC NĂNG SỬA (FULL CODE) ---
    async function openEditPremise(id) {
        if (!isAdmin()) return;
        EDITING_ID = id;
        document.getElementById("detailDlg").close(); // Đóng modal chi tiết

        // Tải dữ liệu bài cần sửa
        const { data, error } = await supabase.from("premises").select("*").eq("id", id).single();
        if (error || !data) { toast("Lỗi tải dữ liệu", 'error'); return; }

        const item = data;
        const getEl = (id) => document.getElementById(id);

        // Đổ dữ liệu vào form sửa
        getEl("edit-code").value = item.code || "";
        getEl("edit-address").value = item.address || "";
        getEl("edit-city").value = item.city || "";
        getEl("edit-district").value = item.district || "";
        getEl("edit-ward").value = item.ward || "";
        getEl("edit-street").value = item.street || "";
        getEl("edit-price").value = item.price || "";
        getEl("edit-area").value = item.area || "";
        getEl("edit-width").value = item.width || "";
        getEl("edit-length").value = item.length || "";
        getEl("edit-floors").value = item.floors || "";
        getEl("edit-bedrooms").value = pickField(item, ["pn", "so_pn", "bedrooms"]) || "";
        getEl("edit-wc").value = pickField(item, ["wc", "bathrooms"]) || "";
        getEl("edit-ket-cau").value = item.ket_cau || "";
        getEl("edit-contact-phone").value = item.contact_phone || "";
        getEl("edit-frontage").checked = !!item.frontage;
        getEl("edit-status").value = item.status || "available";
        getEl("edit-commission").value = item.commission_note || "";
        
        // Xử lý ảnh trong form sửa (hiện path dạng text để admin sửa nhanh nếu cần)
        getEl("edit-images").value = (Array.isArray(item.images) ? item.images.join("\n") : "");
        
        getEl("edit-detail").value = pickField(item, ["detail", "chi_tiet"]) || "";

        document.getElementById("editDlg").showModal();
    }

    async function saveEditPremise() {
        if (!isAdmin() || !EDITING_ID) return;
        
        const getVal = (id) => document.getElementById(id).value.trim();
        const getNum = (id) => { 
            const v = getVal(id).replace(/[^\d.]/g, ""); 
            return v ? Number(v) : 0; 
        };

        const payload = {
            code: getVal("edit-code"),
            address: getVal("edit-address"),
            city: getVal("edit-city"),
            district: getVal("edit-district"),
            ward: getVal("edit-ward"),
            street: getVal("edit-street"),
            price: getNum("edit-price"),
            area: getNum("edit-area"),
            width: getNum("edit-width"),
            length: getNum("edit-length"),
            floors: getNum("edit-floors"),
            pn: getNum("edit-bedrooms"),
            wc: getNum("edit-wc"),
            ket_cau: getVal("edit-ket-cau"),
            contact_phone: getVal("edit-contact-phone"),
            frontage: document.getElementById("edit-frontage").checked,
            status: getVal("edit-status"),
            commission_note: getVal("edit-commission"),
            images: getVal("edit-images").split("\n").map(s => s.trim()).filter(Boolean),
            detail: getVal("edit-detail"),
            updated_at: new Date().toISOString(),
        };

        const { error } = await supabase.from("premises").update(payload).eq("id", EDITING_ID);
        
        if (error) {
            console.error("Lỗi Save:", error);
            toast("Lỗi: " + error.message, 'error');
        } else {
            toast("Đã lưu thay đổi!", 'success');
            document.getElementById("editDlg").close();
            loadData(false); // Refresh nhưng giữ nguyên trang hiện tại
        }
    }

    // ================== UTILS & HELPERS ==================
    
    // Khởi tạo Dropdown cho Form Lọc
    function initFilterDropdowns() {
         const sel = document.getElementById("filter-district");
         const dists = Object.keys(HCM_DATA).sort();
         sel.innerHTML = `<option value="">Tất cả</option>` + dists.map(d => `<option value="${d}">${d}</option>`).join("");
    }

    // Khởi tạo Dropdown cho Form Thêm Mới
    function initAddFormDropdowns() {
        const el = document.getElementById("add-district");
        const dists = Object.keys(HCM_DATA).sort();
        el.innerHTML = `<option value="">-- Chọn Quận --</option>` + dists.map(d => `<option value="${d}">${d}</option>`).join("");
    }

    // Cập nhật Phường khi chọn Quận
    function updateWards(targetId, distName) {
         const el = document.getElementById(targetId);
         const defaultText = targetId.includes("filter") ? "Tất cả" : "-- Chọn --";
         
         el.innerHTML = `<option value="">${defaultText}</option>`;
         
         if (HCM_DATA[distName]) {
             el.disabled = false;
             el.innerHTML += HCM_DATA[distName].map(w => `<option value="${w}">${w}</option>`).join("");
         } else {
             el.disabled = true;
         }
    }
    
    // Mở xem chi tiết
    async function openDetail(id) {
         const d = document.getElementById("detailDlg");
         const c = document.getElementById("detail-content");
         d.showModal();
         c.innerHTML = `<div class="h-full flex items-center justify-center"><span class="loading loading-spinner loading-lg text-primary"></span></div>`;
         
         const { data } = await supabase.from("premises").select("*, profiles(email)").eq("id", id).single();
         
         if(!data) {
             c.innerHTML = `<div class="p-10 text-center text-error">Không tìm thấy dữ liệu.</div>`;
             return;
         }

         const imgs = data.images || [];
         const carouselHtml = imgs.length 
            ? `<div class="carousel w-full h-[400px] bg-black rounded-xl">
                ${imgs.map((src, i) => `
                    <div id="slide${i}" class="carousel-item relative w-full justify-center">
                        <img src="${buildImageUrl(src)}" class="h-full object-contain" />
                        <div class="absolute flex justify-between transform -translate-y-1/2 left-5 right-5 top-1/2">
                            <a href="#slide${i===0 ? imgs.length-1 : i-1}" class="btn btn-circle btn-sm bg-white/20 border-none text-white">❮</a> 
                            <a href="#slide${i===imgs.length-1 ? 0 : i+1}" class="btn btn-circle btn-sm bg-white/20 border-none text-white">❯</a>
                        </div>
                        <div class="absolute bottom-4 right-4 bg-black/50 text-white px-2 py-1 text-xs rounded">${i+1}/${imgs.length}</div>
                    </div>
                `).join('')}
               </div>` 
            : `<div class="h-[300px] bg-gray-100 flex items-center justify-center text-gray-400 rounded-xl">Không có hình ảnh</div>`;

         const editBtn = isAdmin() ? `<button class="btn btn-outline btn-sm" onclick="openEditPremise('${data.id}')">✏️ Sửa tin</button>` : '';
         
         const creatorName = data.profiles?.email || 'Ẩn danh';

         c.innerHTML = `
            <div class="grid md:grid-cols-12 gap-0 h-full">
                <div class="md:col-span-7 bg-gray-900 p-4 flex items-center justify-center overflow-hidden">
                    ${carouselHtml}
                </div>

                <div class="md:col-span-5 p-6 overflow-y-auto bg-white">
                   <div class="flex justify-between items-start mb-2">
                       <div class="badge badge-outline opacity-50">${data.code || 'NO-CODE'}</div>
                       <div class="text-xs opacity-50">Ngày đăng: ${formatDateVN(data.created_at)}</div>
                   </div>
                   
                   <h2 class="text-2xl font-bold text-gray-800 leading-tight mb-1">${maskAddress(data)}</h2>
                   <p class="text-sm text-gray-500 mb-4 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        ${data.ward}, ${data.district}
                   </p>

                   <div class="text-3xl font-black text-primary mb-6 border-b pb-4 border-gray-100">
                       ${money(data.price)} <span class="text-base font-normal text-gray-400">/tháng</span>
                   </div>

                   <div class="grid grid-cols-2 gap-y-4 gap-x-2 text-sm mb-6">
                       <div class="flex flex-col"><span class="text-xs opacity-50">Diện tích</span><span class="font-bold text-gray-700">${data.area || '-'} m²</span></div>
                       <div class="flex flex-col"><span class="text-xs opacity-50">Kích thước</span><span class="font-bold text-gray-700">${data.width} x ${data.length}m</span></div>
                       <div class="flex flex-col"><span class="text-xs opacity-50">Kết cấu</span><span class="font-bold text-gray-700">${data.ket_cau || '-'}</span></div>
                       <div class="flex flex-col"><span class="text-xs opacity-50">Công năng</span><span class="font-bold text-gray-700">${data.pn||0} PN - ${data.wc||0} WC</span></div>
                   </div>

                   <div class="bg-gray-50 p-4 rounded-xl mb-6">
                       <h4 class="font-bold text-sm mb-2 text-gray-700">Mô tả chi tiết</h4>
                       <p class="text-sm whitespace-pre-line text-gray-600 leading-relaxed">${data.detail || 'Chưa có mô tả chi tiết.'}</p>
                   </div>
                   
                   ${(data.contact_phone && isAdmin()) ? `
                   <div class="alert alert-warning shadow-sm mb-6">
                       <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                       <div>
                           <h3 class="font-bold">Thông tin Chủ nhà</h3>
                           <div class="text-xs">SĐT: <span class="font-mono text-base">${data.contact_phone}</span></div>
                       </div>
                   </div>` : ''}

                   <div class="text-xs text-gray-400 text-center mt-auto">
                       Tin được đăng bởi: ${creatorName}
                   </div>

                   <div class="flex gap-2 mt-4 pt-4 border-t">
                       <button class="btn btn-primary flex-1" onclick="window.open('tel:${data.contact_phone}')">Gọi điện</button>
                       <button class="btn btn-outline" onclick="navigator.clipboard.writeText(window.location.href);toast('Đã copy link!')">Share</button>
                       ${editBtn}
                   </div>
                </div>
            </div>`;
    }

    // Các hàm hỗ trợ nhỏ
    function resetFilters() {
        document.querySelectorAll("aside input, aside select").forEach(e => e.value="");
        loadData(true);
    }
    function maskAddress(r) { 
        if(CURRENT_ROLE==='admin') return r.address;
        // Nếu là nhân viên/khách, ẩn số nhà
        const full = r.address || "";
        const parts = full.split(' ');
        if(parts.length > 1) return parts.slice(1).join(' '); // Bỏ từ đầu tiên (thường là số nhà)
        return r.street || "Đang cập nhật";
    }
    function toast(msg, type='info') {
        const t = document.getElementById("toast");
        const tx = document.getElementById("toast-text");
        tx.innerText = msg;
        tx.className = `alert shadow-lg ${type==='error'?'alert-error text-white':'alert-info'}`;
        t.classList.remove("hidden");
        setTimeout(() => t.classList.add("hidden"), 3000);
    }
    function money(v) { return v ? new Intl.NumberFormat("vi-VN").format(v) + " đ" : ""; }
    function formatDateVN(d) { return d ? new Date(d).toLocaleDateString("vi-VN") : ""; }
    function buildImageUrl(path) {
        if (!path) return null;
        if (path.startsWith('http')) return path;
        const { data } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(path);
        return data.publicUrl;
    }
    function formatCurrencyInput(el) {
        let v = el.value.replace(/\D/g, '');
        if(v) el.value = new Intl.NumberFormat('vi-VN').format(v);
    }
    function pickField(obj, names) { 
        for (const n of names) if (obj && obj[n]) return obj[n]; 
        return null; 
    }

  </script>
</body>
</html>